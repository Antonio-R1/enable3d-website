/*! For license information please see enable3d.framework.0.23.0.min.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("THREE"),require("Matter")):"function"==typeof define&&define.amd?define(["THREE","Matter"],t):"object"==typeof exports?exports.ENABLE3D=t(require("THREE"),require("Matter")):e.ENABLE3D=t(e.THREE,e.Matter)}(self,(function(e,t){return(()=>{"use strict";var n={650:function(e,t,n){var s=this&&this.__spreadArray||function(e,t){for(var n=0,s=t.length,r=e.length;n<s;n++,r++)e[r]=t[n];return e};Object.defineProperty(t,"__esModule",{value:!0}),t.Events=void 0;var r=n(406),o=function(e,t,n){void 0===n&&(n=!1),this.fn=e,this.context=t,this.once=n},i=function(e,t,n,s,r){if("function"!=typeof n)throw new TypeError("The listener must be a function");var i=new o(n,s||e,r);return e._events.has(t)?e._events.get(t).fn?e._events.set(t,[e._events.get(t),i]):e._events.get(t).push(i):(e._events.set(t,i),e._eventsCount++),e},a=function(e,t){0==--e._eventsCount?e._events=new Map:e._events.delete(t)},l=function(){function e(){this._events=new Map,this._eventsCount=0}return Object.defineProperty(e,"VERSION",{get:function(){return r.VERSION},enumerable:!1,configurable:!0}),e.prototype.eventNames=function(){return Array.from(this._events.keys())},e.prototype.listeners=function(e){var t=this._events.get(e);if(!t)return[];if(t.fn)return[t.fn];for(var n=0,s=t.length,r=new Array(s);n<s;n++)r[n]=t[n].fn;return r},e.prototype.listenerCount=function(e){var t=this._events.get(e);return t?t.fn?1:t.length:0},e.prototype.emit=function(e){for(var t,n,r=[],o=1;o<arguments.length;o++)r[o-1]=arguments[o];if(!this._events.has(e))return!1;var i,a=this._events.get(e);if(a.fn)return a.once&&this.removeListener(e,a.fn,void 0,!0),(t=a.fn).call.apply(t,s([a.context],r)),!0;var l=a.length;for(i=0;i<l;i++)a[i].once&&this.removeListener(e,a[i].fn,void 0,!0),(n=a[i].fn).call.apply(n,s([a[i].context],r));return!0},e.prototype.on=function(e,t,n){return i(this,e,t,n,!1)},e.prototype.once=function(e,t,n){return i(this,e,t,n,!0)},e.prototype.removeListener=function(e,t,n,s){if(!this._events.has(e))return this;if(!t)return a(this,e),this;var r=this._events.get(e);if(r.fn)r.fn!==t||s&&!r.once||n&&r.context!==n||a(this,e);else{for(var o=0,i=[],l=r.length;o<l;o++)(r[o].fn!==t||s&&!r[o].once||n&&r[o].context!==n)&&i.push(r[o]);i.length?this._events.set(e,1===i.length?i[0]:i):a(this,e)}return this},e.prototype.removeAllListeners=function(e){return e?this._events.delete(e)&&a(this,e):(this._events=new Map,this._eventsCount=0),this},Object.defineProperty(e.prototype,"off",{get:function(){return this.removeListener},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"addListener",{get:function(){return this.on},enumerable:!1,configurable:!0}),e}();t.Events=l},406:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.VERSION=void 0,t.VERSION="0.0.5"},197:function(e,t,n){var s=this&&this.__spreadArray||function(e,t){for(var n=0,s=t.length,r=e.length;n<s;n++,r++)e[r]=t[n];return e};Object.defineProperty(t,"__esModule",{value:!0}),t.Events=void 0;var r=n(789),o=function(e,t,n){void 0===n&&(n=!1),this.fn=e,this.context=t,this.once=n},i=function(e,t,n,s,r){if("function"!=typeof n)throw new TypeError("The listener must be a function");var i=new o(n,s||e,r);return e._events.has(t)?e._events.get(t).fn?e._events.set(t,[e._events.get(t),i]):e._events.get(t).push(i):(e._events.set(t,i),e._eventsCount++),e},a=function(e,t){0==--e._eventsCount?e._events=new Map:e._events.delete(t)},l=function(){function e(){this._events=new Map,this._eventsCount=0}return Object.defineProperty(e,"VERSION",{get:function(){return r.VERSION},enumerable:!1,configurable:!0}),e.prototype.eventNames=function(){return Array.from(this._events.keys())},e.prototype.listeners=function(e){var t=this._events.get(e);if(!t)return[];if(t.fn)return[t.fn];for(var n=0,s=t.length,r=new Array(s);n<s;n++)r[n]=t[n].fn;return r},e.prototype.listenerCount=function(e){var t=this._events.get(e);return t?t.fn?1:t.length:0},e.prototype.emit=function(e){for(var t,n,r=[],o=1;o<arguments.length;o++)r[o-1]=arguments[o];if(!this._events.has(e))return!1;var i,a=this._events.get(e);if(a.fn)return a.once&&this.removeListener(e,a.fn,void 0,!0),(t=a.fn).call.apply(t,s([a.context],r)),!0;var l=a.length;for(i=0;i<l;i++)a[i].once&&this.removeListener(e,a[i].fn,void 0,!0),(n=a[i].fn).call.apply(n,s([a[i].context],r));return!0},e.prototype.on=function(e,t,n){return i(this,e,t,n,!1)},e.prototype.once=function(e,t,n){return i(this,e,t,n,!0)},e.prototype.removeListener=function(e,t,n,s){if(!this._events.has(e))return this;if(!t)return a(this,e),this;var r=this._events.get(e);if(r.fn)r.fn!==t||s&&!r.once||n&&r.context!==n||a(this,e);else{for(var o=0,i=[],l=r.length;o<l;o++)(r[o].fn!==t||s&&!r[o].once||n&&r[o].context!==n)&&i.push(r[o]);i.length?this._events.set(e,1===i.length?i[0]:i):a(this,e)}return this},e.prototype.removeAllListeners=function(e){return e?this._events.delete(e)&&a(this,e):(this._events=new Map,this._eventsCount=0),this},Object.defineProperty(e.prototype,"off",{get:function(){return this.removeListener},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"addListener",{get:function(){return this.on},enumerable:!1,configurable:!0}),e}();t.Events=l},789:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.VERSION=void 0,t.VERSION="0.0.5"},613:function(e,t,n){var s=this&&this.__spreadArray||function(e,t){for(var n=0,s=t.length,r=e.length;n<s;n++,r++)e[r]=t[n];return e};Object.defineProperty(t,"__esModule",{value:!0}),t.Events=void 0;var r=n(547),o=function(e,t,n){void 0===n&&(n=!1),this.fn=e,this.context=t,this.once=n},i=function(e,t,n,s,r){if("function"!=typeof n)throw new TypeError("The listener must be a function");var i=new o(n,s||e,r);return e._events.has(t)?e._events.get(t).fn?e._events.set(t,[e._events.get(t),i]):e._events.get(t).push(i):(e._events.set(t,i),e._eventsCount++),e},a=function(e,t){0==--e._eventsCount?e._events=new Map:e._events.delete(t)},l=function(){function e(){this._events=new Map,this._eventsCount=0}return Object.defineProperty(e,"VERSION",{get:function(){return r.VERSION},enumerable:!1,configurable:!0}),e.prototype.eventNames=function(){return Array.from(this._events.keys())},e.prototype.listeners=function(e){var t=this._events.get(e);if(!t)return[];if(t.fn)return[t.fn];for(var n=0,s=t.length,r=new Array(s);n<s;n++)r[n]=t[n].fn;return r},e.prototype.listenerCount=function(e){var t=this._events.get(e);return t?t.fn?1:t.length:0},e.prototype.emit=function(e){for(var t,n,r=[],o=1;o<arguments.length;o++)r[o-1]=arguments[o];if(!this._events.has(e))return!1;var i,a=this._events.get(e);if(a.fn)return a.once&&this.removeListener(e,a.fn,void 0,!0),(t=a.fn).call.apply(t,s([a.context],r)),!0;var l=a.length;for(i=0;i<l;i++)a[i].once&&this.removeListener(e,a[i].fn,void 0,!0),(n=a[i].fn).call.apply(n,s([a[i].context],r));return!0},e.prototype.on=function(e,t,n){return i(this,e,t,n,!1)},e.prototype.once=function(e,t,n){return i(this,e,t,n,!0)},e.prototype.removeListener=function(e,t,n,s){if(!this._events.has(e))return this;if(!t)return a(this,e),this;var r=this._events.get(e);if(r.fn)r.fn!==t||s&&!r.once||n&&r.context!==n||a(this,e);else{for(var o=0,i=[],l=r.length;o<l;o++)(r[o].fn!==t||s&&!r[o].once||n&&r[o].context!==n)&&i.push(r[o]);i.length?this._events.set(e,1===i.length?i[0]:i):a(this,e)}return this},e.prototype.removeAllListeners=function(e){return e?this._events.delete(e)&&a(this,e):(this._events=new Map,this._eventsCount=0),this},Object.defineProperty(e.prototype,"off",{get:function(){return this.removeListener},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"addListener",{get:function(){return this.on},enumerable:!1,configurable:!0}),e}();t.Events=l},547:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.VERSION=void 0,t.VERSION="0.0.5"},626:e=>{e.exports=t},428:t=>{t.exports=e}},s={};function r(e){var t=s[e];if(void 0!==t)return t.exports;var o=s[e]={exports:{}};return n[e].call(o.exports,o,o.exports,r),o.exports}r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var o={};return(()=>{r.r(o),r.d(o,{DotScreenShader:()=>Mo,EffectComposer:()=>yo,ExtendedGroup:()=>Os,ExtendedMesh:()=>ss,ExtendedObject3D:()=>Is,FLAT:()=>t,FirstPersonControls:()=>io,GlitchPass:()=>Ao,JoyStick:()=>ro,PhysicsLoader:()=>pr,PointerDrag:()=>lo,PointerLock:()=>ao,Project:()=>xr,RenderPass:()=>bo,Scene3D:()=>Vs,ShaderPass:()=>fo,THREE:()=>s,ThirdPersonControls:()=>oo,Types:()=>n});var e={};r.r(e),r.d(e,{AsyncCompress:()=>Je,AsyncDecompress:()=>ft,AsyncDeflate:()=>We,AsyncGunzip:()=>st,AsyncGzip:()=>Je,AsyncInflate:()=>Ye,AsyncUnzipInflate:()=>jt,AsyncUnzlib:()=>ut,AsyncZipDeflate:()=>Nt,AsyncZlib:()=>at,Compress:()=>Ze,DecodeUTF8:()=>Mt,Decompress:()=>mt,Deflate:()=>Ge,EncodeUTF8:()=>_t,Gunzip:()=>nt,Gzip:()=>Ze,Inflate:()=>Ke,Unzip:()=>Ht,UnzipInflate:()=>zt,UnzipPassThrough:()=>Ut,Unzlib:()=>ht,Zip:()=>Bt,ZipDeflate:()=>Ot,ZipPassThrough:()=>It,Zlib:()=>it,compress:()=>et,compressSync:()=>tt,decompress:()=>gt,decompressSync:()=>vt,deflate:()=>Xe,deflateSync:()=>qe,gunzip:()=>rt,gunzipSync:()=>ot,gzip:()=>et,gzipSync:()=>tt,inflate:()=>$e,inflateSync:()=>Qe,strFromU8:()=>St,strToU8:()=>Tt,unzip:()=>Gt,unzipSync:()=>Wt,unzlib:()=>dt,unzlibSync:()=>pt,zip:()=>Dt,zipSync:()=>Ft,zlib:()=>lt,zlibSync:()=>ct});var t={};r.r(t),r.d(t,{ActionSprite:()=>Gr,Button:()=>Xr,DrawSprite:()=>Kr,DrawTexture:()=>qr,SimpleSprite:()=>Hr,SpriteSheet:()=>Wr,TextSprite:()=>Qr,TextTexture:()=>$r,TextureAtlas:()=>Jr,destroy:()=>Ur,getParent:()=>Fr,initEvents:()=>Yr,physics:()=>so,setSize:()=>Dr,updateEvents:()=>jr});var n={};r.r(n);var s=r(428);const i=new s.Matrix4,a=new s.Object3D,l=new s.Vector3;class c extends s.EventDispatcher{constructor(){super(),this.uuid=s.MathUtils.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.elementsNeedUpdate=!1,this.verticesNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1}applyMatrix4(e){const t=(new s.Matrix3).getNormalMatrix(e);for(let t=0,n=this.vertices.length;t<n;t++)this.vertices[t].applyMatrix4(e);for(let e=0,n=this.faces.length;e<n;e++){const n=this.faces[e];n.normal.applyMatrix3(t).normalize();for(let e=0,s=n.vertexNormals.length;e<s;e++)n.vertexNormals[e].applyMatrix3(t).normalize()}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0,this}rotateX(e){return i.makeRotationX(e),this.applyMatrix4(i),this}rotateY(e){return i.makeRotationY(e),this.applyMatrix4(i),this}rotateZ(e){return i.makeRotationZ(e),this.applyMatrix4(i),this}translate(e,t,n){return i.makeTranslation(e,t,n),this.applyMatrix4(i),this}scale(e,t,n){return i.makeScale(e,t,n),this.applyMatrix4(i),this}lookAt(e){return a.lookAt(e),a.updateMatrix(),this.applyMatrix4(a.matrix),this}fromBufferGeometry(e){const t=this,n=null!==e.index?e.index:void 0,r=e.attributes;if(void 0===r.position)return console.error("THREE.Geometry.fromBufferGeometry(): Position attribute required for conversion."),this;const o=r.position,i=r.normal,a=r.color,l=r.uv,c=r.uv2;void 0!==c&&(this.faceVertexUvs[1]=[]);for(let e=0;e<o.count;e++)t.vertices.push((new s.Vector3).fromBufferAttribute(o,e)),void 0!==a&&t.colors.push((new s.Color).fromBufferAttribute(a,e));function h(e,n,r,o){const h=void 0===a?[]:[t.colors[e].clone(),t.colors[n].clone(),t.colors[r].clone()],d=void 0===i?[]:[(new s.Vector3).fromBufferAttribute(i,e),(new s.Vector3).fromBufferAttribute(i,n),(new s.Vector3).fromBufferAttribute(i,r)],p=new u(e,n,r,d,h,o);t.faces.push(p),void 0!==l&&t.faceVertexUvs[0].push([(new s.Vector2).fromBufferAttribute(l,e),(new s.Vector2).fromBufferAttribute(l,n),(new s.Vector2).fromBufferAttribute(l,r)]),void 0!==c&&t.faceVertexUvs[1].push([(new s.Vector2).fromBufferAttribute(c,e),(new s.Vector2).fromBufferAttribute(c,n),(new s.Vector2).fromBufferAttribute(c,r)])}const d=e.groups;if(d.length>0)for(let e=0;e<d.length;e++){const t=d[e],s=t.start;for(let e=s,r=s+t.count;e<r;e+=3)void 0!==n?h(n.getX(e),n.getX(e+1),n.getX(e+2),t.materialIndex):h(e,e+1,e+2,t.materialIndex)}else if(void 0!==n)for(let e=0;e<n.count;e+=3)h(n.getX(e),n.getX(e+1),n.getX(e+2));else for(let e=0;e<o.count;e+=3)h(e,e+1,e+2);return this.computeFaceNormals(),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(l).negate(),this.translate(l.x,l.y,l.z),this}normalize(){this.computeBoundingSphere();const e=this.boundingSphere.center,t=this.boundingSphere.radius,n=0===t?1:1/t,r=new s.Matrix4;return r.set(n,0,0,-n*e.x,0,n,0,-n*e.y,0,0,n,-n*e.z,0,0,0,1),this.applyMatrix4(r),this}computeFaceNormals(){const e=new s.Vector3,t=new s.Vector3;for(let n=0,s=this.faces.length;n<s;n++){const s=this.faces[n],r=this.vertices[s.a],o=this.vertices[s.b],i=this.vertices[s.c];e.subVectors(i,o),t.subVectors(r,o),e.cross(t),e.normalize(),s.normal.copy(e)}}computeVertexNormals(e=!0){const t=new Array(this.vertices.length);for(let e=0,n=this.vertices.length;e<n;e++)t[e]=new s.Vector3;if(e){const e=new s.Vector3,n=new s.Vector3;for(let s=0,r=this.faces.length;s<r;s++){const r=this.faces[s],o=this.vertices[r.a],i=this.vertices[r.b],a=this.vertices[r.c];e.subVectors(a,i),n.subVectors(o,i),e.cross(n),t[r.a].add(e),t[r.b].add(e),t[r.c].add(e)}}else{this.computeFaceNormals();for(let e=0,n=this.faces.length;e<n;e++){const n=this.faces[e];t[n.a].add(n.normal),t[n.b].add(n.normal),t[n.c].add(n.normal)}}for(let e=0,n=this.vertices.length;e<n;e++)t[e].normalize();for(let e=0,n=this.faces.length;e<n;e++){const n=this.faces[e],s=n.vertexNormals;3===s.length?(s[0].copy(t[n.a]),s[1].copy(t[n.b]),s[2].copy(t[n.c])):(s[0]=t[n.a].clone(),s[1]=t[n.b].clone(),s[2]=t[n.c].clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)}computeFlatVertexNormals(){this.computeFaceNormals();for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e],n=t.vertexNormals;3===n.length?(n[0].copy(t.normal),n[1].copy(t.normal),n[2].copy(t.normal)):(n[0]=t.normal.clone(),n[1]=t.normal.clone(),n[2]=t.normal.clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)}computeMorphNormals(){for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e];t.__originalFaceNormal?t.__originalFaceNormal.copy(t.normal):t.__originalFaceNormal=t.normal.clone(),t.__originalVertexNormals||(t.__originalVertexNormals=[]);for(let e=0,n=t.vertexNormals.length;e<n;e++)t.__originalVertexNormals[e]?t.__originalVertexNormals[e].copy(t.vertexNormals[e]):t.__originalVertexNormals[e]=t.vertexNormals[e].clone()}const e=new c;e.faces=this.faces;for(let t=0,n=this.morphTargets.length;t<n;t++){if(!this.morphNormals[t]){this.morphNormals[t]={},this.morphNormals[t].faceNormals=[],this.morphNormals[t].vertexNormals=[];const e=this.morphNormals[t].faceNormals,n=this.morphNormals[t].vertexNormals;for(let t=0,r=this.faces.length;t<r;t++){const t=new s.Vector3,r={a:new s.Vector3,b:new s.Vector3,c:new s.Vector3};e.push(t),n.push(r)}}const n=this.morphNormals[t];e.vertices=this.morphTargets[t].vertices,e.computeFaceNormals(),e.computeVertexNormals();for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e],s=n.faceNormals[e],r=n.vertexNormals[e];s.copy(t.normal),r.a.copy(t.vertexNormals[0]),r.b.copy(t.vertexNormals[1]),r.c.copy(t.vertexNormals[2])}}for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e];t.normal=t.__originalFaceNormal,t.vertexNormals=t.__originalVertexNormals}}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new s.Box3),this.boundingBox.setFromPoints(this.vertices)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new s.Sphere),this.boundingSphere.setFromPoints(this.vertices)}merge(e,t,n=0){if(!e||!e.isGeometry)return void console.error("THREE.Geometry.merge(): geometry not an instance of THREE.Geometry.",e);let r;const o=this.vertices.length,i=this.vertices,a=e.vertices,l=this.faces,c=e.faces,h=this.colors,d=e.colors;void 0!==t&&(r=(new s.Matrix3).getNormalMatrix(t));for(let e=0,n=a.length;e<n;e++){const n=a[e].clone();void 0!==t&&n.applyMatrix4(t),i.push(n)}for(let e=0,t=d.length;e<t;e++)h.push(d[e].clone());for(let e=0,t=c.length;e<t;e++){const t=c[e];let s,i;const a=t.vertexNormals,h=t.vertexColors,d=new u(t.a+o,t.b+o,t.c+o);d.normal.copy(t.normal),void 0!==r&&d.normal.applyMatrix3(r).normalize();for(let e=0,t=a.length;e<t;e++)s=a[e].clone(),void 0!==r&&s.applyMatrix3(r).normalize(),d.vertexNormals.push(s);d.color.copy(t.color);for(let e=0,t=h.length;e<t;e++)i=h[e],d.vertexColors.push(i.clone());d.materialIndex=t.materialIndex+n,l.push(d)}for(let t=0,n=e.faceVertexUvs.length;t<n;t++){const n=e.faceVertexUvs[t];void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]);for(let e=0,s=n.length;e<s;e++){const s=n[e],r=[];for(let e=0,t=s.length;e<t;e++)r.push(s[e].clone());this.faceVertexUvs[t].push(r)}}}mergeMesh(e){e&&e.isMesh?(e.matrixAutoUpdate&&e.updateMatrix(),this.merge(e.geometry,e.matrix)):console.error("THREE.Geometry.mergeMesh(): mesh not an instance of THREE.Mesh.",e)}mergeVertices(e=4){const t={},n=[],s=[],r=Math.pow(10,e);for(let e=0,o=this.vertices.length;e<o;e++){const o=this.vertices[e],i=Math.round(o.x*r)+"_"+Math.round(o.y*r)+"_"+Math.round(o.z*r);void 0===t[i]?(t[i]=e,n.push(this.vertices[e]),s[e]=n.length-1):s[e]=s[t[i]]}const o=[];for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e];t.a=s[t.a],t.b=s[t.b],t.c=s[t.c];const n=[t.a,t.b,t.c];for(let t=0;t<3;t++)if(n[t]===n[(t+1)%3]){o.push(e);break}}for(let e=o.length-1;e>=0;e--){const t=o[e];this.faces.splice(t,1);for(let e=0,n=this.faceVertexUvs.length;e<n;e++)this.faceVertexUvs[e].splice(t,1)}const i=this.vertices.length-n.length;return this.vertices=n,i}setFromPoints(e){this.vertices=[];for(let t=0,n=e.length;t<n;t++){const n=e[t];this.vertices.push(new s.Vector3(n.x,n.y,n.z||0))}return this}sortFacesByMaterialIndex(){const e=this.faces,t=e.length;for(let n=0;n<t;n++)e[n]._id=n;e.sort((function(e,t){return e.materialIndex-t.materialIndex}));const n=this.faceVertexUvs[0],s=this.faceVertexUvs[1];let r,o;n&&n.length===t&&(r=[]),s&&s.length===t&&(o=[]);for(let i=0;i<t;i++){const t=e[i]._id;r&&r.push(n[t]),o&&o.push(s[t])}r&&(this.faceVertexUvs[0]=r),o&&(this.faceVertexUvs[1]=o)}toJSON(){const e={metadata:{version:4.5,type:"Geometry",generator:"Geometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),void 0!==this.parameters){const t=this.parameters;for(const n in t)void 0!==t[n]&&(e[n]=t[n]);return e}const t=[];for(let e=0;e<this.vertices.length;e++){const n=this.vertices[e];t.push(n.x,n.y,n.z)}const n=[],s=[],r={},o=[],i={},a=[],l={};for(let e=0;e<this.faces.length;e++){const t=this.faces[e],s=!0,r=!1,o=void 0!==this.faceVertexUvs[0][e],i=t.normal.length()>0,a=t.vertexNormals.length>0,l=1!==t.color.r||1!==t.color.g||1!==t.color.b,p=t.vertexColors.length>0;let m=0;if(m=c(m,0,0),m=c(m,1,s),m=c(m,2,r),m=c(m,3,o),m=c(m,4,i),m=c(m,5,a),m=c(m,6,l),m=c(m,7,p),n.push(m),n.push(t.a,t.b,t.c),n.push(t.materialIndex),o){const t=this.faceVertexUvs[0][e];n.push(d(t[0]),d(t[1]),d(t[2]))}if(i&&n.push(h(t.normal)),a){const e=t.vertexNormals;n.push(h(e[0]),h(e[1]),h(e[2]))}if(l&&n.push(u(t.color)),p){const e=t.vertexColors;n.push(u(e[0]),u(e[1]),u(e[2]))}}function c(e,t,n){return n?e|1<<t:e&~(1<<t)}function h(e){const t=e.x.toString()+e.y.toString()+e.z.toString();return void 0!==r[t]||(r[t]=s.length/3,s.push(e.x,e.y,e.z)),r[t]}function u(e){const t=e.r.toString()+e.g.toString()+e.b.toString();return void 0!==i[t]||(i[t]=o.length,o.push(e.getHex())),i[t]}function d(e){const t=e.x.toString()+e.y.toString();return void 0!==l[t]||(l[t]=a.length/2,a.push(e.x,e.y)),l[t]}return e.data={},e.data.vertices=t,e.data.normals=s,o.length>0&&(e.data.colors=o),a.length>0&&(e.data.uvs=[a]),e.data.faces=n,e}clone(){return(new c).copy(this)}copy(e){this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.name=e.name;const t=e.vertices;for(let e=0,n=t.length;e<n;e++)this.vertices.push(t[e].clone());const n=e.colors;for(let e=0,t=n.length;e<t;e++)this.colors.push(n[e].clone());const s=e.faces;for(let e=0,t=s.length;e<t;e++)this.faces.push(s[e].clone());for(let t=0,n=e.faceVertexUvs.length;t<n;t++){const n=e.faceVertexUvs[t];void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]);for(let e=0,s=n.length;e<s;e++){const s=n[e],r=[];for(let e=0,t=s.length;e<t;e++){const t=s[e];r.push(t.clone())}this.faceVertexUvs[t].push(r)}}const r=e.morphTargets;for(let e=0,t=r.length;e<t;e++){const t={};if(t.name=r[e].name,void 0!==r[e].vertices){t.vertices=[];for(let n=0,s=r[e].vertices.length;n<s;n++)t.vertices.push(r[e].vertices[n].clone())}if(void 0!==r[e].normals){t.normals=[];for(let n=0,s=r[e].normals.length;n<s;n++)t.normals.push(r[e].normals[n].clone())}this.morphTargets.push(t)}const o=e.morphNormals;for(let e=0,t=o.length;e<t;e++){const t={};if(void 0!==o[e].vertexNormals){t.vertexNormals=[];for(let n=0,s=o[e].vertexNormals.length;n<s;n++){const s=o[e].vertexNormals[n],r={};r.a=s.a.clone(),r.b=s.b.clone(),r.c=s.c.clone(),t.vertexNormals.push(r)}}if(void 0!==o[e].faceNormals){t.faceNormals=[];for(let n=0,s=o[e].faceNormals.length;n<s;n++)t.faceNormals.push(o[e].faceNormals[n].clone())}this.morphNormals.push(t)}const i=e.skinWeights;for(let e=0,t=i.length;e<t;e++)this.skinWeights.push(i[e].clone());const a=e.skinIndices;for(let e=0,t=a.length;e<t;e++)this.skinIndices.push(a[e].clone());const l=e.lineDistances;for(let e=0,t=l.length;e<t;e++)this.lineDistances.push(l[e]);const c=e.boundingBox;null!==c&&(this.boundingBox=c.clone());const h=e.boundingSphere;return null!==h&&(this.boundingSphere=h.clone()),this.elementsNeedUpdate=e.elementsNeedUpdate,this.verticesNeedUpdate=e.verticesNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.lineDistancesNeedUpdate=e.lineDistancesNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this}toBufferGeometry(){const e=(new h).fromGeometry(this),t=new s.BufferGeometry,n=new Float32Array(3*e.vertices.length);if(t.setAttribute("position",new s.BufferAttribute(n,3).copyVector3sArray(e.vertices)),e.normals.length>0){const n=new Float32Array(3*e.normals.length);t.setAttribute("normal",new s.BufferAttribute(n,3).copyVector3sArray(e.normals))}if(e.colors.length>0){const n=new Float32Array(3*e.colors.length);t.setAttribute("color",new s.BufferAttribute(n,3).copyColorsArray(e.colors))}if(e.uvs.length>0){const n=new Float32Array(2*e.uvs.length);t.setAttribute("uv",new s.BufferAttribute(n,2).copyVector2sArray(e.uvs))}if(e.uvs2.length>0){const n=new Float32Array(2*e.uvs2.length);t.setAttribute("uv2",new s.BufferAttribute(n,2).copyVector2sArray(e.uvs2))}t.groups=e.groups;for(const n in e.morphTargets){const r=[],o=e.morphTargets[n];for(let e=0,t=o.length;e<t;e++){const t=o[e],n=new s.Float32BufferAttribute(3*t.data.length,3);n.name=t.name,r.push(n.copyVector3sArray(t.data))}t.morphAttributes[n]=r}if(e.skinIndices.length>0){const n=new s.Float32BufferAttribute(4*e.skinIndices.length,4);t.setAttribute("skinIndex",n.copyVector4sArray(e.skinIndices))}if(e.skinWeights.length>0){const n=new s.Float32BufferAttribute(4*e.skinWeights.length,4);t.setAttribute("skinWeight",n.copyVector4sArray(e.skinWeights))}return null!==e.boundingSphere&&(t.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(t.boundingBox=e.boundingBox.clone()),t}computeTangents(){console.error("THREE.Geometry: .computeTangents() has been removed.")}computeLineDistances(){console.error("THREE.Geometry: .computeLineDistances() has been removed. Use THREE.Line.computeLineDistances() instead.")}applyMatrix(e){return console.warn("THREE.Geometry: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(e)}dispose(){this.dispatchEvent({type:"dispose"})}static createBufferGeometryFromObject(e){let t=new s.BufferGeometry;const n=e.geometry;if(e.isPoints||e.isLine){const e=new s.Float32BufferAttribute(3*n.vertices.length,3),r=new s.Float32BufferAttribute(3*n.colors.length,3);if(t.setAttribute("position",e.copyVector3sArray(n.vertices)),t.setAttribute("color",r.copyColorsArray(n.colors)),n.lineDistances&&n.lineDistances.length===n.vertices.length){const e=new s.Float32BufferAttribute(n.lineDistances.length,1);t.setAttribute("lineDistance",e.copyArray(n.lineDistances))}null!==n.boundingSphere&&(t.boundingSphere=n.boundingSphere.clone()),null!==n.boundingBox&&(t.boundingBox=n.boundingBox.clone())}else e.isMesh&&(t=n.toBufferGeometry());return t}}c.prototype.isGeometry=!0;class h{constructor(){this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}computeGroups(e){const t=[];let n,s,r;const o=e.faces;for(s=0;s<o.length;s++){const e=o[s];e.materialIndex!==r&&(r=e.materialIndex,void 0!==n&&(n.count=3*s-n.start,t.push(n)),n={start:3*s,materialIndex:r})}void 0!==n&&(n.count=3*s-n.start,t.push(n)),this.groups=t}fromGeometry(e){const t=e.faces,n=e.vertices,r=e.faceVertexUvs,o=r[0]&&r[0].length>0,i=r[1]&&r[1].length>0,a=e.morphTargets,l=a.length;let c;if(l>0){c=[];for(let e=0;e<l;e++)c[e]={name:a[e].name,data:[]};this.morphTargets.position=c}const h=e.morphNormals,u=h.length;let d;if(u>0){d=[];for(let e=0;e<u;e++)d[e]={name:h[e].name,data:[]};this.morphTargets.normal=d}const p=e.skinIndices,m=e.skinWeights,f=p.length===n.length,g=m.length===n.length;n.length>0&&0===t.length&&console.error("THREE.DirectGeometry: Faceless geometries are not supported.");for(let e=0;e<t.length;e++){const v=t[e];this.vertices.push(n[v.a],n[v.b],n[v.c]);const y=v.vertexNormals;if(3===y.length)this.normals.push(y[0],y[1],y[2]);else{const e=v.normal;this.normals.push(e,e,e)}const x=v.vertexColors;if(3===x.length)this.colors.push(x[0],x[1],x[2]);else{const e=v.color;this.colors.push(e,e,e)}if(!0===o){const t=r[0][e];void 0!==t?this.uvs.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",e),this.uvs.push(new s.Vector2,new s.Vector2,new s.Vector2))}if(!0===i){const t=r[1][e];void 0!==t?this.uvs2.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",e),this.uvs2.push(new s.Vector2,new s.Vector2,new s.Vector2))}for(let e=0;e<l;e++){const t=a[e].vertices;c[e].data.push(t[v.a],t[v.b],t[v.c])}for(let t=0;t<u;t++){const n=h[t].vertexNormals[e];d[t].data.push(n.a,n.b,n.c)}f&&this.skinIndices.push(p[v.a],p[v.b],p[v.c]),g&&this.skinWeights.push(m[v.a],m[v.b],m[v.c])}return this.computeGroups(e),this.verticesNeedUpdate=e.verticesNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),this}}class u{constructor(e,t,n,r,o,i=0){this.a=e,this.b=t,this.c=n,this.normal=r&&r.isVector3?r:new s.Vector3,this.vertexNormals=Array.isArray(r)?r:[],this.color=o&&o.isColor?o:new s.Color,this.vertexColors=Array.isArray(o)?o:[],this.materialIndex=i}clone(){return(new this.constructor).copy(this)}copy(e){this.a=e.a,this.b=e.b,this.c=e.c,this.normal.copy(e.normal),this.color.copy(e.color),this.materialIndex=e.materialIndex;for(let t=0,n=e.vertexNormals.length;t<n;t++)this.vertexNormals[t]=e.vertexNormals[t].clone();for(let t=0,n=e.vertexColors.length;t<n;t++)this.vertexColors[t]=e.vertexColors[t].clone();return this}}class d{constructor(e,t,n,r,o,i=0){this.a=e,this.b=t,this.c=n,this.normal=r&&r.isVector3?r:new s.Vector3,this.vertexNormals=Array.isArray(r)?r:[],this.color=o&&o.isColor?o:new s.Color,this.vertexColors=Array.isArray(o)?o:[],this.materialIndex=i}clone(){return(new this.constructor).copy(this)}copy(e){this.a=e.a,this.b=e.b,this.c=e.c,this.normal.copy(e.normal),this.color.copy(e.color),this.materialIndex=e.materialIndex;for(let t=0,n=e.vertexNormals.length;t<n;t++)this.vertexNormals[t]=e.vertexNormals[t].clone();for(let t=0,n=e.vertexColors.length;t<n;t++)this.vertexColors[t]=e.vertexColors[t].clone();return this}}class p extends s.Loader{constructor(e){super(e),this.defaultDPI=90,this.defaultUnit="px"}load(e,t,n,r){const o=this,i=new s.FileLoader(o.manager);i.setPath(o.path),i.setRequestHeader(o.requestHeader),i.setWithCredentials(o.withCredentials),i.load(e,(function(n){try{t(o.parse(n))}catch(t){r?r(t):console.error(t),o.manager.itemError(e)}}),n,r)}parse(e){const t=this;function n(e,t,n,s,o,i,a,l){if(0==t||0==n)return void e.lineTo(l.x,l.y);s=s*Math.PI/180,t=Math.abs(t),n=Math.abs(n);const c=(a.x-l.x)/2,h=(a.y-l.y)/2,u=Math.cos(s)*c+Math.sin(s)*h,d=-Math.sin(s)*c+Math.cos(s)*h;let p=t*t,m=n*n;const f=u*u,g=d*d,v=f/p+g/m;if(v>1){const e=Math.sqrt(v);p=(t*=e)*t,m=(n*=e)*n}const y=p*g+m*f,x=(p*m-y)/y;let b=Math.sqrt(Math.max(0,x));o===i&&(b=-b);const w=b*t*d/n,A=-b*n*u/t,M=Math.cos(s)*w-Math.sin(s)*A+(a.x+l.x)/2,_=Math.sin(s)*w+Math.cos(s)*A+(a.y+l.y)/2,T=r(1,0,(u-w)/t,(d-A)/n),S=r((u-w)/t,(d-A)/n,(-u-w)/t,(-d-A)/n)%(2*Math.PI);e.currentPath.absellipse(M,_,t,n,T,T+S,0===i,s)}function r(e,t,n,s){const r=e*n+t*s,o=Math.sqrt(e*e+t*t)*Math.sqrt(n*n+s*s);let i=Math.acos(Math.max(-1,Math.min(1,r/o)));return e*s-t*n<0&&(i=-i),i}function o(e,t){t=Object.assign({},t);let n={};if(e.hasAttribute("class")){const t=e.getAttribute("class").split(/\s/).filter(Boolean).map((e=>e.trim()));for(let e=0;e<t.length;e++)n=Object.assign(n,m["."+t[e]])}function s(s,r,o){void 0===o&&(o=function(e){return e.startsWith("url")&&console.warn("SVGLoader: url access in attributes is not implemented."),e}),e.hasAttribute(s)&&(t[r]=o(e.getAttribute(s))),n[s]&&(t[r]=o(n[s])),e.style&&""!==e.style[s]&&(t[r]=o(e.style[s]))}function r(e){return Math.max(0,Math.min(1,h(e)))}function o(e){return Math.max(0,h(e))}return e.hasAttribute("id")&&(n=Object.assign(n,m["#"+e.getAttribute("id")])),s("fill","fill"),s("fill-opacity","fillOpacity",r),s("opacity","opacity",r),s("stroke","stroke"),s("stroke-opacity","strokeOpacity",r),s("stroke-width","strokeWidth",o),s("stroke-linejoin","strokeLineJoin"),s("stroke-linecap","strokeLineCap"),s("stroke-miterlimit","strokeMiterLimit",o),s("visibility","visibility"),t}function i(e,t){return e-(t-e)}function a(e,t,n){if("string"!=typeof e)throw new TypeError("Invalid input: "+typeof e);const s={SEPARATOR:/[ \t\r\n\,.\-+]/,WHITESPACE:/[ \t\r\n]/,DIGIT:/[\d]/,SIGN:/[-+]/,POINT:/\./,COMMA:/,/,EXP:/e/i,FLAGS:/[01]/};let r=0,o=!0,i="",a="";const l=[];function c(e,t,n){const s=new SyntaxError('Unexpected character "'+e+'" at index '+t+".");throw s.partial=n,s}function h(){""!==i&&(""===a?l.push(Number(i)):l.push(Number(i)*Math.pow(10,Number(a)))),i="",a=""}let u;const d=e.length;for(let p=0;p<d;p++)if(u=e[p],Array.isArray(t)&&t.includes(l.length%n)&&s.FLAGS.test(u))r=1,i=u,h();else{if(0===r){if(s.WHITESPACE.test(u))continue;if(s.DIGIT.test(u)||s.SIGN.test(u)){r=1,i=u;continue}if(s.POINT.test(u)){r=2,i=u;continue}s.COMMA.test(u)&&(o&&c(u,p,l),o=!0)}if(1===r){if(s.DIGIT.test(u)){i+=u;continue}if(s.POINT.test(u)){i+=u,r=2;continue}if(s.EXP.test(u)){r=3;continue}s.SIGN.test(u)&&1===i.length&&s.SIGN.test(i[0])&&c(u,p,l)}if(2===r){if(s.DIGIT.test(u)){i+=u;continue}if(s.EXP.test(u)){r=3;continue}s.POINT.test(u)&&"."===i[i.length-1]&&c(u,p,l)}if(3===r){if(s.DIGIT.test(u)){a+=u;continue}if(s.SIGN.test(u)){if(""===a){a+=u;continue}1===a.length&&s.SIGN.test(a)&&c(u,p,l)}}s.WHITESPACE.test(u)?(h(),r=0,o=!1):s.COMMA.test(u)?(h(),r=0,o=!0):s.SIGN.test(u)?(h(),r=1,i=u):s.POINT.test(u)?(h(),r=2,i=u):c(u,p,l)}return h(),l}const l=["mm","cm","in","pt","pc","px"],c={mm:{mm:1,cm:.1,in:1/25.4,pt:72/25.4,pc:6/25.4,px:-1},cm:{mm:10,cm:1,in:1/2.54,pt:72/2.54,pc:6/2.54,px:-1},in:{mm:25.4,cm:2.54,in:1,pt:72,pc:6,px:-1},pt:{mm:25.4/72,cm:2.54/72,in:1/72,pt:1,pc:6/72,px:-1},pc:{mm:25.4/6,cm:2.54/6,in:1/6,pt:12,pc:1,px:-1},px:{px:1}};function h(e){let n,s="px";if("string"==typeof e||e instanceof String)for(let t=0,n=l.length;t<n;t++){const n=l[t];if(e.endsWith(n)){s=n,e=e.substring(0,e.length-n.length);break}}return"px"===s&&"px"!==t.defaultUnit?n=c.in[t.defaultUnit]/t.defaultDPI:(n=c[s][t.defaultUnit],n<0&&(n=c[s].in*t.defaultDPI)),n*parseFloat(e)}function u(e){const t=e.elements;return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function d(e){const t=e.elements;return Math.sqrt(t[3]*t[3]+t[4]*t[4])}const p=[],m={},f=[],g=new s.Matrix3,v=new s.Matrix3,y=new s.Matrix3,x=new s.Matrix3,b=new s.Vector2,w=new s.Vector3,A=new s.Matrix3,M=(new DOMParser).parseFromString(e,"image/svg+xml");return function e(t,r){if(1!==t.nodeType)return;const l=function(e){if(!(e.hasAttribute("transform")||"use"===e.nodeName&&(e.hasAttribute("x")||e.hasAttribute("y"))))return null;const t=function(e){const t=new s.Matrix3,n=g;if("use"===e.nodeName&&(e.hasAttribute("x")||e.hasAttribute("y"))){const n=h(e.getAttribute("x")),s=h(e.getAttribute("y"));t.translate(n,s)}if(e.hasAttribute("transform")){const s=e.getAttribute("transform").split(")");for(let e=s.length-1;e>=0;e--){const r=s[e].trim();if(""===r)continue;const o=r.indexOf("("),i=r.length;if(o>0&&o<i){const e=r.substr(0,o),t=a(r.substr(o+1,i-o-1));switch(n.identity(),e){case"translate":if(t.length>=1){const e=t[0];let s=e;t.length>=2&&(s=t[1]),n.translate(e,s)}break;case"rotate":if(t.length>=1){let e=0,s=0,r=0;e=-t[0]*Math.PI/180,t.length>=3&&(s=t[1],r=t[2]),v.identity().translate(-s,-r),y.identity().rotate(e),x.multiplyMatrices(y,v),v.identity().translate(s,r),n.multiplyMatrices(v,x)}break;case"scale":if(t.length>=1){const e=t[0];let s=e;t.length>=2&&(s=t[1]),n.scale(e,s)}break;case"skewX":1===t.length&&n.set(1,Math.tan(t[0]*Math.PI/180),0,0,1,0,0,0,1);break;case"skewY":1===t.length&&n.set(1,0,0,Math.tan(t[0]*Math.PI/180),1,0,0,0,1);break;case"matrix":6===t.length&&n.set(t[0],t[2],t[4],t[1],t[3],t[5],0,0,1)}}t.premultiply(n)}}return t}(e);return f.length>0&&t.premultiply(f[f.length-1]),A.copy(t),f.push(t),t}(t);let c=!0,M=null;switch(t.nodeName){case"svg":break;case"style":!function(e){if(e.sheet&&e.sheet.cssRules&&e.sheet.cssRules.length)for(let t=0;t<e.sheet.cssRules.length;t++){const n=e.sheet.cssRules[t];if(1!==n.type)continue;const s=n.selectorText.split(/,/gm).filter(Boolean).map((e=>e.trim()));for(let e=0;e<s.length;e++)m[s[e]]=Object.assign(m[s[e]]||{},n.style)}}(t);break;case"g":r=o(t,r);break;case"path":r=o(t,r),t.hasAttribute("d")&&(M=function(e){const t=new s.ShapePath,r=new s.Vector2,o=new s.Vector2,l=new s.Vector2;let c=!0,h=!1;const u=e.getAttribute("d").match(/[a-df-z][^a-df-z]*/gi);for(let e=0,s=u.length;e<s;e++){const s=u[e],d=s.charAt(0),p=s.substr(1).trim();let m;switch(!0===c&&(h=!0,c=!1),d){case"M":m=a(p);for(let e=0,n=m.length;e<n;e+=2)r.x=m[e+0],r.y=m[e+1],o.x=r.x,o.y=r.y,0===e?t.moveTo(r.x,r.y):t.lineTo(r.x,r.y),0===e&&!0===h&&l.copy(r);break;case"H":m=a(p);for(let e=0,n=m.length;e<n;e++)r.x=m[e],o.x=r.x,o.y=r.y,t.lineTo(r.x,r.y),0===e&&!0===h&&l.copy(r);break;case"V":m=a(p);for(let e=0,n=m.length;e<n;e++)r.y=m[e],o.x=r.x,o.y=r.y,t.lineTo(r.x,r.y),0===e&&!0===h&&l.copy(r);break;case"L":m=a(p);for(let e=0,n=m.length;e<n;e+=2)r.x=m[e+0],r.y=m[e+1],o.x=r.x,o.y=r.y,t.lineTo(r.x,r.y),0===e&&!0===h&&l.copy(r);break;case"C":m=a(p);for(let e=0,n=m.length;e<n;e+=6)t.bezierCurveTo(m[e+0],m[e+1],m[e+2],m[e+3],m[e+4],m[e+5]),o.x=m[e+2],o.y=m[e+3],r.x=m[e+4],r.y=m[e+5],0===e&&!0===h&&l.copy(r);break;case"S":m=a(p);for(let e=0,n=m.length;e<n;e+=4)t.bezierCurveTo(i(r.x,o.x),i(r.y,o.y),m[e+0],m[e+1],m[e+2],m[e+3]),o.x=m[e+0],o.y=m[e+1],r.x=m[e+2],r.y=m[e+3],0===e&&!0===h&&l.copy(r);break;case"Q":m=a(p);for(let e=0,n=m.length;e<n;e+=4)t.quadraticCurveTo(m[e+0],m[e+1],m[e+2],m[e+3]),o.x=m[e+0],o.y=m[e+1],r.x=m[e+2],r.y=m[e+3],0===e&&!0===h&&l.copy(r);break;case"T":m=a(p);for(let e=0,n=m.length;e<n;e+=2){const n=i(r.x,o.x),s=i(r.y,o.y);t.quadraticCurveTo(n,s,m[e+0],m[e+1]),o.x=n,o.y=s,r.x=m[e+0],r.y=m[e+1],0===e&&!0===h&&l.copy(r)}break;case"A":m=a(p,[3,4],7);for(let e=0,s=m.length;e<s;e+=7){if(m[e+5]==r.x&&m[e+6]==r.y)continue;const s=r.clone();r.x=m[e+5],r.y=m[e+6],o.x=r.x,o.y=r.y,n(t,m[e],m[e+1],m[e+2],m[e+3],m[e+4],s,r),0===e&&!0===h&&l.copy(r)}break;case"m":m=a(p);for(let e=0,n=m.length;e<n;e+=2)r.x+=m[e+0],r.y+=m[e+1],o.x=r.x,o.y=r.y,0===e?t.moveTo(r.x,r.y):t.lineTo(r.x,r.y),0===e&&!0===h&&l.copy(r);break;case"h":m=a(p);for(let e=0,n=m.length;e<n;e++)r.x+=m[e],o.x=r.x,o.y=r.y,t.lineTo(r.x,r.y),0===e&&!0===h&&l.copy(r);break;case"v":m=a(p);for(let e=0,n=m.length;e<n;e++)r.y+=m[e],o.x=r.x,o.y=r.y,t.lineTo(r.x,r.y),0===e&&!0===h&&l.copy(r);break;case"l":m=a(p);for(let e=0,n=m.length;e<n;e+=2)r.x+=m[e+0],r.y+=m[e+1],o.x=r.x,o.y=r.y,t.lineTo(r.x,r.y),0===e&&!0===h&&l.copy(r);break;case"c":m=a(p);for(let e=0,n=m.length;e<n;e+=6)t.bezierCurveTo(r.x+m[e+0],r.y+m[e+1],r.x+m[e+2],r.y+m[e+3],r.x+m[e+4],r.y+m[e+5]),o.x=r.x+m[e+2],o.y=r.y+m[e+3],r.x+=m[e+4],r.y+=m[e+5],0===e&&!0===h&&l.copy(r);break;case"s":m=a(p);for(let e=0,n=m.length;e<n;e+=4)t.bezierCurveTo(i(r.x,o.x),i(r.y,o.y),r.x+m[e+0],r.y+m[e+1],r.x+m[e+2],r.y+m[e+3]),o.x=r.x+m[e+0],o.y=r.y+m[e+1],r.x+=m[e+2],r.y+=m[e+3],0===e&&!0===h&&l.copy(r);break;case"q":m=a(p);for(let e=0,n=m.length;e<n;e+=4)t.quadraticCurveTo(r.x+m[e+0],r.y+m[e+1],r.x+m[e+2],r.y+m[e+3]),o.x=r.x+m[e+0],o.y=r.y+m[e+1],r.x+=m[e+2],r.y+=m[e+3],0===e&&!0===h&&l.copy(r);break;case"t":m=a(p);for(let e=0,n=m.length;e<n;e+=2){const n=i(r.x,o.x),s=i(r.y,o.y);t.quadraticCurveTo(n,s,r.x+m[e+0],r.y+m[e+1]),o.x=n,o.y=s,r.x=r.x+m[e+0],r.y=r.y+m[e+1],0===e&&!0===h&&l.copy(r)}break;case"a":m=a(p,[3,4],7);for(let e=0,s=m.length;e<s;e+=7){if(0==m[e+5]&&0==m[e+6])continue;const s=r.clone();r.x+=m[e+5],r.y+=m[e+6],o.x=r.x,o.y=r.y,n(t,m[e],m[e+1],m[e+2],m[e+3],m[e+4],s,r),0===e&&!0===h&&l.copy(r)}break;case"Z":case"z":t.currentPath.autoClose=!0,t.currentPath.curves.length>0&&(r.copy(l),t.currentPath.currentPoint.copy(r),c=!0);break;default:console.warn(s)}h=!1}return t}(t));break;case"rect":r=o(t,r),M=function(e){const t=h(e.getAttribute("x")||0),n=h(e.getAttribute("y")||0),r=h(e.getAttribute("rx")||0),o=h(e.getAttribute("ry")||0),i=h(e.getAttribute("width")),a=h(e.getAttribute("height")),l=new s.ShapePath;return l.moveTo(t+2*r,n),l.lineTo(t+i-2*r,n),(0!==r||0!==o)&&l.bezierCurveTo(t+i,n,t+i,n,t+i,n+2*o),l.lineTo(t+i,n+a-2*o),(0!==r||0!==o)&&l.bezierCurveTo(t+i,n+a,t+i,n+a,t+i-2*r,n+a),l.lineTo(t+2*r,n+a),(0!==r||0!==o)&&l.bezierCurveTo(t,n+a,t,n+a,t,n+a-2*o),l.lineTo(t,n+2*o),(0!==r||0!==o)&&l.bezierCurveTo(t,n,t,n,t+2*r,n),l}(t);break;case"polygon":r=o(t,r),M=function(e){const t=new s.ShapePath;let n=0;return e.getAttribute("points").replace(/(-?[\d\.?]+)[,|\s](-?[\d\.?]+)/g,(function(e,s,r){const o=h(s),i=h(r);0===n?t.moveTo(o,i):t.lineTo(o,i),n++})),t.currentPath.autoClose=!0,t}(t);break;case"polyline":r=o(t,r),M=function(e){const t=new s.ShapePath;let n=0;return e.getAttribute("points").replace(/(-?[\d\.?]+)[,|\s](-?[\d\.?]+)/g,(function(e,s,r){const o=h(s),i=h(r);0===n?t.moveTo(o,i):t.lineTo(o,i),n++})),t.currentPath.autoClose=!1,t}(t);break;case"circle":r=o(t,r),M=function(e){const t=h(e.getAttribute("cx")||0),n=h(e.getAttribute("cy")||0),r=h(e.getAttribute("r")||0),o=new s.Path;o.absarc(t,n,r,0,2*Math.PI);const i=new s.ShapePath;return i.subPaths.push(o),i}(t);break;case"ellipse":r=o(t,r),M=function(e){const t=h(e.getAttribute("cx")||0),n=h(e.getAttribute("cy")||0),r=h(e.getAttribute("rx")||0),o=h(e.getAttribute("ry")||0),i=new s.Path;i.absellipse(t,n,r,o,0,2*Math.PI);const a=new s.ShapePath;return a.subPaths.push(i),a}(t);break;case"line":r=o(t,r),M=function(e){const t=h(e.getAttribute("x1")||0),n=h(e.getAttribute("y1")||0),r=h(e.getAttribute("x2")||0),o=h(e.getAttribute("y2")||0),i=new s.ShapePath;return i.moveTo(t,n),i.lineTo(r,o),i.currentPath.autoClose=!1,i}(t);break;case"defs":c=!1;break;case"use":r=o(t,r);const l=t.href.baseVal.substring(1),u=t.viewportElement.getElementById(l);u?e(u,r):console.warn("SVGLoader: 'use node' references non-existent node id: "+l)}if(M&&(void 0!==r.fill&&"none"!==r.fill&&M.color.setStyle(r.fill),function(e,t){function n(e){w.set(e.x,e.y,1).applyMatrix3(t),e.set(w.x,w.y)}const s=function(e){return 0!==e.elements[1]||0!==e.elements[3]}(t),r=e.subPaths;for(let e=0,o=r.length;e<o;e++){const o=r[e].curves;for(let e=0;e<o.length;e++){const r=o[e];r.isLineCurve?(n(r.v1),n(r.v2)):r.isCubicBezierCurve?(n(r.v0),n(r.v1),n(r.v2),n(r.v3)):r.isQuadraticBezierCurve?(n(r.v0),n(r.v1),n(r.v2)):r.isEllipseCurve&&(s&&console.warn("SVGLoader: Elliptic arc or ellipse rotation or skewing is not implemented."),b.set(r.aX,r.aY),n(b),r.aX=b.x,r.aY=b.y,r.xRadius*=u(t),r.yRadius*=d(t))}}}(M,A),p.push(M),M.userData={node:t,style:r}),c){const n=t.childNodes;for(let t=0;t<n.length;t++)e(n[t],r)}l&&(f.pop(),f.length>0?A.copy(f[f.length-1]):A.identity())}(M.documentElement,{fill:"#000",fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeLineJoin:"miter",strokeLineCap:"butt",strokeMiterLimit:4}),{paths:p,xml:M.documentElement}}static createShapes(e){const t=999999999,n={loc:0,t:0};function r(e,t,s,r){const i=e.x,a=t.x,l=s.x,c=r.x,h=e.y,u=t.y,d=s.y,p=r.y,m=(c-l)*(h-d)-(p-d)*(i-l),f=(p-d)*(a-i)-(c-l)*(u-h),g=m/f,v=((a-i)*(h-d)-(u-h)*(i-l))/f;if(0===f&&0!==m||g<=0||g>=1||v<0||v>1)return null;if(0===m&&0===f){for(let l=0;l<2;l++){if(o(0===l?s:r,e,t),0==n.loc){const e=0===l?s:r;return{x:e.x,y:e.y,t:n.t}}if(2==n.loc)return{x:+(i+n.t*(a-i)).toPrecision(10),y:+(h+n.t*(u-h)).toPrecision(10),t:n.t}}return null}for(let i=0;i<2;i++)if(o(0===i?s:r,e,t),0==n.loc){const e=0===i?s:r;return{x:e.x,y:e.y,t:n.t}}return{x:+(i+g*(a-i)).toPrecision(10),y:+(h+g*(u-h)).toPrecision(10),t:g}}function o(e,t,s){const r=s.x-t.x,o=s.y-t.y,i=e.x-t.x,a=e.y-t.y,l=r*a-i*o;if(e.x===t.x&&e.y===t.y)return n.loc=0,void(n.t=0);if(e.x===s.x&&e.y===s.y)return n.loc=1,void(n.t=1);if(l<-Number.EPSILON)return void(n.loc=3);if(l>Number.EPSILON)return void(n.loc=4);if(r*i<0||o*a<0)return void(n.loc=5);if(Math.sqrt(r*r+o*o)<Math.sqrt(i*i+a*a))return void(n.loc=6);let c;c=0!==r?i/r:a/o,n.loc=2,n.t=c}let i=0,a=t,l=-999999999,c=e.subPaths.map((e=>{const n=e.getPoints();let r=-999999999,o=t,c=-999999999,h=t;for(let e=0;e<n.length;e++){const t=n[e];t.y>r&&(r=t.y),t.y<o&&(o=t.y),t.x>c&&(c=t.x),t.x<h&&(h=t.x)}return l<=c&&(l=c+1),a>=h&&(a=h-1),{points:n,isCW:s.ShapeUtils.isClockWise(n),identifier:i++,boundingBox:new s.Box2(new s.Vector2(h,o),new s.Vector2(c,r))}}));c=c.filter((e=>e.points.length>1));const h=c.map((t=>function(e,t,n,o,i){null!=i&&""!==i||(i="nonzero");const a=new s.Vector2;e.boundingBox.getCenter(a);const l=function(e,t,n){const o=new s.Vector2;t.getCenter(o);const i=[];return n.forEach((t=>{t.boundingBox.containsPoint(o)&&function(e,t){const n=[],o=[];for(let i=1;i<e.length;i++){const a=e[i-1],l=e[i];for(let e=1;e<t.length;e++){const i=r(a,l,t[e-1],t[e]);null!==i&&void 0===n.find((e=>e.t<=i.t+Number.EPSILON&&e.t>=i.t-Number.EPSILON))&&(n.push(i),o.push(new s.Vector2(i.x,i.y)))}}return o}(e,t.points).forEach((e=>{i.push({identifier:t.identifier,isCW:t.isCW,point:e})}))})),i.sort(((e,t)=>e.point.x-t.point.x)),i}([new s.Vector2(n,a.y),new s.Vector2(o,a.y)],e.boundingBox,t);l.sort(((e,t)=>e.point.x-t.point.x));const c=[],h=[];l.forEach((t=>{t.identifier===e.identifier?c.push(t):h.push(t)}));const u=c[0].point.x,d=[];let p=0;for(;p<h.length&&h[p].point.x<u;)d.length>0&&d[d.length-1]===h[p].identifier?d.pop():d.push(h[p].identifier),p++;if(d.push(e.identifier),"evenodd"===i){const t=d.length%2==0,n=d[d.length-2];return{identifier:e.identifier,isHole:t,for:n}}if("nonzero"===i){let n=!0,s=null,r=null;for(let e=0;e<d.length;e++){const o=d[e];n?(r=t[o].isCW,n=!1,s=o):r!==t[o].isCW&&(r=t[o].isCW,n=!0)}return{identifier:e.identifier,isHole:n,for:s}}console.warn('fill-rule: "'+i+'" is currently not implemented.')}(t,c,a,l,e.userData.style.fillRule))),u=[];return c.forEach((e=>{if(!h[e.identifier].isHole){const t=new s.Shape(e.points);h.filter((t=>t.isHole&&t.for===e.identifier)).forEach((e=>{const n=c[e.identifier];t.holes.push(new s.Path(n.points))})),u.push(t)}})),u}static getStrokeStyle(e,t,n,s,r){return{strokeColor:t=void 0!==t?t:"#000",strokeWidth:e=void 0!==e?e:1,strokeLineJoin:n=void 0!==n?n:"miter",strokeLineCap:s=void 0!==s?s:"butt",strokeMiterLimit:r=void 0!==r?r:4}}static pointsToStroke(e,t,n,r){const o=[],i=[],a=[];if(0===p.pointsToStrokeWithBuffers(e,t,n,r,o,i,a))return null;const l=new s.BufferGeometry;return l.setAttribute("position",new s.Float32BufferAttribute(o,3)),l.setAttribute("normal",new s.Float32BufferAttribute(i,3)),l.setAttribute("uv",new s.Float32BufferAttribute(a,2)),l}static pointsToStrokeWithBuffers(e,t,n,r,o,i,a,l){const c=new s.Vector2,h=new s.Vector2,u=new s.Vector2,d=new s.Vector2,p=new s.Vector2,m=new s.Vector2,f=new s.Vector2,g=new s.Vector2,v=new s.Vector2,y=new s.Vector2,x=new s.Vector2,b=new s.Vector2,w=new s.Vector2,A=new s.Vector2,M=new s.Vector2,_=new s.Vector2,T=new s.Vector2;n=void 0!==n?n:12,r=void 0!==r?r:.001,l=void 0!==l?l:0;const S=(e=function(e){let t=!1;for(let n=1,s=e.length-1;n<s;n++)if(e[n].distanceTo(e[n+1])<r){t=!0;break}if(!t)return e;const n=[];n.push(e[0]);for(let t=1,s=e.length-1;t<s;t++)e[t].distanceTo(e[t+1])>=r&&n.push(e[t]);return n.push(e[e.length-1]),n}(e)).length;if(S<2)return 0;const E=e[0].equals(e[S-1]);let P,C,R=e[0];const L=t.strokeWidth/2,V=1/(S-1);let k,I,O,N,B=0,D=!1,F=0,U=3*l,z=2*l;j(e[0],e[1],c).multiplyScalar(L),g.copy(e[0]).sub(c),v.copy(e[0]).add(c),y.copy(g),x.copy(v);for(let n=1;n<S;n++){P=e[n],C=n===S-1?E?e[1]:void 0:e[n+1];const s=c;if(j(R,P,s),u.copy(s).multiplyScalar(L),b.copy(P).sub(u),w.copy(P).add(u),k=B+V,I=!1,void 0!==C){j(P,C,h),u.copy(h).multiplyScalar(L),A.copy(P).sub(u),M.copy(P).add(u),O=!0,u.subVectors(C,R),s.dot(u)<0&&(O=!1),1===n&&(D=O),u.subVectors(C,P),u.normalize();const e=Math.abs(s.dot(u));if(0!==e){const n=L/e;u.multiplyScalar(-n),d.subVectors(P,R),p.copy(d).setLength(n).add(u),_.copy(p).negate();const s=p.length(),r=d.length();d.divideScalar(r),m.subVectors(C,P);const o=m.length();switch(m.divideScalar(o),d.dot(_)<r&&m.dot(_)<o&&(I=!0),T.copy(p).add(P),_.add(P),N=!1,I?O?(M.copy(_),w.copy(_)):(A.copy(_),b.copy(_)):W(),t.strokeLineJoin){case"bevel":X(O,I,k);break;case"round":q(O,I),O?G(P,b,A,k,0):G(P,M,w,k,1);break;case"miter":case"miter-clip":default:const e=L*t.strokeMiterLimit/s;if(e<1){if("miter-clip"!==t.strokeLineJoin){X(O,I,k);break}q(O,I),O?(m.subVectors(T,b).multiplyScalar(e).add(b),f.subVectors(T,A).multiplyScalar(e).add(A),H(b,k,0),H(m,k,0),H(P,k,.5),H(P,k,.5),H(m,k,0),H(f,k,0),H(P,k,.5),H(f,k,0),H(A,k,0)):(m.subVectors(T,w).multiplyScalar(e).add(w),f.subVectors(T,M).multiplyScalar(e).add(M),H(w,k,1),H(m,k,1),H(P,k,.5),H(P,k,.5),H(m,k,1),H(f,k,1),H(P,k,.5),H(f,k,1),H(M,k,1))}else I?(O?(H(v,B,1),H(g,B,0),H(T,k,0),H(v,B,1),H(T,k,0),H(_,k,1)):(H(v,B,1),H(g,B,0),H(T,k,1),H(g,B,0),H(_,k,0),H(T,k,1)),O?A.copy(T):M.copy(T)):O?(H(b,k,0),H(T,k,0),H(P,k,.5),H(P,k,.5),H(T,k,0),H(A,k,0)):(H(w,k,1),H(T,k,1),H(P,k,.5),H(P,k,.5),H(T,k,1),H(M,k,1)),N=!0}}else W()}else W();E||n!==S-1||K(e[0],y,x,O,!0,B),B=k,R=P,g.copy(A),v.copy(M)}if(E){if(I&&o){let e=T,t=_;D!==O&&(e=_,t=T),O?(N||D)&&(t.toArray(o,0),t.toArray(o,9),N&&e.toArray(o,3)):!N&&D||(t.toArray(o,3),t.toArray(o,9),N&&e.toArray(o,0))}}else K(P,b,w,O,!1,k);return F;function j(e,t,n){return n.subVectors(t,e),n.set(-n.y,n.x).normalize()}function H(e,t,n){o&&(o[U]=e.x,o[U+1]=e.y,o[U+2]=0,i&&(i[U]=0,i[U+1]=0,i[U+2]=1),U+=3,a&&(a[z]=t,a[z+1]=n,z+=2)),F+=3}function G(e,t,s,r,o){c.copy(t).sub(e).normalize(),h.copy(s).sub(e).normalize();let i=Math.PI;const a=c.dot(h);Math.abs(a)<1&&(i=Math.abs(Math.acos(a))),i/=n,u.copy(t);for(let t=0,s=n-1;t<s;t++)d.copy(u).rotateAround(e,i),H(u,r,o),H(d,r,o),H(e,r,.5),u.copy(d);H(d,r,o),H(s,r,o),H(e,r,.5)}function W(){H(v,B,1),H(g,B,0),H(b,k,0),H(v,B,1),H(b,k,1),H(w,k,0)}function X(e,t,n){t?e?(H(v,B,1),H(g,B,0),H(b,k,0),H(v,B,1),H(b,k,0),H(_,k,1),H(b,n,0),H(A,n,0),H(_,n,.5)):(H(v,B,1),H(g,B,0),H(w,k,1),H(g,B,0),H(_,k,0),H(w,k,1),H(w,n,1),H(M,n,0),H(_,n,.5)):e?(H(b,n,0),H(A,n,0),H(P,n,.5)):(H(w,n,1),H(M,n,0),H(P,n,.5))}function q(e,t){t&&(e?(H(v,B,1),H(g,B,0),H(b,k,0),H(v,B,1),H(b,k,0),H(_,k,1),H(b,B,0),H(P,k,.5),H(_,k,1),H(P,k,.5),H(A,B,0),H(_,k,1)):(H(v,B,1),H(g,B,0),H(w,k,1),H(g,B,0),H(_,k,0),H(w,k,1),H(w,B,1),H(_,k,0),H(P,k,.5),H(P,k,.5),H(_,k,0),H(M,B,1)))}function K(e,n,s,r,i,a){switch(t.strokeLineCap){case"round":i?G(e,s,n,a,.5):G(e,n,s,a,.5);break;case"square":if(i)c.subVectors(n,e),h.set(c.y,-c.x),u.addVectors(c,h).add(e),d.subVectors(h,c).add(e),r?(u.toArray(o,3),d.toArray(o,0),d.toArray(o,9)):(u.toArray(o,3),u.toArray(o,9),d.toArray(o,0));else{c.subVectors(s,e),h.set(c.y,-c.x),u.addVectors(c,h).add(e),d.subVectors(h,c).add(e);const t=o.length;r?(u.toArray(o,t-3),d.toArray(o,t-6),d.toArray(o,t-12)):(u.toArray(o,t-6),d.toArray(o,t-3),d.toArray(o,t-12))}}}}}class m{constructor(){this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}computeGroups(e){const t=[];let n,s,r;const o=e.faces;for(s=0;s<o.length;s++){const e=o[s];e.materialIndex!==r&&(r=e.materialIndex,void 0!==n&&(n.count=3*s-n.start,t.push(n)),n={start:3*s,materialIndex:r})}void 0!==n&&(n.count=3*s-n.start,t.push(n)),this.groups=t}fromGeometry(e){const t=e.faces,n=e.vertices,r=e.faceVertexUvs,o=r[0]&&r[0].length>0,i=r[1]&&r[1].length>0,a=e.morphTargets,l=a.length;let c;if(l>0){c=[];for(let e=0;e<l;e++)c[e]={name:a[e].name,data:[]};this.morphTargets.position=c}const h=e.morphNormals,u=h.length;let d;if(u>0){d=[];for(let e=0;e<u;e++)d[e]={name:h[e].name,data:[]};this.morphTargets.normal=d}const p=e.skinIndices,m=e.skinWeights,f=p.length===n.length,g=m.length===n.length;n.length>0&&0===t.length&&console.error("THREE.DirectGeometry: Faceless geometries are not supported.");for(let e=0;e<t.length;e++){const v=t[e];this.vertices.push(n[v.a],n[v.b],n[v.c]);const y=v.vertexNormals;if(3===y.length)this.normals.push(y[0],y[1],y[2]);else{const e=v.normal;this.normals.push(e,e,e)}const x=v.vertexColors;if(3===x.length)this.colors.push(x[0],x[1],x[2]);else{const e=v.color;this.colors.push(e,e,e)}if(!0===o){const t=r[0][e];void 0!==t?this.uvs.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",e),this.uvs.push(new s.Vector2,new s.Vector2,new s.Vector2))}if(!0===i){const t=r[1][e];void 0!==t?this.uvs2.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",e),this.uvs2.push(new s.Vector2,new s.Vector2,new s.Vector2))}for(let e=0;e<l;e++){const t=a[e].vertices;c[e].data.push(t[v.a],t[v.b],t[v.c])}for(let t=0;t<u;t++){const n=h[t].vertexNormals[e];d[t].data.push(n.a,n.b,n.c)}f&&this.skinIndices.push(p[v.a],p[v.b],p[v.c]),g&&this.skinWeights.push(m[v.a],m[v.b],m[v.c])}return this.computeGroups(e),this.verticesNeedUpdate=e.verticesNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),this}}const f=(e,t)=>{const n=(new m).fromGeometry(t);return g(e,n)},g=(e,t)=>{var n,r;const o=new Float32Array(3*t.vertices.length);if(e.setAttribute("position",new s.BufferAttribute(o,3).copyVector3sArray(t.vertices)),t.normals.length>0){const n=new Float32Array(3*t.normals.length);e.setAttribute("normal",new s.BufferAttribute(n,3).copyVector3sArray(t.normals))}if(t.colors.length>0){const n=new Float32Array(3*t.colors.length);e.setAttribute("color",new s.BufferAttribute(n,3).copyColorsArray(t.colors))}if(t.uvs.length>0){const n=new Float32Array(2*t.uvs.length);e.setAttribute("uv",new s.BufferAttribute(n,2).copyVector2sArray(t.uvs))}if(t.uvs2.length>0){const n=new Float32Array(2*t.uvs2.length);e.setAttribute("uv2",new s.BufferAttribute(n,2).copyVector2sArray(t.uvs2))}e.groups=t.groups;for(const n in t.morphTargets){const r=[],o=t.morphTargets[n];for(let e=0,t=o.length;e<t;e++){const t=o[e],n=new s.Float32BufferAttribute(3*t.data.length,3);n.name=t.name,r.push(n.copyVector3sArray(t.data))}e.morphAttributes[n]=r}if(t.skinIndices.length>0){const n=new s.Float32BufferAttribute(4*t.skinIndices.length,4);e.setAttribute("skinIndex",n.copyVector4sArray(t.skinIndices))}if(t.skinWeights.length>0){const n=new s.Float32BufferAttribute(4*t.skinWeights.length,4);e.setAttribute("skinWeight",n.copyVector4sArray(t.skinWeights))}return null!==t.boundingSphere&&(e.boundingSphere=null===(n=t.boundingSphere)||void 0===n?void 0:n.clone()),null!==t.boundingBox&&(e.boundingBox=null===(r=t.boundingBox)||void 0===r?void 0:r.clone()),e};class v{constructor(e,t){this.camera=e,this.renderer=t}static geometryToBufferGeometry(e){return e.isGeometry?f(new s.BufferGeometry,e):e}static bufferGeometryToGeometry(e){return e.isBufferGeometry?(new c).fromBufferGeometry(e):e}fromSVGtoShape(e,t=!1,n){if(e){const s=new p,r=[];return s.parse(e).paths.forEach((e=>{e.toShapes(t,n).forEach((e=>{r.push(e)}))})),r}return[]}from3dto2d(e){const t=new s.Vector3(e.x,e.y,e.z),n=this.renderer.domElement;this.camera.updateMatrixWorld(),t.project(this.camera);const r=Math.round((t.x+1)*(n.width/2)),o=Math.round((1-t.y)*(n.height/2));return new s.Vector2(r,o)}from2dto3d(e,t,n){var r;if(!this.tmpPlane){const e=new s.PlaneBufferGeometry(1e4,1e4),t=new s.MeshBasicMaterial({transparent:!0,opacity:.25});this.tmpPlane=new s.Mesh(e,t),this.tmpPlane.name="_tmp_raycast_plane"}let o;this.tmpRaycaster||(this.tmpRaycaster=new s.Raycaster),this.tmpVector3||(this.tmpVector3=new s.Vector3),this.tmpPlane.setRotationFromEuler(this.camera.rotation);const i=this.camera.position;this.tmpPlane.position.set(i.x,i.y,i.z),this.camera.getWorldDirection(this.tmpVector3),this.tmpPlane.position.add(this.tmpVector3.clone().multiplyScalar(n)),this.tmpPlane.updateMatrix(),this.tmpPlane.updateMatrixWorld(!0),this.tmpRaycaster.setFromCamera({x:e,y:t},this.camera);const a=this.tmpRaycaster.intersectObjects([this.tmpPlane]);return"_tmp_raycast_plane"===(null===(r=a[0])||void 0===r?void 0:r.object.name)&&(o=a[0].point),o}}class y{static toGeometry(e,t){e.geometry=v.bufferGeometryToGeometry(e.geometry),t.geometry=v.bufferGeometryToGeometry(t.geometry)}static toBufferGeometry(e){e.geometry=v.geometryToBufferGeometry(e.geometry)}static union(e,t){this.toGeometry(e,t);const n=this.doCSG(e,t,"union");return this.toBufferGeometry(n),n}static subtract(e,t){this.toGeometry(e,t);const n=this.doCSG(e,t,"subtract");return this.toBufferGeometry(n),n}static intersect(e,t){this.toGeometry(e,t);const n=this.doCSG(e,t,"intersect");return this.toBufferGeometry(n),n}static doCSG(e,t,n){e.updateMatrix(),t.updateMatrix();const s=x.fromMesh(e),r=x.fromMesh(t),o=s[n](r);return x.toMesh(o,e.matrix)}}class x{constructor(){this.polygons=[]}static fromPolygons(e){const t=new x;return t.polygons=e,t}static fromGeometry(e){e.isBufferGeometry&&(e=(new c).fromBufferGeometry(e));const t=e.faces,n=e.vertices,s=[],r=["a","b","c"];for(let o=0;o<t.length;o++){const i=t[o],a=[];for(let t=0;t<3;t++){const s=void 0!==e.faceVertexUvs[0][o]&&void 0!==e.faceVertexUvs[0][o][t]?e.faceVertexUvs[0][o][t]:void 0;a.push(new w(n[i[r[t]]],i.vertexNormals[t],s))}s.push(new M(a))}return x.fromPolygons(s)}static fromMesh(e){const t=x.fromGeometry(e.geometry);x._tmpm3.getNormalMatrix(e.matrix);for(const n of t.polygons)for(const t of n.vertices)t.pos.applyMatrix4(e.matrix),t.normal.applyMatrix3(x._tmpm3);return t}static toMesh(e,t){const n=new c,r=e.polygons,o=n.vertices,i=n.faceVertexUvs[0];for(const e of r){const t=e.vertices,r=o.length,a=t.length;for(const e of t)o.push((new s.Vector3).copy(e.pos));for(let o=3;o<=a;o++){const a=new d(r,r+o-2,r+o-1),l=[];i.push(l);const c=a.vertexNormals;c.push((new s.Vector3).copy(t[0].normal)),c.push((new s.Vector3).copy(t[o-2].normal)),c.push((new s.Vector3).copy(t[o-1].normal)),t[0].uv&&t[o-2].uv&&t[o-1].uv&&(l.push((new s.Vector3).copy(t[0].uv)),l.push((new s.Vector3).copy(t[o-2].uv)),l.push((new s.Vector3).copy(t[o-1].uv))),a.normal=(new s.Vector3).copy(e.plane.normal),n.faces.push(a)}}const a=parseInt(s.REVISION)>=123?(new s.Matrix4).copy(t).invert():(new s.Matrix4).getInverse(t);n.applyMatrix4(a),n.verticesNeedUpdate=n.elementsNeedUpdate=n.normalsNeedUpdate=!0,n.computeBoundingSphere(),n.computeBoundingBox();const l=new s.Mesh(n);return l.matrix.copy(t),l.matrix.decompose(l.position,l.rotation,l.scale),l.updateMatrixWorld(),l}static iEval(e,t=0){var n;if("string"==typeof e)x.currentOp=e;else if(e instanceof Array)for(const t of e)x.iEval(t,0);else if("object"==typeof e){const t=x.currentOp;e.updateMatrix(),e.updateMatrixWorld(),x.sourceMesh?(x.nextPrim=x.fromMesh(e),x.currentPrim=x.currentPrim[t](x.nextPrim)):x.currentPrim=x.fromMesh(x.sourceMesh=e),x.doRemove&&(null===(n=null==e?void 0:e.parent)||void 0===n||n.remove(e))}}static eval(e,t){delete x.currentOp,delete x.sourceMesh,x.doRemove=t,x.iEval(e);const n=x.toMesh(x.currentPrim,x.sourceMesh.matrix);return n.material=x.sourceMesh.material,n.castShadow=n.receiveShadow=!0,n}clone(){const e=new x;return e.polygons=this.polygons.map((e=>e.clone())),e}toPolygons(){return this.polygons}union(e){const t=new _(this.clone().polygons),n=new _(e.clone().polygons);return t.clipTo(n),n.clipTo(t),n.invert(),n.clipTo(t),n.invert(),t.build(n.allPolygons()),x.fromPolygons(t.allPolygons())}subtract(e){const t=new _(this.clone().polygons),n=new _(e.clone().polygons);return t.invert(),t.clipTo(n),n.clipTo(t),n.invert(),n.clipTo(t),n.invert(),t.build(n.allPolygons()),t.invert(),x.fromPolygons(t.allPolygons())}intersect(e){const t=new _(this.clone().polygons),n=new _(e.clone().polygons);return t.invert(),n.clipTo(t),n.invert(),t.clipTo(n),n.clipTo(t),t.build(n.allPolygons()),t.invert(),x.fromPolygons(t.allPolygons())}inverse(){const e=this.clone();return e.polygons.map((e=>{e.flip()})),e}}x._tmpm3=new s.Matrix3;class b extends s.Vector3{constructor(e,t,n){if(3===arguments.length)super(e,t,n);else if(Array.isArray(e))super(e[0],e[1],e[2]);else{if("object"!=typeof e)throw new Error("Invalid constructor to vector");this.copy(e)}}clone(){return new b(this.x,this.y,this.z)}negated(){return this.clone().multiplyScalar(-1)}plus(e){return this.clone().add(e)}minus(e){return this.clone().sub(e)}times(e){return this.clone().multiplyScalar(e)}dividedBy(e){return this.clone().divideScalar(e)}lerp(e,t){return this.plus(e.minus(this).times(t))}unit(){return this.dividedBy(this.length())}cross(e,t){return s.Vector3.prototype.cross.call(this.clone(),e)}}class w{constructor(e,t,n){this.pos=new b(e.x,e.y,e.z),this.normal=new b(t.x,t.y,t.z),n&&(this.uv=new b(n.x,n.y,n.z))}clone(){return new w(this.pos.clone(),this.normal.clone(),this.uv?this.uv.clone():void 0)}flip(){this.normal=this.normal.negated()}interpolate(e,t){return new w(this.pos.lerp(e.pos,t),this.normal.lerp(e.normal,t),this.uv?this.uv.lerp(e.uv,t):void 0)}}class A{constructor(e,t){this.normal=e,this.w=t}static fromPoints(e,t,n){const s=t.minus(e).cross(n.minus(e)).unit();return new A(s,s.dot(e))}clone(){return new A(this.normal.clone(),this.w)}flip(){this.normal=this.normal.negated(),this.w=-this.w}splitPolygon(e,t,n,s,r){let o=0;const i=[];for(const t of e.vertices){const e=this.normal.dot(t.pos)-this.w,n=e<-A.EPSILON?2:e>A.EPSILON?1:0;o|=n,i.push(n)}switch(o){case 0:this.normal.dot(e.plane.normal)>0?t.push(e):n.push(e);break;case 1:s.push(e);break;case 2:r.push(e);break;case 3:const o=[],a=[];for(let t=0;t<e.vertices.length;t++){const n=(t+1)%e.vertices.length,s=i[t],r=i[n],l=e.vertices[t],c=e.vertices[n];if(2!==s&&o.push(l),1!==s&&a.push(2!==s?l.clone():l),3==(s|r)){const e=(this.w-this.normal.dot(l.pos))/this.normal.dot(c.pos.minus(l.pos)),t=l.interpolate(c,e);o.push(t),a.push(t.clone())}}o.length>=3&&s.push(new M(o,e.shared)),a.length>=3&&r.push(new M(a,e.shared))}}}A.EPSILON=1e-5;class M{constructor(e,t=null){this.vertices=e,this.shared=t,this.plane=A.fromPoints(e[0].pos,e[1].pos,e[2].pos)}clone(){const e=this.vertices.map((e=>e.clone()));return new M(e,this.shared)}flip(){this.vertices.reverse().map((e=>{e.flip()})),this.plane.flip()}}class _{constructor(e){delete this.plane,delete this.front,delete this.back,this.polygons=[],e&&this.build(e)}clone(){const e=new _;return e.plane=this.plane&&this.plane.clone(),e.front=this.front&&this.front.clone(),e.back=this.back&&this.back.clone(),e.polygons=this.polygons.map((e=>e.clone())),e}invert(){for(const e of this.polygons)e.flip();this.plane.flip(),this.front&&this.front.invert(),this.back&&this.back.invert();const e=this.front;this.front=this.back,this.back=e}clipPolygons(e){if(!this.plane)return e.slice();let t=[],n=[];for(const s of e)this.plane.splitPolygon(s,t,n,t,n);return this.front&&(t=this.front.clipPolygons(t)),n=this.back?this.back.clipPolygons(n):[],t.concat(n)}clipTo(e){this.polygons=e.clipPolygons(this.polygons),this.front&&this.front.clipTo(e),this.back&&this.back.clipTo(e)}allPolygons(){let e=this.polygons.slice();return this.front&&(e=e.concat(this.front.allPolygons())),this.back&&(e=e.concat(this.back.allPolygons())),e}build(e){if(!e.length)return;this.plane||(this.plane=e[0].plane.clone());const t=[],n=[];for(const s of e)this.plane.splitPolygon(s,this.polygons,this.polygons,t,n);t.length&&(this.front||(this.front=new _),this.front.build(t)),n.length&&(this.back||(this.back=new _),this.back.build(n))}}var T={},S=function(e){return URL.createObjectURL(new Blob([e],{type:"text/javascript"}))},E=function(e){return new Worker(e)};try{URL.revokeObjectURL(S(""))}catch(e){S=function(e){return"data:application/javascript;charset=UTF-8,"+encodeURI(e)},E=function(e){return new Worker(e,{type:"module"})}}var P=Uint8Array,C=Uint16Array,R=Uint32Array,L=new P([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),V=new P([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),k=new P([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),I=function(e,t){for(var n=new C(31),s=0;s<31;++s)n[s]=t+=1<<e[s-1];var r=new R(n[30]);for(s=1;s<30;++s)for(var o=n[s];o<n[s+1];++o)r[o]=o-n[s]<<5|s;return[n,r]},O=I(L,2),N=O[0],B=O[1];N[28]=258,B[258]=28;for(var D=I(V,0),F=D[0],U=D[1],z=new C(32768),j=0;j<32768;++j){var H=(43690&j)>>>1|(21845&j)<<1;H=(61680&(H=(52428&H)>>>2|(13107&H)<<2))>>>4|(3855&H)<<4,z[j]=((65280&H)>>>8|(255&H)<<8)>>>1}var G=function(e,t,n){for(var s=e.length,r=0,o=new C(t);r<s;++r)++o[e[r]-1];var i,a=new C(t);for(r=0;r<t;++r)a[r]=a[r-1]+o[r-1]<<1;if(n){i=new C(1<<t);var l=15-t;for(r=0;r<s;++r)if(e[r])for(var c=r<<4|e[r],h=t-e[r],u=a[e[r]-1]++<<h,d=u|(1<<h)-1;u<=d;++u)i[z[u]>>>l]=c}else for(i=new C(s),r=0;r<s;++r)e[r]&&(i[r]=z[a[e[r]-1]++]>>>15-e[r]);return i},W=new P(288);for(j=0;j<144;++j)W[j]=8;for(j=144;j<256;++j)W[j]=9;for(j=256;j<280;++j)W[j]=7;for(j=280;j<288;++j)W[j]=8;var X=new P(32);for(j=0;j<32;++j)X[j]=5;var q=G(W,9,0),K=G(W,9,1),Y=G(X,5,0),$=G(X,5,1),Q=function(e){for(var t=e[0],n=1;n<e.length;++n)e[n]>t&&(t=e[n]);return t},Z=function(e,t,n){var s=t/8|0;return(e[s]|e[s+1]<<8)>>(7&t)&n},J=function(e,t){var n=t/8|0;return(e[n]|e[n+1]<<8|e[n+2]<<16)>>(7&t)},ee=function(e){return(e/8|0)+(7&e&&1)},te=function(e,t,n){(null==t||t<0)&&(t=0),(null==n||n>e.length)&&(n=e.length);var s=new(e instanceof C?C:e instanceof R?R:P)(n-t);return s.set(e.subarray(t,n)),s},ne=function(e,t,n){var s=e.length;if(!s||n&&!n.l&&s<5)return t||new P(0);var r=!t||n,o=!n||n.i;n||(n={}),t||(t=new P(3*s));var i=function(e){var n=t.length;if(e>n){var s=new P(Math.max(2*n,e));s.set(t),t=s}},a=n.f||0,l=n.p||0,c=n.b||0,h=n.l,u=n.d,d=n.m,p=n.n,m=8*s;do{if(!h){n.f=a=Z(e,l,1);var f=Z(e,l+1,3);if(l+=3,!f){var g=e[(E=ee(l)+4)-4]|e[E-3]<<8,v=E+g;if(v>s){if(o)throw"unexpected EOF";break}r&&i(c+g),t.set(e.subarray(E,v),c),n.b=c+=g,n.p=l=8*v;continue}if(1==f)h=K,u=$,d=9,p=5;else{if(2!=f)throw"invalid block type";var y=Z(e,l,31)+257,x=Z(e,l+10,15)+4,b=y+Z(e,l+5,31)+1;l+=14;for(var w=new P(b),A=new P(19),M=0;M<x;++M)A[k[M]]=Z(e,l+3*M,7);l+=3*x;var _=Q(A),T=(1<<_)-1,S=G(A,_,1);for(M=0;M<b;){var E,C=S[Z(e,l,T)];if(l+=15&C,(E=C>>>4)<16)w[M++]=E;else{var R=0,I=0;for(16==E?(I=3+Z(e,l,3),l+=2,R=w[M-1]):17==E?(I=3+Z(e,l,7),l+=3):18==E&&(I=11+Z(e,l,127),l+=7);I--;)w[M++]=R}}var O=w.subarray(0,y),B=w.subarray(y);d=Q(O),p=Q(B),h=G(O,d,1),u=G(B,p,1)}if(l>m){if(o)throw"unexpected EOF";break}}r&&i(c+131072);for(var D=(1<<d)-1,U=(1<<p)-1,z=l;;z=l){var j=(R=h[J(e,l)&D])>>>4;if((l+=15&R)>m){if(o)throw"unexpected EOF";break}if(!R)throw"invalid length/literal";if(j<256)t[c++]=j;else{if(256==j){z=l,h=null;break}var H=j-254;if(j>264){var W=L[M=j-257];H=Z(e,l,(1<<W)-1)+N[M],l+=W}var X=u[J(e,l)&U],q=X>>>4;if(!X)throw"invalid distance";if(l+=15&X,B=F[q],q>3&&(W=V[q],B+=J(e,l)&(1<<W)-1,l+=W),l>m){if(o)throw"unexpected EOF";break}r&&i(c+131072);for(var Y=c+H;c<Y;c+=4)t[c]=t[c-B],t[c+1]=t[c+1-B],t[c+2]=t[c+2-B],t[c+3]=t[c+3-B];c=Y}}n.l=h,n.p=z,n.b=c,h&&(a=1,n.m=d,n.d=u,n.n=p)}while(!a);return c==t.length?t:te(t,0,c)},se=function(e,t,n){n<<=7&t;var s=t/8|0;e[s]|=n,e[s+1]|=n>>>8},re=function(e,t,n){n<<=7&t;var s=t/8|0;e[s]|=n,e[s+1]|=n>>>8,e[s+2]|=n>>>16},oe=function(e,t){for(var n=[],s=0;s<e.length;++s)e[s]&&n.push({s,f:e[s]});var r=n.length,o=n.slice();if(!r)return[de,0];if(1==r){var i=new P(n[0].s+1);return i[n[0].s]=1,[i,1]}n.sort((function(e,t){return e.f-t.f})),n.push({s:-1,f:25001});var a=n[0],l=n[1],c=0,h=1,u=2;for(n[0]={s:-1,f:a.f+l.f,l:a,r:l};h!=r-1;)a=n[n[c].f<n[u].f?c++:u++],l=n[c!=h&&n[c].f<n[u].f?c++:u++],n[h++]={s:-1,f:a.f+l.f,l:a,r:l};var d=o[0].s;for(s=1;s<r;++s)o[s].s>d&&(d=o[s].s);var p=new C(d+1),m=ie(n[h-1],p,0);if(m>t){s=0;var f=0,g=m-t,v=1<<g;for(o.sort((function(e,t){return p[t.s]-p[e.s]||e.f-t.f}));s<r;++s){var y=o[s].s;if(!(p[y]>t))break;f+=v-(1<<m-p[y]),p[y]=t}for(f>>>=g;f>0;){var x=o[s].s;p[x]<t?f-=1<<t-p[x]++-1:++s}for(;s>=0&&f;--s){var b=o[s].s;p[b]==t&&(--p[b],++f)}m=t}return[new P(p),m]},ie=function(e,t,n){return-1==e.s?Math.max(ie(e.l,t,n+1),ie(e.r,t,n+1)):t[e.s]=n},ae=function(e){for(var t=e.length;t&&!e[--t];);for(var n=new C(++t),s=0,r=e[0],o=1,i=function(e){n[s++]=e},a=1;a<=t;++a)if(e[a]==r&&a!=t)++o;else{if(!r&&o>2){for(;o>138;o-=138)i(32754);o>2&&(i(o>10?o-11<<5|28690:o-3<<5|12305),o=0)}else if(o>3){for(i(r),--o;o>6;o-=6)i(8304);o>2&&(i(o-3<<5|8208),o=0)}for(;o--;)i(r);o=1,r=e[a]}return[n.subarray(0,s),t]},le=function(e,t){for(var n=0,s=0;s<t.length;++s)n+=e[s]*t[s];return n},ce=function(e,t,n){var s=n.length,r=ee(t+2);e[r]=255&s,e[r+1]=s>>>8,e[r+2]=255^e[r],e[r+3]=255^e[r+1];for(var o=0;o<s;++o)e[r+o+4]=n[o];return 8*(r+4+s)},he=function(e,t,n,s,r,o,i,a,l,c,h){se(t,h++,n),++r[256];for(var u=oe(r,15),d=u[0],p=u[1],m=oe(o,15),f=m[0],g=m[1],v=ae(d),y=v[0],x=v[1],b=ae(f),w=b[0],A=b[1],M=new C(19),_=0;_<y.length;++_)M[31&y[_]]++;for(_=0;_<w.length;++_)M[31&w[_]]++;for(var T=oe(M,7),S=T[0],E=T[1],P=19;P>4&&!S[k[P-1]];--P);var R,I,O,N,B=c+5<<3,D=le(r,W)+le(o,X)+i,F=le(r,d)+le(o,f)+i+14+3*P+le(M,S)+(2*M[16]+3*M[17]+7*M[18]);if(B<=D&&B<=F)return ce(t,h,e.subarray(l,l+c));if(se(t,h,1+(F<D)),h+=2,F<D){R=G(d,p,0),I=d,O=G(f,g,0),N=f;var U=G(S,E,0);for(se(t,h,x-257),se(t,h+5,A-1),se(t,h+10,P-4),h+=14,_=0;_<P;++_)se(t,h+3*_,S[k[_]]);h+=3*P;for(var z=[y,w],j=0;j<2;++j){var H=z[j];for(_=0;_<H.length;++_){var K=31&H[_];se(t,h,U[K]),h+=S[K],K>15&&(se(t,h,H[_]>>>5&127),h+=H[_]>>>12)}}}else R=q,I=W,O=Y,N=X;for(_=0;_<a;++_)if(s[_]>255){K=s[_]>>>18&31,re(t,h,R[K+257]),h+=I[K+257],K>7&&(se(t,h,s[_]>>>23&31),h+=L[K]);var $=31&s[_];re(t,h,O[$]),h+=N[$],$>3&&(re(t,h,s[_]>>>5&8191),h+=V[$])}else re(t,h,R[s[_]]),h+=I[s[_]];return re(t,h,R[256]),h+I[256]},ue=new R([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),de=new P(0),pe=function(e,t,n,s,r,o){var i=e.length,a=new P(s+i+5*(1+Math.ceil(i/7e3))+r),l=a.subarray(s,a.length-r),c=0;if(!t||i<8)for(var h=0;h<=i;h+=65535){var u=h+65535;u<i?c=ce(l,c,e.subarray(h,u)):(l[h]=o,c=ce(l,c,e.subarray(h,i)))}else{for(var d=ue[t-1],p=d>>>13,m=8191&d,f=(1<<n)-1,g=new C(32768),v=new C(f+1),y=Math.ceil(n/3),x=2*y,b=function(t){return(e[t]^e[t+1]<<y^e[t+2]<<x)&f},w=new R(25e3),A=new C(288),M=new C(32),_=0,T=0,S=(h=0,0),E=0,k=0;h<i;++h){var I=b(h),O=32767&h,N=v[I];if(g[O]=N,v[I]=O,E<=h){var D=i-h;if((_>7e3||S>24576)&&D>423){c=he(e,l,0,w,A,M,T,S,k,h-k,c),S=_=T=0,k=h;for(var F=0;F<286;++F)A[F]=0;for(F=0;F<30;++F)M[F]=0}var z=2,j=0,H=m,G=O-N&32767;if(D>2&&I==b(h-G))for(var W=Math.min(p,D)-1,X=Math.min(32767,h),q=Math.min(258,D);G<=X&&--H&&O!=N;){if(e[h+z]==e[h+z-G]){for(var K=0;K<q&&e[h+K]==e[h+K-G];++K);if(K>z){if(z=K,j=G,K>W)break;var Y=Math.min(G,K-2),$=0;for(F=0;F<Y;++F){var Q=h-G+F+32768&32767,Z=Q-g[Q]+32768&32767;Z>$&&($=Z,N=Q)}}}G+=(O=N)-(N=g[O])+32768&32767}if(j){w[S++]=268435456|B[z]<<18|U[j];var J=31&B[z],ne=31&U[j];T+=L[J]+V[ne],++A[257+J],++M[ne],E=h+z,++_}else w[S++]=e[h],++A[e[h]]}}c=he(e,l,o,w,A,M,T,S,k,h-k,c),!o&&7&c&&(c=ce(l,c+1,de))}return te(a,0,s+ee(c)+r)},me=function(){for(var e=new R(256),t=0;t<256;++t){for(var n=t,s=9;--s;)n=(1&n&&3988292384)^n>>>1;e[t]=n}return e}(),fe=function(){var e=-1;return{p:function(t){for(var n=e,s=0;s<t.length;++s)n=me[255&n^t[s]]^n>>>8;e=n},d:function(){return~e}}},ge=function(){var e=1,t=0;return{p:function(n){for(var s=e,r=t,o=n.length,i=0;i!=o;){for(var a=Math.min(i+2655,o);i<a;++i)r+=s+=n[i];s=(65535&s)+15*(s>>16),r=(65535&r)+15*(r>>16)}e=s,t=r},d:function(){return(255&(e%=65521))<<24|e>>>8<<16|(255&(t%=65521))<<8|t>>>8}}},ve=function(e,t,n,s,r){return pe(e,null==t.level?6:t.level,null==t.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):12+t.mem,n,s,!r)},ye=function(e,t){var n={};for(var s in e)n[s]=e[s];for(var s in t)n[s]=t[s];return n},xe=function(e,t,n){for(var s=e(),r=e.toString(),o=r.slice(r.indexOf("[")+1,r.lastIndexOf("]")).replace(/ /g,"").split(","),i=0;i<s.length;++i){var a=s[i],l=o[i];if("function"==typeof a){t+=";"+l+"=";var c=a.toString();if(a.prototype)if(-1!=c.indexOf("[native code]")){var h=c.indexOf(" ",8)+1;t+=c.slice(h,c.indexOf("(",h))}else for(var u in t+=c,a.prototype)t+=";"+l+".prototype."+u+"="+a.prototype[u].toString();else t+=c}else n[l]=a}return[t,n]},be=[],we=function(e,t,n,s){var r;if(!be[n]){for(var o="",i={},a=e.length-1,l=0;l<a;++l)o=(r=xe(e[l],o,i))[0],i=r[1];be[n]=xe(e[a],o,i)}var c=ye({},be[n][1]);return function(e,t,n,s,r){var o=E(T[t]||(T[t]=S(e)));return o.onerror=function(e){return r(e.error,null)},o.onmessage=function(e){return r(null,e.data)},o.postMessage(n,s),o}(be[n][0]+";onmessage=function(e){for(var k in e.data)self[k]=e.data[k];onmessage="+t.toString()+"}",n,c,function(e){var t=[];for(var n in e)(e[n]instanceof P||e[n]instanceof C||e[n]instanceof R)&&t.push((e[n]=new e[n].constructor(e[n])).buffer);return t}(c),s)},Ae=function(){return[P,C,R,L,V,k,N,F,K,$,z,G,Q,Z,J,ee,te,ne,Qe,Pe,Ce]},Me=function(){return[P,C,R,L,V,k,B,U,q,W,Y,X,z,ue,de,G,se,re,oe,ie,ae,le,ce,he,ee,te,pe,ve,qe,Pe]},_e=function(){return[Be,Ue,Ne,fe,me]},Te=function(){return[De,Fe]},Se=function(){return[ze,Ne,ge]},Ee=function(){return[je]},Pe=function(e){return postMessage(e,[e.buffer])},Ce=function(e){return e&&e.size&&new P(e.size)},Re=function(e,t,n,s,r,o){var i=we(n,s,r,(function(e,t){i.terminate(),o(e,t)}));return i.postMessage([e,t],t.consume?[e.buffer]:[]),function(){i.terminate()}},Le=function(e){return e.ondata=function(e,t){return postMessage([e,t],[e.buffer])},function(t){return e.push(t.data[0],t.data[1])}},Ve=function(e,t,n,s,r){var o,i=we(e,s,r,(function(e,n){e?(i.terminate(),t.ondata.call(t,e)):(n[1]&&i.terminate(),t.ondata.call(t,e,n[0],n[1]))}));i.postMessage(n),t.push=function(e,n){if(o)throw"stream finished";if(!t.ondata)throw"no stream handler";i.postMessage([e,o=n],[e.buffer])},t.terminate=function(){i.terminate()}},ke=function(e,t){return e[t]|e[t+1]<<8},Ie=function(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0},Oe=function(e,t){return Ie(e,t)+4294967296*Ie(e,t+4)},Ne=function(e,t,n){for(;n;++t)e[t]=n,n>>>=8},Be=function(e,t){var n=t.filename;if(e[0]=31,e[1]=139,e[2]=8,e[8]=t.level<2?4:9==t.level?2:0,e[9]=3,0!=t.mtime&&Ne(e,4,Math.floor(new Date(t.mtime||Date.now())/1e3)),n){e[3]=8;for(var s=0;s<=n.length;++s)e[s+10]=n.charCodeAt(s)}},De=function(e){if(31!=e[0]||139!=e[1]||8!=e[2])throw"invalid gzip data";var t=e[3],n=10;4&t&&(n+=e[10]|2+(e[11]<<8));for(var s=(t>>3&1)+(t>>4&1);s>0;s-=!e[n++]);return n+(2&t)},Fe=function(e){var t=e.length;return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0},Ue=function(e){return 10+(e.filename&&e.filename.length+1||0)},ze=function(e,t){var n=t.level,s=0==n?0:n<6?1:9==n?3:2;e[0]=120,e[1]=s<<6|(s?32-2*s:1)},je=function(e){if(8!=(15&e[0])||e[0]>>>4>7||(e[0]<<8|e[1])%31)throw"invalid zlib data";if(32&e[1])throw"invalid zlib data: preset dictionaries not supported"};function He(e,t){return t||"function"!=typeof e||(t=e,e={}),this.ondata=t,e}var Ge=function(){function e(e,t){t||"function"!=typeof e||(t=e,e={}),this.ondata=t,this.o=e||{}}return e.prototype.p=function(e,t){this.ondata(ve(e,this.o,0,0,!t),t)},e.prototype.push=function(e,t){if(this.d)throw"stream finished";if(!this.ondata)throw"no stream handler";this.d=t,this.p(e,t||!1)},e}(),We=function(){return function(e,t){Ve([Me,function(){return[Le,Ge]}],this,He.call(this,e,t),(function(e){var t=new Ge(e.data);onmessage=Le(t)}),6)}}();function Xe(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return Re(e,t,[Me],(function(e){return Pe(qe(e.data[0],e.data[1]))}),0,n)}function qe(e,t){return ve(e,t||{},0,0)}var Ke=function(){function e(e){this.s={},this.p=new P(0),this.ondata=e}return e.prototype.e=function(e){if(this.d)throw"stream finished";if(!this.ondata)throw"no stream handler";var t=this.p.length,n=new P(t+e.length);n.set(this.p),n.set(e,t),this.p=n},e.prototype.c=function(e){this.d=this.s.i=e||!1;var t=this.s.b,n=ne(this.p,this.o,this.s);this.ondata(te(n,t,this.s.b),this.d),this.o=te(n,this.s.b-32768),this.s.b=this.o.length,this.p=te(this.p,this.s.p/8|0),this.s.p&=7},e.prototype.push=function(e,t){this.e(e),this.c(t)},e}(),Ye=function(){return function(e){this.ondata=e,Ve([Ae,function(){return[Le,Ke]}],this,0,(function(){var e=new Ke;onmessage=Le(e)}),7)}}();function $e(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return Re(e,t,[Ae],(function(e){return Pe(Qe(e.data[0],Ce(e.data[1])))}),1,n)}function Qe(e,t){return ne(e,t)}var Ze=function(){function e(e,t){this.c=fe(),this.l=0,this.v=1,Ge.call(this,e,t)}return e.prototype.push=function(e,t){Ge.prototype.push.call(this,e,t)},e.prototype.p=function(e,t){this.c.p(e),this.l+=e.length;var n=ve(e,this.o,this.v&&Ue(this.o),t&&8,!t);this.v&&(Be(n,this.o),this.v=0),t&&(Ne(n,n.length-8,this.c.d()),Ne(n,n.length-4,this.l)),this.ondata(n,t)},e}(),Je=function(){return function(e,t){Ve([Me,_e,function(){return[Le,Ge,Ze]}],this,He.call(this,e,t),(function(e){var t=new Ze(e.data);onmessage=Le(t)}),8)}}();function et(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return Re(e,t,[Me,_e,function(){return[tt]}],(function(e){return Pe(tt(e.data[0],e.data[1]))}),2,n)}function tt(e,t){t||(t={});var n=fe(),s=e.length;n.p(e);var r=ve(e,t,Ue(t),8),o=r.length;return Be(r,t),Ne(r,o-8,n.d()),Ne(r,o-4,s),r}var nt=function(){function e(e){this.v=1,Ke.call(this,e)}return e.prototype.push=function(e,t){if(Ke.prototype.e.call(this,e),this.v){var n=this.p.length>3?De(this.p):4;if(n>=this.p.length&&!t)return;this.p=this.p.subarray(n),this.v=0}if(t){if(this.p.length<8)throw"invalid gzip stream";this.p=this.p.subarray(0,-8)}Ke.prototype.c.call(this,t)},e}(),st=function(){return function(e){this.ondata=e,Ve([Ae,Te,function(){return[Le,Ke,nt]}],this,0,(function(){var e=new nt;onmessage=Le(e)}),9)}}();function rt(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return Re(e,t,[Ae,Te,function(){return[ot]}],(function(e){return Pe(ot(e.data[0]))}),3,n)}function ot(e,t){return ne(e.subarray(De(e),-8),t||new P(Fe(e)))}var it=function(){function e(e,t){this.c=ge(),this.v=1,Ge.call(this,e,t)}return e.prototype.push=function(e,t){Ge.prototype.push.call(this,e,t)},e.prototype.p=function(e,t){this.c.p(e);var n=ve(e,this.o,this.v&&2,t&&4,!t);this.v&&(ze(n,this.o),this.v=0),t&&Ne(n,n.length-4,this.c.d()),this.ondata(n,t)},e}(),at=function(){return function(e,t){Ve([Me,Se,function(){return[Le,Ge,it]}],this,He.call(this,e,t),(function(e){var t=new it(e.data);onmessage=Le(t)}),10)}}();function lt(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return Re(e,t,[Me,Se,function(){return[ct]}],(function(e){return Pe(ct(e.data[0],e.data[1]))}),4,n)}function ct(e,t){t||(t={});var n=ge();n.p(e);var s=ve(e,t,2,4);return ze(s,t),Ne(s,s.length-4,n.d()),s}var ht=function(){function e(e){this.v=1,Ke.call(this,e)}return e.prototype.push=function(e,t){if(Ke.prototype.e.call(this,e),this.v){if(this.p.length<2&&!t)return;this.p=this.p.subarray(2),this.v=0}if(t){if(this.p.length<4)throw"invalid zlib stream";this.p=this.p.subarray(0,-4)}Ke.prototype.c.call(this,t)},e}(),ut=function(){return function(e){this.ondata=e,Ve([Ae,Ee,function(){return[Le,Ke,ht]}],this,0,(function(){var e=new ht;onmessage=Le(e)}),11)}}();function dt(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return Re(e,t,[Ae,Ee,function(){return[pt]}],(function(e){return Pe(pt(e.data[0],Ce(e.data[1])))}),5,n)}function pt(e,t){return ne((je(e),e.subarray(2,-4)),t)}var mt=function(){function e(e){this.G=nt,this.I=Ke,this.Z=ht,this.ondata=e}return e.prototype.push=function(e,t){if(!this.ondata)throw"no stream handler";if(this.s)this.s.push(e,t);else{if(this.p&&this.p.length){var n=new P(this.p.length+e.length);n.set(this.p),n.set(e,this.p.length)}else this.p=e;if(this.p.length>2){var s=this,r=function(){s.ondata.apply(s,arguments)};this.s=31==this.p[0]&&139==this.p[1]&&8==this.p[2]?new this.G(r):8!=(15&this.p[0])||this.p[0]>>4>7||(this.p[0]<<8|this.p[1])%31?new this.I(r):new this.Z(r),this.s.push(this.p,t),this.p=null}}},e}(),ft=function(){function e(e){this.G=st,this.I=Ye,this.Z=ut,this.ondata=e}return e.prototype.push=function(e,t){mt.prototype.push.call(this,e,t)},e}();function gt(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return 31==e[0]&&139==e[1]&&8==e[2]?rt(e,t,n):8!=(15&e[0])||e[0]>>4>7||(e[0]<<8|e[1])%31?$e(e,t,n):dt(e,t,n)}function vt(e,t){return 31==e[0]&&139==e[1]&&8==e[2]?ot(e,t):8!=(15&e[0])||e[0]>>4>7||(e[0]<<8|e[1])%31?Qe(e,t):pt(e,t)}var yt=function(e,t,n,s){for(var r in e){var o=e[r],i=t+r;o instanceof P?n[i]=[o,s]:Array.isArray(o)?n[i]=[o[0],ye(s,o[1])]:yt(o,i+"/",n,s)}},xt="undefined"!=typeof TextEncoder&&new TextEncoder,bt="undefined"!=typeof TextDecoder&&new TextDecoder,wt=0;try{bt.decode(de,{stream:!0}),wt=1}catch(e){}var At=function(e){for(var t="",n=0;;){var s=e[n++],r=(s>127)+(s>223)+(s>239);if(n+r>e.length)return[t,te(e,n-1)];r?3==r?(s=((15&s)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536,t+=String.fromCharCode(55296|s>>10,56320|1023&s)):t+=1&r?String.fromCharCode((31&s)<<6|63&e[n++]):String.fromCharCode((15&s)<<12|(63&e[n++])<<6|63&e[n++]):t+=String.fromCharCode(s)}},Mt=function(){function e(e){this.ondata=e,wt?this.t=new TextDecoder:this.p=de}return e.prototype.push=function(e,t){if(!this.ondata)throw"no callback";if(t=!!t,this.t){if(this.ondata(this.t.decode(e,{stream:!0}),t),t){if(this.t.decode().length)throw"invalid utf-8 data";this.t=null}}else{if(!this.p)throw"stream finished";var n=new P(this.p.length+e.length);n.set(this.p),n.set(e,this.p.length);var s=At(n),r=s[0],o=s[1];if(t){if(o.length)throw"invalid utf-8 data";this.p=null}else this.p=o;this.ondata(r,t)}},e}(),_t=function(){function e(e){this.ondata=e}return e.prototype.push=function(e,t){if(!this.ondata)throw"no callback";if(this.d)throw"stream finished";this.ondata(Tt(e),this.d=t||!1)},e}();function Tt(e,t){if(t){for(var n=new P(e.length),s=0;s<e.length;++s)n[s]=e.charCodeAt(s);return n}if(xt)return xt.encode(e);var r=e.length,o=new P(e.length+(e.length>>1)),i=0,a=function(e){o[i++]=e};for(s=0;s<r;++s){if(i+5>o.length){var l=new P(i+8+(r-s<<1));l.set(o),o=l}var c=e.charCodeAt(s);c<128||t?a(c):c<2048?(a(192|c>>6),a(128|63&c)):c>55295&&c<57344?(a(240|(c=65536+(1047552&c)|1023&e.charCodeAt(++s))>>18),a(128|c>>12&63),a(128|c>>6&63),a(128|63&c)):(a(224|c>>12),a(128|c>>6&63),a(128|63&c))}return te(o,0,i)}function St(e,t){if(t){for(var n="",s=0;s<e.length;s+=16384)n+=String.fromCharCode.apply(null,e.subarray(s,s+16384));return n}if(bt)return bt.decode(e);var r=At(e),o=r[0];if(r[1].length)throw"invalid utf-8 data";return o}var Et=function(e){return 1==e?3:e<6?2:9==e?1:0},Pt=function(e,t){return t+30+ke(e,t+26)+ke(e,t+28)},Ct=function(e,t,n){var s=ke(e,t+28),r=St(e.subarray(t+46,t+46+s),!(2048&ke(e,t+8))),o=t+46+s,i=Ie(e,t+20),a=n&&4294967295==i?Rt(e,o):[i,Ie(e,t+24),Ie(e,t+42)],l=a[0],c=a[1],h=a[2];return[ke(e,t+10),l,c,r,o+ke(e,t+30)+ke(e,t+32),h]},Rt=function(e,t){for(;1!=ke(e,t);t+=4+ke(e,t+2));return[Oe(e,t+12),Oe(e,t+4),Oe(e,t+20)]},Lt=function(e){var t=0;if(e)for(var n in e){var s=e[n].length;if(s>65535)throw"extra field too long";t+=s+4}return t},Vt=function(e,t,n,s,r,o,i,a){var l=s.length,c=n.extra,h=a&&a.length,u=Lt(c);Ne(e,t,null!=i?33639248:67324752),t+=4,null!=i&&(e[t++]=20,e[t++]=n.os),e[t]=20,t+=2,e[t++]=n.flag<<1|(null==o&&8),e[t++]=r&&8,e[t++]=255&n.compression,e[t++]=n.compression>>8;var d=new Date(null==n.mtime?Date.now():n.mtime),p=d.getFullYear()-1980;if(p<0||p>119)throw"date not in range 1980-2099";if(Ne(e,t,p<<25|d.getMonth()+1<<21|d.getDate()<<16|d.getHours()<<11|d.getMinutes()<<5|d.getSeconds()>>>1),t+=4,null!=o&&(Ne(e,t,n.crc),Ne(e,t+4,o),Ne(e,t+8,n.size)),Ne(e,t+12,l),Ne(e,t+14,u),t+=16,null!=i&&(Ne(e,t,h),Ne(e,t+6,n.attrs),Ne(e,t+10,i),t+=14),e.set(s,t),t+=l,u)for(var m in c){var f=c[m],g=f.length;Ne(e,t,+m),Ne(e,t+2,g),e.set(f,t+4),t+=4+g}return h&&(e.set(a,t),t+=h),t},kt=function(e,t,n,s,r){Ne(e,t,101010256),Ne(e,t+8,n),Ne(e,t+10,n),Ne(e,t+12,s),Ne(e,t+16,r)},It=function(){function e(e){this.filename=e,this.c=fe(),this.size=0,this.compression=0}return e.prototype.process=function(e,t){this.ondata(null,e,t)},e.prototype.push=function(e,t){if(!this.ondata)throw"no callback - add to ZIP archive before pushing";this.c.p(e),this.size+=e.length,t&&(this.crc=this.c.d()),this.process(e,t||!1)},e}(),Ot=function(){function e(e,t){var n=this;t||(t={}),It.call(this,e),this.d=new Ge(t,(function(e,t){n.ondata(null,e,t)})),this.compression=8,this.flag=Et(t.level)}return e.prototype.process=function(e,t){try{this.d.push(e,t)}catch(e){this.ondata(e,null,t)}},e.prototype.push=function(e,t){It.prototype.push.call(this,e,t)},e}(),Nt=function(){function e(e,t){var n=this;t||(t={}),It.call(this,e),this.d=new We(t,(function(e,t,s){n.ondata(e,t,s)})),this.compression=8,this.flag=Et(t.level),this.terminate=this.d.terminate}return e.prototype.process=function(e,t){this.d.push(e,t)},e.prototype.push=function(e,t){It.prototype.push.call(this,e,t)},e}(),Bt=function(){function e(e){this.ondata=e,this.u=[],this.d=1}return e.prototype.add=function(e){var t=this;if(2&this.d)throw"stream finished";var n=Tt(e.filename),s=n.length,r=e.comment,o=r&&Tt(r),i=s!=e.filename.length||o&&r.length!=o.length,a=s+Lt(e.extra)+30;if(s>65535)throw"filename too long";var l=new P(a);Vt(l,0,e,n,i);var c=[l],h=function(){for(var e=0,n=c;e<n.length;e++){var s=n[e];t.ondata(null,s,!1)}c=[]},u=this.d;this.d=0;var d=this.u.length,p=ye(e,{f:n,u:i,o,t:function(){e.terminate&&e.terminate()},r:function(){if(h(),u){var e=t.u[d+1];e?e.r():t.d=1}u=1}}),m=0;e.ondata=function(n,s,r){if(n)t.ondata(n,s,r),t.terminate();else if(m+=s.length,c.push(s),r){var o=new P(16);Ne(o,0,134695760),Ne(o,4,e.crc),Ne(o,8,m),Ne(o,12,e.size),c.push(o),p.c=m,p.b=a+m+16,p.crc=e.crc,p.size=e.size,u&&p.r(),u=1}else u&&h()},this.u.push(p)},e.prototype.end=function(){var e=this;if(2&this.d){if(1&this.d)throw"stream finishing";throw"stream finished"}this.d?this.e():this.u.push({r:function(){1&e.d&&(e.u.splice(-1,1),e.e())},t:function(){}}),this.d=3},e.prototype.e=function(){for(var e=0,t=0,n=0,s=0,r=this.u;s<r.length;s++)n+=46+(l=r[s]).f.length+Lt(l.extra)+(l.o?l.o.length:0);for(var o=new P(n+22),i=0,a=this.u;i<a.length;i++){var l=a[i];Vt(o,e,l,l.f,l.u,l.c,t,l.o),e+=46+l.f.length+Lt(l.extra)+(l.o?l.o.length:0),t+=l.b}kt(o,e,this.u.length,n,t),this.ondata(null,o,!0),this.d=2},e.prototype.terminate=function(){for(var e=0,t=this.u;e<t.length;e++)t[e].t();this.d=2},e}();function Dt(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";var s={};yt(e,"",s,t);var r=Object.keys(s),o=r.length,i=0,a=0,l=o,c=new Array(o),h=[],u=function(){for(var e=0;e<h.length;++e)h[e]()},d=function(){var e=new P(a+22),t=i,s=a-i;a=0;for(var r=0;r<l;++r){var o=c[r];try{var h=o.c.length;Vt(e,a,o,o.f,o.u,h);var u=30+o.f.length+Lt(o.extra),d=a+u;e.set(o.c,d),Vt(e,i,o,o.f,o.u,h,a,o.m),i+=16+u+(o.m?o.m.length:0),a=d+h}catch(e){return n(e,null)}}kt(e,i,c.length,s,t),n(null,e)};o||d();for(var p=function(e){var t=r[e],l=s[t],p=l[0],m=l[1],f=fe(),g=p.length;f.p(p);var v=Tt(t),y=v.length,x=m.comment,b=x&&Tt(x),w=b&&b.length,A=Lt(m.extra),M=0==m.level?0:8,_=function(s,r){if(s)u(),n(s,null);else{var l=r.length;c[e]=ye(m,{size:g,crc:f.d(),c:r,f:v,m:b,u:y!=t.length||b&&x.length!=w,compression:M}),i+=30+y+A+l,a+=76+2*(y+A)+(w||0)+l,--o||d()}};if(y>65535&&_("filename too long",null),M)if(g<16e4)try{_(null,qe(p,m))}catch(e){_(e,null)}else h.push(Xe(p,m,_));else _(null,p)},m=0;m<l;++m)p(m);return u}function Ft(e,t){t||(t={});var n={},s=[];yt(e,"",n,t);var r=0,o=0;for(var i in n){var a=n[i],l=a[0],c=a[1],h=0==c.level?0:8,u=(M=Tt(i)).length,d=c.comment,p=d&&Tt(d),m=p&&p.length,f=Lt(c.extra);if(u>65535)throw"filename too long";var g=h?qe(l,c):l,v=g.length,y=fe();y.p(l),s.push(ye(c,{size:l.length,crc:y.d(),c:g,f:M,m:p,u:u!=i.length||p&&d.length!=m,o:r,compression:h})),r+=30+u+f+v,o+=76+2*(u+f)+(m||0)+v}for(var x=new P(o+22),b=r,w=o-r,A=0;A<s.length;++A){var M=s[A];Vt(x,M.o,M,M.f,M.u,M.c.length);var _=30+M.f.length+Lt(M.extra);x.set(M.c,M.o+_),Vt(x,r,M,M.f,M.u,M.c.length,M.o,M.m),r+=16+_+(M.m?M.m.length:0)}return kt(x,r,s.length,w,b),x}var Ut=function(){function e(){}return e.prototype.push=function(e,t){this.ondata(null,e,t)},e.compression=0,e}(),zt=function(){function e(){var e=this;this.i=new Ke((function(t,n){e.ondata(null,t,n)}))}return e.prototype.push=function(e,t){try{this.i.push(e,t)}catch(n){this.ondata(n,e,t)}},e.compression=8,e}(),jt=function(){function e(e,t){var n=this;t<32e4?this.i=new Ke((function(e,t){n.ondata(null,e,t)})):(this.i=new Ye((function(e,t,s){n.ondata(e,t,s)})),this.terminate=this.i.terminate)}return e.prototype.push=function(e,t){this.i.terminate&&(e=te(e,0)),this.i.push(e,t)},e.compression=8,e}(),Ht=function(){function e(e){this.onfile=e,this.k=[],this.o={0:Ut},this.p=de}return e.prototype.push=function(e,t){var n=this;if(!this.onfile)throw"no callback";if(!this.p)throw"stream finished";if(this.c>0){var s=Math.min(this.c,e.length),r=e.subarray(0,s);if(this.c-=s,this.d?this.d.push(r,!this.c):this.k[0].push(r),(e=e.subarray(s)).length)return this.push(e,t)}else{var o=0,i=0,a=void 0,l=void 0;this.p.length?e.length?((l=new P(this.p.length+e.length)).set(this.p),l.set(e,this.p.length)):l=this.p:l=e;for(var c=l.length,h=this.c,u=h&&this.d,d=function(){var e,t=Ie(l,i);if(67324752==t){o=1,a=i,p.d=null,p.c=0;var s=ke(l,i+6),r=ke(l,i+8),u=2048&s,d=8&s,m=ke(l,i+26),f=ke(l,i+28);if(c>i+30+m+f){var g=[];p.k.unshift(g),o=2;var v,y=Ie(l,i+18),x=Ie(l,i+22),b=St(l.subarray(i+30,i+=30+m),!u);4294967295==y?(e=d?[-2]:Rt(l,i),y=e[0],x=e[1]):d&&(y=-1),i+=f,p.c=y;var w={name:b,compression:r,start:function(){if(!w.ondata)throw"no callback";if(y){var e=n.o[r];if(!e)throw"unknown compression type "+r;(v=y<0?new e(b):new e(b,y,x)).ondata=function(e,t,n){w.ondata(e,t,n)};for(var t=0,s=g;t<s.length;t++){var o=s[t];v.push(o,!1)}n.k[0]==g&&n.c?n.d=v:v.push(de,!0)}else w.ondata(null,de,!0)},terminate:function(){v&&v.terminate&&v.terminate()}};y>=0&&(w.size=y,w.originalSize=x),p.onfile(w)}return"break"}if(h){if(134695760==t)return a=i+=12+(-2==h&&8),o=3,p.c=0,"break";if(33639248==t)return a=i-=4,o=3,p.c=0,"break"}},p=this;i<c-4&&"break"!==d();++i);if(this.p=de,h<0){var m=o?l.subarray(0,a-12-(-2==h&&8)-(134695760==Ie(l,a-16)&&4)):l.subarray(0,i);u?u.push(m,!!o):this.k[+(2==o)].push(m)}if(2&o)return this.push(l.subarray(i),t);this.p=l.subarray(i)}if(t){if(this.c)throw"invalid zip file";this.p=null}},e.prototype.register=function(e){this.o[e.compression]=e},e}();function Gt(e,t){if("function"!=typeof t)throw"no callback";for(var n=[],s=function(){for(var e=0;e<n.length;++e)n[e]()},r={},o=e.length-22;101010256!=Ie(e,o);--o)if(!o||e.length-o>65558)return void t("invalid zip file",null);var i=ke(e,o+8);i||t(null,{});var a=i,l=Ie(e,o+16),c=4294967295==l;if(c){if(o=Ie(e,o-12),101075792!=Ie(e,o))return void t("invalid zip file",null);a=i=Ie(e,o+32),l=Ie(e,o+48)}for(var h=function(o){var a=Ct(e,l,c),h=a[0],u=a[1],d=a[2],p=a[3],m=a[4],f=a[5],g=Pt(e,f);l=m;var v=function(e,n){e?(s(),t(e,null)):(r[p]=n,--i||t(null,r))};if(h)if(8==h){var y=e.subarray(g,g+u);if(u<32e4)try{v(null,Qe(y,new P(d)))}catch(e){v(e,null)}else n.push($e(y,{size:d},v))}else v("unknown compression type "+h,null);else v(null,te(e,g,g+u))},u=0;u<a;++u)h();return s}function Wt(e){for(var t={},n=e.length-22;101010256!=Ie(e,n);--n)if(!n||e.length-n>65558)throw"invalid zip file";var s=ke(e,n+8);if(!s)return{};var r=Ie(e,n+16),o=4294967295==r;if(o){if(n=Ie(e,n-12),101075792!=Ie(e,n))throw"invalid zip file";s=Ie(e,n+32),r=Ie(e,n+48)}for(var i=0;i<s;++i){var a=Ct(e,r,o),l=a[0],c=a[1],h=a[2],u=a[3],d=a[4],p=a[5],m=Pt(e,p);if(r=d,l){if(8!=l)throw"unknown compression type "+l;t[u]=Qe(e.subarray(m,m+c),new P(h))}else t[u]=te(e,m,m+c)}return t}class Xt{static findSpan(e,t,n){const s=n.length-e-1;if(t>=n[s])return s-1;if(t<=n[e])return e;let r=e,o=s,i=Math.floor((r+o)/2);for(;t<n[i]||t>=n[i+1];)t<n[i]?o=i:r=i,i=Math.floor((r+o)/2);return i}static calcBasisFunctions(e,t,n,s){const r=[],o=[],i=[];r[0]=1;for(let a=1;a<=n;++a){o[a]=t-s[e+1-a],i[a]=s[e+a]-t;let n=0;for(let e=0;e<a;++e){const t=i[e+1],s=o[a-e],l=r[e]/(t+s);r[e]=n+t*l,n=s*l}r[a]=n}return r}static calcBSplinePoint(e,t,n,r){const o=this.findSpan(e,r,t),i=this.calcBasisFunctions(o,r,e,t),a=new s.Vector4(0,0,0,0);for(let t=0;t<=e;++t){const s=n[o-e+t],r=i[t],l=s.w*r;a.x+=s.x*l,a.y+=s.y*l,a.z+=s.z*l,a.w+=s.w*r}return a}static calcBasisFunctionDerivatives(e,t,n,s,r){const o=[];for(let e=0;e<=n;++e)o[e]=0;const i=[];for(let e=0;e<=s;++e)i[e]=o.slice(0);const a=[];for(let e=0;e<=n;++e)a[e]=o.slice(0);a[0][0]=1;const l=o.slice(0),c=o.slice(0);for(let s=1;s<=n;++s){l[s]=t-r[e+1-s],c[s]=r[e+s]-t;let n=0;for(let e=0;e<s;++e){const t=c[e+1],r=l[s-e];a[s][e]=t+r;const o=a[e][s-1]/a[s][e];a[e][s]=n+t*o,n=r*o}a[s][s]=n}for(let e=0;e<=n;++e)i[0][e]=a[e][n];for(let e=0;e<=n;++e){let t=0,r=1;const l=[];for(let e=0;e<=n;++e)l[e]=o.slice(0);l[0][0]=1;for(let o=1;o<=s;++o){let s=0;const c=e-o,h=n-o;e>=o&&(l[r][0]=l[t][0]/a[h+1][c],s=l[r][0]*a[c][h]);const u=e-1<=h?o-1:n-e;for(let e=c>=-1?1:-c;e<=u;++e)l[r][e]=(l[t][e]-l[t][e-1])/a[h+1][c+e],s+=l[r][e]*a[c+e][h];e<=h&&(l[r][o]=-l[t][o-1]/a[h+1][e],s+=l[r][o]*a[e][h]),i[o][e]=s;const d=t;t=r,r=d}}let h=n;for(let e=1;e<=s;++e){for(let t=0;t<=n;++t)i[e][t]*=h;h*=n-e}return i}static calcBSplineDerivatives(e,t,n,r,o){const i=o<e?o:e,a=[],l=this.findSpan(e,r,t),c=this.calcBasisFunctionDerivatives(l,r,e,i,t),h=[];for(let e=0;e<n.length;++e){const t=n[e].clone(),s=t.w;t.x*=s,t.y*=s,t.z*=s,h[e]=t}for(let t=0;t<=i;++t){const n=h[l-e].clone().multiplyScalar(c[t][0]);for(let s=1;s<=e;++s)n.add(h[l-e+s].clone().multiplyScalar(c[t][s]));a[t]=n}for(let e=i+1;e<=o+1;++e)a[e]=new s.Vector4(0,0,0);return a}static calcKoverI(e,t){let n=1;for(let t=2;t<=e;++t)n*=t;let s=1;for(let e=2;e<=t;++e)s*=e;for(let n=2;n<=e-t;++n)s*=n;return n/s}static calcRationalCurveDerivatives(e){const t=e.length,n=[],r=[];for(let o=0;o<t;++o){const t=e[o];n[o]=new s.Vector3(t.x,t.y,t.z),r[o]=t.w}const o=[];for(let e=0;e<t;++e){const t=n[e].clone();for(let n=1;n<=e;++n)t.sub(o[e-n].clone().multiplyScalar(this.calcKoverI(e,n)*r[n]));o[e]=t.divideScalar(r[0])}return o}static calcNURBSDerivatives(e,t,n,s,r){const o=this.calcBSplineDerivatives(e,t,n,s,r);return this.calcRationalCurveDerivatives(o)}static calcSurfacePoint(e,t,n,r,o,i,a,l){const c=this.findSpan(e,i,n),h=this.findSpan(t,a,r),u=this.calcBasisFunctions(c,i,e,n),d=this.calcBasisFunctions(h,a,t,r),p=[];for(let n=0;n<=t;++n){p[n]=new s.Vector4(0,0,0,0);for(let s=0;s<=e;++s){const r=o[c-e+s][h-t+n].clone(),i=r.w;r.x*=i,r.y*=i,r.z*=i,p[n].add(r.multiplyScalar(u[s]))}}const m=new s.Vector4(0,0,0,0);for(let e=0;e<=t;++e)m.add(p[e].multiplyScalar(d[e]));m.divideScalar(m.w),l.set(m.x,m.y,m.z)}}class qt extends s.Curve{constructor(e,t,n,r,o){super(),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=r||0,this.endKnot=o||this.knots.length-1;for(let e=0;e<n.length;++e){const t=n[e];this.controlPoints[e]=new s.Vector4(t.x,t.y,t.z,t.w)}}getPoint(e,t=new s.Vector3){const n=t,r=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),o=Xt.calcBSplinePoint(this.degree,this.knots,this.controlPoints,r);return 1!==o.w&&o.divideScalar(o.w),n.set(o.x,o.y,o.z)}getTangent(e,t=new s.Vector3){const n=t,r=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),o=Xt.calcNURBSDerivatives(this.degree,this.knots,this.controlPoints,r,1);return n.copy(o[1]).normalize(),n}}let Kt,Yt,$t;class Qt extends s.Loader{constructor(e){super(e)}load(e,t,n,r){const o=this,i=""===o.path?s.LoaderUtils.extractUrlBase(e):o.path,a=new s.FileLoader(this.manager);a.setPath(o.path),a.setResponseType("arraybuffer"),a.setRequestHeader(o.requestHeader),a.setWithCredentials(o.withCredentials),a.load(e,(function(n){try{t(o.parse(n,i))}catch(t){r?r(t):console.error(t),o.manager.itemError(e)}}),n,r)}parse(e,t){if(function(e){const t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===fn(e,0,t.length)}(e))Kt=(new nn).parse(e);else{const t=fn(e);if(!function(e){const t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let n=0;function s(t){const s=e[t-1];return e=e.slice(n+t),n++,s}for(let e=0;e<t.length;++e)if(s(1)===t[e])return!1;return!0}(t))throw new Error("THREE.FBXLoader: Unknown format.");if(on(t)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+on(t));Kt=(new tn).parse(t)}const n=new s.TextureLoader(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new Zt(n,this.manager).parse(Kt)}}class Zt{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){Yt=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),n=this.parseMaterials(t),s=this.parseDeformers(),r=(new Jt).parse(s);return this.parseScene(s,r,n),$t}parseConnections(){const e=new Map;return"Connections"in Kt&&Kt.Connections.connections.forEach((function(t){const n=t[0],s=t[1],r=t[2];e.has(n)||e.set(n,{parents:[],children:[]});const o={ID:s,relationship:r};e.get(n).parents.push(o),e.has(s)||e.set(s,{parents:[],children:[]});const i={ID:n,relationship:r};e.get(s).children.push(i)})),e}parseImages(){const e={},t={};if("Video"in Kt.Objects){const n=Kt.Objects.Video;for(const s in n){const r=n[s];if(e[parseInt(s)]=r.RelativeFilename||r.Filename,"Content"in r){const e=r.Content instanceof ArrayBuffer&&r.Content.byteLength>0,o="string"==typeof r.Content&&""!==r.Content;if(e||o){const e=this.parseImage(n[s]);t[r.RelativeFilename||r.Filename]=e}}}}for(const n in e){const s=e[n];void 0!==t[s]?e[n]=t[s]:e[n]=e[n].split("\\").pop()}return e}parseImage(e){const t=e.Content,n=e.RelativeFilename||e.Filename,s=n.slice(n.lastIndexOf(".")+1).toLowerCase();let r;switch(s){case"bmp":r="image/bmp";break;case"jpg":case"jpeg":r="image/jpeg";break;case"png":r="image/png";break;case"tif":r="image/tiff";break;case"tga":null===this.manager.getHandler(".tga")&&console.warn("FBXLoader: TGA loader not found, skipping ",n),r="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+s+'" is not supported.')}if("string"==typeof t)return"data:"+r+";base64,"+t;{const e=new Uint8Array(t);return window.URL.createObjectURL(new Blob([e],{type:r}))}}parseTextures(e){const t=new Map;if("Texture"in Kt.Objects){const n=Kt.Objects.Texture;for(const s in n){const r=this.parseTexture(n[s],e);t.set(parseInt(s),r)}}return t}parseTexture(e,t){const n=this.loadTexture(e,t);n.ID=e.id,n.name=e.attrName;const r=e.WrapModeU,o=e.WrapModeV,i=void 0!==r?r.value:0,a=void 0!==o?o.value:0;if(n.wrapS=0===i?s.RepeatWrapping:s.ClampToEdgeWrapping,n.wrapT=0===a?s.RepeatWrapping:s.ClampToEdgeWrapping,"Scaling"in e){const t=e.Scaling.value;n.repeat.x=t[0],n.repeat.y=t[1]}return n}loadTexture(e,t){let n;const r=this.textureLoader.path,o=Yt.get(e.id).children;let i;void 0!==o&&o.length>0&&void 0!==t[o[0].ID]&&(n=t[o[0].ID],0!==n.indexOf("blob:")&&0!==n.indexOf("data:")||this.textureLoader.setPath(void 0));const a=e.FileName.slice(-3).toLowerCase();if("tga"===a){const t=this.manager.getHandler(".tga");null===t?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),i=new s.Texture):(t.setPath(this.textureLoader.path),i=t.load(n))}else"psd"===a?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),i=new s.Texture):i=this.textureLoader.load(n);return this.textureLoader.setPath(r),i}parseMaterials(e){const t=new Map;if("Material"in Kt.Objects){const n=Kt.Objects.Material;for(const s in n){const r=this.parseMaterial(n[s],e);null!==r&&t.set(parseInt(s),r)}}return t}parseMaterial(e,t){const n=e.id,r=e.attrName;let o=e.ShadingModel;if("object"==typeof o&&(o=o.value),!Yt.has(n))return null;const i=this.parseParameters(e,t,n);let a;switch(o.toLowerCase()){case"phong":a=new s.MeshPhongMaterial;break;case"lambert":a=new s.MeshLambertMaterial;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',o),a=new s.MeshPhongMaterial}return a.setValues(i),a.name=r,a}parseParameters(e,t,n){const r={};e.BumpFactor&&(r.bumpScale=e.BumpFactor.value),e.Diffuse?r.color=(new s.Color).fromArray(e.Diffuse.value):!e.DiffuseColor||"Color"!==e.DiffuseColor.type&&"ColorRGB"!==e.DiffuseColor.type||(r.color=(new s.Color).fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(r.displacementScale=e.DisplacementFactor.value),e.Emissive?r.emissive=(new s.Color).fromArray(e.Emissive.value):!e.EmissiveColor||"Color"!==e.EmissiveColor.type&&"ColorRGB"!==e.EmissiveColor.type||(r.emissive=(new s.Color).fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(r.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(r.opacity=parseFloat(e.Opacity.value)),r.opacity<1&&(r.transparent=!0),e.ReflectionFactor&&(r.reflectivity=e.ReflectionFactor.value),e.Shininess&&(r.shininess=e.Shininess.value),e.Specular?r.specular=(new s.Color).fromArray(e.Specular.value):e.SpecularColor&&"Color"===e.SpecularColor.type&&(r.specular=(new s.Color).fromArray(e.SpecularColor.value));const o=this;return Yt.get(n).children.forEach((function(e){const n=e.relationship;switch(n){case"Bump":r.bumpMap=o.getTexture(t,e.ID);break;case"Maya|TEX_ao_map":r.aoMap=o.getTexture(t,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":r.map=o.getTexture(t,e.ID),r.map.encoding=s.sRGBEncoding;break;case"DisplacementColor":r.displacementMap=o.getTexture(t,e.ID);break;case"EmissiveColor":r.emissiveMap=o.getTexture(t,e.ID),r.emissiveMap.encoding=s.sRGBEncoding;break;case"NormalMap":case"Maya|TEX_normal_map":r.normalMap=o.getTexture(t,e.ID);break;case"ReflectionColor":r.envMap=o.getTexture(t,e.ID),r.envMap.mapping=s.EquirectangularReflectionMapping,r.envMap.encoding=s.sRGBEncoding;break;case"SpecularColor":r.specularMap=o.getTexture(t,e.ID),r.specularMap.encoding=s.sRGBEncoding;break;case"TransparentColor":case"TransparencyFactor":r.alphaMap=o.getTexture(t,e.ID),r.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",n)}})),r}getTexture(e,t){return"LayeredTexture"in Kt.Objects&&t in Kt.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=Yt.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in Kt.Objects){const n=Kt.Objects.Deformer;for(const s in n){const r=n[s],o=Yt.get(parseInt(s));if("Skin"===r.attrType){const t=this.parseSkeleton(o,n);t.ID=s,o.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),t.geometryID=o.parents[0].ID,e[s]=t}else if("BlendShape"===r.attrType){const e={id:s};e.rawTargets=this.parseMorphTargets(o,n),e.id=s,o.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[s]=e}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const n=[];return e.children.forEach((function(e){const r=t[e.ID];if("Cluster"!==r.attrType)return;const o={ID:e.ID,indices:[],weights:[],transformLink:(new s.Matrix4).fromArray(r.TransformLink.a)};"Indexes"in r&&(o.indices=r.Indexes.a,o.weights=r.Weights.a),n.push(o)})),{rawBones:n,bones:[]}}parseMorphTargets(e,t){const n=[];for(let s=0;s<e.children.length;s++){const r=e.children[s],o=t[r.ID],i={name:o.attrName,initialWeight:o.DeformPercent,id:o.id,fullWeights:o.FullWeights.a};if("BlendShapeChannel"!==o.attrType)return;i.geoID=Yt.get(parseInt(r.ID)).children.filter((function(e){return void 0===e.relationship}))[0].ID,n.push(i)}return n}parseScene(e,t,n){$t=new s.Group;const r=this.parseModels(e.skeletons,t,n),o=Kt.Objects.Model,i=this;r.forEach((function(e){const t=o[e.ID];i.setLookAtProperties(e,t),Yt.get(e.ID).parents.forEach((function(t){const n=r.get(t.ID);void 0!==n&&n.add(e)})),null===e.parent&&$t.add(e)})),this.bindSkeleton(e.skeletons,t,r),this.createAmbientLight(),this.setupMorphMaterials(),$t.traverse((function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrix=e.parent.matrix,e.userData.transformData.parentMatrixWorld=e.parent.matrixWorld);const t=dn(e.userData.transformData);e.applyMatrix4(t),e.updateWorldMatrix()}}));const a=(new en).parse();1===$t.children.length&&$t.children[0].isGroup&&($t.children[0].animations=a,$t=$t.children[0]),$t.animations=a}parseModels(e,t,n){const r=new Map,o=Kt.Objects.Model;for(const i in o){const a=parseInt(i),l=o[i],c=Yt.get(a);let h=this.buildSkeleton(c,e,a,l.attrName);if(!h){switch(l.attrType){case"Camera":h=this.createCamera(c);break;case"Light":h=this.createLight(c);break;case"Mesh":h=this.createMesh(c,t,n);break;case"NurbsCurve":h=this.createCurve(c,t);break;case"LimbNode":case"Root":h=new s.Bone;break;case"Null":default:h=new s.Group}h.name=l.attrName?s.PropertyBinding.sanitizeNodeName(l.attrName):"",h.ID=a}this.getTransformData(h,l),r.set(a,h)}return r}buildSkeleton(e,t,n,r){let o=null;return e.parents.forEach((function(e){for(const i in t){const a=t[i];a.rawBones.forEach((function(t,i){if(t.ID===e.ID){const e=o;o=new s.Bone,o.matrixWorld.copy(t.transformLink),o.name=r?s.PropertyBinding.sanitizeNodeName(r):"",o.ID=n,a.bones[i]=o,null!==e&&o.add(e)}}))}})),o}createCamera(e){let t,n;if(e.children.forEach((function(e){const t=Kt.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)})),void 0===n)t=new s.Object3D;else{let e=0;void 0!==n.CameraProjectionType&&1===n.CameraProjectionType.value&&(e=1);let r=1;void 0!==n.NearPlane&&(r=n.NearPlane.value/1e3);let o=1e3;void 0!==n.FarPlane&&(o=n.FarPlane.value/1e3);let i=window.innerWidth,a=window.innerHeight;void 0!==n.AspectWidth&&void 0!==n.AspectHeight&&(i=n.AspectWidth.value,a=n.AspectHeight.value);const l=i/a;let c=45;void 0!==n.FieldOfView&&(c=n.FieldOfView.value);const h=n.FocalLength?n.FocalLength.value:null;switch(e){case 0:t=new s.PerspectiveCamera(c,l,r,o),null!==h&&t.setFocalLength(h);break;case 1:t=new s.OrthographicCamera(-i/2,i/2,a/2,-a/2,r,o);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+e+"."),t=new s.Object3D}}return t}createLight(e){let t,n;if(e.children.forEach((function(e){const t=Kt.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)})),void 0===n)t=new s.Object3D;else{let e;e=void 0===n.LightType?0:n.LightType.value;let r=16777215;void 0!==n.Color&&(r=(new s.Color).fromArray(n.Color.value));let o=void 0===n.Intensity?1:n.Intensity.value/100;void 0!==n.CastLightOnObject&&0===n.CastLightOnObject.value&&(o=0);let i=0;void 0!==n.FarAttenuationEnd&&(i=void 0!==n.EnableFarAttenuation&&0===n.EnableFarAttenuation.value?0:n.FarAttenuationEnd.value);const a=1;switch(e){case 0:t=new s.PointLight(r,o,i,a);break;case 1:t=new s.DirectionalLight(r,o);break;case 2:let e=Math.PI/3;void 0!==n.InnerAngle&&(e=s.MathUtils.degToRad(n.InnerAngle.value));let l=0;void 0!==n.OuterAngle&&(l=s.MathUtils.degToRad(n.OuterAngle.value),l=Math.max(l,1)),t=new s.SpotLight(r,o,i,e,l,a);break;default:console.warn("THREE.FBXLoader: Unknown light type "+n.LightType.value+", defaulting to a PointLight."),t=new s.PointLight(r,o)}void 0!==n.CastShadows&&1===n.CastShadows.value&&(t.castShadow=!0)}return t}createMesh(e,t,n){let r,o=null,i=null;const a=[];return e.children.forEach((function(e){t.has(e.ID)&&(o=t.get(e.ID)),n.has(e.ID)&&a.push(n.get(e.ID))})),a.length>1?i=a:a.length>0?i=a[0]:(i=new s.MeshPhongMaterial({color:13421772}),a.push(i)),"color"in o.attributes&&a.forEach((function(e){e.vertexColors=!0})),o.FBX_Deformer?(r=new s.SkinnedMesh(o,i),r.normalizeSkinWeights()):r=new s.Mesh(o,i),r}createCurve(e,t){const n=e.children.reduce((function(e,n){return t.has(n.ID)&&(e=t.get(n.ID)),e}),null),r=new s.LineBasicMaterial({color:3342591,linewidth:1});return new s.Line(n,r)}getTransformData(e,t){const n={};"InheritType"in t&&(n.inheritType=parseInt(t.InheritType.value)),n.eulerOrder="RotationOrder"in t?pn(t.RotationOrder.value):"ZYX","Lcl_Translation"in t&&(n.translation=t.Lcl_Translation.value),"PreRotation"in t&&(n.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(n.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(n.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(n.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(n.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(n.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(n.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(n.rotationPivot=t.RotationPivot.value),e.userData.transformData=n}setLookAtProperties(e,t){"LookAtProperty"in t&&Yt.get(e.ID).children.forEach((function(t){if("LookAtProperty"===t.relationship){const n=Kt.Objects.Model[t.ID];if("Lcl_Translation"in n){const t=n.Lcl_Translation.value;void 0!==e.target?(e.target.position.fromArray(t),$t.add(e.target)):e.lookAt((new s.Vector3).fromArray(t))}}}))}bindSkeleton(e,t,n){const r=this.parsePoseNodes();for(const o in e){const i=e[o];Yt.get(parseInt(i.ID)).parents.forEach((function(e){if(t.has(e.ID)){const t=e.ID;Yt.get(t).parents.forEach((function(e){n.has(e.ID)&&n.get(e.ID).bind(new s.Skeleton(i.bones),r[e.ID])}))}}))}}parsePoseNodes(){const e={};if("Pose"in Kt.Objects){const t=Kt.Objects.Pose;for(const n in t)if("BindPose"===t[n].attrType){const r=t[n].PoseNode;Array.isArray(r)?r.forEach((function(t){e[t.Node]=(new s.Matrix4).fromArray(t.Matrix.a)})):e[r.Node]=(new s.Matrix4).fromArray(r.Matrix.a)}}return e}createAmbientLight(){if("GlobalSettings"in Kt&&"AmbientColor"in Kt.GlobalSettings){const e=Kt.GlobalSettings.AmbientColor.value,t=e[0],n=e[1],r=e[2];if(0!==t||0!==n||0!==r){const e=new s.Color(t,n,r);$t.add(new s.AmbientLight(e,1))}}}setupMorphMaterials(){const e=this;$t.traverse((function(t){t.isMesh&&t.geometry.morphAttributes.position&&t.geometry.morphAttributes.position.length&&(Array.isArray(t.material)?t.material.forEach((function(n,s){e.setupMorphMaterial(t,n,s)})):e.setupMorphMaterial(t,t.material))}))}setupMorphMaterial(e,t,n){const s=e.uuid,r=t.uuid;let o=!1;if($t.traverse((function(e){e.isMesh&&(Array.isArray(e.material)?e.material.forEach((function(t){t.uuid===r&&e.uuid!==s&&(o=!0)})):e.material.uuid===r&&e.uuid!==s&&(o=!0))})),!0===o){const s=t.clone();s.morphTargets=!0,void 0===n?e.material=s:e.material[n]=s}else t.morphTargets=!0}}class Jt{parse(e){const t=new Map;if("Geometry"in Kt.Objects){const n=Kt.Objects.Geometry;for(const s in n){const r=Yt.get(parseInt(s)),o=this.parseGeometry(r,n[s],e);t.set(parseInt(s),o)}}return t}parseGeometry(e,t,n){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,n);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,n){const s=n.skeletons,r=[],o=e.parents.map((function(e){return Kt.Objects.Model[e.ID]}));if(0===o.length)return;const i=e.children.reduce((function(e,t){return void 0!==s[t.ID]&&(e=s[t.ID]),e}),null);e.children.forEach((function(e){void 0!==n.morphTargets[e.ID]&&r.push(n.morphTargets[e.ID])}));const a=o[0],l={};"RotationOrder"in a&&(l.eulerOrder=pn(a.RotationOrder.value)),"InheritType"in a&&(l.inheritType=parseInt(a.InheritType.value)),"GeometricTranslation"in a&&(l.translation=a.GeometricTranslation.value),"GeometricRotation"in a&&(l.rotation=a.GeometricRotation.value),"GeometricScaling"in a&&(l.scale=a.GeometricScaling.value);const c=dn(l);return this.genGeometry(t,i,r,c)}genGeometry(e,t,n,r){const o=new s.BufferGeometry;e.attrName&&(o.name=e.attrName);const i=this.parseGeoNode(e,t),a=this.genBuffers(i),l=new s.Float32BufferAttribute(a.vertex,3);if(l.applyMatrix4(r),o.setAttribute("position",l),a.colors.length>0&&o.setAttribute("color",new s.Float32BufferAttribute(a.colors,3)),t&&(o.setAttribute("skinIndex",new s.Uint16BufferAttribute(a.weightsIndices,4)),o.setAttribute("skinWeight",new s.Float32BufferAttribute(a.vertexWeights,4)),o.FBX_Deformer=t),a.normal.length>0){const e=(new s.Matrix3).getNormalMatrix(r),t=new s.Float32BufferAttribute(a.normal,3);t.applyNormalMatrix(e),o.setAttribute("normal",t)}if(a.uvs.forEach((function(e,t){let n="uv"+(t+1).toString();0===t&&(n="uv"),o.setAttribute(n,new s.Float32BufferAttribute(a.uvs[t],2))})),i.material&&"AllSame"!==i.material.mappingType){let e=a.materialIndex[0],t=0;if(a.materialIndex.forEach((function(n,s){n!==e&&(o.addGroup(t,s-t,e),e=n,t=s)})),o.groups.length>0){const t=o.groups[o.groups.length-1],n=t.start+t.count;n!==a.materialIndex.length&&o.addGroup(n,a.materialIndex.length-n,e)}0===o.groups.length&&o.addGroup(0,a.materialIndex.length,a.materialIndex[0])}return this.addMorphTargets(o,e,n,r),o}parseGeoNode(e,t){const n={};if(n.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],n.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(n.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(n.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(n.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){n.uv=[];let t=0;for(;e.LayerElementUV[t];)e.LayerElementUV[t].UV&&n.uv.push(this.parseUVs(e.LayerElementUV[t])),t++}return n.weightTable={},null!==t&&(n.skeleton=t,t.rawBones.forEach((function(e,t){e.indices.forEach((function(s,r){void 0===n.weightTable[s]&&(n.weightTable[s]=[]),n.weightTable[s].push({id:t,weight:e.weights[r]})}))}))),n}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let n=0,s=0,r=!1,o=[],i=[],a=[],l=[],c=[],h=[];const u=this;return e.vertexIndices.forEach((function(d,p){let m,f=!1;d<0&&(d^=-1,f=!0);let g=[],v=[];if(o.push(3*d,3*d+1,3*d+2),e.color){const t=cn(p,n,d,e.color);a.push(t[0],t[1],t[2])}if(e.skeleton){if(void 0!==e.weightTable[d]&&e.weightTable[d].forEach((function(e){v.push(e.weight),g.push(e.id)})),v.length>4){r||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),r=!0);const e=[0,0,0,0],t=[0,0,0,0];v.forEach((function(n,s){let r=n,o=g[s];t.forEach((function(t,n,s){if(r>t){s[n]=r,r=t;const i=e[n];e[n]=o,o=i}}))})),g=e,v=t}for(;v.length<4;)v.push(0),g.push(0);for(let e=0;e<4;++e)c.push(v[e]),h.push(g[e])}if(e.normal){const t=cn(p,n,d,e.normal);i.push(t[0],t[1],t[2])}e.material&&"AllSame"!==e.material.mappingType&&(m=cn(p,n,d,e.material)[0]),e.uv&&e.uv.forEach((function(e,t){const s=cn(p,n,d,e);void 0===l[t]&&(l[t]=[]),l[t].push(s[0]),l[t].push(s[1])})),s++,f&&(u.genFace(t,e,o,m,i,a,l,c,h,s),n++,s=0,o=[],i=[],a=[],l=[],c=[],h=[])})),t}genFace(e,t,n,s,r,o,i,a,l,c){for(let h=2;h<c;h++)e.vertex.push(t.vertexPositions[n[0]]),e.vertex.push(t.vertexPositions[n[1]]),e.vertex.push(t.vertexPositions[n[2]]),e.vertex.push(t.vertexPositions[n[3*(h-1)]]),e.vertex.push(t.vertexPositions[n[3*(h-1)+1]]),e.vertex.push(t.vertexPositions[n[3*(h-1)+2]]),e.vertex.push(t.vertexPositions[n[3*h]]),e.vertex.push(t.vertexPositions[n[3*h+1]]),e.vertex.push(t.vertexPositions[n[3*h+2]]),t.skeleton&&(e.vertexWeights.push(a[0]),e.vertexWeights.push(a[1]),e.vertexWeights.push(a[2]),e.vertexWeights.push(a[3]),e.vertexWeights.push(a[4*(h-1)]),e.vertexWeights.push(a[4*(h-1)+1]),e.vertexWeights.push(a[4*(h-1)+2]),e.vertexWeights.push(a[4*(h-1)+3]),e.vertexWeights.push(a[4*h]),e.vertexWeights.push(a[4*h+1]),e.vertexWeights.push(a[4*h+2]),e.vertexWeights.push(a[4*h+3]),e.weightsIndices.push(l[0]),e.weightsIndices.push(l[1]),e.weightsIndices.push(l[2]),e.weightsIndices.push(l[3]),e.weightsIndices.push(l[4*(h-1)]),e.weightsIndices.push(l[4*(h-1)+1]),e.weightsIndices.push(l[4*(h-1)+2]),e.weightsIndices.push(l[4*(h-1)+3]),e.weightsIndices.push(l[4*h]),e.weightsIndices.push(l[4*h+1]),e.weightsIndices.push(l[4*h+2]),e.weightsIndices.push(l[4*h+3])),t.color&&(e.colors.push(o[0]),e.colors.push(o[1]),e.colors.push(o[2]),e.colors.push(o[3*(h-1)]),e.colors.push(o[3*(h-1)+1]),e.colors.push(o[3*(h-1)+2]),e.colors.push(o[3*h]),e.colors.push(o[3*h+1]),e.colors.push(o[3*h+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(s),e.materialIndex.push(s),e.materialIndex.push(s)),t.normal&&(e.normal.push(r[0]),e.normal.push(r[1]),e.normal.push(r[2]),e.normal.push(r[3*(h-1)]),e.normal.push(r[3*(h-1)+1]),e.normal.push(r[3*(h-1)+2]),e.normal.push(r[3*h]),e.normal.push(r[3*h+1]),e.normal.push(r[3*h+2])),t.uv&&t.uv.forEach((function(t,n){void 0===e.uvs[n]&&(e.uvs[n]=[]),e.uvs[n].push(i[n][0]),e.uvs[n].push(i[n][1]),e.uvs[n].push(i[n][2*(h-1)]),e.uvs[n].push(i[n][2*(h-1)+1]),e.uvs[n].push(i[n][2*h]),e.uvs[n].push(i[n][2*h+1])}))}addMorphTargets(e,t,n,s){if(0===n.length)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const r=this;n.forEach((function(n){n.rawTargets.forEach((function(n){const o=Kt.Objects.Geometry[n.geoID];void 0!==o&&r.genMorphGeometry(e,t,o,s,n.name)}))}))}genMorphGeometry(e,t,n,r,o){const i=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],a=void 0!==n.Vertices?n.Vertices.a:[],l=void 0!==n.Indexes?n.Indexes.a:[],c=3*e.attributes.position.count,h=new Float32Array(c);for(let e=0;e<l.length;e++){const t=3*l[e];h[t]=a[3*e],h[t+1]=a[3*e+1],h[t+2]=a[3*e+2]}const u={vertexIndices:i,vertexPositions:h},d=this.genBuffers(u),p=new s.Float32BufferAttribute(d.vertex,3);p.name=o||n.attrName,p.applyMatrix4(r),e.morphAttributes.position.push(p)}parseNormals(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,s=e.Normals.a;let r=[];return"IndexToDirect"===n&&("NormalIndex"in e?r=e.NormalIndex.a:"NormalsIndex"in e&&(r=e.NormalsIndex.a)),{dataSize:3,buffer:s,indices:r,mappingType:t,referenceType:n}}parseUVs(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,s=e.UV.a;let r=[];return"IndexToDirect"===n&&(r=e.UVIndex.a),{dataSize:2,buffer:s,indices:r,mappingType:t,referenceType:n}}parseVertexColors(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,s=e.Colors.a;let r=[];return"IndexToDirect"===n&&(r=e.ColorIndex.a),{dataSize:4,buffer:s,indices:r,mappingType:t,referenceType:n}}parseMaterialIndices(e){const t=e.MappingInformationType,n=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:n};const s=e.Materials.a,r=[];for(let e=0;e<s.length;++e)r.push(e);return{dataSize:1,buffer:s,indices:r,mappingType:t,referenceType:n}}parseNurbsGeometry(e){if(void 0===qt)return console.error("THREE.FBXLoader: The loader relies on NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new s.BufferGeometry;const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new s.BufferGeometry;const n=t-1,r=e.KnotVector.a,o=[],i=e.Points.a;for(let e=0,t=i.length;e<t;e+=4)o.push((new s.Vector4).fromArray(i,e));let a,l;if("Closed"===e.Form)o.push(o[0]);else if("Periodic"===e.Form){a=n,l=r.length-1-a;for(let e=0;e<n;++e)o.push(o[e])}const c=new qt(n,r,o,a,l).getPoints(7*o.length),h=new Float32Array(3*c.length);c.forEach((function(e,t){e.toArray(h,3*t)}));const u=new s.BufferGeometry;return u.setAttribute("position",new s.BufferAttribute(h,3)),u}}class en{parse(){const e=[],t=this.parseClips();if(void 0!==t)for(const n in t){const s=t[n],r=this.addClip(s);e.push(r)}return e}parseClips(){if(void 0===Kt.Objects.AnimationCurve)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=Kt.Objects.AnimationCurveNode,t=new Map;for(const n in e){const s=e[n];if(null!==s.attrName.match(/S|R|T|DeformPercent/)){const e={id:s.id,attr:s.attrName,curves:{}};t.set(e.id,e)}}return t}parseAnimationCurves(e){const t=Kt.Objects.AnimationCurve;for(const n in t){const s={id:t[n].id,times:t[n].KeyTime.a.map(an),values:t[n].KeyValueFloat.a},r=Yt.get(s.id);if(void 0!==r){const t=r.parents[0].ID,n=r.parents[0].relationship;n.match(/X/)?e.get(t).curves.x=s:n.match(/Y/)?e.get(t).curves.y=s:n.match(/Z/)?e.get(t).curves.z=s:n.match(/d|DeformPercent/)&&e.has(t)&&(e.get(t).curves.morph=s)}}}parseAnimationLayers(e){const t=Kt.Objects.AnimationLayer,n=new Map;for(const r in t){const t=[],o=Yt.get(parseInt(r));void 0!==o&&(o.children.forEach((function(n,r){if(e.has(n.ID)){const o=e.get(n.ID);if(void 0!==o.curves.x||void 0!==o.curves.y||void 0!==o.curves.z){if(void 0===t[r]){const e=Yt.get(n.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID;if(void 0!==e){const o=Kt.Objects.Model[e.toString()];if(void 0===o)return void console.warn("THREE.FBXLoader: Encountered a unused curve.",n);const i={modelName:o.attrName?s.PropertyBinding.sanitizeNodeName(o.attrName):"",ID:o.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};$t.traverse((function(e){e.ID===o.id&&(i.transform=e.matrix,e.userData.transformData&&(i.eulerOrder=e.userData.transformData.eulerOrder))})),i.transform||(i.transform=new s.Matrix4),"PreRotation"in o&&(i.preRotation=o.PreRotation.value),"PostRotation"in o&&(i.postRotation=o.PostRotation.value),t[r]=i}}t[r]&&(t[r][o.attr]=o)}else if(void 0!==o.curves.morph){if(void 0===t[r]){const e=Yt.get(n.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID,o=Yt.get(e).parents[0].ID,i=Yt.get(o).parents[0].ID,a=Yt.get(i).parents[0].ID,l=Kt.Objects.Model[a],c={modelName:l.attrName?s.PropertyBinding.sanitizeNodeName(l.attrName):"",morphName:Kt.Objects.Deformer[e].attrName};t[r]=c}t[r][o.attr]=o}}})),n.set(parseInt(r),t))}return n}parseAnimStacks(e){const t=Kt.Objects.AnimationStack,n={};for(const s in t){const r=Yt.get(parseInt(s)).children;r.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const o=e.get(r[0].ID);n[s]={name:t[s].attrName,layer:o}}return n}addClip(e){let t=[];const n=this;return e.layer.forEach((function(e){t=t.concat(n.generateTracks(e))})),new s.AnimationClip(e.name,-1,t)}generateTracks(e){const t=[];let n=new s.Vector3,r=new s.Quaternion,o=new s.Vector3;if(e.transform&&e.transform.decompose(n,r,o),n=n.toArray(),r=(new s.Euler).setFromQuaternion(r,e.eulerOrder).toArray(),o=o.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){const s=this.generateVectorTrack(e.modelName,e.T.curves,n,"position");void 0!==s&&t.push(s)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){const n=this.generateRotationTrack(e.modelName,e.R.curves,r,e.preRotation,e.postRotation,e.eulerOrder);void 0!==n&&t.push(n)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){const n=this.generateVectorTrack(e.modelName,e.S.curves,o,"scale");void 0!==n&&t.push(n)}if(void 0!==e.DeformPercent){const n=this.generateMorphTrack(e);void 0!==n&&t.push(n)}return t}generateVectorTrack(e,t,n,r){const o=this.getTimesForAllAxes(t),i=this.getKeyframeTrackValues(o,t,n);return new s.VectorKeyframeTrack(e+"."+r,o,i)}generateRotationTrack(e,t,n,r,o,i){void 0!==t.x&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(s.MathUtils.degToRad)),void 0!==t.y&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(s.MathUtils.degToRad)),void 0!==t.z&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(s.MathUtils.degToRad));const a=this.getTimesForAllAxes(t),l=this.getKeyframeTrackValues(a,t,n);void 0!==r&&((r=r.map(s.MathUtils.degToRad)).push(i),r=(new s.Euler).fromArray(r),r=(new s.Quaternion).setFromEuler(r)),void 0!==o&&((o=o.map(s.MathUtils.degToRad)).push(i),o=(new s.Euler).fromArray(o),o=(new s.Quaternion).setFromEuler(o).invert());const c=new s.Quaternion,h=new s.Euler,u=[];for(let e=0;e<l.length;e+=3)h.set(l[e],l[e+1],l[e+2],i),c.setFromEuler(h),void 0!==r&&c.premultiply(r),void 0!==o&&c.multiply(o),c.toArray(u,e/3*4);return new s.QuaternionKeyframeTrack(e+".quaternion",a,u)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,n=t.values.map((function(e){return e/100})),r=$t.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new s.NumberKeyframeTrack(e.modelName+".morphTargetInfluences["+r+"]",t.times,n)}getTimesForAllAxes(e){let t=[];if(void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort((function(e,t){return e-t})),t.length>1){let e=1,n=t[0];for(let s=1;s<t.length;s++){const r=t[s];r!==n&&(t[e]=r,n=r,e++)}t=t.slice(0,e)}return t}getKeyframeTrackValues(e,t,n){const s=n,r=[];let o=-1,i=-1,a=-1;return e.forEach((function(e){if(t.x&&(o=t.x.times.indexOf(e)),t.y&&(i=t.y.times.indexOf(e)),t.z&&(a=t.z.times.indexOf(e)),-1!==o){const e=t.x.values[o];r.push(e),s[0]=e}else r.push(s[0]);if(-1!==i){const e=t.y.values[i];r.push(e),s[1]=e}else r.push(s[1]);if(-1!==a){const e=t.z.values[a];r.push(e),s[2]=e}else r.push(s[2])})),r}interpolateRotations(e){for(let t=1;t<e.values.length;t++){const n=e.values[t-1],s=e.values[t]-n,r=Math.abs(s);if(r>=180){const o=r/180,i=s/o;let a=n+i;const l=e.times[t-1],c=(e.times[t]-l)/o;let h=l+c;const u=[],d=[];for(;h<e.times[t];)u.push(h),h+=c,d.push(a),a+=i;e.times=gn(e.times,t,u),e.values=gn(e.values,t,d)}}}}class tn{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new rn,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,n=e.split(/[\r\n]+/);return n.forEach((function(e,s){const r=e.match(/^[\s\t]*;/),o=e.match(/^[\s\t]*$/);if(r||o)return;const i=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),a=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=e.match("^\\t{"+(t.currentIndent-1)+"}}");i?t.parseNodeBegin(e,i):a?t.parseNodeProperty(e,a,n[++s]):l?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)})),this.allNodes}parseNodeBegin(e,t){const n=t[1].trim().replace(/^"/,"").replace(/"$/,""),s=t[2].split(",").map((function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")})),r={name:n},o=this.parseNodeAttr(s),i=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(n,r):n in i?("PoseNode"===n?i.PoseNode.push(r):void 0!==i[n].id&&(i[n]={},i[n][i[n].id]=i[n]),""!==o.id&&(i[n][o.id]=r)):"number"==typeof o.id?(i[n]={},i[n][o.id]=r):"Properties70"!==n&&(i[n]="PoseNode"===n?[r]:r),"number"==typeof o.id&&(r.id=o.id),""!==o.name&&(r.attrName=o.name),""!==o.type&&(r.attrType=o.type),this.pushStack(r)}parseNodeAttr(e){let t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let n="",s="";return e.length>1&&(n=e[1].replace(/^(\w+)::/,""),s=e[2]),{id:t,name:n,type:s}}parseNodeProperty(e,t,n){let s=t[1].replace(/^"/,"").replace(/"$/,"").trim(),r=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===s&&","===r&&(r=n.replace(/"/g,"").replace(/,$/,"").trim());const o=this.getCurrentNode();if("Properties70"!==o.name){if("C"===s){const e=r.split(",").slice(1),t=parseInt(e[0]),n=parseInt(e[1]);let i=r.split(",").slice(3);i=i.map((function(e){return e.trim().replace(/^"/,"")})),s="connections",r=[t,n],function(e,t){for(let n=0,s=e.length,r=t.length;n<r;n++,s++)e[s]=t[n]}(r,i),void 0===o[s]&&(o[s]=[])}"Node"===s&&(o.id=r),s in o&&Array.isArray(o[s])?o[s].push(r):"a"!==s?o[s]=r:o.a=r,this.setCurrentProp(o,s),"a"===s&&","!==r.slice(-1)&&(o.a=mn(r))}else this.parseNodeSpecialProperty(e,s,r)}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=mn(t.a))}parseNodeSpecialProperty(e,t,n){const s=n.split('",').map((function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")})),r=s[0],o=s[1],i=s[2],a=s[3];let l=s[4];switch(o){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=mn(l)}this.getPrevNode()[r]={type:o,type2:i,flag:a,value:l},this.setCurrentProp(this.getPrevNode(),r)}}class nn{parse(e){const t=new sn(e);t.skip(23);const n=t.getUint32();if(n<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+n);const s=new rn;for(;!this.endOfContent(t);){const e=this.parseNode(t,n);null!==e&&s.add(e.name,e)}return s}endOfContent(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const n={},s=t>=7500?e.getUint64():e.getUint32(),r=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const o=e.getUint8(),i=e.getString(o);if(0===s)return null;const a=[];for(let t=0;t<r;t++)a.push(this.parseProperty(e));const l=a.length>0?a[0]:"",c=a.length>1?a[1]:"",h=a.length>2?a[2]:"";for(n.singleProperty=1===r&&e.getOffset()===s;s>e.getOffset();){const s=this.parseNode(e,t);null!==s&&this.parseSubNode(i,n,s)}return n.propertyList=a,"number"==typeof l&&(n.id=l),""!==c&&(n.attrName=c),""!==h&&(n.attrType=h),""!==i&&(n.name=i),n}parseSubNode(e,t,n){if(!0===n.singleProperty){const e=n.propertyList[0];Array.isArray(e)?(t[n.name]=n,n.a=e):t[n.name]=e}else if("Connections"===e&&"C"===n.name){const e=[];n.propertyList.forEach((function(t,n){0!==n&&e.push(t)})),void 0===t.connections&&(t.connections=[]),t.connections.push(e)}else if("Properties70"===n.name)Object.keys(n).forEach((function(e){t[e]=n[e]}));else if("Properties70"===e&&"P"===n.name){let e=n.propertyList[0],s=n.propertyList[1];const r=n.propertyList[2],o=n.propertyList[3];let i;0===e.indexOf("Lcl ")&&(e=e.replace("Lcl ","Lcl_")),0===s.indexOf("Lcl ")&&(s=s.replace("Lcl ","Lcl_")),i="Color"===s||"ColorRGB"===s||"Vector"===s||"Vector3D"===s||0===s.indexOf("Lcl_")?[n.propertyList[4],n.propertyList[5],n.propertyList[6]]:n.propertyList[4],t[e]={type:s,type2:r,flag:o,value:i}}else void 0===t[n.name]?"number"==typeof n.id?(t[n.name]={},t[n.name][n.id]=n):t[n.name]=n:"PoseNode"===n.name?(Array.isArray(t[n.name])||(t[n.name]=[t[n.name]]),t[n.name].push(n)):void 0===t[n.name][n.id]&&(t[n.name][n.id]=n)}parseProperty(t){const n=t.getString(1);let s;switch(n){case"C":return t.getBoolean();case"D":return t.getFloat64();case"F":return t.getFloat32();case"I":return t.getInt32();case"L":return t.getInt64();case"R":return s=t.getUint32(),t.getArrayBuffer(s);case"S":return s=t.getUint32(),t.getString(s);case"Y":return t.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const r=t.getUint32(),o=t.getUint32(),i=t.getUint32();if(0===o)switch(n){case"b":case"c":return t.getBooleanArray(r);case"d":return t.getFloat64Array(r);case"f":return t.getFloat32Array(r);case"i":return t.getInt32Array(r);case"l":return t.getInt64Array(r)}void 0===e&&console.error("THREE.FBXLoader: External library fflate.min.js required.");const a=pt(new Uint8Array(t.getArrayBuffer(i))),l=new sn(a.buffer);switch(n){case"b":case"c":return l.getBooleanArray(r);case"d":return l.getFloat64Array(r);case"f":return l.getFloat32Array(r);case"i":return l.getInt32Array(r);case"l":return l.getInt64Array(r)}default:throw new Error("THREE.FBXLoader: Unknown property type "+n)}}}class sn{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return 1==(1&this.getUint8())}getBooleanArray(e){const t=[];for(let n=0;n<e;n++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,e=4294967295&~e,4294967295===e&&(t=t+1&4294967295),e=e+1&4294967295,-(4294967296*t+e)):4294967296*t+e}getInt64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){let t=[];for(let n=0;n<e;n++)t[n]=this.getUint8();const n=t.indexOf(0);return n>=0&&(t=t.slice(0,n)),s.LoaderUtils.decodeText(new Uint8Array(t))}}class rn{add(e,t){this[e]=t}}function on(e){const t=e.match(/FBXVersion: (\d+)/);if(t)return parseInt(t[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function an(e){return e/46186158e3}const ln=[];function cn(e,t,n,s){let r;switch(s.mappingType){case"ByPolygonVertex":r=e;break;case"ByPolygon":r=t;break;case"ByVertice":r=n;break;case"AllSame":r=s.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+s.mappingType)}"IndexToDirect"===s.referenceType&&(r=s.indices[r]);const o=r*s.dataSize,i=o+s.dataSize;return function(e,t,n,s){for(let r=n,o=0;r<s;r++,o++)e[o]=t[r];return e}(ln,s.buffer,o,i)}const hn=new s.Euler,un=new s.Vector3;function dn(e){const t=new s.Matrix4,n=new s.Matrix4,r=new s.Matrix4,o=new s.Matrix4,i=new s.Matrix4,a=new s.Matrix4,l=new s.Matrix4,c=new s.Matrix4,h=new s.Matrix4,u=new s.Matrix4,d=new s.Matrix4,p=new s.Matrix4,m=e.inheritType?e.inheritType:0;if(e.translation&&t.setPosition(un.fromArray(e.translation)),e.preRotation){const t=e.preRotation.map(s.MathUtils.degToRad);t.push(e.eulerOrder),n.makeRotationFromEuler(hn.fromArray(t))}if(e.rotation){const t=e.rotation.map(s.MathUtils.degToRad);t.push(e.eulerOrder),r.makeRotationFromEuler(hn.fromArray(t))}if(e.postRotation){const t=e.postRotation.map(s.MathUtils.degToRad);t.push(e.eulerOrder),o.makeRotationFromEuler(hn.fromArray(t)),o.invert()}e.scale&&i.scale(un.fromArray(e.scale)),e.scalingOffset&&l.setPosition(un.fromArray(e.scalingOffset)),e.scalingPivot&&a.setPosition(un.fromArray(e.scalingPivot)),e.rotationOffset&&c.setPosition(un.fromArray(e.rotationOffset)),e.rotationPivot&&h.setPosition(un.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(d.copy(e.parentMatrix),u.copy(e.parentMatrixWorld));const f=n.clone().multiply(r).multiply(o),g=new s.Matrix4;g.extractRotation(u);const v=new s.Matrix4;v.copyPosition(u);const y=v.clone().invert().multiply(u),x=g.clone().invert().multiply(y),b=i,w=new s.Matrix4;if(0===m)w.copy(g).multiply(f).multiply(x).multiply(b);else if(1===m)w.copy(g).multiply(x).multiply(f).multiply(b);else{const e=(new s.Matrix4).scale((new s.Vector3).setFromMatrixScale(d)).clone().invert(),t=x.clone().multiply(e);w.copy(g).multiply(f).multiply(t).multiply(b)}const A=h.clone().invert(),M=a.clone().invert();let _=t.clone().multiply(c).multiply(h).multiply(n).multiply(r).multiply(o).multiply(A).multiply(l).multiply(a).multiply(i).multiply(M);const T=(new s.Matrix4).copyPosition(_),S=u.clone().multiply(T);return p.copyPosition(S),_=p.clone().multiply(w),_.premultiply(u.invert()),_}function pn(e){const t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function mn(e){return e.split(",").map((function(e){return parseFloat(e)}))}function fn(e,t,n){return void 0===t&&(t=0),void 0===n&&(n=e.byteLength),s.LoaderUtils.decodeText(new Uint8Array(e,t,n))}function gn(e,t,n){return e.slice(0,t).concat(n).concat(e.slice(t))}class vn extends s.Loader{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new An(e)})),this.register((function(e){return new _n(e)})),this.register((function(e){return new Tn(e)})),this.register((function(e){return new Mn(e)})),this.register((function(e){return new bn(e)})),this.register((function(e){return new Sn(e)}))}load(e,t,n,r){const o=this;let i;i=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:s.LoaderUtils.extractUrlBase(e),this.manager.itemStart(e);const a=function(t){r?r(t):console.error(t),o.manager.itemError(e),o.manager.itemEnd(e)},l=new s.FileLoader(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,(function(n){try{o.parse(n,i,(function(n){t(n),o.manager.itemEnd(e)}),a)}catch(e){a(e)}}),n,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,r){let o;const i={},a={};if("string"==typeof e)o=e;else if(s.LoaderUtils.decodeText(new Uint8Array(e,0,4))===En){try{i[xn.KHR_BINARY_GLTF]=new Pn(e)}catch(e){return void(r&&r(e))}o=i[xn.KHR_BINARY_GLTF].content}else o=s.LoaderUtils.decodeText(new Uint8Array(e));const l=JSON.parse(o);if(void 0===l.asset||l.asset.version[0]<2)return void(r&&r(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const c=new Yn(l,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](c);a[t.name]=t,i[t.name]=!0}if(l.extensionsUsed)for(let e=0;e<l.extensionsUsed.length;++e){const t=l.extensionsUsed[e],n=l.extensionsRequired||[];switch(t){case xn.KHR_MATERIALS_UNLIT:i[t]=new wn;break;case xn.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:i[t]=new Vn;break;case xn.KHR_DRACO_MESH_COMPRESSION:i[t]=new Cn(l,this.dracoLoader);break;case xn.KHR_TEXTURE_TRANSFORM:i[t]=new Rn;break;case xn.KHR_MESH_QUANTIZATION:i[t]=new kn;break;default:n.indexOf(t)>=0&&void 0===a[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}c.setExtensions(i),c.setPlugins(a),c.parse(n,r)}}function yn(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const xn={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};class bn{constructor(e){this.parser=e,this.name=xn.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let n=0,s=t.length;n<s;n++){const s=t[n];s.extensions&&s.extensions[this.name]&&void 0!==s.extensions[this.name].light&&e._addNodeRef(this.cache,s.extensions[this.name].light)}}_loadLight(e){const t=this.parser,n="light:"+e;let r=t.cache.get(n);if(r)return r;const o=t.json,i=((o.extensions&&o.extensions[this.name]||{}).lights||[])[e];let a;const l=new s.Color(16777215);void 0!==i.color&&l.fromArray(i.color);const c=void 0!==i.range?i.range:0;switch(i.type){case"directional":a=new s.DirectionalLight(l),a.target.position.set(0,0,-1),a.add(a.target);break;case"point":a=new s.PointLight(l),a.distance=c;break;case"spot":a=new s.SpotLight(l),a.distance=c,i.spot=i.spot||{},i.spot.innerConeAngle=void 0!==i.spot.innerConeAngle?i.spot.innerConeAngle:0,i.spot.outerConeAngle=void 0!==i.spot.outerConeAngle?i.spot.outerConeAngle:Math.PI/4,a.angle=i.spot.outerConeAngle,a.penumbra=1-i.spot.innerConeAngle/i.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+i.type)}return a.position.set(0,0,0),a.decay=2,void 0!==i.intensity&&(a.intensity=i.intensity),a.name=t.createUniqueName(i.name||"light_"+e),r=Promise.resolve(a),t.cache.add(n,r),r}createNodeAttachment(e){const t=this,n=this.parser,s=n.json.nodes[e],r=(s.extensions&&s.extensions[this.name]||{}).light;return void 0===r?null:this._loadLight(r).then((function(e){return n._getNodeRef(t.cache,r,e)}))}}class wn{constructor(){this.name=xn.KHR_MATERIALS_UNLIT}getMaterialType(){return s.MeshBasicMaterial}extendParams(e,t,n){const r=[];e.color=new s.Color(1,1,1),e.opacity=1;const o=t.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){const t=o.baseColorFactor;e.color.fromArray(t),e.opacity=t[3]}void 0!==o.baseColorTexture&&r.push(n.assignTexture(e,"map",o.baseColorTexture))}return Promise.all(r)}}class An{constructor(e){this.parser=e,this.name=xn.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const o=[],i=r.extensions[this.name];if(void 0!==i.clearcoatFactor&&(t.clearcoat=i.clearcoatFactor),void 0!==i.clearcoatTexture&&o.push(n.assignTexture(t,"clearcoatMap",i.clearcoatTexture)),void 0!==i.clearcoatRoughnessFactor&&(t.clearcoatRoughness=i.clearcoatRoughnessFactor),void 0!==i.clearcoatRoughnessTexture&&o.push(n.assignTexture(t,"clearcoatRoughnessMap",i.clearcoatRoughnessTexture)),void 0!==i.clearcoatNormalTexture&&(o.push(n.assignTexture(t,"clearcoatNormalMap",i.clearcoatNormalTexture)),void 0!==i.clearcoatNormalTexture.scale)){const e=i.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new s.Vector2(e,-e)}return Promise.all(o)}}class Mn{constructor(e){this.parser=e,this.name=xn.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],o=s.extensions[this.name];return void 0!==o.transmissionFactor&&(t.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&r.push(n.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(r)}}class _n{constructor(e){this.parser=e,this.name=xn.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,n=t.json,s=n.textures[e];if(!s.extensions||!s.extensions[this.name])return null;const r=s.extensions[this.name],o=n.images[r.source],i=t.options.ktx2Loader;if(!i){if(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,o,i)}}class Tn{constructor(e){this.parser=e,this.name=xn.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,s=n.json,r=s.textures[e];if(!r.extensions||!r.extensions[t])return null;const o=r.extensions[t],i=s.images[o.source];let a=n.textureLoader;if(i.uri){const e=n.options.manager.getHandler(i.uri);null!==e&&(a=e)}return this.detectSupport().then((function(r){if(r)return n.loadTextureImage(e,i,a);if(s.extensionsRequired&&s.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return n.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class Sn{constructor(e){this.name=xn.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,n=t.bufferViews[e];if(n.extensions&&n.extensions[this.name]){const e=n.extensions[this.name],s=this.parser.getDependency("buffer",e.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([s,r.ready]).then((function(t){const n=e.byteOffset||0,s=e.byteLength||0,o=e.count,i=e.byteStride,a=new ArrayBuffer(o*i),l=new Uint8Array(t[0],n,s);return r.decodeGltfBuffer(new Uint8Array(a),o,i,l,e.mode,e.filter),a}))}return null}}const En="glTF";class Pn{constructor(e){this.name=xn.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12);if(this.header={magic:s.LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==En)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-12,r=new DataView(e,12);let o=0;for(;o<n;){const t=r.getUint32(o,!0);o+=4;const n=r.getUint32(o,!0);if(o+=4,1313821514===n){const n=new Uint8Array(e,12+o,t);this.content=s.LoaderUtils.decodeText(n)}else if(5130562===n){const n=12+o;this.body=e.slice(n,n+t)}o+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Cn{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=xn.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const n=this.json,s=this.dracoLoader,r=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,i={},a={},l={};for(const e in o){const t=Fn[e]||e.toLowerCase();i[t]=o[e]}for(const t in e.attributes){const s=Fn[t]||t.toLowerCase();if(void 0!==o[t]){const r=n.accessors[e.attributes[t]],o=On[r.componentType];l[s]=o,a[s]=!0===r.normalized}}return t.getDependency("bufferView",r).then((function(e){return new Promise((function(t){s.decodeDracoFile(e,(function(e){for(const t in e.attributes){const n=e.attributes[t],s=a[t];void 0!==s&&(n.normalized=s)}t(e)}),i,l)}))}))}}class Rn{constructor(){this.name=xn.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Ln extends s.MeshStandardMaterial{constructor(e){super(),this.isGLTFSpecularGlossinessMaterial=!0;const t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),n=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),r=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),o=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),i=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),a={specular:{value:(new s.Color).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=a,this.onBeforeCompile=function(e){for(const t in a)e.uniforms[t]=a[t];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",t).replace("#include <metalnessmap_pars_fragment>",n).replace("#include <roughnessmap_fragment>",r).replace("#include <metalnessmap_fragment>",o).replace("#include <lights_physical_fragment>",i)},Object.defineProperties(this,{specular:{get:function(){return a.specular.value},set:function(e){a.specular.value=e}},specularMap:{get:function(){return a.specularMap.value},set:function(e){a.specularMap.value=e,e?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return a.glossiness.value},set:function(e){a.glossiness.value=e}},glossinessMap:{get:function(){return a.glossinessMap.value},set:function(e){a.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}copy(e){return super.copy(e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}class Vn{constructor(){this.name=xn.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"]}getMaterialType(){return Ln}extendParams(e,t,n){const r=t.extensions[this.name];e.color=new s.Color(1,1,1),e.opacity=1;const o=[];if(Array.isArray(r.diffuseFactor)){const t=r.diffuseFactor;e.color.fromArray(t),e.opacity=t[3]}if(void 0!==r.diffuseTexture&&o.push(n.assignTexture(e,"map",r.diffuseTexture)),e.emissive=new s.Color(0,0,0),e.glossiness=void 0!==r.glossinessFactor?r.glossinessFactor:1,e.specular=new s.Color(1,1,1),Array.isArray(r.specularFactor)&&e.specular.fromArray(r.specularFactor),void 0!==r.specularGlossinessTexture){const t=r.specularGlossinessTexture;o.push(n.assignTexture(e,"glossinessMap",t)),o.push(n.assignTexture(e,"specularMap",t))}return Promise.all(o)}createMaterial(e){const t=new Ln(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=s.TangentSpaceNormalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}class kn{constructor(){this.name=xn.KHR_MESH_QUANTIZATION}}class In extends s.Interpolant{constructor(e,t,n,s){super(e,t,n,s)}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,s=this.valueSize,r=e*s*3+s;for(let e=0;e!==s;e++)t[e]=n[r+e];return t}}In.prototype.beforeStart_=In.prototype.copySampleValue_,In.prototype.afterEnd_=In.prototype.copySampleValue_,In.prototype.interpolate_=function(e,t,n,s){const r=this.resultBuffer,o=this.sampleValues,i=this.valueSize,a=2*i,l=3*i,c=s-t,h=(n-t)/c,u=h*h,d=u*h,p=e*l,m=p-l,f=-2*d+3*u,g=d-u,v=1-f,y=g-u+h;for(let e=0;e!==i;e++){const t=o[m+e+i],n=o[m+e+a]*c,s=o[p+e+i],l=o[p+e]*c;r[e]=v*t+y*n+f*s+g*l}return r};const On={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Nn={9728:s.NearestFilter,9729:s.LinearFilter,9984:s.NearestMipmapNearestFilter,9985:s.LinearMipmapNearestFilter,9986:s.NearestMipmapLinearFilter,9987:s.LinearMipmapLinearFilter},Bn={33071:s.ClampToEdgeWrapping,33648:s.MirroredRepeatWrapping,10497:s.RepeatWrapping},Dn={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Fn={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Un={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},zn={CUBICSPLINE:void 0,LINEAR:s.InterpolateLinear,STEP:s.InterpolateDiscrete};function jn(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function Hn(e,t,n){for(const s in n.extensions)void 0===e[s]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[s]=n.extensions[s])}function Gn(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function Wn(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,s=t.weights.length;n<s;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){const n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,s=n.length;t<s;t++)e.morphTargetDictionary[n[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Xn(e){const t=e.extensions&&e.extensions[xn.KHR_DRACO_MESH_COMPRESSION];let n;return n=t?"draco:"+t.bufferView+":"+t.indices+":"+qn(t.attributes):e.indices+":"+qn(e.attributes)+":"+e.mode,n}function qn(e){let t="";const n=Object.keys(e).sort();for(let s=0,r=n.length;s<r;s++)t+=n[s]+":"+e[n[s]]+";";return t}function Kn(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}class Yn{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new yn,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.textureCache={},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new s.ImageBitmapLoader(this.options.manager):this.textureLoader=new s.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new s.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const n=this,s=this.json,r=this.extensions;this.cache.removeAll(),this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])})).then((function(t){const o={scene:t[0][s.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:s.asset,parser:n,userData:{}};Hn(r,o,s),Gn(o,s),Promise.all(n._invokeAll((function(e){return e.afterRoot&&e.afterRoot(o)}))).then((function(){e(o)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let n=0,s=t.length;n<s;n++){const s=t[n].joints;for(let t=0,n=s.length;t<n;t++)e[s[t]].isBone=!0}for(let t=0,s=e.length;t<s;t++){const s=e[t];void 0!==s.mesh&&(this._addNodeRef(this.meshCache,s.mesh),void 0!==s.skin&&(n[s.mesh].isSkinnedMesh=!0)),void 0!==s.camera&&this._addNodeRef(this.cameraCache,s.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;const s=n.clone();return s.name+="_instance_"+e.uses[t]++,s}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){const s=e(t[n]);if(s)return s}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const n=[];for(let s=0;s<t.length;s++){const r=e(t[s]);r&&n.push(r)}return n}getDependency(e,t){const n=e+":"+t;let s=this.cache.get(n);if(!s){switch(e){case"scene":s=this.loadScene(t);break;case"node":s=this.loadNode(t);break;case"mesh":s=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":s=this.loadAccessor(t);break;case"bufferView":s=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":s=this.loadBuffer(t);break;case"material":s=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":s=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":s=this.loadSkin(t);break;case"animation":s=this.loadAnimation(t);break;case"camera":s=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(n,s)}return s}getDependencies(e){let t=this.cache.get(e);if(!t){const n=this,s=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(s.map((function(t,s){return n.getDependency(e,s)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[xn.KHR_BINARY_GLTF].body);const s=this.options;return new Promise((function(e,r){n.load(jn(t.uri,s.path),e,void 0,(function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const n=t.byteLength||0,s=t.byteOffset||0;return e.slice(s,s+n)}))}loadAccessor(e){const t=this,n=this.json,r=this.json.accessors[e];if(void 0===r.bufferView&&void 0===r.sparse)return Promise.resolve(null);const o=[];return void 0!==r.bufferView?o.push(this.getDependency("bufferView",r.bufferView)):o.push(null),void 0!==r.sparse&&(o.push(this.getDependency("bufferView",r.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",r.sparse.values.bufferView))),Promise.all(o).then((function(e){const o=e[0],i=Dn[r.type],a=On[r.componentType],l=a.BYTES_PER_ELEMENT,c=l*i,h=r.byteOffset||0,u=void 0!==r.bufferView?n.bufferViews[r.bufferView].byteStride:void 0,d=!0===r.normalized;let p,m;if(u&&u!==c){const e=Math.floor(h/u),n="InterleavedBuffer:"+r.bufferView+":"+r.componentType+":"+e+":"+r.count;let c=t.cache.get(n);c||(p=new a(o,e*u,r.count*u/l),c=new s.InterleavedBuffer(p,u/l),t.cache.add(n,c)),m=new s.InterleavedBufferAttribute(c,i,h%u/l,d)}else p=null===o?new a(r.count*i):new a(o,h,r.count*i),m=new s.BufferAttribute(p,i,d);if(void 0!==r.sparse){const t=Dn.SCALAR,n=On[r.sparse.indices.componentType],l=r.sparse.indices.byteOffset||0,c=r.sparse.values.byteOffset||0,h=new n(e[1],l,r.sparse.count*t),u=new a(e[2],c,r.sparse.count*i);null!==o&&(m=new s.BufferAttribute(m.array.slice(),m.itemSize,m.normalized));for(let e=0,t=h.length;e<t;e++){const t=h[e];if(m.setX(t,u[e*i]),i>=2&&m.setY(t,u[e*i+1]),i>=3&&m.setZ(t,u[e*i+2]),i>=4&&m.setW(t,u[e*i+3]),i>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return m}))}loadTexture(e){const t=this.json,n=this.options,s=t.textures[e],r=t.images[s.source];let o=this.textureLoader;if(r.uri){const e=n.manager.getHandler(r.uri);null!==e&&(o=e)}return this.loadTextureImage(e,r,o)}loadTextureImage(e,t,n){const r=this,o=this.json,i=this.options,a=o.textures[e],l=(t.uri||t.bufferView)+":"+a.sampler;if(this.textureCache[l])return this.textureCache[l];const c=self.URL||self.webkitURL;let h=t.uri||"",u=!1,d=!0;const p=h.search(/\.jpe?g($|\?)/i)>0||0===h.search(/^data\:image\/jpeg/);if(("image/jpeg"===t.mimeType||p)&&(d=!1),void 0!==t.bufferView)h=r.getDependency("bufferView",t.bufferView).then((function(e){if("image/png"===t.mimeType){const t=new DataView(e,25,1).getUint8(0,!1);d=6===t||4===t||3===t}u=!0;const n=new Blob([e],{type:t.mimeType});return h=c.createObjectURL(n),h}));else if(void 0===t.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const m=Promise.resolve(h).then((function(e){return new Promise((function(t,r){let o=t;!0===n.isImageBitmapLoader&&(o=function(e){const n=new s.Texture(e);n.needsUpdate=!0,t(n)}),n.load(jn(e,i.path),o,void 0,r)}))})).then((function(t){!0===u&&c.revokeObjectURL(h),t.flipY=!1,a.name&&(t.name=a.name),d||(t.format=s.RGBFormat);const n=(o.samplers||{})[a.sampler]||{};return t.magFilter=Nn[n.magFilter]||s.LinearFilter,t.minFilter=Nn[n.minFilter]||s.LinearMipmapLinearFilter,t.wrapS=Bn[n.wrapS]||s.RepeatWrapping,t.wrapT=Bn[n.wrapT]||s.RepeatWrapping,r.associations.set(t,{type:"textures",index:e}),t})).catch((function(){return console.error("THREE.GLTFLoader: Couldn't load texture",h),null}));return this.textureCache[l]=m,m}assignTexture(e,t,n){const s=this;return this.getDependency("texture",n.index).then((function(r){if(void 0===n.texCoord||0==n.texCoord||"aoMap"===t&&1==n.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+n.texCoord+" for texture "+t+" not yet supported."),s.extensions[xn.KHR_TEXTURE_TRANSFORM]){const e=void 0!==n.extensions?n.extensions[xn.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=s.associations.get(r);r=s.extensions[xn.KHR_TEXTURE_TRANSFORM].extendTexture(r,e),s.associations.set(r,t)}}e[t]=r}))}assignFinalMaterial(e){const t=e.geometry;let n=e.material;const r=void 0!==t.attributes.tangent,o=void 0!==t.attributes.color,i=void 0===t.attributes.normal,a=Object.keys(t.morphAttributes).length>0,l=a&&void 0!==t.morphAttributes.normal;if(e.isPoints){const e="PointsMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new s.PointsMaterial,s.Material.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,t.sizeAttenuation=!1,this.cache.add(e,t)),n=t}else if(e.isLine){const e="LineBasicMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new s.LineBasicMaterial,s.Material.prototype.copy.call(t,n),t.color.copy(n.color),this.cache.add(e,t)),n=t}if(r||o||i||a){let e="ClonedMaterial:"+n.uuid+":";n.isGLTFSpecularGlossinessMaterial&&(e+="specular-glossiness:"),r&&(e+="vertex-tangents:"),o&&(e+="vertex-colors:"),i&&(e+="flat-shading:"),a&&(e+="morph-targets:"),l&&(e+="morph-normals:");let t=this.cache.get(e);t||(t=n.clone(),o&&(t.vertexColors=!0),i&&(t.flatShading=!0),a&&(t.morphTargets=!0),l&&(t.morphNormals=!0),r&&(t.vertexTangents=!0,t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(n))),n=t}n.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),e.material=n}getMaterialType(){return s.MeshStandardMaterial}loadMaterial(e){const t=this,n=this.json,r=this.extensions,o=n.materials[e];let i;const a={},l=o.extensions||{},c=[];if(l[xn.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){const e=r[xn.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];i=e.getMaterialType(),c.push(e.extendParams(a,o,t))}else if(l[xn.KHR_MATERIALS_UNLIT]){const e=r[xn.KHR_MATERIALS_UNLIT];i=e.getMaterialType(),c.push(e.extendParams(a,o,t))}else{const n=o.pbrMetallicRoughness||{};if(a.color=new s.Color(1,1,1),a.opacity=1,Array.isArray(n.baseColorFactor)){const e=n.baseColorFactor;a.color.fromArray(e),a.opacity=e[3]}void 0!==n.baseColorTexture&&c.push(t.assignTexture(a,"map",n.baseColorTexture)),a.metalness=void 0!==n.metallicFactor?n.metallicFactor:1,a.roughness=void 0!==n.roughnessFactor?n.roughnessFactor:1,void 0!==n.metallicRoughnessTexture&&(c.push(t.assignTexture(a,"metalnessMap",n.metallicRoughnessTexture)),c.push(t.assignTexture(a,"roughnessMap",n.metallicRoughnessTexture))),i=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),c.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,a)}))))}!0===o.doubleSided&&(a.side=s.DoubleSide);const h=o.alphaMode||"OPAQUE";return"BLEND"===h?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,"MASK"===h&&(a.alphaTest=void 0!==o.alphaCutoff?o.alphaCutoff:.5)),void 0!==o.normalTexture&&i!==s.MeshBasicMaterial&&(c.push(t.assignTexture(a,"normalMap",o.normalTexture)),a.normalScale=new s.Vector2(1,-1),void 0!==o.normalTexture.scale&&a.normalScale.set(o.normalTexture.scale,-o.normalTexture.scale)),void 0!==o.occlusionTexture&&i!==s.MeshBasicMaterial&&(c.push(t.assignTexture(a,"aoMap",o.occlusionTexture)),void 0!==o.occlusionTexture.strength&&(a.aoMapIntensity=o.occlusionTexture.strength)),void 0!==o.emissiveFactor&&i!==s.MeshBasicMaterial&&(a.emissive=(new s.Color).fromArray(o.emissiveFactor)),void 0!==o.emissiveTexture&&i!==s.MeshBasicMaterial&&c.push(t.assignTexture(a,"emissiveMap",o.emissiveTexture)),Promise.all(c).then((function(){let n;return n=i===Ln?r[xn.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(a):new i(a),o.name&&(n.name=o.name),n.map&&(n.map.encoding=s.sRGBEncoding),n.emissiveMap&&(n.emissiveMap.encoding=s.sRGBEncoding),Gn(n,o),t.associations.set(n,{type:"materials",index:e}),o.extensions&&Hn(r,n,o),n}))}createUniqueName(e){const t=s.PropertyBinding.sanitizeNodeName(e||"");let n=t;for(let e=1;this.nodeNamesUsed[n];++e)n=t+"_"+e;return this.nodeNamesUsed[n]=!0,n}loadGeometries(e){const t=this,n=this.extensions,r=this.primitiveCache;function o(e){return n[xn.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(n){return Qn(n,e,t)}))}const i=[];for(let n=0,a=e.length;n<a;n++){const a=e[n],l=Xn(a),c=r[l];if(c)i.push(c.promise);else{let e;e=a.extensions&&a.extensions[xn.KHR_DRACO_MESH_COMPRESSION]?o(a):Qn(new s.BufferGeometry,a,t),r[l]={primitive:a,promise:e},i.push(e)}}return Promise.all(i)}loadMesh(e){const t=this,n=this.json,r=this.extensions,o=n.meshes[e],i=o.primitives,a=[];for(let e=0,t=i.length;e<t;e++){const t=void 0===i[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new s.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:s.FrontSide})),l.DefaultMaterial):this.getDependency("material",i[e].material);a.push(t)}var l;return a.push(t.loadGeometries(i)),Promise.all(a).then((function(n){const a=n.slice(0,n.length-1),l=n[n.length-1],c=[];for(let n=0,h=l.length;n<h;n++){const h=l[n],u=i[n];let d;const p=a[n];if(4===u.mode||5===u.mode||6===u.mode||void 0===u.mode)d=!0===o.isSkinnedMesh?new s.SkinnedMesh(h,p):new s.Mesh(h,p),!0!==d.isSkinnedMesh||d.geometry.attributes.skinWeight.normalized||d.normalizeSkinWeights(),5===u.mode?d.geometry=Zn(d.geometry,s.TriangleStripDrawMode):6===u.mode&&(d.geometry=Zn(d.geometry,s.TriangleFanDrawMode));else if(1===u.mode)d=new s.LineSegments(h,p);else if(3===u.mode)d=new s.Line(h,p);else if(2===u.mode)d=new s.LineLoop(h,p);else{if(0!==u.mode)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+u.mode);d=new s.Points(h,p)}Object.keys(d.geometry.morphAttributes).length>0&&Wn(d,o),d.name=t.createUniqueName(o.name||"mesh_"+e),Gn(d,o),u.extensions&&Hn(r,d,u),t.assignFinalMaterial(d),c.push(d)}if(1===c.length)return c[0];const h=new s.Group;for(let e=0,t=c.length;e<t;e++)h.add(c[e]);return h}))}loadCamera(e){let t;const n=this.json.cameras[e],r=n[n.type];if(r)return"perspective"===n.type?t=new s.PerspectiveCamera(s.MathUtils.radToDeg(r.yfov),r.aspectRatio||1,r.znear||1,r.zfar||2e6):"orthographic"===n.type&&(t=new s.OrthographicCamera(-r.xmag,r.xmag,r.ymag,-r.ymag,r.znear,r.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),Gn(t,n),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],n={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(n):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return n.inverseBindMatrices=e,n}))}loadAnimation(e){const t=this.json.animations[e],n=[],r=[],o=[],i=[],a=[];for(let e=0,s=t.channels.length;e<s;e++){const s=t.channels[e],l=t.samplers[s.sampler],c=s.target,h=void 0!==c.node?c.node:c.id,u=void 0!==t.parameters?t.parameters[l.input]:l.input,d=void 0!==t.parameters?t.parameters[l.output]:l.output;n.push(this.getDependency("node",h)),r.push(this.getDependency("accessor",u)),o.push(this.getDependency("accessor",d)),i.push(l),a.push(c)}return Promise.all([Promise.all(n),Promise.all(r),Promise.all(o),Promise.all(i),Promise.all(a)]).then((function(n){const r=n[0],o=n[1],i=n[2],a=n[3],l=n[4],c=[];for(let e=0,t=r.length;e<t;e++){const t=r[e],n=o[e],h=i[e],u=a[e],d=l[e];if(void 0===t)continue;let p;switch(t.updateMatrix(),t.matrixAutoUpdate=!0,Un[d.path]){case Un.weights:p=s.NumberKeyframeTrack;break;case Un.rotation:p=s.QuaternionKeyframeTrack;break;case Un.position:case Un.scale:default:p=s.VectorKeyframeTrack}const m=t.name?t.name:t.uuid,f=void 0!==u.interpolation?zn[u.interpolation]:s.InterpolateLinear,g=[];Un[d.path]===Un.weights?t.traverse((function(e){!0===e.isMesh&&e.morphTargetInfluences&&g.push(e.name?e.name:e.uuid)})):g.push(m);let v=h.array;if(h.normalized){const e=Kn(v.constructor),t=new Float32Array(v.length);for(let n=0,s=v.length;n<s;n++)t[n]=v[n]*e;v=t}for(let e=0,t=g.length;e<t;e++){const t=new p(g[e]+"."+Un[d.path],n.array,v,f);"CUBICSPLINE"===u.interpolation&&(t.createInterpolant=function(e){return new In(this.times,this.values,this.getValueSize()/3,e)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),c.push(t)}}const h=t.name?t.name:"animation_"+e;return new s.AnimationClip(h,void 0,c)}))}createNodeMesh(e){const t=this.json,n=this,s=t.nodes[e];return void 0===s.mesh?null:n.getDependency("mesh",s.mesh).then((function(e){const t=n._getNodeRef(n.meshCache,s.mesh,e);return void 0!==s.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,n=s.weights.length;t<n;t++)e.morphTargetInfluences[t]=s.weights[t]})),t}))}loadNode(e){const t=this.json,n=this.extensions,r=this,o=t.nodes[e],i=o.name?r.createUniqueName(o.name):"";return function(){const t=[],n=r._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return n&&t.push(n),void 0!==o.camera&&t.push(r.getDependency("camera",o.camera).then((function(e){return r._getNodeRef(r.cameraCache,o.camera,e)}))),r._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){t.push(e)})),Promise.all(t)}().then((function(t){let a;if(a=!0===o.isBone?new s.Bone:t.length>1?new s.Group:1===t.length?t[0]:new s.Object3D,a!==t[0])for(let e=0,n=t.length;e<n;e++)a.add(t[e]);if(o.name&&(a.userData.name=o.name,a.name=i),Gn(a,o),o.extensions&&Hn(n,a,o),void 0!==o.matrix){const e=new s.Matrix4;e.fromArray(o.matrix),a.applyMatrix4(e)}else void 0!==o.translation&&a.position.fromArray(o.translation),void 0!==o.rotation&&a.quaternion.fromArray(o.rotation),void 0!==o.scale&&a.scale.fromArray(o.scale);return r.associations.set(a,{type:"nodes",index:e}),a}))}loadScene(e){const t=this.json,n=this.extensions,r=this.json.scenes[e],o=this,i=new s.Group;r.name&&(i.name=o.createUniqueName(r.name)),Gn(i,r),r.extensions&&Hn(n,i,r);const a=r.nodes||[],l=[];for(let e=0,n=a.length;e<n;e++)l.push($n(a[e],i,t,o));return Promise.all(l).then((function(){return i}))}}function $n(e,t,n,r){const o=n.nodes[e];return r.getDependency("node",e).then((function(e){if(void 0===o.skin)return e;let t;return r.getDependency("skin",o.skin).then((function(e){t=e;const n=[];for(let e=0,s=t.joints.length;e<s;e++)n.push(r.getDependency("node",t.joints[e]));return Promise.all(n)})).then((function(n){return e.traverse((function(e){if(!e.isMesh)return;const r=[],o=[];for(let e=0,i=n.length;e<i;e++){const i=n[e];if(i){r.push(i);const n=new s.Matrix4;void 0!==t.inverseBindMatrices&&n.fromArray(t.inverseBindMatrices.array,16*e),o.push(n)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[e])}e.bind(new s.Skeleton(r,o),e.matrixWorld)})),e}))})).then((function(e){t.add(e);const s=[];if(o.children){const t=o.children;for(let o=0,i=t.length;o<i;o++){const i=t[o];s.push($n(i,e,n,r))}}return Promise.all(s)}))}function Qn(e,t,n){const r=t.attributes,o=[];function i(t,s){return n.getDependency("accessor",t).then((function(t){e.setAttribute(s,t)}))}for(const t in r){const n=Fn[t]||t.toLowerCase();n in e.attributes||o.push(i(r[t],n))}if(void 0!==t.indices&&!e.index){const s=n.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));o.push(s)}return Gn(e,t),function(e,t,n){const r=t.attributes,o=new s.Box3;if(void 0===r.POSITION)return;{const e=n.json.accessors[r.POSITION],t=e.min,i=e.max;if(void 0===t||void 0===i)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(o.set(new s.Vector3(t[0],t[1],t[2]),new s.Vector3(i[0],i[1],i[2])),e.normalized){const t=Kn(On[e.componentType]);o.min.multiplyScalar(t),o.max.multiplyScalar(t)}}const i=t.targets;if(void 0!==i){const e=new s.Vector3,t=new s.Vector3;for(let s=0,r=i.length;s<r;s++){const r=i[s];if(void 0!==r.POSITION){const s=n.json.accessors[r.POSITION],o=s.min,i=s.max;if(void 0!==o&&void 0!==i){if(t.setX(Math.max(Math.abs(o[0]),Math.abs(i[0]))),t.setY(Math.max(Math.abs(o[1]),Math.abs(i[1]))),t.setZ(Math.max(Math.abs(o[2]),Math.abs(i[2]))),s.normalized){const e=Kn(On[s.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}o.expandByVector(e)}e.boundingBox=o;const a=new s.Sphere;o.getCenter(a.center),a.radius=o.min.distanceTo(o.max)/2,e.boundingSphere=a}(e,t,n),Promise.all(o).then((function(){return void 0!==t.targets?function(e,t,n){let s=!1,r=!1;for(let e=0,n=t.length;e<n;e++){const n=t[e];if(void 0!==n.POSITION&&(s=!0),void 0!==n.NORMAL&&(r=!0),s&&r)break}if(!s&&!r)return Promise.resolve(e);const o=[],i=[];for(let a=0,l=t.length;a<l;a++){const l=t[a];if(s){const t=void 0!==l.POSITION?n.getDependency("accessor",l.POSITION):e.attributes.position;o.push(t)}if(r){const t=void 0!==l.NORMAL?n.getDependency("accessor",l.NORMAL):e.attributes.normal;i.push(t)}}return Promise.all([Promise.all(o),Promise.all(i)]).then((function(t){const n=t[0],o=t[1];return s&&(e.morphAttributes.position=n),r&&(e.morphAttributes.normal=o),e.morphTargetsRelative=!0,e}))}(e,t.targets,n):e}))}function Zn(e,t){let n=e.getIndex();if(null===n){const t=[],s=e.getAttribute("position");if(void 0===s)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<s.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}const r=n.count-2,o=[];if(t===s.TriangleFanDrawMode)for(let e=1;e<=r;e++)o.push(n.getX(0)),o.push(n.getX(e)),o.push(n.getX(e+1));else for(let e=0;e<r;e++)e%2==0?(o.push(n.getX(e)),o.push(n.getX(e+1)),o.push(n.getX(e+2))):(o.push(n.getX(e+2)),o.push(n.getX(e+1)),o.push(n.getX(e)));o.length/3!==r&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const i=e.clone();return i.setIndex(o),i}var Jn=function(e,t,n,s){return new(n||(n=Promise))((function(r,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}l((s=s.apply(e,t||[])).next())}))};class es{constructor(e,t){this.cache=e,this.textureAnisotropy=t}get fileLoader(){return this._fileLoader||(this._fileLoader=new s.FileLoader),this._fileLoader}get imageLoader(){return this._imgLoader||(this._imgLoader=new s.ImageLoader),this._imgLoader}get svgLoader(){return this._svgLoader||(this._svgLoader=new p),this._svgLoader}get textureLoader(){return this._textureLoader||(this._textureLoader=new s.TextureLoader),this._textureLoader}get objectLoader(){return this._objectLoader||(this._objectLoader=new s.ObjectLoader),this._objectLoader}get gltfLoader(){return this._gltfLoader||(this._gltfLoader=new vn),this._gltfLoader}get fbxLoader(){return this._fbxLoader||(this._fbxLoader=new Qt),this._fbxLoader}preload(e,t){return Jn(this,void 0,void 0,(function*(){return this.cache.add(e,t),new Promise((e=>{const n=/\.fbx$|\.glb$|\.gltf$/.test(t);/\.jpe?g$|\.png$/.test(t)?this.textureLoader.load(t,(t=>e(t))):(n&&this.fileLoader.setResponseType("arraybuffer"),this.fileLoader.load(t,(t=>e(t))))}))}))}textureAtlas(e,t,n="JSONHash"){return Jn(this,void 0,void 0,(function*(){let n=JSON.parse(yield this.file(t));if(n.textures){const e=n.textures[0].frames;let t={frames:{}};e.forEach((e=>{t=Object.assign(Object.assign({},t),{frames:Object.assign(Object.assign({},t.frames),{[e.filename]:{frame:e.frame,rotated:e.rotated,sourceSize:e.sourceSize,spriteSourceSize:e.spriteSourceSize,trimmed:e.trimmed}})})})),n=t}return{texture:yield this.texture(e),json:n}}))}file(e){const t=this.cache.get(e);return e=t||e,new Promise((t=>{this.fileLoader.load(e,(e=>t(e)))}))}svg(e){const t=this.cache.get(e);return e=t||e,new Promise((t=>{this.svgLoader.load(e,(e=>t(e)))}))}texture(e){if(!/^data:image\/[\S]+;base64,/gm.test(e)){const t=this.cache.get(e);e=t||e}return new Promise((t=>{this.textureLoader.load(e,(e=>{e.anisotropy=this.textureAnisotropy,e.needsUpdate=!0,t(e)}))}))}object(e){const t=this.cache.get(e);return e=t||e,new Promise((t=>{this.objectLoader.load(e,(e=>{t(e)}))}))}gltf(e){const t=this.cache.get(e);return e=t||e,new Promise((t=>{this.gltfLoader.load(e,(e=>{t(e)}))}))}fbx(e){const t=this.cache.get(e);return e=t||e,new Promise((t=>{this.fbxLoader.load(e,(e=>{t(e)}))}))}}class ts extends s.Object3D{constructor(e,t,n,r){super(),this.scene=e,this.light=t,this.size=n,this.color=r,this.geo=new s.SphereBufferGeometry(n||.2,16,8),this.mat=new s.MeshBasicMaterial({color:r||t.color}),this.mesh=new s.Mesh(this.geo,this.mat),this.add(this.mesh),t.add(this)}dispose(){this.mesh.geometry.dispose(),Array.isArray(this.mesh.material)?this.mesh.material.forEach((e=>e.dispose())):this.mesh.material.dispose(),this.remove(this.mesh)}update(){}}class ns{constructor(e){this.scene=e}get helper(){return{directionalLightHelper:(e,t,n)=>{const r=new s.DirectionalLightHelper(e,t,n);return this.scene.add(r),r},spotLightHelper:(e,t)=>{const n=new s.SpotLightHelper(e,t);return this.scene.add(n),n},pointLightHelper:(e,t,n)=>new ts(this.scene,e,t,n)}}directionalLight(e={}){const{color:t=16777215,intensity:n=1}=e,r=new s.DirectionalLight(t,n);return r.castShadow=!0,this.scene.add(r),r}hemisphereLight(e={}){const{skyColor:t=16777215,groundColor:n=16777215,intensity:r=1}=e,o=new s.HemisphereLight(t,n,r);return this.scene.add(o),o}ambientLight(e={}){const{color:t=16777215,intensity:n=1}=e,r=new s.AmbientLight(t,n);return this.scene.add(r),r}pointLight(e={}){const{color:t=16777215,intensity:n=1,distance:r=0,decay:o=1}=e,i=new s.PointLight(t,n,r,o);return i.castShadow=!0,this.scene.add(i),i}spotLight(e={}){const{color:t=16777215,intensity:n=1,distance:r=0,angle:o=Math.PI/8,penumbra:i=0,decay:a=1}=e,l=new s.SpotLight(t,n,r,o,i,a);return l.castShadow=!0,this.scene.add(l),l}rectAreaLight(e={}){const{color:t=16777215,intensity:n=1,width:r=10,height:o=10}=e,i=new s.RectAreaLight(t,n,r,o);return this.scene.add(i),i}}class ss extends s.Mesh{constructor(e,t){super(e,t),this.isExtendedMesh=!0,this.isGroup=!1,this.vector3=new s.Vector3,this.hasBody=!1,this.fragmentDepth=0,this.breakable=!1,this.fractureImpulse=1,this.name=`object-${this.id}`}get world(){return{theta:this.worldTheta,phi:this.worldPhi}}get worldTheta(){return this.getWorldDirection(this.vector3),Math.atan2(this.vector3.x,this.vector3.z)}get worldPhi(){return this.getWorldDirection(this.vector3),Math.acos(this.vector3.y)}}const rs=new Map,os=(e,t=!1)=>{if(rs.has(e)){const t=rs.get(e);if(void 0===t)return;if(t>=5)return;rs.set(e,t+1)}else rs.set(e,1);t?console.error(`%c [enable3d] ${e} `,"background: #222; color: #bada55"):console.warn(`%c [enable3d] ${e} `,"background: #222; color: #bada55")},is=class{constructor(){this._defaultMaterial=new s.MeshLambertMaterial({color:13421772})}get(){return this._defaultMaterial}};var as=function(e,t){var n={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(n[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(s=Object.getOwnPropertySymbols(e);r<s.length;r++)t.indexOf(s[r])<0&&Object.prototype.propertyIsEnumerable.call(e,s[r])&&(n[s[r]]=e[s[r]])}return n};class ls{constructor(e){this.scene=e,this.isHeadless="headless"===e,this.defaultMaterial=new is}get make(){return{plane:(e={},t={})=>this.makePlane(e,t),box:(e={},t={})=>this.makeBox(e,t),sphere:(e={},t={})=>this.makeSphere(e,t),cylinder:(e={},t={})=>this.makeCylinder(e,t),cone:(e={},t={})=>this.makeCone(e,t),torus:(e={},t={})=>this.makeTorus(e,t),extrude:(e,t={})=>this.makeExtrude(e,t)}}get add(){return{mesh:e=>this.addMesh(e),existing:e=>this.addExisting(e),plane:(e={},t={})=>this.addPlane(e,t),box:(e={},t={})=>this.addBox(e,t),ground:(e,t={})=>this.addGround(e,t),sphere:(e={},t={})=>this.addSphere(e,t),cylinder:(e={},t={})=>this.addCylinder(e,t),cone:(e={},t={})=>this.addCone(e,t),torus:(e={},t={})=>this.addTorus(e,t),extrude:(e,t={})=>this.addExtrude(e,t),material:(e={})=>this.addMaterial(e)}}addExisting(...e){"headless"!==this.scene&&this.scene.add(...e)}addMesh(e){if(Array.isArray(e))for(let t=0;t<e.length;t++)this.addExisting(e[t]);else this.addExisting(e);return this}createMesh(e,t,n){const{x:r=0,y:o=0,z:i=0}=n;let a;switch(!Array.isArray(t)&&t.type){case"LineBasicMaterial":a=new s.Line(e,t);break;case"PointsMaterial":a=new s.Points(e,t);break;default:a=new ss(e,t)}return a.position.set(r,o,i),a.castShadow=a.receiveShadow=!0,a}makeExtrude(e,t){const{x:n,y:r,z:o,name:i,shape:a,autoCenter:l=!0,breakable:c=!1}=e,h=as(e,["x","y","z","name","shape","autoCenter","breakable"]),{depth:u=1,bevelEnabled:d=!1}=h,p=new s.ExtrudeBufferGeometry(a,Object.assign({depth:u,bevelEnabled:d},h)),m=this.addMaterial(t),f=this.createMesh(p,m,{x:n,y:r,z:o});return l&&f.geometry.center(),f.name=i||`body_id_${f.id}`,f.shape="extrude",f}addExtrude(e,t={}){const n=this.makeExtrude(e,t);return this.addExisting(n),n}makePlane(e,t){const{x:n,y:r,z:o,name:i,breakable:a=!1}=e,l=as(e,["x","y","z","name","breakable"]),c=new s.PlaneBufferGeometry(l.width||1,l.height||1,l.widthSegments||1,l.heightSegments||1),h=this.addMaterial(t);h.side=s.DoubleSide;const u=this.createMesh(c,h,{x:n,y:r,z:o});return u.name=i||`body_id_${u.id}`,u.shape="plane",u}addPlane(e,t){const n=this.makePlane(e,t);return this.addExisting(n),n}makeSphere(e,t){const{x:n,y:r,z:o,name:i,breakable:a=!1}=e,l=as(e,["x","y","z","name","breakable"]),c=new s.SphereBufferGeometry(l.radius||1,l.widthSegments||16,l.heightSegments||12,l.phiStart||void 0,l.phiLength||void 0,l.thetaStart||void 0,l.thetaLength||void 0),h=this.addMaterial(t),u=this.createMesh(c,h,{x:n,y:r,z:o});return u.name=i||`body_id_${u.id}`,u.shape="sphere",u}addSphere(e={},t={}){const n=this.makeSphere(e,t);return this.addExisting(n),n}makeBox(e,t){const{x:n,y:r,z:o,name:i,breakable:a=!1}=e,l=as(e,["x","y","z","name","breakable"]),c=new s.BoxBufferGeometry(l.width||1,l.height||1,l.depth||1,l.widthSegments||void 0,l.heightSegments||void 0,l.depthSegments||void 0),h=this.addMaterial(t),u=this.createMesh(c,h,{x:n,y:r,z:o});return u.name=i||`body_id_${u.id}`,u.shape="box",u}addBox(e={},t={}){const n=this.makeBox(e,t);return this.addExisting(n),n}addGround(e,t={}){const n=this.makeBox(e,t);return n.rotateX(s.MathUtils.degToRad(90)),this.addExisting(n),n}makeCylinder(e={},t={}){const{x:n,y:r,z:o,name:i,breakable:a=!1}=e,l=as(e,["x","y","z","name","breakable"]),c=new s.CylinderBufferGeometry(l.radiusTop||1,l.radiusBottom||1,l.height||1,l.radiusSegments||void 0,l.heightSegments||void 0,l.openEnded||void 0,l.thetaStart||void 0,l.thetaLength||void 0),h=this.addMaterial(t),u=this.createMesh(c,h,{x:n,y:r,z:o});return u.name=i||`body_id_${u.id}`,u.shape="cylinder",u}addCylinder(e={},t={}){const n=this.makeCylinder(e,t);return this.addExisting(n),n}makeCone(e={},t={}){const{x:n,y:r,z:o,name:i,breakable:a=!1}=e,l=as(e,["x","y","z","name","breakable"]),c=new s.ConeBufferGeometry(l.radius||1,l.height||1,l.radiusSegments||8,l.heightSegments||1,l.openEnded||!1,l.thetaStart||0,l.thetaLength||2*Math.PI),h=this.addMaterial(t),u=this.createMesh(c,h,{x:n,y:r,z:o});return u.name=i||`body_id_${u.id}`,u.shape="cone",u}addCone(e={},t={}){const n=this.makeCone(e,t);return this.addExisting(n),n}makeTorus(e={},t={}){const{x:n,y:r,z:o,name:i,breakable:a=!1}=e,l=as(e,["x","y","z","name","breakable"]),c=new s.TorusBufferGeometry(l.radius||void 0,l.tube||void 0,l.radialSegments||void 0,l.tubularSegments||void 0,l.arc||void 0),h=this.addMaterial(t),u=this.createMesh(c,h,{x:n,y:r,z:o});return u.name=i||`body_id_${u.id}`,u.shape="torus",u}addTorus(e={},t={}){const n=this.makeTorus(e,t);return this.addExisting(n),n}addMaterial(e={}){const t=Object.keys(e)[0];let n;if("headless"===this.scene)return this.defaultMaterial.get();switch(t){case"basic":n=new s.MeshBasicMaterial(e.basic);break;case"normal":n=new s.MeshNormalMaterial(e.normal);break;case"standard":n=new s.MeshStandardMaterial(e.standard);break;case"lambert":n=new s.MeshLambertMaterial(e.lambert);break;case"phong":n=new s.MeshPhongMaterial(e.phong);break;case"physical":void 0!==e.physical?n=new s.MeshPhysicalMaterial(e.physical):(os("You need to pass parameters to the physical material. (Fallback to default material)"),n=this.defaultMaterial.get());break;case"toon":n=new s.MeshToonMaterial(e.toon);break;case"line":n=new s.LineBasicMaterial(e.line);break;case"points":n=new s.PointsMaterial(e.points);break;case"custom":n=e.custom||this.defaultMaterial.get();break;default:n=this.defaultMaterial.get()}return n}}class cs{constructor(e){this.scene=e}add(e,t={}){const n=this.make(e,t);return n?this.scene.add(n):console.warn("Could not make heightmap"),n}make(e,t={}){const{image:n}=e,{width:r,height:o}=n,{colorScale:i}=t,a=document.createElement("canvas");a.width=r,a.height=o;const l=a.getContext("2d");if(!l)return;l.drawImage(e.image,0,0);const h=l.getImageData(0,0,r,o),u=(new c).fromBufferGeometry(new s.PlaneBufferGeometry(10,10,r-1,o-1));let d={color:13421772,side:s.DoubleSide};i&&(d=Object.assign(Object.assign({},d),{vertexColors:!0}));const p=new s.MeshPhongMaterial(d),m=new ss(u,p);m.receiveShadow=m.castShadow=!0,m.shape="concave";const g=m.geometry;for(let e=0;e<g.vertices.length;e++)g.vertices[e].z=h.data[4*e]/120;return i&&g.faces.forEach((e=>e.color=new s.Color(i(((e,t)=>{var n=e.vertices[t.a].z,s=e.vertices[t.b].z,r=e.vertices[t.c].z;return Math.max(n,s,r)})(g,e)).hex()))),m.rotateX(-Math.PI/2),m.updateMatrix(),u.computeFaceNormals(),u.computeVertexNormals(),m.name="heightmap",m.geometry=f(new s.BufferGeometry,m.geometry),m}}const hs={type:"change"},us={type:"start"},ds={type:"end"};class ps extends s.EventDispatcher{constructor(e,t){super(),void 0===t&&console.warn('THREE.OrbitControls: The second parameter "domElement" is now mandatory.'),t===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.object=e,this.domElement=t,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new s.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:s.MOUSE.ROTATE,MIDDLE:s.MOUSE.DOLLY,RIGHT:s.MOUSE.PAN},this.touches={ONE:s.TOUCH.ROTATE,TWO:s.TOUCH.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return a.phi},this.getAzimuthalAngle=function(){return a.theta},this.listenToKeyEvents=function(e){e.addEventListener("keydown",G),this._domElementKeyEvents=e},this.saveState=function(){n.target0.copy(n.target),n.position0.copy(n.object.position),n.zoom0=n.object.zoom},this.reset=function(){n.target.copy(n.target0),n.object.position.copy(n.position0),n.object.zoom=n.zoom0,n.object.updateProjectionMatrix(),n.dispatchEvent(hs),n.update(),o=r.NONE},this.update=function(){const t=new s.Vector3,d=(new s.Quaternion).setFromUnitVectors(e.up,new s.Vector3(0,1,0)),p=d.clone().invert(),m=new s.Vector3,f=new s.Quaternion,g=2*Math.PI;return function(){const e=n.object.position;t.copy(e).sub(n.target),t.applyQuaternion(d),a.setFromVector3(t),n.autoRotate&&o===r.NONE&&_(2*Math.PI/60/60*n.autoRotateSpeed),n.enableDamping?(a.theta+=l.theta*n.dampingFactor,a.phi+=l.phi*n.dampingFactor):(a.theta+=l.theta,a.phi+=l.phi);let s=n.minAzimuthAngle,v=n.maxAzimuthAngle;return isFinite(s)&&isFinite(v)&&(s<-Math.PI?s+=g:s>Math.PI&&(s-=g),v<-Math.PI?v+=g:v>Math.PI&&(v-=g),a.theta=s<=v?Math.max(s,Math.min(v,a.theta)):a.theta>(s+v)/2?Math.max(s,a.theta):Math.min(v,a.theta)),a.phi=Math.max(n.minPolarAngle,Math.min(n.maxPolarAngle,a.phi)),a.makeSafe(),a.radius*=c,a.radius=Math.max(n.minDistance,Math.min(n.maxDistance,a.radius)),!0===n.enableDamping?n.target.addScaledVector(h,n.dampingFactor):n.target.add(h),t.setFromSpherical(a),t.applyQuaternion(p),e.copy(n.target).add(t),n.object.lookAt(n.target),!0===n.enableDamping?(l.theta*=1-n.dampingFactor,l.phi*=1-n.dampingFactor,h.multiplyScalar(1-n.dampingFactor)):(l.set(0,0,0),h.set(0,0,0)),c=1,!!(u||m.distanceToSquared(n.object.position)>i||8*(1-f.dot(n.object.quaternion))>i)&&(n.dispatchEvent(hs),m.copy(n.object.position),f.copy(n.object.quaternion),u=!1,!0)}}(),this.dispose=function(){n.domElement.removeEventListener("contextmenu",W),n.domElement.removeEventListener("pointerdown",F),n.domElement.removeEventListener("pointercancel",j),n.domElement.removeEventListener("wheel",H),n.domElement.ownerDocument.removeEventListener("pointermove",U),n.domElement.ownerDocument.removeEventListener("pointerup",z),null!==n._domElementKeyEvents&&n._domElementKeyEvents.removeEventListener("keydown",G)};const n=this,r={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let o=r.NONE;const i=1e-6,a=new s.Spherical,l=new s.Spherical;let c=1;const h=new s.Vector3;let u=!1;const d=new s.Vector2,p=new s.Vector2,m=new s.Vector2,f=new s.Vector2,g=new s.Vector2,v=new s.Vector2,y=new s.Vector2,x=new s.Vector2,b=new s.Vector2,w=[],A={};function M(){return Math.pow(.95,n.zoomSpeed)}function _(e){l.theta-=e}function T(e){l.phi-=e}const S=function(){const e=new s.Vector3;return function(t,n){e.setFromMatrixColumn(n,0),e.multiplyScalar(-t),h.add(e)}}(),E=function(){const e=new s.Vector3;return function(t,s){!0===n.screenSpacePanning?e.setFromMatrixColumn(s,1):(e.setFromMatrixColumn(s,0),e.crossVectors(n.object.up,e)),e.multiplyScalar(t),h.add(e)}}(),P=function(){const e=new s.Vector3;return function(t,s){const r=n.domElement;if(n.object.isPerspectiveCamera){const o=n.object.position;e.copy(o).sub(n.target);let i=e.length();i*=Math.tan(n.object.fov/2*Math.PI/180),S(2*t*i/r.clientHeight,n.object.matrix),E(2*s*i/r.clientHeight,n.object.matrix)}else n.object.isOrthographicCamera?(S(t*(n.object.right-n.object.left)/n.object.zoom/r.clientWidth,n.object.matrix),E(s*(n.object.top-n.object.bottom)/n.object.zoom/r.clientHeight,n.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),n.enablePan=!1)}}();function C(e){n.object.isPerspectiveCamera?c/=e:n.object.isOrthographicCamera?(n.object.zoom=Math.max(n.minZoom,Math.min(n.maxZoom,n.object.zoom*e)),n.object.updateProjectionMatrix(),u=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),n.enableZoom=!1)}function R(e){n.object.isPerspectiveCamera?c*=e:n.object.isOrthographicCamera?(n.object.zoom=Math.max(n.minZoom,Math.min(n.maxZoom,n.object.zoom/e)),n.object.updateProjectionMatrix(),u=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),n.enableZoom=!1)}function L(e){d.set(e.clientX,e.clientY)}function V(e){f.set(e.clientX,e.clientY)}function k(){if(1===w.length)d.set(w[0].pageX,w[0].pageY);else{const e=.5*(w[0].pageX+w[1].pageX),t=.5*(w[0].pageY+w[1].pageY);d.set(e,t)}}function I(){if(1===w.length)f.set(w[0].pageX,w[0].pageY);else{const e=.5*(w[0].pageX+w[1].pageX),t=.5*(w[0].pageY+w[1].pageY);f.set(e,t)}}function O(){const e=w[0].pageX-w[1].pageX,t=w[0].pageY-w[1].pageY,n=Math.sqrt(e*e+t*t);y.set(0,n)}function N(e){if(1==w.length)p.set(e.pageX,e.pageY);else{const t=K(e),n=.5*(e.pageX+t.x),s=.5*(e.pageY+t.y);p.set(n,s)}m.subVectors(p,d).multiplyScalar(n.rotateSpeed);const t=n.domElement;_(2*Math.PI*m.x/t.clientHeight),T(2*Math.PI*m.y/t.clientHeight),d.copy(p)}function B(e){if(1===w.length)g.set(e.pageX,e.pageY);else{const t=K(e),n=.5*(e.pageX+t.x),s=.5*(e.pageY+t.y);g.set(n,s)}v.subVectors(g,f).multiplyScalar(n.panSpeed),P(v.x,v.y),f.copy(g)}function D(e){const t=K(e),s=e.pageX-t.x,r=e.pageY-t.y,o=Math.sqrt(s*s+r*r);x.set(0,o),b.set(0,Math.pow(x.y/y.y,n.zoomSpeed)),C(b.y),y.copy(x)}function F(e){!1!==n.enabled&&(0===w.length&&(n.domElement.ownerDocument.addEventListener("pointermove",U),n.domElement.ownerDocument.addEventListener("pointerup",z)),function(e){w.push(e)}(e),"touch"===e.pointerType?function(e){switch(q(e),w.length){case 1:switch(n.touches.ONE){case s.TOUCH.ROTATE:if(!1===n.enableRotate)return;k(),o=r.TOUCH_ROTATE;break;case s.TOUCH.PAN:if(!1===n.enablePan)return;I(),o=r.TOUCH_PAN;break;default:o=r.NONE}break;case 2:switch(n.touches.TWO){case s.TOUCH.DOLLY_PAN:if(!1===n.enableZoom&&!1===n.enablePan)return;n.enableZoom&&O(),n.enablePan&&I(),o=r.TOUCH_DOLLY_PAN;break;case s.TOUCH.DOLLY_ROTATE:if(!1===n.enableZoom&&!1===n.enableRotate)return;n.enableZoom&&O(),n.enableRotate&&k(),o=r.TOUCH_DOLLY_ROTATE;break;default:o=r.NONE}break;default:o=r.NONE}o!==r.NONE&&n.dispatchEvent(us)}(e):function(e){let t;switch(e.button){case 0:t=n.mouseButtons.LEFT;break;case 1:t=n.mouseButtons.MIDDLE;break;case 2:t=n.mouseButtons.RIGHT;break;default:t=-1}switch(t){case s.MOUSE.DOLLY:if(!1===n.enableZoom)return;!function(e){y.set(e.clientX,e.clientY)}(e),o=r.DOLLY;break;case s.MOUSE.ROTATE:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===n.enablePan)return;V(e),o=r.PAN}else{if(!1===n.enableRotate)return;L(e),o=r.ROTATE}break;case s.MOUSE.PAN:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===n.enableRotate)return;L(e),o=r.ROTATE}else{if(!1===n.enablePan)return;V(e),o=r.PAN}break;default:o=r.NONE}o!==r.NONE&&n.dispatchEvent(us)}(e))}function U(e){!1!==n.enabled&&("touch"===e.pointerType?function(e){switch(q(e),o){case r.TOUCH_ROTATE:if(!1===n.enableRotate)return;N(e),n.update();break;case r.TOUCH_PAN:if(!1===n.enablePan)return;B(e),n.update();break;case r.TOUCH_DOLLY_PAN:if(!1===n.enableZoom&&!1===n.enablePan)return;!function(e){n.enableZoom&&D(e),n.enablePan&&B(e)}(e),n.update();break;case r.TOUCH_DOLLY_ROTATE:if(!1===n.enableZoom&&!1===n.enableRotate)return;!function(e){n.enableZoom&&D(e),n.enableRotate&&N(e)}(e),n.update();break;default:o=r.NONE}}(e):function(e){if(!1!==n.enabled)switch(o){case r.ROTATE:if(!1===n.enableRotate)return;!function(e){p.set(e.clientX,e.clientY),m.subVectors(p,d).multiplyScalar(n.rotateSpeed);const t=n.domElement;_(2*Math.PI*m.x/t.clientHeight),T(2*Math.PI*m.y/t.clientHeight),d.copy(p),n.update()}(e);break;case r.DOLLY:if(!1===n.enableZoom)return;!function(e){x.set(e.clientX,e.clientY),b.subVectors(x,y),b.y>0?C(M()):b.y<0&&R(M()),y.copy(x),n.update()}(e);break;case r.PAN:if(!1===n.enablePan)return;!function(e){g.set(e.clientX,e.clientY),v.subVectors(g,f).multiplyScalar(n.panSpeed),P(v.x,v.y),f.copy(g),n.update()}(e)}}(e))}function z(e){!1!==n.enabled&&(e.pointerType,n.dispatchEvent(ds),o=r.NONE,X(e),0===w.length&&(n.domElement.ownerDocument.removeEventListener("pointermove",U),n.domElement.ownerDocument.removeEventListener("pointerup",z)))}function j(e){X(e)}function H(e){!1===n.enabled||!1===n.enableZoom||o!==r.NONE&&o!==r.ROTATE||(e.preventDefault(),n.dispatchEvent(us),function(e){e.deltaY<0?R(M()):e.deltaY>0&&C(M()),n.update()}(e),n.dispatchEvent(ds))}function G(e){!1!==n.enabled&&!1!==n.enablePan&&function(e){let t=!1;switch(e.code){case n.keys.UP:P(0,n.keyPanSpeed),t=!0;break;case n.keys.BOTTOM:P(0,-n.keyPanSpeed),t=!0;break;case n.keys.LEFT:P(n.keyPanSpeed,0),t=!0;break;case n.keys.RIGHT:P(-n.keyPanSpeed,0),t=!0}t&&(e.preventDefault(),n.update())}(e)}function W(e){!1!==n.enabled&&e.preventDefault()}function X(e){delete A[e.pointerId];for(let t=0;t<w.length;t++)if(w[t].pointerId==e.pointerId)return void w.splice(t,1)}function q(e){let t=A[e.pointerId];void 0===t&&(t=new s.Vector2,A[e.pointerId]=t),t.set(e.pageX,e.pageY)}function K(e){const t=e.pointerId===w[0].pointerId?w[1]:w[0];return A[t.pointerId]}n.domElement.addEventListener("contextmenu",W),n.domElement.addEventListener("pointerdown",F),n.domElement.addEventListener("pointercancel",j),n.domElement.addEventListener("wheel",H,{passive:!1}),this.update()}}class ms{constructor(e,t,n,s,r,o,i){this.scene=e,this.renderer=t,this.camera=n,this.lights=s,this.physics=r,this.load=o,this.factories=i}warpSpeed(...e){return t=this,n=void 0,o=function*(){let t={};const n=e.filter((e=>/^-\w+/.test(e))),r=n.length>0;if((0===e.length||r)&&(e=["light","camera","lookAtCenter","ground","grid","orbitControls","fog","sky"]),r&&n.map((e=>e.substr(1))).forEach((t=>{const n=e.indexOf(t);e.splice(n,1)})),e.includes("sky")){const e=["varying vec3 vWorldPosition;","","void main() {","","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;","","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","","}"].join("\n"),t=["uniform vec3 topColor;","uniform vec3 bottomColor;","uniform float offset;","uniform float exponent;","","varying vec3 vWorldPosition;","","void main() {","","float h = normalize( vWorldPosition + offset ).y;","gl_FragColor = vec4( mix( bottomColor, topColor, max( pow( max( h , 0.0), exponent ), 0.0 ) ), 1.0 );","","}"].join("\n"),n={topColor:{value:new s.Color(30719)},bottomColor:{value:new s.Color(15595007)},offset:{value:33},exponent:{value:.6}};var o=new s.SphereBufferGeometry(500,32,15),i=new s.ShaderMaterial({uniforms:n,vertexShader:e,fragmentShader:t,side:s.BackSide}),a=new s.Mesh(o,i);this.scene.add(a)}if(e.includes("camera")&&(this.camera.position.set(0,6,12),t=Object.assign({camera:this.camera},t)),e.includes("light")){const e=.4,n=this.lights.hemisphereLight({skyColor:16777215,groundColor:0,intensity:e}),s=this.lights.ambientLight({color:16777215,intensity:e}),r=this.lights.directionalLight({color:16777215,intensity:e});r.position.set(100,200,50);const o=20;r.shadow.camera.top=o,r.shadow.camera.bottom=-o,r.shadow.camera.left=-o,r.shadow.camera.right=o,r.shadow.mapSize.set(1024,1024);const i={ambientLight:s,directionalLight:r,hemisphereLight:n};t=Object.assign({lights:i},t)}if(e.includes("lookAtCenter")&&this.camera.lookAt(this.scene.position),e.includes("ground")){const n=e.includes("grid"),r="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOnAAADusBZ+q87AAAAJtJREFUeJzt0EENwDAAxLDbNP6UOxh+NEYQ5dl2drFv286598GrA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAu37AD8eaBH5JQdVbAAAAAElFTkSuQmCC",o=yield this.load.texture(r);o.wrapS=o.wrapT=s.RepeatWrapping,o.repeat.set(21,21);const i={name:"ground",width:21,height:21,depth:1,y:-.5},a={phong:{map:n?o:null,color:16777215}};let l;window.__loadPhysics?(l=this.physics.add.ground(i,a),l.body.setRestitution(1)):l=this.factories.add.ground(i,a),l.receiveShadow=!0,t=Object.assign({ground:l},t)}if(e.includes("orbitControls")){const e=new ps(this.camera,document.getElementById("enable3d-phaser-canvas")||this.renderer.domElement);t=Object.assign({orbitControls:e},t)}return t},new((r=void 0)||(r=Promise))((function(e,s){function i(e){try{l(o.next(e))}catch(e){s(e)}}function a(e){try{l(o.throw(e))}catch(e){s(e)}}function l(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}l((o=o.apply(t,n||[])).next())}));var t,n,r,o}}class fs extends s.Mesh{constructor(e,t={}){super(e),this.type="Reflector";const n=this,r=void 0!==t.color?new s.Color(t.color):new s.Color(8355711),o=t.textureWidth||512,i=t.textureHeight||512,a=t.clipBias||0,l=t.shader||fs.ReflectorShader,c=new s.Plane,h=new s.Vector3,u=new s.Vector3,d=new s.Vector3,p=new s.Matrix4,m=new s.Vector3(0,0,-1),f=new s.Vector4,g=new s.Vector3,v=new s.Vector3,y=new s.Vector4,x=new s.Matrix4,b=new s.PerspectiveCamera,w={minFilter:s.LinearFilter,magFilter:s.LinearFilter,format:s.RGBFormat},A=new s.WebGLRenderTarget(o,i,w);s.MathUtils.isPowerOfTwo(o)&&s.MathUtils.isPowerOfTwo(i)||(A.texture.generateMipmaps=!1);const M=new s.ShaderMaterial({uniforms:s.UniformsUtils.clone(l.uniforms),fragmentShader:l.fragmentShader,vertexShader:l.vertexShader});M.uniforms.tDiffuse.value=A.texture,M.uniforms.color.value=r,M.uniforms.textureMatrix.value=x,this.material=M,this.onBeforeRender=function(e,t,s){if(u.setFromMatrixPosition(n.matrixWorld),d.setFromMatrixPosition(s.matrixWorld),p.extractRotation(n.matrixWorld),h.set(0,0,1),h.applyMatrix4(p),g.subVectors(u,d),g.dot(h)>0)return;g.reflect(h).negate(),g.add(u),p.extractRotation(s.matrixWorld),m.set(0,0,-1),m.applyMatrix4(p),m.add(d),v.subVectors(u,m),v.reflect(h).negate(),v.add(u),b.position.copy(g),b.up.set(0,1,0),b.up.applyMatrix4(p),b.up.reflect(h),b.lookAt(v),b.far=s.far,b.updateMatrixWorld(),b.projectionMatrix.copy(s.projectionMatrix),x.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),x.multiply(b.projectionMatrix),x.multiply(b.matrixWorldInverse),x.multiply(n.matrixWorld),c.setFromNormalAndCoplanarPoint(h,u),c.applyMatrix4(b.matrixWorldInverse),f.set(c.normal.x,c.normal.y,c.normal.z,c.constant);const r=b.projectionMatrix;y.x=(Math.sign(f.x)+r.elements[8])/r.elements[0],y.y=(Math.sign(f.y)+r.elements[9])/r.elements[5],y.z=-1,y.w=(1+r.elements[10])/r.elements[14],f.multiplyScalar(2/f.dot(y)),r.elements[2]=f.x,r.elements[6]=f.y,r.elements[10]=f.z+1-a,r.elements[14]=f.w,A.texture.encoding=e.outputEncoding,n.visible=!1;const o=e.getRenderTarget(),i=e.xr.enabled,l=e.shadowMap.autoUpdate;e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(A),e.state.buffers.depth.setMask(!0),!1===e.autoClear&&e.clear(),e.render(t,b),e.xr.enabled=i,e.shadowMap.autoUpdate=l,e.setRenderTarget(o);const w=s.viewport;void 0!==w&&e.state.viewport(w),n.visible=!0},this.getRenderTarget=function(){return A}}}fs.prototype.isReflector=!0,fs.ReflectorShader={uniforms:{color:{value:null},tDiffuse:{value:null},textureMatrix:{value:null}},vertexShader:"\n\t\tuniform mat4 textureMatrix;\n\t\tvarying vec4 vUv;\n\n\t\t#include <common>\n\t\t#include <logdepthbuf_pars_vertex>\n\n\t\tvoid main() {\n\n\t\t\tvUv = textureMatrix * vec4( position, 1.0 );\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t\t#include <logdepthbuf_vertex>\n\n\t\t}",fragmentShader:"\n\t\tuniform vec3 color;\n\t\tuniform sampler2D tDiffuse;\n\t\tvarying vec4 vUv;\n\n\t\t#include <logdepthbuf_pars_fragment>\n\n\t\tfloat blendOverlay( float base, float blend ) {\n\n\t\t\treturn( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );\n\n\t\t}\n\n\t\tvec3 blendOverlay( vec3 base, vec3 blend ) {\n\n\t\t\treturn vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#include <logdepthbuf_fragment>\n\n\t\t\tvec4 base = texture2DProj( tDiffuse, vUv );\n\t\t\tgl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );\n\n\t\t}"};class gs extends s.Mesh{constructor(e,t={}){super(e),this.type="Refractor";const n=this,r=void 0!==t.color?new s.Color(t.color):new s.Color(8355711),o=t.textureWidth||512,i=t.textureHeight||512,a=t.clipBias||0,l=t.shader||gs.RefractorShader,c=new s.PerspectiveCamera;c.matrixAutoUpdate=!1,c.userData.refractor=!0;const h=new s.Plane,u=new s.Matrix4,d={minFilter:s.LinearFilter,magFilter:s.LinearFilter,format:s.RGBFormat},p=new s.WebGLRenderTarget(o,i,d);s.MathUtils.isPowerOfTwo(o)&&s.MathUtils.isPowerOfTwo(i)||(p.texture.generateMipmaps=!1),this.material=new s.ShaderMaterial({uniforms:s.UniformsUtils.clone(l.uniforms),vertexShader:l.vertexShader,fragmentShader:l.fragmentShader,transparent:!0}),this.material.uniforms.color.value=r,this.material.uniforms.tDiffuse.value=p.texture,this.material.uniforms.textureMatrix.value=u;const m=function(){const e=new s.Vector3,t=new s.Vector3,r=new s.Matrix4,o=new s.Vector3,i=new s.Vector3;return function(s){return e.setFromMatrixPosition(n.matrixWorld),t.setFromMatrixPosition(s.matrixWorld),o.subVectors(e,t),r.extractRotation(n.matrixWorld),i.set(0,0,1),i.applyMatrix4(r),o.dot(i)<0}}(),f=function(){const e=new s.Vector3,t=new s.Vector3,r=new s.Quaternion,o=new s.Vector3;return function(){n.matrixWorld.decompose(t,r,o),e.set(0,0,1).applyQuaternion(r).normalize(),e.negate(),h.setFromNormalAndCoplanarPoint(e,t)}}(),g=function(){const e=new s.Plane,t=new s.Vector4,n=new s.Vector4;return function(s){c.matrixWorld.copy(s.matrixWorld),c.matrixWorldInverse.copy(c.matrixWorld).invert(),c.projectionMatrix.copy(s.projectionMatrix),c.far=s.far,e.copy(h),e.applyMatrix4(c.matrixWorldInverse),t.set(e.normal.x,e.normal.y,e.normal.z,e.constant);const r=c.projectionMatrix;n.x=(Math.sign(t.x)+r.elements[8])/r.elements[0],n.y=(Math.sign(t.y)+r.elements[9])/r.elements[5],n.z=-1,n.w=(1+r.elements[10])/r.elements[14],t.multiplyScalar(2/t.dot(n)),r.elements[2]=t.x,r.elements[6]=t.y,r.elements[10]=t.z+1-a,r.elements[14]=t.w}}();this.onBeforeRender=function(e,t,s){p.texture.encoding=e.outputEncoding,!0!==s.userData.refractor&&1!=!m(s)&&(f(),function(e){u.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),u.multiply(e.projectionMatrix),u.multiply(e.matrixWorldInverse),u.multiply(n.matrixWorld)}(s),g(s),function(e,t,s){n.visible=!1;const r=e.getRenderTarget(),o=e.xr.enabled,i=e.shadowMap.autoUpdate;e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(p),!1===e.autoClear&&e.clear(),e.render(t,c),e.xr.enabled=o,e.shadowMap.autoUpdate=i,e.setRenderTarget(r);const a=s.viewport;void 0!==a&&e.state.viewport(a),n.visible=!0}(e,t,s))},this.getRenderTarget=function(){return p}}}gs.prototype.isRefractor=!0,gs.RefractorShader={uniforms:{color:{value:null},tDiffuse:{value:null},textureMatrix:{value:null}},vertexShader:"\n\n\t\tuniform mat4 textureMatrix;\n\n\t\tvarying vec4 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = textureMatrix * vec4( position, 1.0 );\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform vec3 color;\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec4 vUv;\n\n\t\tfloat blendOverlay( float base, float blend ) {\n\n\t\t\treturn( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );\n\n\t\t}\n\n\t\tvec3 blendOverlay( vec3 base, vec3 blend ) {\n\n\t\t\treturn vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvec4 base = texture2DProj( tDiffuse, vUv );\n\t\t\tgl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );\n\n\t\t}"};class vs extends s.Mesh{constructor(e,t={}){super(e),this.type="Water";const n=this,r=void 0!==t.color?new s.Color(t.color):new s.Color(16777215),o=t.textureWidth||512,i=t.textureHeight||512,a=t.clipBias||0,l=t.flowDirection||new s.Vector2(1,0),c=t.flowSpeed||.03,h=t.reflectivity||.02,u=t.scale||1,d=t.shader||vs.WaterShader,p=void 0!==t.encoding?t.encoding:s.LinearEncoding,m=new s.TextureLoader,f=t.flowMap||void 0,g=t.normalMap0||m.load("textures/water/Water_1_M_Normal.jpg"),v=t.normalMap1||m.load("textures/water/Water_2_M_Normal.jpg"),y=.15,x=.075,b=new s.Matrix4,w=new s.Clock;if(void 0===fs)return void console.error("THREE.Water: Required component Reflector not found.");if(void 0===gs)return void console.error("THREE.Water: Required component Refractor not found.");const A=new fs(e,{textureWidth:o,textureHeight:i,clipBias:a,encoding:p}),M=new gs(e,{textureWidth:o,textureHeight:i,clipBias:a,encoding:p});A.matrixAutoUpdate=!1,M.matrixAutoUpdate=!1,this.material=new s.ShaderMaterial({uniforms:s.UniformsUtils.merge([s.UniformsLib.fog,d.uniforms]),vertexShader:d.vertexShader,fragmentShader:d.fragmentShader,transparent:!0,fog:!0}),void 0!==f?(this.material.defines.USE_FLOWMAP="",this.material.uniforms.tFlowMap={type:"t",value:f}):this.material.uniforms.flowDirection={type:"v2",value:l},g.wrapS=g.wrapT=s.RepeatWrapping,v.wrapS=v.wrapT=s.RepeatWrapping,this.material.uniforms.tReflectionMap.value=A.getRenderTarget().texture,this.material.uniforms.tRefractionMap.value=M.getRenderTarget().texture,this.material.uniforms.tNormalMap0.value=g,this.material.uniforms.tNormalMap1.value=v,this.material.uniforms.color.value=r,this.material.uniforms.reflectivity.value=h,this.material.uniforms.textureMatrix.value=b,this.material.uniforms.config.value.x=0,this.material.uniforms.config.value.y=x,this.material.uniforms.config.value.z=x,this.material.uniforms.config.value.w=u,this.onBeforeRender=function(e,t,s){!function(e){b.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),b.multiply(e.projectionMatrix),b.multiply(e.matrixWorldInverse),b.multiply(n.matrixWorld)}(s),function(){const e=w.getDelta(),t=n.material.uniforms.config;t.value.x+=c*e,t.value.y=t.value.x+x,t.value.x>=y?(t.value.x=0,t.value.y=x):t.value.y>=y&&(t.value.y=t.value.y-y)}(),n.visible=!1,A.matrixWorld.copy(n.matrixWorld),M.matrixWorld.copy(n.matrixWorld),A.onBeforeRender(e,t,s),M.onBeforeRender(e,t,s),n.visible=!0}}}vs.prototype.isWater=!0,vs.WaterShader={uniforms:{color:{type:"c",value:null},reflectivity:{type:"f",value:0},tReflectionMap:{type:"t",value:null},tRefractionMap:{type:"t",value:null},tNormalMap0:{type:"t",value:null},tNormalMap1:{type:"t",value:null},textureMatrix:{type:"m4",value:null},config:{type:"v4",value:new s.Vector4}},vertexShader:"\n\n\t\t#include <common>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\n\t\tuniform mat4 textureMatrix;\n\n\t\tvarying vec4 vCoord;\n\t\tvarying vec2 vUv;\n\t\tvarying vec3 vToEye;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tvCoord = textureMatrix * vec4( position, 1.0 );\n\n\t\t\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n\t\t\tvToEye = cameraPosition - worldPosition.xyz;\n\n\t\t\tvec4 mvPosition =  viewMatrix * worldPosition; // used in fog_vertex\n\t\t\tgl_Position = projectionMatrix * mvPosition;\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}",fragmentShader:"\n\n\t\t#include <common>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\n\t\tuniform sampler2D tReflectionMap;\n\t\tuniform sampler2D tRefractionMap;\n\t\tuniform sampler2D tNormalMap0;\n\t\tuniform sampler2D tNormalMap1;\n\n\t\t#ifdef USE_FLOWMAP\n\t\t\tuniform sampler2D tFlowMap;\n\t\t#else\n\t\t\tuniform vec2 flowDirection;\n\t\t#endif\n\n\t\tuniform vec3 color;\n\t\tuniform float reflectivity;\n\t\tuniform vec4 config;\n\n\t\tvarying vec4 vCoord;\n\t\tvarying vec2 vUv;\n\t\tvarying vec3 vToEye;\n\n\t\tvoid main() {\n\n\t\t\t#include <logdepthbuf_fragment>\n\n\t\t\tfloat flowMapOffset0 = config.x;\n\t\t\tfloat flowMapOffset1 = config.y;\n\t\t\tfloat halfCycle = config.z;\n\t\t\tfloat scale = config.w;\n\n\t\t\tvec3 toEye = normalize( vToEye );\n\n\t\t\t// determine flow direction\n\t\t\tvec2 flow;\n\t\t\t#ifdef USE_FLOWMAP\n\t\t\t\tflow = texture2D( tFlowMap, vUv ).rg * 2.0 - 1.0;\n\t\t\t#else\n\t\t\t\tflow = flowDirection;\n\t\t\t#endif\n\t\t\tflow.x *= - 1.0;\n\n\t\t\t// sample normal maps (distort uvs with flowdata)\n\t\t\tvec4 normalColor0 = texture2D( tNormalMap0, ( vUv * scale ) + flow * flowMapOffset0 );\n\t\t\tvec4 normalColor1 = texture2D( tNormalMap1, ( vUv * scale ) + flow * flowMapOffset1 );\n\n\t\t\t// linear interpolate to get the final normal color\n\t\t\tfloat flowLerp = abs( halfCycle - flowMapOffset0 ) / halfCycle;\n\t\t\tvec4 normalColor = mix( normalColor0, normalColor1, flowLerp );\n\n\t\t\t// calculate normal vector\n\t\t\tvec3 normal = normalize( vec3( normalColor.r * 2.0 - 1.0, normalColor.b,  normalColor.g * 2.0 - 1.0 ) );\n\n\t\t\t// calculate the fresnel term to blend reflection and refraction maps\n\t\t\tfloat theta = max( dot( toEye, normal ), 0.0 );\n\t\t\tfloat reflectance = reflectivity + ( 1.0 - reflectivity ) * pow( ( 1.0 - theta ), 5.0 );\n\n\t\t\t// calculate final uv coords\n\t\t\tvec3 coord = vCoord.xyz / vCoord.w;\n\t\t\tvec2 uv = coord.xy + coord.z * normal.xz * 0.05;\n\n\t\t\tvec4 reflectColor = texture2D( tReflectionMap, vec2( 1.0 - uv.x, uv.y ) );\n\t\t\tvec4 refractColor = texture2D( tRefractionMap, uv );\n\n\t\t\t// multiply water color with the mix of both textures\n\t\t\tgl_FragColor = vec4( color, 1.0 ) * mix( refractColor, reflectColor, reflectance );\n\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}"};class ys{constructor(e,t,n){this.scene=e,this.renderer=t,this.factories=n}water(e={}){((e,t,n={})=>{const{width:r=20,height:o=20,x:i=0,y:a=0,z:l=0,color:c="#ffffff",scale:h=4,flowX:u=1,flowY:d=1,normalMap0:p,normalMap1:m}=n,f=new s.PlaneBufferGeometry(r,o),g=new s.MeshStandardMaterial({color:30654,transparent:!0,opacity:.8}),v=new s.Mesh(f,g);v.position.set(i,a,l),v.rotation.x=-.5*Math.PI,e.add(v);const y=new s.PlaneBufferGeometry(r,o),x=new vs(y,{color:c,scale:h,flowDirection:new s.Vector2(u,d),textureWidth:1024,textureHeight:1024,normalMap0:p,normalMap1:m,encoding:t.outputEncoding});x.position.set(i,a+.1,l),x.rotation.x=-.5*Math.PI,e.add(x)})(this.scene,this.renderer,e)}textureCube(e){6!==e.length&&os("You need to pass 6 urls to textureCube()");const t=new xs;return e.forEach(((e,n)=>{e.wrapS=e.wrapT=s.RepeatWrapping;const r=this.factories.add.material({phong:{map:e}});t.materials[n]=r})),t}}class xs{constructor(){this.materials=new Array(6)}get texture(){return{left:this.getTexture(0),right:this.getTexture(1),up:this.getTexture(2),down:this.getTexture(3),front:this.getTexture(4),back:this.getTexture(5)}}getTexture(e){return this.materials[e].map}}const bs={Handedness:Object.freeze({NONE:"none",LEFT:"left",RIGHT:"right"}),ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})};async function ws(e){const t=await fetch(e);if(t.ok)return t.json();throw new Error(t.statusText)}const As={xAxis:0,yAxis:0,button:0,state:bs.ComponentState.DEFAULT};class Ms{constructor(e){this.componentProperty=e.componentProperty,this.states=e.states,this.valueNodeName=e.valueNodeName,this.valueNodeProperty=e.valueNodeProperty,this.valueNodeProperty===bs.VisualResponseProperty.TRANSFORM&&(this.minNodeName=e.minNodeName,this.maxNodeName=e.maxNodeName),this.value=0,this.updateFromComponent(As)}updateFromComponent({xAxis:e,yAxis:t,button:n,state:s}){const{normalizedXAxis:r,normalizedYAxis:o}=function(e=0,t=0){let n=e,s=t;if(Math.sqrt(e*e+t*t)>1){const r=Math.atan2(t,e);n=Math.cos(r),s=Math.sin(r)}return{normalizedXAxis:.5*n+.5,normalizedYAxis:.5*s+.5}}(e,t);switch(this.componentProperty){case bs.ComponentProperty.X_AXIS:this.value=this.states.includes(s)?r:.5;break;case bs.ComponentProperty.Y_AXIS:this.value=this.states.includes(s)?o:.5;break;case bs.ComponentProperty.BUTTON:this.value=this.states.includes(s)?n:0;break;case bs.ComponentProperty.STATE:this.valueNodeProperty===bs.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(s):this.value=this.states.includes(s)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}class _s{constructor(e,t){if(!(e&&t&&t.visualResponses&&t.gamepadIndices&&0!==Object.keys(t.gamepadIndices).length))throw new Error("Invalid arguments supplied");this.id=e,this.type=t.type,this.rootNodeName=t.rootNodeName,this.touchPointNodeName=t.touchPointNodeName,this.visualResponses={},Object.keys(t.visualResponses).forEach((e=>{const n=new Ms(t.visualResponses[e]);this.visualResponses[e]=n})),this.gamepadIndices=Object.assign({},t.gamepadIndices),this.values={state:bs.ComponentState.DEFAULT,button:void 0!==this.gamepadIndices.button?0:void 0,xAxis:void 0!==this.gamepadIndices.xAxis?0:void 0,yAxis:void 0!==this.gamepadIndices.yAxis?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(e){if(this.values.state=bs.ComponentState.DEFAULT,void 0!==this.gamepadIndices.button&&e.buttons.length>this.gamepadIndices.button){const t=e.buttons[this.gamepadIndices.button];this.values.button=t.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,t.pressed||1===this.values.button?this.values.state=bs.ComponentState.PRESSED:(t.touched||this.values.button>bs.ButtonTouchThreshold)&&(this.values.state=bs.ComponentState.TOUCHED)}void 0!==this.gamepadIndices.xAxis&&e.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=e.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===bs.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>bs.AxisTouchThreshold&&(this.values.state=bs.ComponentState.TOUCHED)),void 0!==this.gamepadIndices.yAxis&&e.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=e.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===bs.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>bs.AxisTouchThreshold&&(this.values.state=bs.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach((e=>{e.updateFromComponent(this.values)}))}}class Ts{constructor(e,t,n){if(!e)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No profile supplied");this.xrInputSource=e,this.assetUrl=n,this.id=t.profileId,this.layoutDescription=t.layouts[e.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach((e=>{const t=this.layoutDescription.components[e];this.components[e]=new _s(e,t)})),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const e=[];return Object.values(this.components).forEach((t=>{e.push(t.data)})),e}updateFromGamepad(){Object.values(this.components).forEach((e=>{e.updateFromGamepad(this.xrInputSource.gamepad)}))}}class Ss extends s.Object3D{constructor(){super(),this.motionController=null,this.envMap=null}setEnvironmentMap(e){return this.envMap==e||(this.envMap=e,this.traverse((e=>{e.isMesh&&(e.material.envMap=this.envMap,e.material.needsUpdate=!0)}))),this}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&(this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach((e=>{Object.values(e.visualResponses).forEach((e=>{const{valueNode:t,minNode:n,maxNode:s,value:r,valueNodeProperty:o}=e;t&&(o===bs.VisualResponseProperty.VISIBILITY?t.visible=r:o===bs.VisualResponseProperty.TRANSFORM&&(t.quaternion.slerpQuaternions(n.quaternion,s.quaternion,r),t.position.lerpVectors(n.position,s.position,r)))}))})))}}function Es(e,t){!function(e,t){Object.values(e.components).forEach((e=>{const{type:n,touchPointNodeName:r,visualResponses:o}=e;if(n===bs.ComponentType.TOUCHPAD)if(e.touchPointNode=t.getObjectByName(r),e.touchPointNode){const t=new s.SphereGeometry(.001),n=new s.MeshBasicMaterial({color:255}),r=new s.Mesh(t,n);e.touchPointNode.add(r)}else console.warn(`Could not find touch dot, ${e.touchPointNodeName}, in touchpad component ${e.id}`);Object.values(o).forEach((e=>{const{valueNodeName:n,minNodeName:s,maxNodeName:r,valueNodeProperty:o}=e;if(o===bs.VisualResponseProperty.TRANSFORM){if(e.minNode=t.getObjectByName(s),e.maxNode=t.getObjectByName(r),!e.minNode)return void console.warn(`Could not find ${s} in the model`);if(!e.maxNode)return void console.warn(`Could not find ${r} in the model`)}e.valueNode=t.getObjectByName(n),e.valueNode||console.warn(`Could not find ${n} in the model`)}))}))}(e.motionController,t),e.envMap&&t.traverse((t=>{t.isMesh&&(t.material.envMap=e.envMap,t.material.needsUpdate=!0)})),e.add(t)}class Ps{constructor(e=null){this.gltfLoader=e,this.path="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",this._assetCache={},this.gltfLoader||(this.gltfLoader=new vn)}createControllerModel(e){const t=new Ss;let n=null;return e.addEventListener("connected",(e=>{const s=e.data;"tracked-pointer"===s.targetRayMode&&s.gamepad&&async function(e,t,n=null,s=!0){if(!e)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No basePath supplied");const r=await async function(e){if(!e)throw new Error("No basePath supplied");return await ws(`${e}/profilesList.json`)}(t);let o;if(e.profiles.some((e=>{const n=r[e];return n&&(o={profileId:e,profilePath:`${t}/${n.path}`,deprecated:!!n.deprecated}),!!o})),!o){if(!n)throw new Error("No matching profile name found");const e=r[n];if(!e)throw new Error(`No matching profile name found and default profile "${n}" missing.`);o={profileId:n,profilePath:`${t}/${e.path}`,deprecated:!!e.deprecated}}const i=await ws(o.profilePath);let a;if(s){let t;if(t="any"===e.handedness?i.layouts[Object.keys(i.layouts)[0]]:i.layouts[e.handedness],!t)throw new Error(`No matching handedness, ${e.handedness}, in profile ${o.profileId}`);t.assetPath&&(a=o.profilePath.replace("profile.json",t.assetPath))}return{profile:i,assetPath:a}}(s,this.path,"generic-trigger").then((({profile:e,assetPath:r})=>{t.motionController=new Ts(s,e,r);const o=this._assetCache[t.motionController.assetUrl];if(o)n=o.scene.clone(),Es(t,n);else{if(!this.gltfLoader)throw new Error("GLTFLoader not set.");this.gltfLoader.setPath(""),this.gltfLoader.load(t.motionController.assetUrl,(e=>{this._assetCache[t.motionController.assetUrl]=e,n=e.scene.clone(),Es(t,n)}),null,(()=>{throw new Error(`Asset ${t.motionController.assetUrl} missing or malformed.`)}))}})).catch((e=>{console.warn(e)}))})),e.addEventListener("disconnected",(()=>{t.motionController=null,t.remove(n),n=null})),t}}class Cs{constructor(e,t,n){this._renderer=e,this._scene=t,this._camera=n,this.controllerModelFactory=new Ps,this.cameraGroup=new s.Group,this.cameraGroup.add(n),t.add(this.cameraGroup),e.xr.enabled=!0;const r=class{static createButton(e,t){t&&console.error('THREE.VRButton: The "options" parameter has been removed. Please set the reference space type via renderer.xr.setReferenceSpaceType() instead.');const n=document.createElement("button");function s(e){e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="rgba(0,0,0,0.1)",e.style.color="#fff",e.style.font="normal 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.5",e.style.outline="none",e.style.zIndex="999"}if("xr"in navigator)return n.id="VRButton",n.style.display="none",s(n),navigator.xr.isSessionSupported("immersive-vr").then((function(t){t?function(){let t=null;async function s(s){s.addEventListener("end",r),await e.xr.setSession(s),n.textContent="EXIT VR",t=s}function r(){t.removeEventListener("end",r),n.textContent="ENTER VR",t=null}n.style.display="",n.style.cursor="pointer",n.style.left="calc(50% - 50px)",n.style.width="100px",n.textContent="ENTER VR",n.onmouseenter=function(){n.style.opacity="1.0"},n.onmouseleave=function(){n.style.opacity="0.5"},n.onclick=function(){if(null===t){const e={optionalFeatures:["local-floor","bounded-floor","hand-tracking","layers"]};navigator.xr.requestSession("immersive-vr",e).then(s)}else t.end()}}():(n.style.display="",n.style.cursor="auto",n.style.left="calc(50% - 75px)",n.style.width="150px",n.onmouseenter=null,n.onmouseleave=null,n.onclick=null,n.textContent="VR NOT SUPPORTED")})),n;{const e=document.createElement("a");return!1===window.isSecureContext?(e.href=document.location.href.replace(/^http:/,"https:"),e.innerHTML="WEBXR NEEDS HTTPS"):(e.href="https://immersiveweb.dev/",e.innerHTML="WEBXR NOT AVAILABLE"),e.style.left="calc(50% - 90px)",e.style.width="180px",e.style.textDecoration="none",s(e),e}}}.createButton(e);r.style.cssText+="background: rgba(0, 0, 0, 0.8); ",document.body.appendChild(r)}get isPresenting(){var e,t;return!!(null===(t=null===(e=this._renderer)||void 0===e?void 0:e.xr)||void 0===t?void 0:t.isPresenting)}getController(e){const t=this._renderer.xr.getController(e);return this.cameraGroup.add(t),t}getControllerGrip(e){const t=this._renderer.xr.getControllerGrip(e),n=this.controllerModelFactory.createControllerModel(t);return t.add(n),this.cameraGroup.add(t),t}getControllerRay(e){const{targetRayMode:t}=e;if("tracked-pointer"===t){const e=new s.BufferGeometry;e.setAttribute("position",new s.Float32BufferAttribute([0,0,0,0,0,-1],3)),e.setAttribute("color",new s.Float32BufferAttribute([1,0,0,1,1,1],3));const t=new s.LineBasicMaterial({vertexColors:!0});return new s.Line(e,t)}if("gaze"===t){const e=new s.RingBufferGeometry(.02,.04,32).translate(0,0,-1),t=new s.MeshBasicMaterial({color:"red",opacity:.5,transparent:!0});return new s.Mesh(e,t)}}get camera(){return this.WebXRCamera}get WebXRCamera(){var e;return{group:this.cameraGroup,position:null===(e=this.cameraGroup)||void 0===e?void 0:e.position,rotation:this.isPresenting?this._renderer.xr.getCamera(this._camera).rotation:void 0,getWorldDirection:e=>this.isPresenting?this._renderer.xr.getCamera(this._camera).getWorldDirection(e):void 0}}}class Rs{perspectiveCamera(e={}){return Rs.Perspective(e)}orthographicCamera(e={}){return Rs.Orthographic(e)}static Perspective(e={}){const{fov:t=50,aspect:n=window.innerWidth/window.innerHeight,near:r=.1,far:o=2e3,x:i=0,y:a=5,z:l=25}=e,c=new s.PerspectiveCamera(t,n,r,o);return c.position.set(i,a,l),c}static Orthographic(e={}){const t=window.innerWidth,n=window.innerHeight,{left:r=t/-2,right:o=t/2,top:i=n/2,bottom:a=n/-2,near:l=1,far:c=1e3,x:h=0,y:u=0,z:d=10}=e,p=new s.OrthographicCamera(r,o,i,a,l,c);return p.position.set(h,u,d),p}}var Ls=function(e,t,n,s){return new(n||(n=Promise))((function(r,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}l((s=s.apply(e,t||[])).next())}))};class Vs{constructor(e={}){this.sceneConfig=e,this.scenes=new Map,this.__config={},this._isRunning=!1,this._deconstructor=[];const{key:t=Math.random().toString(),enableXR:n=!1}=e;this.__config.sceneKey=t,this.__config.enableXR=n}get deconstructor(){return{add:(...e)=>{e.forEach((e=>{this._deconstructor.push(e)}))}}}initializeScene(e){const{renderer:t,parent:n,canvas:r,scene:o,scenes:i,camera:a,cache:l,physics:c,sceneConfig:h}=e;this.scene=o,this.scenes=i,this.camera=a,this.cache=l,this.physics=c,this.renderer=t,this.parent=n,this.canvas=r;const{autoStart:u,textureAnisotropy:d}=h;this.load=new es(this.cache,d),this.lights=new ns(this.scene),this.transform=new v(this.camera,this.renderer),this.csg=y,this.heightMap=new cs(this.scene),this.factories=new ls(this.scene),this.misc=new ys(this.scene,this.renderer,this.factories),this.ws=new ms(o,t,a,this.lights,this.physics,this.load,this.factories),this.mixers=new class{constructor(){this._mixers=[]}animationMixer(e){const t=new s.AnimationMixer(e);return this.mixers.add(t),t}get mixers(){return{create:e=>this.animationMixer(e),add:e=>this._mixers.push(e),get:()=>this._mixers,update:e=>{var t;return null===(t=this._mixers)||void 0===t?void 0:t.forEach((t=>t.update(e/1e3)))}}}},this.cameras=new Rs,this.clock=new s.Clock,this.__config.enableXR&&(this.webXR=new Cs(this.renderer,this.scene,this.camera)),u&&this.start(this.__config.sceneKey)}get sceneKey(){return this.__config.sceneKey}destroy(e){var t;null===(t=this.physics)||void 0===t||t.destroy(e.body),this.scene.remove(e),e=null}warpSpeed(...e){return Ls(this,void 0,void 0,(function*(){return yield this.ws.warpSpeed(...e)}))}get animationMixers(){return this.mixers.mixers}get make(){return this.factories.make}get add(){return this.factories.add}haveSomeFun(e=20){((e=20,t)=>{if(window.__loadPhysics)for(let n=0;n<e;n++){const e=["standard","basic","normal","phong","line","points"],n=(e,t)=>Math.floor(Math.random()*(t-e+1)+e),s=e=>e[Math.floor(Math.random()*e.length)];Math.random()>.5?t.add.box({x:n(-10,10),y:n(10,20),z:n(-10,10),width:n(1,2)/10,height:n(1,2)/10,depth:n(1,2)/10,mass:1},{[s(e)]:{color:Math.floor(16777215*Math.random())}}).body.setRestitution(Math.floor(10*Math.random())/20):t.add.sphere({x:n(-10,10),y:n(10,20),z:n(-10,10),radius:n(1,2)/10,mass:1},{[s(e)]:{color:Math.floor(16777215*Math.random())}}).body.setRestitution(Math.floor(10*Math.random())/20)}else console.log("There is not much fun without physics enabled!")})(e,this.physics)}isRunning(){return this._isRunning}start(e,t){var n;return Ls(this,void 0,void 0,(function*(){e&&e!==this.__config.sceneKey?(this.stop(),null===(n=this.scenes.get(e))||void 0===n||n._start(t)):this._start(t)}))}_start(e){var t;return Ls(this,void 0,void 0,(function*(){yield null===(t=this.init)||void 0===t?void 0:t.call(this,e),yield this._preload(),yield this._create(),this.renderer.setAnimationLoop((()=>{this._update()})),this._isRunning=!0}))}restart(e){return Ls(this,void 0,void 0,(function*(){yield this.stop(),yield this.start(this.__config.sceneKey,e)}))}stop(){var e,t,n;return Ls(this,void 0,void 0,(function*(){this._isRunning=!1,this.renderer.setAnimationLoop(null),this.clock.start();for(let n of this._deconstructor)yield null===(e=n.dispose)||void 0===e?void 0:e.call(n),yield null===(t=n.destroy)||void 0===t?void 0:t.call(n),"function"==typeof n&&(yield null==n?void 0:n()),n=null;if(this._deconstructor=[],null===(n=this.physics)||void 0===n?void 0:n.rigidBodies)for(let e=this.physics.rigidBodies.length-1;e>=0;e--)this.physics.destroy(this.physics.rigidBodies[e]);for(let e=this.scene.children.length-1;e>=0;e--)this.scene.remove(this.scene.children[e])}))}setSize(e,t){this.renderer.setSize(e,t),void 0!==this.camera.aspect&&(this.camera.aspect=e/t),this.camera.updateProjectionMatrix()}setPixelRatio(e){this.renderer.setPixelRatio(e)}init(e={}){}preload(){}create(){}update(e,t){}preRender(){}postRender(){}_preload(){var e;return Ls(this,void 0,void 0,(function*(){yield null===(e=this.preload)||void 0===e?void 0:e.call(this)}))}_create(){var e;return Ls(this,void 0,void 0,(function*(){yield null===(e=this.create)||void 0===e?void 0:e.call(this)}))}_update(){var e,t,n;const s=1e3*this.clock.getDelta(),r=this.clock.getElapsedTime();null===(e=this.update)||void 0===e||e.call(this,parseFloat(r.toFixed(3)),parseInt(s.toString())),null===(t=this.physics)||void 0===t||t.update(s),null===(n=this.physics)||void 0===n||n.updateDebugger(),this.animationMixers.update(s),this.preRender(),this.composer?this.composer.render():this.renderer.render(this.scene,this.camera),this.postRender()}}var ks=r(197);class Is extends s.Object3D{constructor(){super(),this.isExtendedObject3D=!0,this.isGroup=!1,this.vector3=new s.Vector3,this.hasBody=!1,this.fragmentDepth=0,this.breakable=!1,this.fractureImpulse=1,this._currentAnimation="",this._animationActions=new Map,this.name=`object-${this.id}`}get world(){return{theta:this.worldTheta,phi:this.worldPhi}}get worldTheta(){return this.getWorldDirection(this.vector3),Math.atan2(this.vector3.x,this.vector3.z)}get worldPhi(){return this.getWorldDirection(this.vector3),Math.acos(this.vector3.y)}set animationMixer(e){this._animationMixer=e}get animationMixer(){return this._animationMixer||(this._animationMixer=new s.AnimationMixer(this)),this._animationMixer}get anims(){return{current:this._currentAnimation,add:(e,t)=>this._animsAdd(e,t),get:e=>this._animsGet(e),play:(e,t=500,n=!0)=>this._animsPlay(e,t,n),mixer:this.animationMixer}}get animation(){return os('Please use "anims" instead of "animation"'),this.anims}_animsAdd(e,t){this._animationActions.set(e,this.animationMixer.clipAction(t))}_animsGet(e){const t=this._animationActions.get(e);return t||os(`Animation(${e}) not found!`),t}_animsPlay(e,t=500,n=!0){const r=this._animationActions.get(e),o=this._animationActions.get(this._currentAnimation);r&&(r.reset(),o&&(r.crossFadeFrom(o,t/1e3,!0),r.clampWhenFinished=!0),n||r.setLoop(s.LoopOnce,0),r.play()),this._currentAnimation=e}setAction(e){os(`setAction(${e}) is deprecated. Use animation.play(${e}) instead!`)}traverse(e){super.traverse(e)}traverseVisible(e){super.traverseVisible(e)}traverseAncestors(e){super.traverseAncestors(e)}}class Os extends s.Group{constructor(){super(),this.isExtendedGroup=!0,this.isMesh=!1,this.hasBody=!1,this.fragmentDepth=0,this.breakable=!1,this.fractureImpulse=1,this.name=`object-${this.id}`}}class Ns{constructor(e,t){this.worldTransform=e,this.physicsWorld=t,this.tmpBtVector3=new Ammo.btVector3}toAmmoV3(e,t=0){return new Ammo.btVector3(void 0!==(null==e?void 0:e.x)?e.x:t,void 0!==(null==e?void 0:e.y)?e.y:t,void 0!==(null==e?void 0:e.z)?e.z:t)}get addConstraints(){return{lock:(e,t,n)=>this.lock(e,t,n),fixed:(e,t,n)=>this.fixed(e,t,n),pointToPoint:(e,t,n,s)=>this.pointToPoint(e,t,n,s),hinge:(e,t,n,s)=>this.hinge(e,t,n,s),slider:(e,t,n={},s)=>this.slider(e,t,n,s),spring:(e,t,n={},s)=>this.spring(e,t,n,s),coneTwist:(e,t,n={frameA:{},frameB:{}},s)=>this.coneTwist(e,t,n,s),dof:(e,t,n,s)=>this.dof(e,t,n,s)}}getTransform(e,t,n={x:0,y:0,z:0},s=!1){n=Object.assign({x:0,y:0,z:0},n);const r=new Ammo.btTransform;if(r.setIdentity(),s){const s=(o=e.getWorldTransform().getOrigin(),i=t.getWorldTransform().getOrigin(),a=(o.x()-i.x())/2+n.x,l=(o.y()-i.y())/2+n.y,c=(o.z()-i.z())/2+n.z,new Ammo.btVector3(a,l,c)),r=new Ammo.btTransform;r.setIdentity(),r.setOrigin(s);const h=e.getCenterOfMassTransform().inverse().op_mul(t.getWorldTransform());return h.op_mul(r),{transformA:h,transformB:r}}return r.setOrigin(new Ammo.btVector3(n.x,n.y,n.z)),{transformA:e.getCenterOfMassTransform().inverse().op_mul(t.getWorldTransform()).op_mul(r),transformB:r};var o,i,a,l,c}lock(e,t,n=!0){const s={x:0,y:0,z:0};return this.dof(e,t,{angularLowerLimit:s,angularUpperLimit:s},n)}fixed(e,t,n=!0){const s=this.getTransform(e.ammo,t.ammo);s.transformA.setRotation(e.ammo.getWorldTransform().getRotation()),s.transformB.setRotation(t.ammo.getWorldTransform().getRotation());const r=new Ammo.btFixedConstraint(e.ammo,t.ammo,s.transformA,s.transformB);return this.physicsWorld.addConstraint(r,n),r}pointToPoint(e,t,n={},s=!0){const{pivotA:r,pivotB:o}=n,i=new Ammo.btVector3((null==r?void 0:r.x)||0,(null==r?void 0:r.y)||0,(null==r?void 0:r.z)||0),a=new Ammo.btVector3((null==o?void 0:o.x)||0,(null==o?void 0:o.y)||0,(null==o?void 0:o.z)||0),l=new Ammo.btPoint2PointConstraint(e.ammo,t.ammo,i,a);return this.physicsWorld.addConstraint(l,s),l}hinge(e,t,n={},s=!0){const{pivotA:r,pivotB:o,axisA:i,axisB:a}=n,l=new Ammo.btVector3((null==r?void 0:r.x)||0,(null==r?void 0:r.y)||0,(null==r?void 0:r.z)||0),c=new Ammo.btVector3((null==o?void 0:o.x)||0,(null==o?void 0:o.y)||0,(null==o?void 0:o.z)||0),h=new Ammo.btVector3((null==i?void 0:i.x)||0,(null==i?void 0:i.y)||0,(null==i?void 0:i.z)||0),u=new Ammo.btVector3((null==a?void 0:a.x)||0,(null==a?void 0:a.y)||0,(null==a?void 0:a.z)||0),d=new Ammo.btHingeConstraint(e.ammo,t.ammo,l,c,h,u,!0);return this.physicsWorld.addConstraint(d,s),d}slider(e,t,n={},s=!0){const r=this.getTransform(e.ammo,t.ammo),{frameA:o={},frameB:i={},linearLowerLimit:a=0,linearUpperLimit:l=0,angularLowerLimit:c=0,angularUpperLimit:h=0}=n,u=r.transformA.getRotation();u.setEulerZYX(o.x||0,o.y||0,o.z||0),r.transformA.setRotation(u);const d=r.transformB.getRotation();d.setEulerZYX(i.x||0,i.y||0,i.z||0),r.transformB.setRotation(d);const p=new Ammo.btSliderConstraint(e.ammo,t.ammo,r.transformA,r.transformB,!0);return p.setLowerLinLimit(a),p.setUpperLinLimit(l),p.setLowerAngLimit(c),p.setUpperAngLimit(h),this.physicsWorld.addConstraint(p,s),p}spring(e,t,n={},s=!0){const{stiffness:r=50,damping:o=.01,angularLock:i=!1,linearLowerLimit:a={},linearUpperLimit:l={},angularLowerLimit:c={},angularUpperLimit:h={},offset:u={},center:d=!1,enableSpring:p=!0}=n,m=Object.assign({x:0,y:0,z:0},u),f=this.getTransform(e.ammo,t.ammo,m,d),g=new Ammo.btGeneric6DofSpringConstraint(e.ammo,t.ammo,f.transformA,f.transformB,!0);this.tmpBtVector3.setValue(a.x||0,a.y||0,a.z||0),g.setLinearLowerLimit(this.tmpBtVector3),this.tmpBtVector3.setValue(l.x||0,l.y||0,l.z||0),g.setLinearUpperLimit(this.tmpBtVector3),i?(this.tmpBtVector3.setValue(0,0,0),g.setAngularLowerLimit(this.tmpBtVector3),g.setAngularUpperLimit(this.tmpBtVector3)):(console.log(c,h),g.setAngularLowerLimit(this.toAmmoV3(c,-Math.PI)),g.setAngularUpperLimit(this.toAmmoV3(h,Math.PI)));for(let e=0;e<3;e++)g.enableSpring(e,p),g.setStiffness(e,r),g.setDamping(e,o);return this.physicsWorld.addConstraint(g,s),g}coneTwist(e,t,n,s=!0){const{frameA:r,frameB:o}=n,i=new Ammo.btTransform;i.setIdentity(),i.getOrigin().setValue((null==r?void 0:r.x)||0,(null==r?void 0:r.y)||0,(null==r?void 0:r.z)||0);const a=new Ammo.btTransform;a.setIdentity(),a.getOrigin().setValue((null==o?void 0:o.x)||0,(null==o?void 0:o.y)||0,(null==o?void 0:o.z)||0),this.getTransform(e.ammo,t.ammo);const l=new Ammo.btConeTwistConstraint(t.ammo,e.ammo,i,a);return l.setAngularOnly(!0),this.physicsWorld.addConstraint(l,s),l}dof(e,t,n={},s=!0){const{offset:r,center:o=!1}=n,i=Object.assign({x:0,y:0,z:0},r),a=this.getTransform(e.ammo,t.ammo,i,o),l=new Ammo.btGeneric6DofConstraint(e.ammo,t.ammo,a.transformA,a.transformB,!0),{linearLowerLimit:c,linearUpperLimit:h,angularLowerLimit:u,angularUpperLimit:d}=n,p=this.toAmmoV3(c),m=this.toAmmoV3(h),f=this.toAmmoV3(u,-Math.PI),g=this.toAmmoV3(d,Math.PI);return l.setLinearLowerLimit(p),l.setLinearUpperLimit(m),l.setAngularLowerLimit(f),l.setAngularUpperLimit(g),Ammo.destroy(p),Ammo.destroy(m),Ammo.destroy(f),Ammo.destroy(g),this.physicsWorld.addConstraint(l,s),l}}var Bs=r(650);const Ds="hull",Fs="manual",Us=function(){const e=new s.Vector3,t=new s.Vector3,n=new s.Matrix4;return function(s,r,o,i={}){if(i.type=Ds,Gs(i),i.fit===Fs)return console.warn("cannot use fit: manual with type: hull"),null;const a=Ks(s,r),l=new Ammo.btVector3,c=new Ammo.btConvexHullShape;c.setMargin(i.margin),t.addVectors(a.max,a.min).multiplyScalar(.5);let h=0;for(let e=0;e<s.length;e++)h+=s[e].length/3;const u=i.hullMaxVertices||1e5;h>u&&console.warn(`too many vertices for hull shape; sampling ~${u} from ~${h} vertices`);const d=Math.min(1,u/h);for(let o=0;o<s.length;o++){const i=s[o];n.fromArray(r[o]);for(let r=0;r<i.length;r+=3){const a=o===s.length-1&&r===i.length-3;(Math.random()<=d||a)&&(e.set(i[r],i[r+1],i[r+2]).applyMatrix4(n).sub(t),l.setValue(e.x,e.y,e.z),c.addPoint(l,a))}}let p=c;if(c.getNumVertices()>=100){const e=new Ammo.btShapeHull(c);e.buildHull(i.margin),Ammo.destroy(c),p=new Ammo.btConvexHullShape(Ammo.getPointer(e.getVertexPointer()),e.numVertices()),Ammo.destroy(e)}return Ammo.destroy(l),Ws(p,i,qs(o,i)),p}}(),zs=function(){const e=new s.Vector3,t=new s.Vector3,n=new s.Matrix4;return function(s,r,o,i,a={}){if(a.type="hacd",Gs(a),a.fit===Fs)return console.warn("cannot use fit: manual with type: hacd"),[];if(!Ammo.hasOwnProperty("HACD"))return console.warn("HACD unavailable in included build of Ammo.js. Visit https://github.com/mozillareality/ammo.js for the latest version."),[];const l=Ks(s,r),c=qs(i,a);let h=0,u=0;t.addVectors(l.max,l.min).multiplyScalar(.5);for(let e=0;e<s.length;e++)h+=s[e].length/3,o&&o[e]?u+=o[e].length/3:u+=s[e].length/9;const d=new Ammo.HACD;a.hasOwnProperty("compacityWeight")&&d.SetCompacityWeight(a.compacityWeight),a.hasOwnProperty("volumeWeight")&&d.SetVolumeWeight(a.volumeWeight),a.hasOwnProperty("nClusters")&&d.SetNClusters(a.nClusters),a.hasOwnProperty("nVerticesPerCH")&&d.SetNVerticesPerCH(a.nVerticesPerCH),a.hasOwnProperty("concavity")&&d.SetConcavity(a.concavity);const p=Ammo._malloc(3*h*8),m=Ammo._malloc(3*u*4);d.SetPoints(p),d.SetTriangles(m),d.SetNPoints(h),d.SetNTriangles(u);let f=p/8,g=m/4;for(let i=0;i<s.length;i++){const a=s[i];n.fromArray(r[i]);for(let s=0;s<a.length;s+=3)e.set(a[s+0],a[s+1],a[s+2]).applyMatrix4(n).sub(t),Ammo.HEAPF64[f+0]=e.x,Ammo.HEAPF64[f+1]=e.y,Ammo.HEAPF64[f+2]=e.z,f+=3;if(o[i]){const e=o[i];for(let t=0;t<e.length;t++)Ammo.HEAP32[g]=e[t],g++}else for(let e=0;e<a.length/3;e++)Ammo.HEAP32[g]=e,g++}d.Compute(),Ammo._free(p),Ammo._free(m);const v=d.GetNClusters(),y=[];for(let e=0;e<v;e++){const t=new Ammo.btConvexHullShape;t.setMargin(a.margin);const n=d.GetNPointsCH(e),s=d.GetNTrianglesCH(e),r=Ammo._malloc(3*n*8),o=Ammo._malloc(3*s*4);d.GetCH(e,r,o);const i=r/8;for(let e=0;e<n;e++){const s=new Ammo.btVector3,r=Ammo.HEAPF64[i+3*e+0],o=Ammo.HEAPF64[i+3*e+1],a=Ammo.HEAPF64[i+3*e+2];s.setValue(r,o,a),t.addPoint(s,e===n-1),Ammo.destroy(s)}Ws(t,a,c),y.push(t)}return y}}(),js=function(){const e=new s.Vector3,t=new s.Vector3,n=new s.Matrix4;return function(s,r,o,i,a={}){if(a.type="vhacd",Gs(a),a.fit===Fs)return console.warn("cannot use fit: manual with type: vhacd"),[];if(!Ammo.hasOwnProperty("VHACD"))return console.warn("VHACD unavailable in included build of Ammo.js. Visit https://github.com/mozillareality/ammo.js for the latest version."),[];const l=Ks(s,r),c=qs(i,a);let h=0,u=0;t.addVectors(l.max,l.min).multiplyScalar(.5);for(let e=0;e<s.length;e++)h+=s[e].length/3,o&&o[e]?u+=o[e].length/3:u+=s[e].length/9;const d=new Ammo.VHACD,p=new Ammo.Parameters;a.hasOwnProperty("resolution")&&p.set_m_resolution(a.resolution),a.hasOwnProperty("depth")&&p.set_m_depth(a.depth),a.hasOwnProperty("concavity")&&p.set_m_concavity(a.concavity),a.hasOwnProperty("planeDownsampling")&&p.set_m_planeDownsampling(a.planeDownsampling),a.hasOwnProperty("convexhullDownsampling")&&p.set_m_convexhullDownsampling(a.convexhullDownsampling),a.hasOwnProperty("alpha")&&p.set_m_alpha(a.alpha),a.hasOwnProperty("beta")&&p.set_m_beta(a.beta),a.hasOwnProperty("gamma")&&p.set_m_gamma(a.gamma),a.hasOwnProperty("pca")&&p.set_m_pca(a.pca),a.hasOwnProperty("mode")&&p.set_m_mode(a.mode),a.hasOwnProperty("maxNumVerticesPerCH")&&p.set_m_maxNumVerticesPerCH(a.maxNumVerticesPerCH),a.hasOwnProperty("minVolumePerCH")&&p.set_m_minVolumePerCH(a.minVolumePerCH),a.hasOwnProperty("convexhullApproximation")&&p.set_m_convexhullApproximation(a.convexhullApproximation),a.hasOwnProperty("oclAcceleration")&&p.set_m_oclAcceleration(a.oclAcceleration);const m=Ammo._malloc(3*h*8+3),f=Ammo._malloc(3*u*4);let g=m/8,v=f/4;for(let i=0;i<s.length;i++){const a=s[i];n.fromArray(r[i]);for(let s=0;s<a.length;s+=3)e.set(a[s+0],a[s+1],a[s+2]).applyMatrix4(n).sub(t),Ammo.HEAPF64[g+0]=e.x,Ammo.HEAPF64[g+1]=e.y,Ammo.HEAPF64[g+2]=e.z,g+=3;if(o[i]){const e=o[i];for(let t=0;t<e.length;t++)Ammo.HEAP32[v]=e[t],v++}else for(let e=0;e<a.length/3;e++)Ammo.HEAP32[v]=e,v++}d.Compute(m,3,h,f,3,u,p),Ammo._free(m),Ammo._free(f);const y=d.GetNConvexHulls(),x=[],b=new Ammo.ConvexHull;for(let e=0;e<y;e++){d.GetConvexHull(e,b);const t=b.get_m_nPoints(),n=(b.get_m_points(),new Ammo.btConvexHullShape);n.setMargin(a.margin);for(let e=0;e<t;e++){const s=new Ammo.btVector3,r=b.get_m_points(3*e+0),o=b.get_m_points(3*e+1),i=b.get_m_points(3*e+2);s.setValue(r,o,i),n.addPoint(s,e===t-1),Ammo.destroy(s)}Ws(n,a,c),x.push(n)}return Ammo.destroy(b),Ammo.destroy(d),x}}(),Hs=function(){const e=new s.Vector3,t=new s.Vector3,n=new s.Vector3,r=new s.Matrix4;return function(s,o,i,a,l={}){if(l.type="mesh",Gs(l),l.fit===Fs)return console.warn("cannot use fit: manual with type: mesh"),null;const c=qs(a,l),h=new Ammo.btVector3,u=new Ammo.btVector3,d=new Ammo.btVector3,p=new Ammo.btTriangleMesh(!0,!1);for(let a=0;a<s.length;a++){const l=s[a],c=i[a]?i[a]:null;if(r.fromArray(o[a]),c)for(let s=0;s<c.length;s+=3){const o=3*c[s],i=3*c[s+1],a=3*c[s+2];e.set(l[o],l[o+1],l[o+2]).applyMatrix4(r),t.set(l[i],l[i+1],l[i+2]).applyMatrix4(r),n.set(l[a],l[a+1],l[a+2]).applyMatrix4(r),h.setValue(e.x,e.y,e.z),u.setValue(t.x,t.y,t.z),d.setValue(n.x,n.y,n.z),p.addTriangle(h,u,d,!1)}else for(let s=0;s<l.length;s+=9)e.set(l[s+0],l[s+1],l[s+2]).applyMatrix4(r),t.set(l[s+3],l[s+4],l[s+5]).applyMatrix4(r),n.set(l[s+6],l[s+7],l[s+8]).applyMatrix4(r),h.setValue(e.x,e.y,e.z),u.setValue(t.x,t.y,t.z),d.setValue(n.x,n.y,n.z),p.addTriangle(h,u,d,!1)}const m=new Ammo.btVector3(c.x,c.y,c.z);let f;return p.setScaling(m),Ammo.destroy(m),f=l.concave?new Ammo.btBvhTriangleMeshShape(p,!0,!0):new Ammo.btConvexTriangleMeshShape(p,!0),f.resources=[p],Ammo.destroy(h),Ammo.destroy(u),Ammo.destroy(d),Ws(f,l),f}}();function Gs(e){e.type=e.type||Ds,e.margin=e.hasOwnProperty("margin")?e.margin:.01}const Ws=function(e,t,n){},Xs=function(){const e=new s.Matrix4;return function(t,n,r){parseInt(s.REVISION)>=123?e.copy(t.matrixWorld).invert():e.getInverse(t.matrixWorld),(new s.Vector3).setFromMatrixScale(t.matrixWorld),t.traverse((o=>{const i=new s.Matrix4;o.isMesh&&(n.includeInvisible||o.el&&o.el.object3D.visible||o.visible)&&(o===t?i.identity():(o.updateWorldMatrix(!0),i.multiplyMatrices(e,o.matrixWorld)),r(o.geometry.isBufferGeometry?o.geometry.attributes.position.array:o.geometry.vertices,i.elements,o.geometry.index?o.geometry.index.array:null))}))}}(),qs=function(){const e=new s.Matrix4;return function(t,n={}){const r=new s.Vector3(1,1,1);return"all"===n.fit&&(e.fromArray(t),r.setFromMatrixScale(e)),r}}(),Ks=(new s.Vector3,function(e,t){const n=new s.Box3;let r=1/0,o=1/0,i=1/0,a=-1/0,l=-1/0,c=-1/0;return n.min.set(0,0,0),n.max.set(0,0,0),Ys(e,t,(e=>{e.x<r&&(r=e.x),e.y<o&&(o=e.y),e.z<i&&(i=e.z),e.x>a&&(a=e.x),e.y>l&&(l=e.y),e.z>c&&(c=e.z)})),n.min.set(r,o,i),n.max.set(a,l,c),n}),Ys=function(){const e=new s.Vector3,t=new s.Matrix4;return function(n,s,r){for(let o=0;o<n.length;o++){t.fromArray(s[o]);for(let s=0;s<n[o].length;s+=3)e.set(n[o][s],n[o][s+1],n[o][s+2]).applyMatrix4(t),r(e)}}}();class $s extends Bs.Events{addCollider(e,t,n){e.body&&t.body&&(e.body.checkCollisions=!0,t.body.checkCollisions=!0,this.on("collision",(s=>{var r,o;const{bodies:i,event:a}=s;(null===(r=i[0])||void 0===r?void 0:r.name)&&(null===(o=i[1])||void 0===o?void 0:o.name)&&(null==e?void 0:e.name)&&(null==t?void 0:t.name)&&(i[0].name===e.name&&i[1].name===t.name||i[1].name===e.name&&i[0].name===t.name)&&n(a)})))}}const Qs=new s.Vector3,Zs=new s.Line3,Js=new s.Plane,er=new s.Vector3,tr=new s.Triangle;class nr{constructor(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new ir,this.unassigned=new ir,this.vertices=[]}setFromPoints(e){!0!==Array.isArray(e)&&console.error("THREE.ConvexHull: Points parameter is not an array."),e.length<4&&console.error("THREE.ConvexHull: The algorithm needs at least four points."),this.makeEmpty();for(let t=0,n=e.length;t<n;t++)this.vertices.push(new or(e[t]));return this.compute(),this}setFromObject(e){const t=[];return e.updateMatrixWorld(!0),e.traverse((function(e){const n=e.geometry;if(void 0!==n){if(n.isGeometry)return void console.error("THREE.ConvexHull no longer supports Geometry. Use THREE.BufferGeometry instead.");if(n.isBufferGeometry){const r=n.attributes.position;if(void 0!==r)for(let n=0,o=r.count;n<o;n++){const o=new s.Vector3;o.fromBufferAttribute(r,n).applyMatrix4(e.matrixWorld),t.push(o)}}}})),this.setFromPoints(t)}containsPoint(e){const t=this.faces;for(let n=0,s=t.length;n<s;n++)if(t[n].distanceToPoint(e)>this.tolerance)return!1;return!0}intersectRay(e,t){const n=this.faces;let s=-1/0,r=1/0;for(let t=0,o=n.length;t<o;t++){const o=n[t],i=o.distanceToPoint(e.origin),a=o.normal.dot(e.direction);if(i>0&&a>=0)return null;const l=0!==a?-i/a:0;if(!(l<=0)&&(a>0?r=Math.min(l,r):s=Math.max(l,s),s>r))return null}return s!==-1/0?e.at(s,t):e.at(r,t),t}intersectsRay(e){return null!==this.intersectRay(e,Qs)}makeEmpty(){return this.faces=[],this.vertices=[],this}addVertexToFace(e,t){return e.face=t,null===t.outside?this.assigned.append(e):this.assigned.insertBefore(t.outside,e),t.outside=e,this}removeVertexFromFace(e,t){return e===t.outside&&(null!==e.next&&e.next.face===t?t.outside=e.next:t.outside=null),this.assigned.remove(e),this}removeAllVerticesFromFace(e){if(null!==e.outside){const t=e.outside;let n=e.outside;for(;null!==n.next&&n.next.face===e;)n=n.next;return this.assigned.removeSubList(t,n),t.prev=n.next=null,e.outside=null,t}}deleteFaceVertices(e,t){const n=this.removeAllVerticesFromFace(e);if(void 0!==n)if(void 0===t)this.unassigned.appendChain(n);else{let e=n;do{const n=e.next;t.distanceToPoint(e.point)>this.tolerance?this.addVertexToFace(e,t):this.unassigned.append(e),e=n}while(null!==e)}return this}resolveUnassignedPoints(e){if(!1===this.unassigned.isEmpty()){let t=this.unassigned.first();do{const n=t.next;let s=this.tolerance,r=null;for(let n=0;n<e.length;n++){const o=e[n];if(0===o.mark){const e=o.distanceToPoint(t.point);if(e>s&&(s=e,r=o),s>1e3*this.tolerance)break}}null!==r&&this.addVertexToFace(t,r),t=n}while(null!==t)}return this}computeExtremes(){const e=new s.Vector3,t=new s.Vector3,n=[],r=[];for(let e=0;e<3;e++)n[e]=r[e]=this.vertices[0];e.copy(this.vertices[0].point),t.copy(this.vertices[0].point);for(let s=0,o=this.vertices.length;s<o;s++){const o=this.vertices[s],i=o.point;for(let t=0;t<3;t++)i.getComponent(t)<e.getComponent(t)&&(e.setComponent(t,i.getComponent(t)),n[t]=o);for(let e=0;e<3;e++)i.getComponent(e)>t.getComponent(e)&&(t.setComponent(e,i.getComponent(e)),r[e]=o)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(e.x),Math.abs(t.x))+Math.max(Math.abs(e.y),Math.abs(t.y))+Math.max(Math.abs(e.z),Math.abs(t.z))),{min:n,max:r}}computeInitialHull(){const e=this.vertices,t=this.computeExtremes(),n=t.min,s=t.max;let r=0,o=0;for(let e=0;e<3;e++){const t=s[e].point.getComponent(e)-n[e].point.getComponent(e);t>r&&(r=t,o=e)}const i=n[o],a=s[o];let l,c;r=0,Zs.set(i.point,a.point);for(let t=0,n=this.vertices.length;t<n;t++){const n=e[t];if(n!==i&&n!==a){Zs.closestPointToPoint(n.point,!0,er);const e=er.distanceToSquared(n.point);e>r&&(r=e,l=n)}}r=-1,Js.setFromCoplanarPoints(i.point,a.point,l.point);for(let t=0,n=this.vertices.length;t<n;t++){const n=e[t];if(n!==i&&n!==a&&n!==l){const e=Math.abs(Js.distanceToPoint(n.point));e>r&&(r=e,c=n)}}const h=[];if(Js.distanceToPoint(c.point)<0){h.push(sr.create(i,a,l),sr.create(c,a,i),sr.create(c,l,a),sr.create(c,i,l));for(let e=0;e<3;e++){const t=(e+1)%3;h[e+1].getEdge(2).setTwin(h[0].getEdge(t)),h[e+1].getEdge(1).setTwin(h[t+1].getEdge(0))}}else{h.push(sr.create(i,l,a),sr.create(c,i,a),sr.create(c,a,l),sr.create(c,l,i));for(let e=0;e<3;e++){const t=(e+1)%3;h[e+1].getEdge(2).setTwin(h[0].getEdge((3-e)%3)),h[e+1].getEdge(0).setTwin(h[t+1].getEdge(1))}}for(let e=0;e<4;e++)this.faces.push(h[e]);for(let t=0,n=e.length;t<n;t++){const n=e[t];if(n!==i&&n!==a&&n!==l&&n!==c){r=this.tolerance;let e=null;for(let t=0;t<4;t++){const s=this.faces[t].distanceToPoint(n.point);s>r&&(r=s,e=this.faces[t])}null!==e&&this.addVertexToFace(n,e)}}return this}reindexFaces(){const e=[];for(let t=0;t<this.faces.length;t++){const n=this.faces[t];0===n.mark&&e.push(n)}return this.faces=e,this}nextVertexToAdd(){if(!1===this.assigned.isEmpty()){let e,t=0;const n=this.assigned.first().face;let s=n.outside;do{const r=n.distanceToPoint(s.point);r>t&&(t=r,e=s),s=s.next}while(null!==s&&s.face===n);return e}}computeHorizon(e,t,n,s){let r;this.deleteFaceVertices(n),n.mark=1,r=null===t?t=n.getEdge(0):t.next;do{const t=r.twin,n=t.face;0===n.mark&&(n.distanceToPoint(e)>this.tolerance?this.computeHorizon(e,t,n,s):s.push(r)),r=r.next}while(r!==t);return this}addAdjoiningFace(e,t){const n=sr.create(e,t.tail(),t.head());return this.faces.push(n),n.getEdge(-1).setTwin(t.twin),n.getEdge(0)}addNewFaces(e,t){this.newFaces=[];let n=null,s=null;for(let r=0;r<t.length;r++){const o=t[r],i=this.addAdjoiningFace(e,o);null===n?n=i:i.next.setTwin(s),this.newFaces.push(i.face),s=i}return n.next.setTwin(s),this}addVertexToHull(e){const t=[];return this.unassigned.clear(),this.removeVertexFromFace(e,e.face),this.computeHorizon(e.point,null,e.face,t),this.addNewFaces(e,t),this.resolveUnassignedPoints(this.newFaces),this}cleanup(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this}compute(){let e;for(this.computeInitialHull();void 0!==(e=this.nextVertexToAdd());)this.addVertexToHull(e);return this.reindexFaces(),this.cleanup(),this}}class sr{constructor(){this.normal=new s.Vector3,this.midpoint=new s.Vector3,this.area=0,this.constant=0,this.outside=null,this.mark=0,this.edge=null}static create(e,t,n){const s=new sr,r=new rr(e,s),o=new rr(t,s),i=new rr(n,s);return r.next=i.prev=o,o.next=r.prev=i,i.next=o.prev=r,s.edge=r,s.compute()}getEdge(e){let t=this.edge;for(;e>0;)t=t.next,e--;for(;e<0;)t=t.prev,e++;return t}compute(){const e=this.edge.tail(),t=this.edge.head(),n=this.edge.next.head();return tr.set(e.point,t.point,n.point),tr.getNormal(this.normal),tr.getMidpoint(this.midpoint),this.area=tr.getArea(),this.constant=this.normal.dot(this.midpoint),this}distanceToPoint(e){return this.normal.dot(e)-this.constant}}class rr{constructor(e,t){this.vertex=e,this.prev=null,this.next=null,this.twin=null,this.face=t}head(){return this.vertex}tail(){return this.prev?this.prev.vertex:null}length(){const e=this.head(),t=this.tail();return null!==t?t.point.distanceTo(e.point):-1}lengthSquared(){const e=this.head(),t=this.tail();return null!==t?t.point.distanceToSquared(e.point):-1}setTwin(e){return this.twin=e,e.twin=this,this}}class or{constructor(e){this.point=e,this.prev=null,this.next=null,this.face=null}}class ir{constructor(){this.head=null,this.tail=null}first(){return this.head}last(){return this.tail}clear(){return this.head=this.tail=null,this}insertBefore(e,t){return t.prev=e.prev,t.next=e,null===t.prev?this.head=t:t.prev.next=t,e.prev=t,this}insertAfter(e,t){return t.prev=e,t.next=e.next,null===t.next?this.tail=t:t.next.prev=t,e.next=t,this}append(e){return null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail,e.next=null,this.tail=e,this}appendChain(e){for(null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail;null!==e.next;)e=e.next;return this.tail=e,this}remove(e){return null===e.prev?this.head=e.next:e.prev.next=e.next,null===e.next?this.tail=e.prev:e.next.prev=e.prev,this}removeSubList(e,t){return null===e.prev?this.head=t.next:e.prev.next=t.next,null===t.next?this.tail=e.prev:t.next.prev=e.prev,this}isEmpty(){return null===this.head}}class ar extends s.BufferGeometry{constructor(e){super();const t=[],n=[];void 0===nr&&console.error("THREE.ConvexBufferGeometry: ConvexBufferGeometry relies on ConvexHull");const r=(new nr).setFromPoints(e).faces;for(let e=0;e<r.length;e++){const s=r[e];let o=s.edge;do{const e=o.head().point;t.push(e.x,e.y,e.z),n.push(s.normal.x,s.normal.y,s.normal.z),o=o.next}while(o!==s.edge)}this.setAttribute("position",new s.Float32BufferAttribute(t,3)),this.setAttribute("normal",new s.Float32BufferAttribute(n,3))}}const lr=e=>new(window.THREE&&window.THREE.ConvexGeometry?window.THREE.ConvexGeometry:ar)(e),cr=function(e,t){this.minSizeForBreak=e||1.4,this.smallDelta=t||1e-4,this.tempLine1=new s.Line3,this.tempPlane1=new s.Plane,this.tempPlane2=new s.Plane,this.tempPlane_Cut=new s.Plane,this.tempCM1=new s.Vector3,this.tempCM2=new s.Vector3,this.tempVector3=new s.Vector3,this.tempVector3_2=new s.Vector3,this.tempVector3_3=new s.Vector3,this.tempVector3_P0=new s.Vector3,this.tempVector3_P1=new s.Vector3,this.tempVector3_P2=new s.Vector3,this.tempVector3_N0=new s.Vector3,this.tempVector3_N1=new s.Vector3,this.tempVector3_AB=new s.Vector3,this.tempVector3_CB=new s.Vector3,this.tempResultObjects={object1:null,object2:null},this.segments=[];for(var n=0;n<900;n++)this.segments[n]=!1};var hr;cr.prototype={constructor:cr,prepareBreakableObject:function(e,t,n,s,r){e.geometry.isBufferGeometry||console.error("THREE.ConvexObjectBreaker.prepareBreakableObject(): Parameter object must have a BufferGeometry."),e.userData.ammoPhysicsData={};var o=e.userData.ammoPhysicsData;o.mass=t,o.velocity=n.clone(),o.angularVelocity=s.clone(),o.breakable=r},subdivideByImpact:function(e,t,n,s,r){var o=[],i=this.tempPlane1,a=this.tempPlane2;this.tempVector3.addVectors(t,n),i.setFromCoplanarPoints(t,e.position,this.tempVector3);var l=r+s,c=this;return function r(h,u,d,p){if(Math.random()<.05*p||p>l)o.push(h);else{var m=Math.PI;0===p?(a.normal.copy(i.normal),a.constant=i.constant):p<=s?(m=(d-u)*(.2+.6*Math.random())+u,c.tempVector3_2.copy(e.position).sub(t).applyAxisAngle(n,m).add(t),a.setFromCoplanarPoints(t,c.tempVector3,c.tempVector3_2)):(m=(.5*(1&p)+.2*(2-Math.random()))*Math.PI,c.tempVector3_2.copy(t).sub(h.position).applyAxisAngle(n,m).add(h.position),c.tempVector3_3.copy(n).add(h.position),a.setFromCoplanarPoints(h.position,c.tempVector3_3,c.tempVector3_2)),c.cutByPlane(h,a,c.tempResultObjects);var f=c.tempResultObjects.object1,g=c.tempResultObjects.object2;f&&r(f,u,m,p+1),g&&r(g,m,d,p+1)}}(e,0,2*Math.PI,0),o},cutByPlane:function(e,t,n){var r=e.geometry,o=r.attributes.position.array,i=r.attributes.normal.array,a=o.length/3,l=a/3,c=r.getIndex();function h(e,t){var n=3*e+t;return c?c[n]:n}c&&(l=(c=c.array).length/3);for(var u=[],d=[],p=this.smallDelta,m=a*a,f=0;f<m;f++)this.segments[f]=!1;var g=this.tempVector3_P0,v=this.tempVector3_P1,y=this.tempVector3_N0,x=this.tempVector3_N1;for(f=0;f<l-1;f++){var b=h(f,0),w=h(f,1),A=h(f,2);y.set(i[b],i[b]+1,i[b]+2);for(var M=f+1;M<l;M++){var _=h(M,0),T=h(M,1),S=h(M,2);x.set(i[_],i[_]+1,i[_]+2),1-y.dot(x)<p&&(b===_||b===T||b===S?w===_||w===T||w===S?(this.segments[b*a+w]=!0,this.segments[w*a+b]=!0):(this.segments[A*a+b]=!0,this.segments[b*a+A]=!0):w!==_&&w!==T&&w!==S||(this.segments[A*a+w]=!0,this.segments[w*a+A]=!0))}}var E=this.tempPlane_Cut;for(e.updateMatrix(),cr.transformPlaneToLocalSpace(t,e.matrix,E),f=0;f<l;f++)for(var P=h(f,0),C=h(f,1),R=h(f,2),L=0;L<3;L++){var V=0===L?P:1===L?C:R,k=0===L?C:1===L?R:P;if(!this.segments[V*a+k]){this.segments[V*a+k]=!0,this.segments[k*a+V]=!0,g.set(o[3*V],o[3*V+1],o[3*V+2]),v.set(o[3*k],o[3*k+1],o[3*k+2]);var I=0;(O=E.distanceToPoint(g))>p?(I=2,d.push(g.clone())):O<-p?(I=1,u.push(g.clone())):(I=3,u.push(g.clone()),d.push(g.clone()));var O,N=0;if((O=E.distanceToPoint(v))>p?(N=2,d.push(v.clone())):O<-p?(N=1,u.push(v.clone())):(N=3,u.push(v.clone()),d.push(v.clone())),1===I&&2===N||2===I&&1===N){this.tempLine1.start.copy(g),this.tempLine1.end.copy(v);var B=new s.Vector3;if(void 0===(B=E.intersectLine(this.tempLine1,B)))return console.error("Internal error: segment does not intersect plane."),n.segmentedObject1=null,n.segmentedObject2=null,0;u.push(B),d.push(B.clone())}}}var D=.5*e.userData.ammoPhysicsData.mass;this.tempCM1.set(0,0,0);var F=0,U=u.length;if(U>0){for(f=0;f<U;f++)this.tempCM1.add(u[f]);for(this.tempCM1.divideScalar(U),f=0;f<U;f++)(H=u[f]).sub(this.tempCM1),F=Math.max(F,H.x,H.y,H.z);this.tempCM1.add(e.position)}this.tempCM2.set(0,0,0);var z=0,j=d.length;if(j>0){for(f=0;f<j;f++)this.tempCM2.add(d[f]);for(this.tempCM2.divideScalar(j),f=0;f<j;f++){var H;(H=d[f]).sub(this.tempCM2),z=Math.max(z,H.x,H.y,H.z)}this.tempCM2.add(e.position)}var G=null,W=null,X=0;if(U>4)try{(G=new s.Mesh(lr(u),e.material)).position.copy(this.tempCM1),G.quaternion.copy(e.quaternion),G.userData=e.userData,this.prepareBreakableObject(G,D,e.userData.ammoPhysicsData.velocity,e.userData.ammoPhysicsData.angularVelocity,2*F>this.minSizeForBreak),X++}catch(e){os("Error in ConvexObjectBreaker.ts",!0),os(e,!0)}if(j>4)try{(W=new s.Mesh(lr(d),e.material)).position.copy(this.tempCM2),W.quaternion.copy(e.quaternion),W.userData=e.userData,this.prepareBreakableObject(W,D,e.userData.ammoPhysicsData.velocity,e.userData.ammoPhysicsData.angularVelocity,2*z>this.minSizeForBreak),X++}catch(e){os("Error in ConvexObjectBreaker.ts",!0),os(e,!0)}return n.object1=G,n.object2=W,X}},cr.transformFreeVector=function(e,t){var n=e.x,s=e.y,r=e.z,o=t.elements;return e.x=o[0]*n+o[4]*s+o[8]*r,e.y=o[1]*n+o[5]*s+o[9]*r,e.z=o[2]*n+o[6]*s+o[10]*r,e},cr.transformFreeVectorInverse=function(e,t){var n=e.x,s=e.y,r=e.z,o=t.elements;return e.x=o[0]*n+o[1]*s+o[2]*r,e.y=o[4]*n+o[5]*s+o[6]*r,e.z=o[8]*n+o[9]*s+o[10]*r,e},cr.transformTiedVectorInverse=function(e,t){var n=e.x,s=e.y,r=e.z,o=t.elements;return e.x=o[0]*n+o[1]*s+o[2]*r-o[12],e.y=o[4]*n+o[5]*s+o[6]*r-o[13],e.z=o[8]*n+o[9]*s+o[10]*r-o[14],e},cr.transformPlaneToLocalSpace=(hr=new s.Vector3,function(e,t,n){n.normal.copy(e.normal),n.constant=e.constant;var s=cr.transformTiedVectorInverse(e.coplanarPoint(hr),t);cr.transformFreeVectorInverse(n.normal,t),n.constant=-s.dot(n.normal)});const ur=(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){console.error(e.message)}return!1})(),dr=(e,t)=>{((e,t)=>{var n=document.createElement("script");n.onload=()=>{t()},n.onerror=()=>{throw new Error(`failed to load ${e}`)},n.async=!0,n.src=e,document.head.appendChild(n)})(ur?`${e}/ammo.wasm.js`:`${e}/ammo.js`,(()=>t()))},pr=(e,t)=>{"undefined"!=typeof window&&(window.__loadPhysics=!0),dr(e,(()=>{Ammo().then((()=>{t()}))}))},mr=(e,t)=>{t.forEach((t=>{Object.getOwnPropertyNames(t.prototype).forEach((n=>{Object.defineProperty(e.prototype,n,Object.getOwnPropertyDescriptor(t.prototype,n))}))}))};class fr{constructor(e){this.physics=e}setRayFromWorld(e=0,t=0,n=0){this._btRayFrom.setValue(e,t,n)}setRayToWorld(e=0,t=0,n=0){this._btRayTo.setValue(e,t,n)}hasHit(){return this._btRayCallback.hasHit()}rayTest(){void 0!==this._btRayCallback&&Ammo.destroy(this._btRayCallback),this._btRayCallback="closest"===this.type?new Ammo.ClosestRayResultCallback(this._btRayFrom,this._btRayTo):new Ammo.AllHitsRayResultCallback(this._btRayFrom,this._btRayTo),this.physics.physicsWorld.rayTest(this._btRayFrom,this._btRayTo,this._btRayCallback)}destroy(){void 0!==this._btRayFrom&&Ammo.destroy(this._btRayFrom),void 0!==this._btRayTo&&Ammo.destroy(this._btRayTo),void 0!==this._btRayCallback&&Ammo.destroy(this._btRayCallback)}}class gr{constructor(e){this.physics=e,this.type="closest",this._btRayFrom=new Ammo.btVector3(0,0,0),this._btRayTo=new Ammo.btVector3(0,0,0)}}class vr{constructor(e){this.physics=e,this.type="allHits",this._btRayFrom=new Ammo.btVector3(0,0,0),this._btRayTo=new Ammo.btVector3(0,0,0)}}mr(gr,[fr,class{constructor(e){this.physics=e}getHitPointWorld(){const e=this._btRayCallback.get_m_hitPointWorld();return{x:e.x(),y:e.y(),z:e.z()}}getHitNormalWorld(){const e=this._btRayCallback.get_m_hitNormalWorld();return{x:e.x(),y:e.y(),z:e.z()}}getCollisionObject(){return Ammo.castObject(this._btRayCallback.get_m_collisionObject(),Ammo.btRigidBody).threeObject}}]),mr(vr,[fr,class{constructor(e){this.physics=e}getHitPointsWorld(){const e=this._btRayCallback.get_m_hitPointWorld(),t=[];for(let n=e.size()-1;n>=0;n--){const s=e.at(n);t.push({x:s.x(),y:s.y(),z:s.z()})}return t}getHitPointWorld(){return os("Use getHitPointsWorld() instead of getHitPointWorld() for the AllHitsRayCaster!"),this.getHitPointsWorld()}getHitNormalsWorld(){const e=this._btRayCallback.get_m_hitNormalWorld(),t=[];for(let n=e.size()-1;n>=0;n--){const s=e.at(n);t.push({x:s.x(),y:s.y(),z:s.z()})}return t}getCollisionObjects(){const e=[],t=this._btRayCallback.get_m_collisionObjects();for(let n=t.size()-1;n>=0;n--){const s=Ammo.castObject(t.at(n),Ammo.btRigidBody);e.push(s.threeObject)}return e}}]);class yr extends Bs.Events{constructor(e,t={}){super(),this.scene=e,this.config=t,this.rigidBodies=[],this.earlierDetectedCollisions=[],this.complexShapes=["plane","hull","hacd","vhacd","convexMesh","concaveMesh"],this.gravity=t.gravity||{x:0,y:-9.81,z:0},this.isHeadless="headless"===e,this.tmpEuler=new s.Euler,this.tmpQuaternion=new s.Quaternion,this.tmpVector3=new s.Vector3,this.tmpVector3a=new s.Vector3,this.tmpMatrix4=new s.Matrix4,this.tmpMatrix4a=new s.Matrix4,this.tmpBtVector3=new Ammo.btVector3,this.tmpBtQuaternion=new Ammo.btQuaternion(0,0,0,1),this.emptyV3=new s.Vector3,this.impactPoint=new s.Vector3,this.impactNormal=new s.Vector3,"headless"!==e&&(this.defaultMaterial=new is),this.start()}get tmpTrans(){return console.warn("Use worldTransform instead of tmpTrans."),this.worldTransform}set tmpTrans(e){console.warn("Use worldTransform instead of tmpTrans."),this.worldTransform=e}destroy(e){var t;const n=Object.keys(e).includes("body")?e.body:e;if(void 0===(null==n?void 0:n.ammo))return;const s=n.ammo.name;let r=n.ammo.threeObject;if(s&&r&&(null===(t=null==r?void 0:r.body)||void 0===t?void 0:t.ammo)){r.body.isSoftBody?this.physicsWorld.removeSoftBody(r.body.ammo):this.physicsWorld.removeRigidBody(r.body.ammo),r.body.destructor(),r.body=void 0,r.hasBody=!1,delete n.ammo.threeObject;for(let e=0;e<this.rigidBodies.length;e++)this.rigidBodies[e].name===s&&(this.rigidBodies.splice(e,1),e--)}"headless"===this.scene&&r&&(r=null)}setup(){if(this.worldTransform=new Ammo.btTransform,"function"==typeof this.config.setupPhysicsWorld?this.physicsWorld=this.config.setupPhysicsWorld():this.physicsWorld=this.setupPhysicsWorld(),"headless"!==this.scene){this.convexBreaker=new cr,this.objectsToRemove=[],this.numObjectsToRemove=0;for(let e=0;e<500;e++)this.objectsToRemove[e]=null}this.collisionEvents=new $s,this.factory=new ls(this.scene),this.shapes=new class{constructor(e,t){this.factory=e,this.addExisting=t}addPlane(e={},t={}){const n=this.factory.add.plane(e,t);return this.addExisting(n,e),n}addSphere(e={},t={}){const n=this.factory.add.sphere(e,t);return this.addExisting(n,e),n}addBox(e={},t={}){const n=this.factory.add.box(e,t);return this.addExisting(n,e),n}addGround(e,t={}){const n=this.factory.add.ground(e,t),s=Object.assign(Object.assign({},e),{mass:0,collisionFlags:1});return this.addExisting(n,s),n}addCylinder(e={},t={}){const n=this.factory.add.cylinder(e,t);return this.addExisting(n,e),n}addCone(e={},t={}){const n=this.factory.add.cone(e,t);return this.addExisting(n,e),n}addTorus(e={},t={}){const n=this.factory.add.torus(e,t);return this.addExisting(n,e),n}addExtrude(e,t={}){const n=this.factory.add.extrude(e,t);return n.translateX(1),this.addExisting(n),n}}(this.factory,((e,t)=>this.addExisting(e,t))),this.constraints=new Ns(this.worldTransform,this.physicsWorld),"headless"!==this.scene&&(this.debugDrawer=new class{constructor(e,t,n={}){this.scene=e,this.world=t,this.options=n,this.debugDrawMode=n.debugDrawMode||1;const r=32768&this.debugDrawMode||!1,o=n.maxBufferSize||1e6;this.geometry=new s.BufferGeometry;const i=new Float32Array(3*o),a=new Float32Array(3*o);this.geometry.setAttribute("position",new s.BufferAttribute(i,3).setUsage(s.StaticDrawUsage)),this.geometry.setAttribute("color",new s.BufferAttribute(a,3).setUsage(s.StaticDrawUsage)),this.index=0;const l=new s.LineBasicMaterial({vertexColors:!0,depthTest:!r});this.mesh=new s.LineSegments(this.geometry,l),r&&(this.mesh.renderOrder=999),this.mesh.frustumCulled=!1,this.enabled=!1,this.debugDrawer=new Ammo.DebugDrawer,this.debugDrawer.drawLine=this.drawLine.bind(this),this.debugDrawer.drawContactPoint=this.drawContactPoint.bind(this),this.debugDrawer.reportErrorWarning=this.reportErrorWarning.bind(this),this.debugDrawer.draw3dText=this.draw3dText.bind(this),this.debugDrawer.setDebugMode=this.setDebugMode.bind(this),this.debugDrawer.getDebugMode=this.getDebugMode.bind(this),this.world.setDebugDrawer(this.debugDrawer)}enable(){this.enabled=!0,this.scene.add(this.mesh)}disable(){this.enabled=!1,this.scene.remove(this.mesh)}update(){this.enabled&&(0!=this.index&&(this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0),this.index=0,this.world.debugDrawWorld(),this.geometry.setDrawRange(0,this.index))}drawLine(e,t,n){const s=Ammo.HEAPF32,r=s[(n+0)/4],o=s[(n+4)/4],i=s[(n+8)/4],a=s[(e+0)/4],l=s[(e+4)/4],c=s[(e+8)/4];this.geometry.attributes.position.setXYZ(this.index,a,l,c),this.geometry.attributes.color.setXYZ(this.index++,r,o,i);const h=s[(t+0)/4],u=s[(t+4)/4],d=s[(t+8)/4];this.geometry.attributes.position.setXYZ(this.index,h,u,d),this.geometry.attributes.color.setXYZ(this.index++,r,o,i)}drawContactPoint(e,t,n,s,r){const o=Ammo.HEAPF32,i=o[(r+0)/4],a=o[(r+4)/4],l=o[(r+8)/4],c=o[(e+0)/4],h=o[(e+4)/4],u=o[(e+8)/4];this.geometry.attributes.position.setXYZ(this.index,c,h,u),this.geometry.attributes.color.setXYZ(this.index++,i,a,l);const d=o[(t+0)/4]*n,p=o[(t+4)/4]*n,m=o[(t+8)/4]*n;this.geometry.attributes.position.setXYZ(this.index,c+d,h+p,u+m),this.geometry.attributes.color.setXYZ(this.index++,i,a,l)}reportErrorWarning(e){Ammo.hasOwnProperty("Pointer_stringify")?console.warn(Ammo.Pointer_stringify(e)):this.warnedOnce||(this.warnedOnce=!0,console.warn("Cannot print warningString, please rebuild Ammo.js using 'debug' flag"))}draw3dText(e,t){console.warn("TODO: draw3dText")}setDebugMode(e){this.debugDrawMode=e}getDebugMode(){return this.debugDrawMode}}(this.scene,this.physicsWorld,{}))}updateDebugger(){"headless"!==this.scene&&this.debugDrawer&&this.debugDrawer.enabled&&this.debugDrawer.update()}setupPhysicsWorld(){const e=this.gravity,{softBodies:t=!1}=this.config;let n;if(!t){const e=new Ammo.btDefaultCollisionConfiguration,t=new Ammo.btCollisionDispatcher(e),s=new Ammo.btDbvtBroadphase,r=new Ammo.btSequentialImpulseConstraintSolver;n=new Ammo.btDiscreteDynamicsWorld(t,s,r,e)}if(t){const e=new Ammo.btSoftBodyRigidBodyCollisionConfiguration,t=new Ammo.btCollisionDispatcher(e),s=new Ammo.btDbvtBroadphase,r=new Ammo.btSequentialImpulseConstraintSolver,o=new Ammo.btDefaultSoftBodySolver;n=new Ammo.btSoftRigidDynamicsWorld(t,s,r,e,o)}return n.setGravity(new Ammo.btVector3(e.x,e.y,e.z)),n}createDebrisFromBreakableObject(e,t){"headless"!==this.scene&&(e.material=t.material,e.shape="hull",e.fragmentDepth=t.fragmentDepth+1,this.scene.add(e),this.addExisting(e),e.body.fractureImpulse=t.body.fractureImpulse,e.body.breakable=!1,setTimeout((()=>{e.body.breakable=!0}),2500))}removeDebris(e){"headless"!==this.scene&&(this.scene.remove(e),this.destroy(e))}update(e){this.updatePhysics(e),this.detectCollisions()}updatePhysics(e){const t=e/1e3;this.physicsWorld.stepSimulation(t,this.config.maxSubSteps||4,this.config.fixedTimeStep||1/60);for(let e=0;e<this.rigidBodies.length;e++){const t=this.rigidBodies[e],n=t.body.ammo.getMotionState();if(n)if(n.getWorldTransform(this.worldTransform),t.body.didUpdate&&(t.body._emitUpdateEvents&&t.body.eventEmitter.emit("update"),t.body.didUpdate=!1),t.body.ammo.isKinematicObject()&&t.body.needUpdate)t.getWorldQuaternion(this.tmpQuaternion),t.getWorldPosition(this.tmpVector3),this.tmpBtVector3.setValue(this.tmpVector3.x,this.tmpVector3.y,this.tmpVector3.z),this.tmpBtQuaternion.setValue(this.tmpQuaternion.x,this.tmpQuaternion.y,this.tmpQuaternion.z,this.tmpQuaternion.w),this.worldTransform.setOrigin(this.tmpBtVector3),this.worldTransform.setRotation(this.tmpBtQuaternion),n.setWorldTransform(this.worldTransform),t.body.needUpdate=!1;else if(t.body.skipUpdate);else if(!t.body.ammo.isStaticObject()){const e=this.worldTransform.getOrigin(),n=this.worldTransform.getRotation(),r=t.body.offset;if(t.body.ignoreScale)this.tmpVector3a.set(t.scale.x,t.scale.y,t.scale.z);else{const e=t.body.ammo.getCollisionShape().getLocalScaling();this.tmpVector3a.set(e.x(),e.y(),e.z())}this.tmpVector3.set(e.x()+r.x,e.y()+r.y,e.z()+r.z),this.tmpQuaternion.set(n.x(),n.y(),n.z(),n.w()),this.tmpMatrix4.compose(this.tmpVector3,this.tmpQuaternion,this.tmpVector3a),t.parent?parseInt(s.REVISION)>=123?this.tmpMatrix4a.copy(t.parent.matrixWorld).invert():this.tmpMatrix4a.getInverse(t.parent.matrixWorld):this.tmpMatrix4a.identity(),this.tmpMatrix4a.multiply(this.tmpMatrix4),this.tmpMatrix4a.decompose(t.position,t.quaternion,t.scale)}}}detectCollisions(){var e,t;const n=[];this.impactPoint.set(0,0,0),this.impactNormal.set(0,0,0);const s=this.physicsWorld.getDispatcher(),r=s.getNumManifolds();for(let o=0;o<r;o++){const r=s.getManifoldByIndexInternal(o),i=r.getNumContacts(),a=Ammo.castObject(r.getBody0(),Ammo.btRigidBody),l=Ammo.castObject(r.getBody1(),Ammo.btRigidBody),c=a.threeObject,h=l.threeObject;if(!c||!h)continue;if(""===a.name&&""===l.name)continue;const u=null===(e=c.body)||void 0===e?void 0:e.checkCollisions,d=null===(t=h.body)||void 0===t?void 0:t.checkCollisions,p=c.body.breakable,m=h.body.breakable,f=c.body.fractureImpulse,g=h.body.fractureImpulse,v=p||m;if(!u&&!d&&!v)continue;let y=!1,x=0,b="start";for(let e=0;e<i;e++){const t=r.getContactPoint(e);if(t.getDistance()<=0){y=!0;const e=t.getAppliedImpulse(),s=t.get_m_positionWorldOnB(),r=t.get_m_normalWorldOnB();if(u||d){const e=[c.name,h.name].sort(),t=`${e[0]}__${e[1]}`;this.earlierDetectedCollisions.find((e=>e.combinedName===t))&&(b="collision"),n.find((e=>e.combinedName===t))||(n.push({combinedName:t,collision:!0}),this.collisionEvents.emit("collision",{bodies:[c,h],event:b}))}e>=x&&(x=e,(p||m)&&(this.impactPoint.set(s.x(),s.y(),s.z()),this.impactNormal.set(r.x(),r.y(),r.z())));break}}if(!y)continue;if(!v)continue;const w=2;if(this.emptyV3.set(0,0,0),c.userData.ammoPhysicsData={mass:1,velocity:this.emptyV3,angularVelocity:this.emptyV3,breakable:p,physicsBody:a},h.userData.ammoPhysicsData={mass:1,velocity:this.emptyV3,angularVelocity:this.emptyV3,breakable:m,physicsBody:l},p&&x>f&&c.fragmentDepth<w){const e=this.convexBreaker.subdivideByImpact(c,this.impactPoint,this.impactNormal,1,2),t=e.length;for(let n=0;n<t;n++){const t=a.getLinearVelocity(),s=a.getAngularVelocity(),r=e[n];r.userData.ammoPhysicsData.velocity.set(t.x(),t.y(),t.z()),r.userData.ammoPhysicsData.angularVelocity.set(s.x(),s.y(),s.z()),this.createDebrisFromBreakableObject(r,c)}this.objectsToRemove[this.numObjectsToRemove++]=c}if(m&&x>g&&h.fragmentDepth<w){const e=this.convexBreaker.subdivideByImpact(h,this.impactPoint,this.impactNormal,1,2),t=e.length;for(let n=0;n<t;n++){const t=l.getLinearVelocity(),s=l.getAngularVelocity(),r=e[n];r.userData.ammoPhysicsData.velocity.set(t.x(),t.y(),t.z()),r.userData.ammoPhysicsData.angularVelocity.set(s.x(),s.y(),s.z()),this.createDebrisFromBreakableObject(r,h)}this.objectsToRemove[this.numObjectsToRemove++]=h}}for(let e=0;e<this.numObjectsToRemove;e++)this.removeDebris(this.objectsToRemove[e]);this.numObjectsToRemove=0,this.earlierDetectedCollisions.forEach((e=>{const{combinedName:t}=e;if(!n.find((e=>e.combinedName===t))){const e=t.split("__"),n=this.rigidBodies.find((t=>t.name===e[0])),s=this.rigidBodies.find((t=>t.name===e[1])),r="end";n&&s&&this.collisionEvents.emit("collision",{bodies:[n,s],event:r})}})),this.earlierDetectedCollisions=[...n]}setGravity(e=0,t=-9.8,n=0){this.tmpBtVector3.setValue(e,t,n),this.physicsWorld.setGravity(this.tmpBtVector3)}get debug(){return this.isHeadless?null:{enable:()=>{this.debugDrawer.enable()},mode:(e=1)=>{this.debugDrawer.setDebugMode(e)},disable:()=>{this.debugDrawer.disable()}}}start(){"undefined"!=typeof Ammo?"function"==typeof Ammo?Ammo().then((()=>{this.setup()})):this.setup():os("Are you sure you included ammo.js?")}get add(){return{collider:(e,t,n)=>this.collisionEvents.addCollider(e,t,n),constraints:this.constraints.addConstraints,existing:(e,t)=>this.addExisting(e,t),plane:(e={},t={})=>this.shapes.addPlane(e,t),sphere:(e={},t={})=>this.shapes.addSphere(e,t),ground:(e={},t={})=>this.shapes.addGround(e,t),box:(e={},t={})=>this.shapes.addBox(e,t),cylinder:(e={},t={})=>this.shapes.addCylinder(e,t),cone:(e={},t={})=>this.shapes.addCone(e,t),torus:(e={},t={})=>this.shapes.addTorus(e,t),extrude:(e,t={})=>this.shapes.addExtrude(e,t),raycaster:(e="closest")=>"closest"===e?new gr(this):new vr(this)}}prepareThreeObjectForCollisionShape(e,t={}){var n,s;const{autoCenter:r=!1}=t,o={width:1,height:1,depth:1,radius:1,radiusTop:1,radiusBottom:1,tube:.4,tubularSegments:6};let i="unknown";const a=(null===(n=e.geometry)||void 0===n?void 0:n.type)||"unknown";/box/i.test(a)?i="box":/cone/i.test(a)?i="cone":/cylinder/i.test(a)?i="cylinder":/extrude/i.test(a)?i="extrude":/plane/i.test(a)?i="plane":/sphere/i.test(a)?i="sphere":/torus/i.test(a)&&(i="torus");let l=Object.assign(Object.assign({},o),null===(s=null==e?void 0:e.geometry)||void 0===s?void 0:s.parameters);return t.shape?(l=Object.assign(Object.assign({},o),t),i=t.shape):e.shape&&(i=e.shape),Object.keys(l).forEach((e=>{void 0===l[e]&&o[e]&&(l[e]=o[e])})),r&&e.geometry.center(),"cylinder"===i&&(l.radius=t.radius||l.radiusTop),"extrude"===i&&(i="hacd"),"mesh"!==i&&"convex"!==i||(i="convexMesh"),"concave"===i&&(i="concaveMesh"),"unknown"===i&&(os(`Shape for ${null==e?void 0:e.name} not recognized! Will fallback to box.`),i="box"),{shape:i,params:l,object:e}}createCollisionShape(e,t,n){const r=(null==n?void 0:n.quaternion)?null==n?void 0:n.quaternion:new s.Quaternion(0,0,0,1),{axis:o="y"}=t,i=new Ammo.btVector3,a=null==n?void 0:n.geometry;n&&(null==a?void 0:a.isGeometry)&&(n.geometry=(new s.BufferGeometry).fromGeometry(a));let l,c={};switch(-1!==this.complexShapes.indexOf(e)&&(c=(e=>{const t=(new s.Matrix4).elements,n=[],r=[],o=[];return Xs(e,{},((e,t,s)=>{n.push(e),r.push(t),o.push(s)})),{vertices:n,matrices:r,indexes:o,matrixWorld:t}})(n)),e){case"box":i.setValue(t.width/2,t.height/2,t.depth/2),l=new Ammo.btBoxShape(i);break;case"sphere":l=new Ammo.btSphereShape(t.radius);break;case"cylinder":switch(o){case"y":i.setValue(t.radius,t.height/2,t.radius),l=new Ammo.btCylinderShape(i);break;case"x":i.setValue(t.height/2,t.radius,t.radius),l=new Ammo.btCylinderShapeX(i);break;case"z":i.setValue(t.radius,t.radius,t.height/2),l=new Ammo.btCylinderShapeZ(i)}break;case"cone":switch(o){case"y":l=new Ammo.btConeShape(t.radius,t.height);break;case"x":l=new Ammo.btConeShapeX(t.radius,t.height);break;case"z":l=new Ammo.btConeShapeZ(t.radius,t.height)}break;case"capsule":switch(o){case"y":l=new Ammo.btCapsuleShape(t.radius,t.height);break;case"x":l=new Ammo.btCapsuleShapeX(t.radius,t.height);break;case"z":l=new Ammo.btCapsuleShapeZ(t.radius,t.height)}break;case"torus":l=((e,t)=>{const{radius:n=1,tube:s=.4,tubularSegments:r=8}=e,o=Math.PI,i=r,a=Math.sqrt(2*s*s-2*s*s*Math.cos(2*o/i)),l=new Ammo.btVector3(s,o/i+.5*a,s),c=new Ammo.btCylinderShape(l);c.setMargin(.05);const h=new Ammo.btCompoundShape,u=new Ammo.btVector3(0,0,1),d=new Ammo.btVector3(0,n,0),p=new Ammo.btQuaternion(t.x,t.y,t.z,t.w);for(let e=0;e<i;e++){const t=2*e*o/i,n=d.rotate(u,t),s=new Ammo.btTransform;p.setRotation(u,t+Math.PI/2),s.setIdentity(),s.setOrigin(n),s.setRotation(p),h.addChildShape(s,c)}return h})(t,r);break;case"plane":l=Hs(c.vertices,c.matrices,c.indexes,c.matrixWorld,Object.assign(Object.assign({},t),{concave:!1}));break;case"hull":l=Us(c.vertices,c.matrices,c.matrixWorld,t);break;case"hacd":l=zs(c.vertices,c.matrices,c.indexes,c.matrixWorld,t);break;case"vhacd":l=js(c.vertices,c.matrices,c.indexes,c.matrixWorld,t);break;case"convexMesh":l=Hs(c.vertices,c.matrices,c.indexes,c.matrixWorld,Object.assign(Object.assign({},t),{concave:!1}));break;case"concaveMesh":l=Hs(c.vertices,c.matrices,c.indexes,c.matrixWorld,Object.assign(Object.assign({},t),{concave:!0}))}Ammo.destroy(i);const{x:h,y:u,z:d}=t;return(h||u||d)&&(l.offset={x:h||0,y:u||0,z:d||0}),Array.isArray(l)&&(l=this.mergeCollisionShapesToCompoundShape(l)),l}mergeCollisionShapesToCompoundShape(e){const t=new Ammo.btCompoundShape;return e.forEach((e=>{const n=e._tmp;if(n){const{pos:s,quat:r,scale:o,margin:i}=n,a=this.applyPosQuatScaleMargin(e,s,r,o,i);t.addChildShape(a,e)}else{const n=new Ammo.btTransform;n.setIdentity(),t.addChildShape(n,e)}})),t}addExisting(e,t={}){const{hasBody:n}=e;if(n)return void os(`Object "${e.name}" already has a physical body!`);const r=new s.Vector3,o=new s.Quaternion,i=new s.Vector3;e.getWorldPosition(r),e.getWorldQuaternion(o),e.getWorldScale(i);const a="1"===(t.collisionFlags||0).toString(2).slice(-1),l="1"===(t.collisionFlags||0).toString(2).slice(-2,-1),{shape:c="unknown",compound:h=[],mass:u=(a||l?0:1),collisionFlags:d=0,collisionGroup:p=1,collisionMask:m=-1,offset:f,breakable:g=!1,addChildren:v=!0,margin:y=.01,ignoreScale:x=!1,fractureImpulse:b=1}=t;if(x&&i.set(1,1,1),h.length>=1){const t=h.map((e=>this.createCollisionShape(e.shape,e))),n=this.mergeCollisionShapesToCompoundShape(t),s=this.applyPosQuatScaleMargin(n,r,o,i,y),a=this.collisionShapeToRigidBody(n,s,u,l);return this.addRigidBodyToWorld(e,a,d,p,m,f),e.body.breakable=g,e.body.fractureImpulse=b,void(e.body.ignoreScale=x)}const w=[];if("unknown"!==c||e.isMesh){const n=this.prepareThreeObjectForCollisionShape(e,t),s=this.createCollisionShape(n.shape,n.params,n.object);w.push(s)}if("unknown"===c&&v&&e.children.length>=1&&e.children.forEach((e=>{if(e.isMesh){const t=this.prepareThreeObjectForCollisionShape(e),n=this.createCollisionShape(t.shape,t.params,t.object);n._tmp={pos:e.position.clone(),quat:e.quaternion.clone(),scale:e.scale.clone(),margin:y},w.push(n)}})),0===w.length){const n=this.prepareThreeObjectForCollisionShape(e,t),s=this.createCollisionShape(n.shape,n.params,n.object);w.push(s)}const A=1===w.length?w[0]:this.mergeCollisionShapesToCompoundShape(w),M=this.applyPosQuatScaleMargin(A,r,o,i,y),_=this.collisionShapeToRigidBody(A,M,u,l);this.addRigidBodyToWorld(e,_,d,p,m,f),e.body.breakable=g,e.body.fractureImpulse=b,e.body.ignoreScale=x}addRigidBodyToWorld(e,t,n,r,o,i){this.rigidBodies.push(e),this.physicsWorld.addRigidBody(t,r,o);const a=Object.values(t)[0];t.name=e.name,e.body=new class{constructor(e,t){this.physics=e,this.ammo=t,this.ignoreScale=!1,this.isSoftBody=!1,this.offset={x:0,y:0,z:0},this.errors=[],this.checkCollisions=!1,this.breakable=!1,this.fractureImpulse=1,this.didUpdate=!1,this.skipUpdate=!1,this._emitUpdateEvents=!1,this._needUpdate=!1,this.tmpEuler=new s.Euler,this.tmpQuaternion=new s.Quaternion,this.tmpBtVector3=new Ammo.btVector3,this.tmpBtVector3_1=new Ammo.btVector3,this.tmpBtQuaternion=new Ammo.btQuaternion(0,0,0,1),this.eventEmitter=new ks.Events,this.name=t.name}destructor(){this.eventEmitter&&this.eventEmitter.removeAllListeners(),Ammo.destroy(this.tmpBtVector3),Ammo.destroy(this.tmpBtVector3_1),Ammo.destroy(this.tmpBtQuaternion),Ammo.destroy(this.ammo.getCollisionShape()),Ammo.destroy(this.ammo)}setupEventEmitter(){void 0===this.eventEmitter&&(this.eventEmitter=new ks.Events)}get needUpdate(){return this._needUpdate}set needUpdate(e){!e&&this._needUpdate&&(this.didUpdate=!0),this._needUpdate=e}onUpdateEvent(e,t=!1){this.setupEventEmitter(),this._emitUpdateEvents=!0,t?this.eventEmitter.once("update",(()=>{e()})):this.eventEmitter.on("update",(()=>{e()}))}get on(){return{update:e=>this.onUpdateEvent(e),collision:e=>this.onCollision(e)}}get once(){return{update:e=>this.onUpdateEvent(e,!0)}}onCollision(e){this.checkCollisions=!0,this.physics.collisionEvents.on("collision",(t=>{const{bodies:n,event:s}=t;n[0].name===this.name?e(n[1],s):n[1].name===this.name&&e(n[0],s)}))}transform(){const e=this.physics.worldTransform;this.ammo.getMotionState().getWorldTransform(e)}refresh(){const e=this.physics.worldTransform;this.ammo.getMotionState().setWorldTransform(e)}setRotation(e,t,n){const s=this.tmpEuler.set(e,t,n),r=this.tmpQuaternion.set(0,0,0,1);r.setFromEuler(s),this.tmpBtQuaternion.setValue(0,0,0,1);const o=this.tmpBtQuaternion;o.setValue(r.x,r.y,r.z,r.w),this.physics.worldTransform.setRotation(o)}get rotation(){let e,t,n;const s=this.physics.worldTransform.getRotation();let r=this.tmpQuaternion.set(s.x(),s.y(),s.z(),s.w());r.w>1&&(r=r.normalize());const o=2*Math.acos(r.w),i=Math.sqrt(1-r.w*r.w);return i<.001?(e=r.x,t=r.y,n=r.z):(e=r.x/i,t=r.y/i,n=r.z/i),{x:e*o,y:t*o,z:n*o}}get quaternion(){const e=this.physics.worldTransform.getRotation();return{x:e.x(),y:e.y(),z:e.z(),w:e.w()}}setPosition(e,t,n){this.physics.worldTransform.getOrigin().setValue(e,t,n)}get position(){const e=this.physics.worldTransform;return{x:e.getOrigin().x(),y:e.getOrigin().y(),z:e.getOrigin().z()}}get velocity(){return{x:this.ammo.getLinearVelocity().x(),y:this.ammo.getLinearVelocity().y(),z:this.ammo.getLinearVelocity().z()}}get angularVelocity(){return{x:this.ammo.getAngularVelocity().x(),y:this.ammo.getAngularVelocity().y(),z:this.ammo.getAngularVelocity().z()}}setVelocity(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.setLinearVelocity(this.tmpBtVector3)}setVelocityX(e){this.tmpBtVector3.setValue(e,this.velocity.y,this.velocity.z),this.ammo.setLinearVelocity(this.tmpBtVector3)}setVelocityY(e){this.tmpBtVector3.setValue(this.velocity.x,e,this.velocity.z),this.ammo.setLinearVelocity(this.tmpBtVector3)}setVelocityZ(e){this.tmpBtVector3.setValue(this.velocity.x,this.velocity.y,e),this.ammo.setLinearVelocity(this.tmpBtVector3)}setAngularVelocity(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.setAngularVelocity(this.tmpBtVector3)}setAngularVelocityX(e){this.tmpBtVector3.setValue(e,this.angularVelocity.y,this.angularVelocity.z),this.ammo.setAngularVelocity(this.tmpBtVector3)}setAngularVelocityY(e){this.tmpBtVector3.setValue(this.angularVelocity.x,e,this.angularVelocity.z),this.ammo.setAngularVelocity(this.tmpBtVector3)}setAngularVelocityZ(e){this.tmpBtVector3.setValue(this.angularVelocity.x,this.angularVelocity.y,e),this.ammo.setAngularVelocity(this.tmpBtVector3)}applyForce(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.applyCentralImpulse(this.tmpBtVector3)}applyForceX(e){this.tmpBtVector3.setValue(e,0,0),this.ammo.applyCentralImpulse(this.tmpBtVector3)}applyForceY(e){this.tmpBtVector3.setValue(0,e,0),this.ammo.applyCentralImpulse(this.tmpBtVector3)}applyForceZ(e){this.tmpBtVector3.setValue(0,0,e),this.ammo.applyCentralImpulse(this.tmpBtVector3)}applyCentralForce(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.applyCentralForce(this.tmpBtVector3)}applyCentralImpulse(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.applyCentralImpulse(this.tmpBtVector3)}applyCentralLocalForce(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.applyCentralLocalForce(this.tmpBtVector3)}applyImpulse(e,t){this.tmpBtVector3.setValue(e.x||0,e.y||0,e.z||0),this.tmpBtVector3_1.setValue(t.x||0,t.y||0,t.z||0),this.ammo.applyImpulse(this.tmpBtVector3,this.tmpBtVector3_1)}applyLocalTorque(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.applyLocalTorque(this.tmpBtVector3)}applyTorque(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.applyTorque(this.tmpBtVector3)}applyTorqueImpulse(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.applyTorqueImpulse(this.tmpBtVector3)}setCollisionFlags(e){this.ammo.setCollisionFlags(e)}getCollisionFlags(){return this.ammo.getCollisionFlags()}setRestitution(e){this.ammo.setRestitution(e)}setBounciness(e){this.setRestitution(e)}setFriction(e){this.ammo.setFriction(e)}setDamping(e,t){this.ammo.setDamping(e,t)}setGravity(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.setGravity(this.tmpBtVector3)}setLinearFactor(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.setLinearFactor(this.tmpBtVector3)}setAngularFactor(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.setAngularFactor(this.tmpBtVector3)}setCcdMotionThreshold(e){this.ammo.setCcdMotionThreshold(e)}setCcdSweptSphereRadius(e){this.ammo.setCcdSweptSphereRadius(e)}}(this,t),e.hasBody=!0,e.ptr=a,t.threeObject=e,i&&(e.body.offset=Object.assign({x:0,y:0,z:0},i)),e.body.setCollisionFlags(n)}applyPosQuatScaleMargin(e,t=new s.Vector3,n=new s.Quaternion,r=new s.Vector3,o=.01){e.setMargin(o);const i=new Ammo.btQuaternion(0,0,0,1);i.setValue(n.x,n.y,n.z,n.w);const a=new Ammo.btTransform;a.setIdentity(),a.getOrigin().setValue(t.x,t.y,t.z),a.setRotation(i),Ammo.destroy(i);const l=new Ammo.btVector3(r.x,r.y,r.z);return e.setLocalScaling(l),Ammo.destroy(l),a}collisionShapeToRigidBody(e,t,n,s){const r=new Ammo.btDefaultMotionState(t),o=new Ammo.btVector3(0,0,0);n>0&&e.calculateLocalInertia(n,o);const i=new Ammo.btRigidBodyConstructionInfo(n,r,e,o),a=new Ammo.btRigidBody(i);return(n>0||s)&&a.setActivationState(4),a}}console.log("%c %c %c %c %c Powered by enable3d v0.23.0 %c https://enable3d.io/","background: #ff0000","background: #ffff00","background: #00ff00","background: #00ffff","color: #fff; background: #000000;","background: none");class xr extends class{constructor(e={}){this.threeGraphicsConfig=e;const{alpha:t=!1,anisotropy:n=1,camera:r=Rs.Perspective({z:25,y:5}),antialias:o=!1,usePhysics:i=!0,renderer:a}=e;this.textureAnisotropy=n,this.camera=r,this.scene=new s.Scene,this.renderer=a||new s.WebGLRenderer({antialias:o,alpha:t}),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=s.PCFSoftShadowMap,this.cache=s.Cache,this.cache.enabled=!0,i&&("undefined"!=typeof Ammo?this.physics=new yr(this.scene,e):os("Are you sure you included ammo.js?"))}}{constructor(e){var t;super(e),this.projectConfig=e,this.scenes=new Map,this.renderer.setSize(window.innerWidth,window.innerHeight),this.projectConfig.parent?this.parent=document.getElementById(this.projectConfig.parent):this.parent=document.body,this.parent||(os(`Parent "${this.projectConfig.parent}" not found! Will add it to the body.`),this.parent=document.body),this.parent.appendChild(this.renderer.domElement),this.canvas=this.renderer.domElement;let n="";this.projectConfig.scenes.forEach(((e,t)=>{const s=new e;0===t&&(n=s.sceneKey);const r={sceneConfig:{textureAnisotropy:this.textureAnisotropy,autoStart:!1},renderer:this.renderer,parent:this.parent,canvas:this.canvas,scene:this.scene,scenes:this.scenes,camera:this.camera,cache:this.cache,physics:this.physics};s.initializeScene(r),0===t&&(s.setSize(this.parent.clientWidth,this.parent.clientHeight),s.setPixelRatio(Math.max(1,window.devicePixelRatio/2))),this.scenes.set(s.sceneKey,s)})),null===(t=this.scenes.get(n))||void 0===t||t.start(n)}}var br=r(613);const wr=[{name:"pointer",enabled:!0,test:"onpointerdown"in window,events:{down:"pointerdown",move:"pointermove",up:"pointerup"}},{name:"touch",enabled:!0,test:"ontouchstart"in window&&window.navigator.maxTouchPoints>=1,events:{down:"touchstart",move:"touchmove",up:"touchend"}},{name:"mouse",enabled:!0,test:"onmousedown"in window,events:{down:"mousedown",move:"mousemove",up:"mouseup"}}];class Ar{constructor(e){this._events=new br.Events,this.domElement=null,this._isDown=!1,this._isPaused=!1,this.active={touch:!1,mouse:!1,pointer:!1},this.registered={touch:!1,mouse:!1,pointer:!1},this._currentPosition={x:-1,y:-1},this._lastPosition={x:-1,y:-1},this._isPointerLockAvailable="onpointerlockchange"in document,this._add(e)}static get VERSION(){return"0.0.3"}get isDown(){return this._isDown}set _position(e){e.x===this._currentPosition.x&&e.y==this._currentPosition.y||(this._lastPosition=this._currentPosition,this._currentPosition=e)}get currentPosition(){return this._currentPosition}get lastPosition(){return this._lastPosition}get isPaused(){return this._isPaused}pause(){this._isPaused=!0}resume(){this._isPaused=!1}_onPointerLockChange(){return new Promise((e=>{document.addEventListener("pointerlockchange",(t=>{e(t)}),{once:!0})}))}get pointerLock(){return{onceChange:this._onPointerLockChange,request:()=>new Promise(((e,t)=>this._isPointerLockAvailable?this.pointerLock.isLocked?t("Pointer is already locked!"):(this._onPointerLockChange().then((t=>{e(t)})),void this.once.down((()=>{var e;null===(e=this.domElement)||void 0===e||e.requestPointerLock()}))):t("PointerLock is not available!"))),exit:()=>new Promise(((e,t)=>{if(!this.pointerLock.isLocked)return t("Pointer is not locked!");this._onPointerLockChange().then((t=>{e(t)})),document.exitPointerLock()})),available:this._isPointerLockAvailable,isLocked:!!document.pointerLockElement}}get once(){return{down:e=>{this._events.once("down",(t=>{e(t)}))},move:e=>{this._events.once("move",(t=>{e(t)}))},up:e=>{this._events.once("up",(t=>{e(t)}))}}}get on(){return{down:e=>{this._events.on("down",(t=>{this._isPaused||e(t)}))},move:e=>{this._events.on("move",(t=>{this._isPaused||e(t)}))},up:e=>{this._events.on("up",(t=>{this._isPaused||e(t)}))}}}_add(e){const t=this.domElement=null!=e?e:window;t||console.warn("[tap] No domElement found!"),this._onDown=this._onDown.bind(this),this._onMove=this._onMove.bind(this),this._onUp=this._onUp.bind(this),wr.forEach((e=>{e.test&&e.enabled&&(this.active[e.name]=!0,t.addEventListener(e.events.down,this._onDown,!1),t.addEventListener(e.events.move,this._onMove,!1),t.addEventListener(e.events.up,this._onUp,!1))}))}_remove(e){if(!this.active[e])return;const t=this.domElement;t||console.warn("[tap] No domElement found!"),wr.forEach((n=>{n.name===e&&(t.removeEventListener(n.events.down,this._onDown,!1),t.removeEventListener(n.events.move,this._onMove,!1),t.removeEventListener(n.events.up,this._onUp,!1))})),this.active[e]=!1}destroy(){this.pause(),Object.keys(this.active).forEach((e=>{this._remove(e)})),this._events.removeAllListeners(),this._events=null,this.domElement=null,this._isDown=null,this._isPaused=null,this.active=null,this.registered=null,this._currentPosition=null,this._lastPosition=null}_calcPosition(e){let t,n;return e.touches&&e.touches[0]?(t=e.touches[0].pageX,n=e.touches[0].pageY):e.clientX?(t=e.clientX,n=e.clientY):(t=this._currentPosition.x,n=this._currentPosition.y),this.pointerLock.isLocked&&(t=e.movementX,n=e.movementY),this._position={x:t,y:n},{x:t,y:n}}_removeDuplicates(e){return"pointerdown"===e.type&&(this.registered.pointer=!0),"touchstart"===e.type&&(this.registered.touch=!0),"mousedown"===e.type&&(this.registered.mouse=!0),"touchstart"===e.type&&this.active.touch&&this.registered.pointer?(this._remove("touch"),!1):"mousedown"!==e.type||!this.active.mouse||!this.registered.pointer&&!this.registered.touch||(this._remove("mouse"),!1)}_onDown(e){this._removeDuplicates(e)&&(this._isDown=!0,this._events.emit("down",{position:this._calcPosition(e),event:e}))}_onMove(e){this._events.emit("move",{position:this._calcPosition(e),event:e,dragging:this._isDown})}_onUp(e){this._isDown=!1,this._events.emit("up",{position:this._calcPosition(e),event:e})}}const Mr=(e,t,n,s,r,o)=>{s<2*o&&(o=s/2),r<2*o&&(o=r/2),e.beginPath(),e.moveTo(t+o,n),e.arcTo(t+s,n,t+s,n+r,o),e.arcTo(t+s,n+r,t,n+r,o),e.arcTo(t,n+r,t,n,o),e.arcTo(t,n,t+s,n,o),e.closePath()},_r=new Map,Tr=e=>{const t=new s.Texture(e);return t.minFilter=s.LinearFilter,t.generateMipmaps=!1,t.needsUpdate=!0,t},Sr=document.createElement("canvas");let Er,Pr,Cr,Rr=!1;const Lr=[],Vr=new s.Raycaster,kr=new s.Vector2,Ir=new s.Vector2,Or=new s.Vector2,Nr=[],Br=e=>{Nr.includes(e)||(console.warn(e),Nr.push(e))},Dr=(e,t)=>{Or.x=e,Or.y=t},Fr=()=>Er,Ur=()=>{zr(),Cr&&Cr.destroy()},zr=()=>{for(;Lr.length>0;)Lr.pop()},jr=e=>{return t=void 0,n=void 0,r=function*(){if(!Cr)return;const{currentPosition:{x:t,y:n},isDown:s}=Cr;if(kr.x===t&&kr.y===n&&Rr===s)return;if(Rr=s,kr.x=t,kr.y=n,0===Or.x||void 0===Or.x)return void Br("[FLAT] Please call FLAT.setSize() first!");Ir.x=t/Or.x*2-1,Ir.y=-n/Or.y*2+1,Vr.setFromCamera(Ir,e);let r=[...Lr];const o=Vr.intersectObjects(r);0===o.length?document.body.style.cursor="default":document.body.style.cursor="pointer",Pr&&Pr.enabled&&o.length>=0&&(Pr.enabled=!1),Pr&&!Pr.enabled&&0===o.length&&(Pr.enabled=!0);for(let e=0;e<o.length;e++){const t=o[e].object;let n=!1;if(t.pixelPerfect){const e=e=>{Sr.width=e.width,Sr.height=e.height;const t=Sr.getContext("2d");return t.drawImage(e,0,0),t.getImageData(0,0,e.width,e.height)},s=(e,t,n)=>{const s=4*(t+e.width*n),r=e.data;return{r:r[s],g:r[s+1],b:r[s+2],a:r[s+3]}},r=o[0].uv,{x:i,y:a}=t.texture.transformUv(r),l=e(yield createImageBitmap(t.texture.image)),{r:c,g:h,b:u,a:d}=s(l,Math.round(i*l.width),Math.round(a*l.height));n=c+h+u+d===0}if(t.pixelPerfect&&n)continue;t.event=Cr.isDown?"down":"over";const s=r.findIndex((e=>e.uuid===t.uuid));r=[...r.slice(0,s),...r.slice(s+1)];break}return r.forEach((e=>{e.event="out"})),o},new((s=void 0)||(s=Promise))((function(e,o){function i(e){try{l(r.next(e))}catch(e){o(e)}}function a(e){try{l(r.throw(e))}catch(e){o(e)}}function l(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(i,a)}l((r=r.apply(t,n||[])).next())}));var t,n,s,r};class Hr extends s.Sprite{constructor(e,t=!0){super(new s.SpriteMaterial({map:t?e.clone():e,color:16777215})),this._event="out",this._pixelPerfect=!1,this._isInteractive=!1,this._depth=0,this._bodyOffset={x:0,y:0},this._internalScale={x:1,y:1},this._pixelRatio=1,this.onInputOver=()=>{},this.onInputOut=()=>{},this.onInputDown=()=>{},this._setTexture(),this.setScale(this._internalScale.x,this._internalScale.y),this.setDepth(this._calcZ())}_onInputOver(){}_onInputOut(){}_onInputDown(){}set event(e){this._event!==e&&(this._event=e,"over"===e?(this._onInputOver(),this.onInputOver()):"out"===e?(this._onInputOut(),this.onInputOut()):"down"===e&&(this._onInputDown(),this.onInputDown()))}setPixelRatio(e){this._pixelRatio=e,this.setScale(this._internalScale.x,this._internalScale.y)}setInteractive({pixelPerfect:e=!1}={}){var t;this._isInteractive||(this._isInteractive=!0,this._pixelPerfect=e,t=this,0===Lr.length&&(()=>{const e=Fr();e?Cr=new Ar(e):Br('Please call "FLAT.initEvents()" first.')})(),Lr.push(t))}get pixelPerfect(){return this._pixelPerfect}_calcZ(){return this._depth/100-1e-8*this.id}getTexture(){return this.texture}setTexture(e){this._setTexture(e)}get texture(){return this.material.map}_setTexture(e){if(!this.material.map)return void console.warn("Something went wrong!");e&&(this.material.map=e);const{width:t,height:n}=this.material.map.image;this.textureWidth=t,this.textureHeight=n,this.material.map.needsUpdate=!0}getBodyOffset(){return{x:this._bodyOffset.x*this.getScale().x,y:this._bodyOffset.y*this.getScale().y}}setPosition(e,t){this.position.set(e,t,this._calcZ())}setDepth(e){this._depth=e,this.position.setZ(this._calcZ())}setRotation(e){this.material.rotation=e}getRotation(){return this.material.rotation}getPixelRatio(){return this._pixelRatio}getScale(){return{x:this._internalScale.x,y:this._internalScale.y}}setScale(e,t){this._internalScale.x=e,this._internalScale.y=t||e;const n=e,s=t||e;this.scale.set(n*this.textureWidth/this._pixelRatio,s*this.textureHeight/this._pixelRatio,1)}}class Gr extends Hr{constructor(e){super(e),this._anims=[],this._flipX=!1,this._frame={name:"",index:-1,width:-1,height:-1},this._currentIndex=0,this._currentAnimationName=""}get frame(){return{name:this._frame.name,index:this._frame.index,width:this._frame.width*this._internalScale.x*1/this._pixelRatio,height:this._frame.height*this._internalScale.y*1/this._pixelRatio}}get anims(){return{add:this._add.bind(this),get:this.getAnimationByName.bind(this),play:this._play.bind(this),stop:this._stop.bind(this),getName:()=>this._currentAnimationName,name:this._currentAnimationName}}getAnimationByName(e){return this._anims.filter((t=>t.name===e))[0]}_add(e,t){const{start:n,end:s,rate:r=30,repeat:o=-1,timeline:i=[]}=t;if(this.getAnimationByName(e))console.warn(`The animation "${e}" does already exist!`);else{if(0===i.length){if(void 0===s||void 0===n)return void console.warn('You need to provide "start" and "end or a "timeline"!');for(let e=n;e<=s;e++)i.push(e)}this._anims.push({name:e,timeline:i,rate:r,repeat:o})}}_stop(){this.interval&&clearInterval(this.interval)}_play(e){this._stop(),this._currentAnimationName=e;const t=this.getAnimationByName(e);t||console.warn(`Animation "${e}" does not exist!`);const{timeline:n,rate:s,repeat:r}=t;this._currentIndex=-1;let o=0;const i=()=>{if(this._currentIndex++,this._currentIndex>=n.length&&(this._currentIndex=0,o++),this._currentIndex=n[this._currentIndex],!(-1===r||o<r))return this._stop(),void this._events.emit("complete");this.setFrame(this._currentIndex)};return i(),this.interval=window.setInterval((()=>{i()}),1e3/s),{onComplete:e=>this._events.once("complete",e)}}get _events(){return{emit:e=>{this._eventEmitter||(this._eventEmitter=new br.Events),this._eventEmitter.emit(e)},once:(e,t)=>{this._eventEmitter||(this._eventEmitter=new br.Events),this._eventEmitter.once(e,t)}}}}class Wr extends Gr{constructor(e,t){super(e);const{width:n=this.textureWidth,height:s=this.textureHeight}=t;this._tilesHoriz=this.textureWidth/n,this._tilesVert=this.textureHeight/s,this._tilesHoriz!==Math.round(this._tilesHoriz)&&console.warn("The horizontal row does not seem to fit!"),this._tilesVert!==Math.round(this._tilesVert)&&console.warn("The vertical row does not seem to fit!"),this._width=n,this._height=s,this._frame.width=n,this._frame.height=s,this.sizeFrame(1/this._tilesHoriz,1/this._tilesVert),this.scaleFrame()}setScale(e,t){super.setScale(e,t),this.scaleFrame()}scaleFrame(){this.scale.set(this._width*this._internalScale.x/this._pixelRatio,this._height*this._internalScale.y/this._pixelRatio,1)}getRow(e){return Math.floor(e/this._tilesHoriz)}getColumn(e){return e%this._tilesHoriz}sizeFrame(e,t){this.texture.wrapS=this.texture.wrapT=s.RepeatWrapping,this.texture.repeat.set(e,t),this.texture.needsUpdate=!0}offsetTexture(e,t){this._flipX&&(e+=1/this._tilesHoriz),this.texture.offset.setX(e),this.texture.offset.setY(t)}flipX(e){this._flipX=e;let t=1/this._tilesHoriz;const n=1/this._tilesVert;e&&(t*=-1),this.texture.repeat.set(t,n),this.setFrame(this._frame.index)}setFrame(e){this._frame.index=e;const t=this.getColumn(e)/this._tilesHoriz,n=(this._tilesVert-this.getRow(e)-1)/this._tilesVert;this.offsetTexture(t,n)}}class Xr extends Wr{constructor(e,t,n,s,r){super(e,t),this.overFrame=n,this.outFrame=s,this.downFrame=r,this.setFrame(s)}_onInputOver(){this.setFrame(this.overFrame)}_onInputOut(){this.setFrame(this.outFrame)}_onInputDown(){this.setFrame(this.downFrame)}}class qr extends s.Texture{constructor(e,t,n){const r=Sr.getContext("2d");r.clearRect(0,0,Sr.width,Sr.height),Sr.height=t,Sr.width=e,n(r),super(r.getImageData(0,0,Sr.width,Sr.height)),this.minFilter=s.LinearFilter,this.generateMipmaps=!1,this.width=e,this.height=t,this.drawCanvas=n,this.needsUpdate=!0}clone(){return new qr(this.width,this.height,this.drawCanvas).copy(this)}}class Kr extends Hr{constructor(e,t,n){const s=Sr.getContext("2d");s.clearRect(0,0,Sr.width,Sr.height),Sr.height=t,Sr.width=e,n(s);const r=s.getImageData(0,0,Sr.width,Sr.height);super(Tr(r)),this._drawCanvas=n}clone(){return new Kr(this.textureWidth,this.textureHeight,this._drawCanvas).clone()}}const Yr=({canvas:e,orbitControls:t})=>{(e=>{e&&(Pr=e)})(t),(e=>{Er=e})(e)};class $r extends s.Texture{constructor(e,t={}){const{imageData:n,width:r,height:o}=Zr(e,t);super(n),this.width=r,this.height=o,this._text=e,this._styles=t,this._image=n,this.minFilter=s.LinearFilter,this.generateMipmaps=!1,this.needsUpdate=!0}getText(){return this._text}getStyles(){return this._styles}clone(){return new this.constructor(this._text,this._styles).copy(this)}}class Qr extends Hr{constructor(e){super(e,!1),this._text=e.getText(),this._styles=e.getStyles()}getText(){return this._text}getStyles(){return this._styles}setStyles(e){this._styles=e,this.texture.dispose(),this.setTexture(Tr(Zr(this._text,e).imageData))}setText(e){this._text=e,this.texture.dispose(),this.setTexture(Tr(Zr(e,this._styles).imageData)),this._update()}_update(){this.textureHeight=this.texture.image.height,this.textureWidth=this.texture.image.width,this.texture.needsUpdate=!0,this.material.needsUpdate=!0;const{x:e,y:t}=this._internalScale;this.setScale(e,t)}}const Zr=(e,t)=>{const{align:n="center",background:s="",baseline:r="middle",borderColor:o="",borderRadius:i=0,borderWidth:a=0,fillStyle:l="SlateBlue",fontFamily:c="Arial",fontSize:h=48,fontWeight:u="",lineHeight:d=1,lineWidth:p=4,padding:m=0,strokeStyle:f=""}=t,{offset:{x:g=0,y:v=0}={}}=t;let y,x;"number"!=typeof m?(y=m.x||0,x=m.y||0):(y=m,x=m);const b=`${u} ${h}px ${c}`,w=Sr.getContext("2d");w.clearRect(0,0,Sr.width,Sr.height);const A=e.split("\n");w.font=b;const M=((e,t,n,s=1)=>{const r=t+n;let o=_r.get(r);if(!o){const i=document.createElement("p");i.style.fontFamily=n,i.style.fontSize=`${t}px`,i.style.whiteSpace="nowrap",i.style.lineHeight=s.toString(),i.textContent=e,document.body.appendChild(i),o=Math.ceil(i.offsetHeight),document.body.removeChild(i),_r.set(r,o)}return o})(e,h,c,d),_=l?2*p:p,T=M*A.length+2*x+2*a,S=((e,t)=>Math.max(...t.map((t=>Math.ceil(e.measureText(t).width)))))(w,A)+_+2*y+2*a;Sr.height=T,Sr.width=S,o&&(w.strokeStyle=o,Mr(w,a/2,a/2,Sr.width-a,Sr.height-a,i),w.lineWidth=a,w.stroke()),s&&(w.fillStyle=s,Mr(w,a,a,Sr.width-2*a,Sr.height-2*a,o?i/2:i),w.fill()),w.font=b,w.textAlign=n,w.textBaseline=r,f&&p&&(w.strokeStyle=f,w.lineWidth=_),l&&(w.fillStyle=l);for(var E=0;E<A.length;E++){let e=E*M+M/2,t=0;"left"===n&&(t=_/2,t+=y,t+=a),"center"===n&&(t=S/2),"right"===n&&(t=S-_/2,t-=y,t-=a),e+=x,e+=a,e+=v,t+=g,f&&p&&w.strokeText(A[E],t,e),l&&w.fillText(A[E],t,e)}return{imageData:w.getImageData(0,0,Sr.width,Sr.height),width:S,height:T}};class Jr extends Gr{constructor(e,t){super(e.texture),this.positionOffset={x:0,y:0},this.JSONHash=e.json,t&&this.setFrame(t)}setScale(e,t){this._internalScale.x=e,this._internalScale.y=t||e,this.scaleFrame()}scaleFrame(){var e;if(!(null===(e=this._frame)||void 0===e?void 0:e.name))return;const{frame:{w:t,h:n}}=this.getFrame(this._frame.name),s=t*this._internalScale.x/this._pixelRatio,r=n*this._internalScale.y/this._pixelRatio;this.scale.set(s,r,1)}sizeFrame(e,t){this.texture.wrapS=this.texture.wrapT=s.RepeatWrapping,this.texture.repeat.set(e,t),this.texture.needsUpdate=!0}offsetTexture(e,t){this.texture.offset.setX(e),this.texture.offset.setY(t)}flipX(e){this._flipX=e,this.update()}getFrame(e){return this.JSONHash.frames[e]}setFrame(e){this.update(e)}update(e){if(e||(e=this._frame.name),!e)return;const t=this.getFrame(e);t||console.warn(`Frame ${e} not found!`);const{frame:n,rotated:s,trimmed:r,spriteSourceSize:o,sourceSize:i}=t;this._frame.name=e,this.texture.rotation=0;const a=n.x/this.textureWidth;let l=1-(n.y+n.h)/this.textureHeight,c=n.w,h=n.h;if(this._frame.width=c,this._frame.height=h,s&&(this.texture.rotation=Math.PI/2,l=1-n.y/this.textureHeight,[c,h]=[h,c],this._flipX&&(this.texture.rotation*=-1)),r){const e=((i.w-n.w)/2-o.x)/(1/this._internalScale.x),t=((i.h-n.h)/2-o.y)/(1/this._internalScale.x);this._flipX?this.position.x+=e-this.positionOffset.x:this.position.x-=e-this.positionOffset.x,this.position.y+=t-this.positionOffset.y,this.positionOffset.x=e,this.positionOffset.y=t}let u=a,d=l,p=c/this.textureWidth;const m=h/this.textureHeight;this._flipX&&(p*=-1,s?d-=n.w/this.textureHeight:u+=n.w/this.textureWidth),this.offsetTexture(u,d),this.sizeFrame(p,m),this.scaleFrame()}}var eo=r(626);const to={colors:{dynamic:"#ff0000",static:"#90ee90",sensor:"#ffff00",sleeping:"#464646"},lineWidth:2,fill:!1,opacity:.25},no=(e,t=0,n,s)=>{const r=((e={})=>{const{colors:t}=to;return e.isStatic?t.static:e.isSensor?t.sensor:e.isSleeping?t.sleeping:t.dynamic})(e),o=to.opacity,i=to.lineWidth,a=to.fill;let l=null!=n?n:r+Math.round(255*o).toString(16);a||(l=null!=n?n:"transparent"),!e.isSleeping||e.isStatic||e.isSensor||(l=null!=n?n:r);const c=null!=s?s:r;e.render.fillStyle=l,e.render.strokeStyle=c,e.render.lineWidth=i,t>=5||e.parts.forEach((e=>{no(e,t+1,l,c)}))};class so{constructor(e=!0){this._objects=new Map,this.width=window.innerWidth,this.height=window.innerHeight;const t=e;if(this.engine=eo.Engine.create({enableSleeping:!0}),this.world=this.engine.world,this.runner=eo.Runner.create(),t){const e=document.createElement("canvas");e.id="matter-debug",e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.pointerEvents="none",document.body.append(e),this.render=eo.Render.create({canvas:e,engine:this.engine,options:{width:this.width,height:this.height,background:"transparent",wireframeBackground:"transparent",wireframes:!1,showConvexHulls:!0,showPositions:!0,showVelocity:!0}}),eo.Render.run(this.render)}eo.Runner.run(this.runner,this.engine),eo.Events.on(this.engine,"afterUpdate",(()=>this.update()))}destroy(){eo.World.clear(this.world,!1),eo.Engine.clear(this.engine)}parsePhysics(e){const t=JSON.parse(e);delete t.generator_info;let n={};for(const e in t){const s=t[e].fixtures;n=Object.assign(Object.assign({},n),{[e]:s})}return n}addBodyFromFixtures(e,t,n){const s=[];let r;return n.forEach((n=>{let r;n.vertices?r=this.add.fromVertices(e,t,n.vertices):n.circle?r=this.add.circle(e+n.circle.x,t+n.circle.y,n.circle.radius):console.log("Shape not recognized!"),r&&s.push(r)})),r=s.length>1?eo.Body.create({parts:s}):s[0],eo.Body.setPosition(r,{x:e,y:t}),r}fromVertices_Fixed(e,t,n,s={}){const r=[];for(var o=0;o<n.length;o++){const i=eo.Bodies.fromVertices(e,t,[n[o]],Object.assign({},s));r.push(i);const a=eo.Vertices.centre(n[o]);eo.Body.setPosition(i,{x:i.position.x+a.x,y:i.position.y+a.y})}return eo.Body.create(Object.assign(Object.assign({},s),{parts:r}))}fromVertices(e,t,n,s={}){return this.fromVertices_Fixed(e,t,n,Object.assign({},s))}setBounds(e=0,t=0,n=this.width,s=this.height,r=50){eo.World.add(this.world,[this.add.rectangle(e+n/2,t+0-r/2,n+2*r,r,{isStatic:!0}),this.add.rectangle(e+n/2,t+s+r/2,n+2*r,r,{isStatic:!0}),this.add.rectangle(e+0-r/2,t+s/2,r,s+2*r,{isStatic:!0}),this.add.rectangle(e+n+r/2,t+s/2,r,s+2*r,{isStatic:!0})])}rectangle(e,t,n,s,r={}){return eo.Bodies.rectangle(e,t,n,s,Object.assign({},r))}circle(e,t,n,s={}){return eo.Bodies.circle(e,t,n,Object.assign({},s))}existing(e){this.add.bodyToSprite(e),this._objects.set(e.body.id.toString(),e)}calcBodyOffset(e){const t=e.body,n=t.bounds.max.x-t.bounds.min.x,s=t.bounds.max.y-t.bounds.min.y,r=eo.Vector.sub(t.bounds.min,t.position),o=(t.position,{x:r.x+n/2,y:r.y+s/2});e._bodyOffset=o}_addBodyToSprite(e){this.add.body(e.body),this.calcBodyOffset(e);const t=e.getScale().x,n=e.getScale().y;((e,t,n)=>{e.circleRadius||e.parts.forEach((e=>{((e,t,n)=>{e.circleRadius&&(t===n?e.circleRadius*=t:e.circleRadius=void 0)})(e,t,n)})),eo.Body.scale(e,t,n)})(e.body,t,n),e.setBodyPosition=(t,n)=>{eo.Body.setPosition(e.body,{x:t-e.getBodyOffset().x,y:n-e.getBodyOffset().y})}}_addBody(e){eo.World.add(this.world,e)}get add(){return{body:this._addBody.bind(this),bodyToSprite:this._addBodyToSprite.bind(this),fromVertices:this.fromVertices.bind(this),circle:this.circle.bind(this),existing:this.existing.bind(this),rectangle:this.rectangle.bind(this)}}adjustDebugColor(e){no(e)}update(){this._objects.forEach((e=>{const{body:t}=e,{angle:n,position:r}=t,{x:o,y:i}=r,a=new s.Vector2(e.getBodyOffset().x,e.getBodyOffset().y);a.rotateAround(new s.Vector2,n),e.setPosition(o+a.x,this.height-i-a.y),e.setRotation(-n),no(t)}))}}class ro extends ks.Events{constructor(){super(...arguments),this.id=-1}get add(){return{axis:(e={})=>this.addAxis(e),button:(e={})=>this.addButton(e)}}addAxis(e={}){this.id++;const{styles:t={left:35,bottom:35,size:100}}=e,n=this.circle({styles:t}),s=this.thumb({styles:t});n.appendChild(s),document.body.appendChild(n);const{maxRadius:r=40,rotationDamping:o=.06,moveDamping:i=.01}=e,a={id:this.id,domElement:s,maxRadius:r,maxRadiusSquared:r*r,origin:{left:s.offsetLeft,top:s.offsetTop},offset:{x:0,y:0},rotationDamping:o,moveDamping:i};if(null==a?void 0:a.domElement){const{domElement:e}=a;"ontouchstart"in window?e.addEventListener("touchstart",(e=>{e.preventDefault(),this.tap(e,a),e.stopPropagation()})):e.addEventListener("mousedown",(e=>{e.preventDefault(),this.tap(e,a),e.stopPropagation()}))}return{onMove:e=>{this.on(`axis_onmove_${a.id}`,(t=>{e(t)}))}}}addButton(e={}){this.id++;const{styles:t={right:35,bottom:35,size:80},letter:n="A"}=e,s=this.circle({styles:t}),r=this.letter({letter:n});s.appendChild(r),document.body.appendChild(s);const o={id:this.id,domElement:s,offset:{x:0,y:0}};return(null==o?void 0:o.domElement)&&this.click(o),{onClick:e=>{this.on(`button_onclick_${o.id}`,(t=>{e(t)}))},onRelease:e=>{this.on(`button_onrelease_${o.id}`,(t=>{e(t)}))}}}circle(e={}){const{styles:t}=e,{top:n,right:s,bottom:r,left:o,size:i}=t,a=document.createElement("div");let l=`position:absolute; width:${i}px; height:${i}px; background:rgba(126, 126, 126, 0.5); border:#444 solid medium; border-radius:50%; cursor: pointer; `;return n&&(l+=`top:${n}px; `),s&&(l+=`right:${s}px; `),r&&(l+=`bottom:${r}px; `),o&&(l+=`left:${o}px; `),a.style.cssText=l,a}thumb(e={}){const{styles:t}=e,{size:n}=t,s=document.createElement("div");return s.style.cssText=`position: absolute; left: ${n/4}px; top: ${n/4}px; width: ${n/2}px; height: ${n/2}px; border-radius: 50%; background: #fff; `,s}letter(e={}){const{letter:t}=e,n=document.createElement("span");return n.innerText=t,n.style.cssText="position: absolute; text-align: center; top: 4px; width: 80px; height: 80px; font-size: 64px; color: #fff; ",n}click(e){const{id:t,domElement:n}=e;"ontouchstart"in window?(n.addEventListener("touchstart",(e=>{e.preventDefault(),this.emit(`button_onclick_${t}`)})),n.addEventListener("touchend",(e=>{e.preventDefault(),this.emit(`button_onrelease_${t}`)}))):(n.addEventListener("mousedown",(e=>{e.preventDefault(),this.emit(`button_onclick_${t}`),e.stopPropagation()})),n.addEventListener("mouseup",(e=>{e.preventDefault(),this.emit(`button_onrelease_${t}`),e.stopPropagation()})))}tap(e,t){e=e||window.event,t.offset=this.getMousePosition(e),"ontouchstart"in window?(document.ontouchmove=e=>{e.target===t.domElement&&this.move(e,t)},document.ontouchend=e=>{e.target===t.domElement&&this.up(t)}):(document.onmousemove=e=>{e.target===t.domElement&&this.move(e,t)},document.onmouseup=e=>{this.up(t)})}move(e,t){const{domElement:n,maxRadius:s,maxRadiusSquared:r,origin:o,offset:i,id:a}=t;e=e||window.event;const l=this.getMousePosition(e);let c=l.x-i.x,h=l.y-i.y;const u=c*c+h*h;if(u>r){const e=Math.sqrt(u);c/=e,h/=e,c*=s,h*=s}n.style.top=`${h+n.clientHeight/2}px`,n.style.left=`${c+n.clientWidth/2}px`;const d=-(h-o.top+n.clientHeight/2)/s,p=(c-o.left+n.clientWidth/2)/s;this.emit(`axis_onmove_${a}`,{top:d,right:p})}up(e){const{domElement:t,origin:n,id:s}=e;"ontouchstart"in window?(document.ontouchmove=null,document.touchend=null):(document.onmousemove=null,document.onmouseup=null),t.style.top=`${n.top}px`,t.style.left=`${n.left}px`,this.emit(`axis_onmove_${s}`,{top:0,right:0})}getMousePosition(e){return{x:e.targetTouches?e.targetTouches[0].pageX:e.clientX,y:e.targetTouches?e.targetTouches[0].pageY:e.clientY}}}class oo{constructor(e,t,n){this.camera=e,this.target=t,this.config=n;const{offset:r=new s.Vector3(0,0,0),sensitivity:o=new s.Vector2(.25,.25),radius:i=8,targetRadius:a=10,interpolationFactor:l=.05,pointerLock:c=!0,autoUpdate:h=!0,theta:u=0,phi:d=0,maxPhi:p=85,minPhi:m=-85}=n;this.offset=r,this.sensitivity=o,this.radius=i,this.targetRadius=a,this.interpolationFactor=l,this.theta=u,this.phi=d,this.maxPhi=p,this.minPhi=m}update(e,t){const n=this.target.position.clone().add(this.offset);this.theta-=e*(this.sensitivity.x/2),this.theta%=360,this.phi+=t*(this.sensitivity.y/2),this.phi=Math.min(this.maxPhi,Math.max(this.minPhi,this.phi)),this.radius=s.MathUtils.lerp(this.radius,this.targetRadius,this.interpolationFactor),this.camera.position.x=n.x+this.radius*Math.sin(this.theta*Math.PI/180)*Math.cos(this.phi*Math.PI/180),this.camera.position.y=n.y+this.radius*Math.sin(this.phi*Math.PI/180),this.camera.position.z=n.z+this.radius*Math.cos(this.theta*Math.PI/180)*Math.cos(this.phi*Math.PI/180),this.camera.updateMatrix(),this.camera.lookAt(n)}}class io{constructor(e,t,n){this.camera=e,this.target=t,this.config=n;const{offset:r=new s.Vector3(0,0,0),sensitivity:o=new s.Vector2(.25,.25),radius:i=8,targetRadius:a=10,interpolationFactor:l=.05,pointerLock:c=!0,autoUpdate:h=!0}=n;this.offset=r,this.sensitivity=o,this.radius=i,this.targetRadius=a,this.interpolationFactor=l,this.theta=0,this.phi=0}update(e,t){const n=this.target.position.clone().add(this.offset);this.camera.position.copy(n),this.theta-=e*(this.sensitivity.x/2),this.theta%=360,this.phi+=t*(-this.sensitivity.y/2),this.phi=Math.min(85,Math.max(-85,this.phi));const r=new s.Vector3;r.x=n.x+this.radius*Math.sin(this.theta*Math.PI/180)*Math.cos(this.phi*Math.PI/180),r.y=n.y+this.radius*Math.sin(this.phi*Math.PI/180),r.z=n.z+this.radius*Math.cos(this.theta*Math.PI/180)*Math.cos(this.phi*Math.PI/180),this.camera.updateMatrix(),this.camera.lookAt(r)}}class ao{constructor(e,t=!0){this._element=e,this._isRunning=!1,t&&this.request()}isLocked(){return!!document.pointerLockElement}exit(){this._isRunning=!1,document.exitPointerLock(),this.removeListeners()}removeListeners(){document.removeEventListener("pointerlockchange",(()=>this.pointerLockChangeHandler())),this._element.removeEventListener("pointerdown",(()=>this.pointerDownHandlerHandler()))}pointerLockChangeHandler(){this._isRunning&&this._request()}pointerDownHandlerHandler(){this._isRunning&&this._element.requestPointerLock()}request(){this._isRunning=!0,this._request()}_request(){document.addEventListener("pointerlockchange",(()=>this.pointerLockChangeHandler()),{once:!0}),document.pointerLockElement||this._element.addEventListener("pointerdown",(()=>this.pointerDownHandlerHandler()),{once:!0})}}class lo{constructor(e,t=!0){this._element=e,this._isRunning=!1,this._position={x:0,y:0},this._delta={x:0,y:0},this._onMoveCallback=()=>{},this._isPointerDown=!1,t&&this.start()}get isTouchDevice(){return"ontouchstart"in window}get isPointerDown(){return this._isPointerDown}start(){this._isRunning||(this._isRunning=!0,this.isTouchDevice?(this._element.addEventListener("touchstart",(e=>this.onTouchStart(e))),this._element.addEventListener("touchend",(e=>this.onTouchEnd(e))),this._element.addEventListener("touchmove",(e=>this.onTouchMove(e)))):(this._element.addEventListener("mousedown",(e=>this.onPointerDown(e))),this._element.addEventListener("mouseup",(e=>this.onPointerUp(e))),this._element.addEventListener("mouseleave",(e=>this.onPointerLeave(e))),this._element.addEventListener("mouseover",(e=>this.onPointerOver(e))),this._element.addEventListener("mousemove",(e=>this.onPointerMove(e)))))}stop(){this.isTouchDevice?(this._element.removeEventListener("touchstart",(e=>this.onTouchStart(e))),this._element.removeEventListener("touchend",(e=>this.onTouchEnd(e))),this._element.removeEventListener("touchmove",(e=>this.onTouchMove(e)))):(this._element.removeEventListener("mousedown",(e=>this.onPointerDown(e))),this._element.removeEventListener("mouseleave",(e=>this.onPointerLeave(e))),this._element.removeEventListener("mouseup",(e=>this.onPointerUp(e))),this._element.removeEventListener("mouseover",(e=>this.onPointerOver(e))),this._element.removeEventListener("mousemove",(e=>this.onPointerMove(e)))),this._isRunning=!1}removeListeners(){this.stop()}onMove(e){this._onMoveCallback=e}onPointerDown(e){this._isPointerDown=!0}onPointerUp(e){this._isPointerDown=!1}onPointerLeave(e){this._isPointerDown=!1}onPointerMove(e){const t=e.movementX,n=e.movementY;this._delta={x:t,y:n},this._onMoveCallback(this._delta)}onPointerOver(e){}onTouchStart(e){const t=e.touches[0].clientX,n=e.touches[0].clientY;this._position={x:t,y:n}}onTouchEnd(e){this._position={x:0,y:0},this._delta={x:0,y:0},this._onMoveCallback(this._delta)}onTouchMove(e){const t=e.touches[0].clientX,n=e.touches[0].clientY;this._delta={x:t-this._position.x,y:n-this._position.y},this._onMoveCallback(this._delta),this._position={x:t,y:n}}}var co={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform float opacity;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\t\t\tgl_FragColor = opacity * texel;\n\n\t\t}"};class ho{constructor(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}}const uo=new s.OrthographicCamera(-1,1,1,-1,0,1),po=new s.BufferGeometry;po.setAttribute("position",new s.Float32BufferAttribute([-1,3,0,-1,-1,0,3,-1,0],3)),po.setAttribute("uv",new s.Float32BufferAttribute([0,2,0,0,2,0],2));class mo{constructor(e){this._mesh=new s.Mesh(po,e)}dispose(){this._mesh.geometry.dispose()}render(e){e.render(this._mesh,uo)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}}class fo extends ho{constructor(e,t){super(),this.textureID=void 0!==t?t:"tDiffuse",e instanceof s.ShaderMaterial?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=s.UniformsUtils.clone(e.uniforms),this.material=new s.ShaderMaterial({defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.fsQuad=new mo(this.material)}render(e,t,n){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=n.texture),this.fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}}class go extends ho{constructor(e,t){super(),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,n){const s=e.getContext(),r=e.state;let o,i;r.buffers.color.setMask(!1),r.buffers.depth.setMask(!1),r.buffers.color.setLocked(!0),r.buffers.depth.setLocked(!0),this.inverse?(o=0,i=1):(o=1,i=0),r.buffers.stencil.setTest(!0),r.buffers.stencil.setOp(s.REPLACE,s.REPLACE,s.REPLACE),r.buffers.stencil.setFunc(s.ALWAYS,o,4294967295),r.buffers.stencil.setClear(i),r.buffers.stencil.setLocked(!0),e.setRenderTarget(n),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),r.buffers.color.setLocked(!1),r.buffers.depth.setLocked(!1),r.buffers.stencil.setLocked(!1),r.buffers.stencil.setFunc(s.EQUAL,1,4294967295),r.buffers.stencil.setOp(s.KEEP,s.KEEP,s.KEEP),r.buffers.stencil.setLocked(!0)}}class vo extends ho{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}class yo{constructor(e,t){if(this.renderer=e,void 0===t){const n={minFilter:s.LinearFilter,magFilter:s.LinearFilter,format:s.RGBAFormat},r=e.getSize(new s.Vector2);this._pixelRatio=e.getPixelRatio(),this._width=r.width,this._height=r.height,(t=new s.WebGLRenderTarget(this._width*this._pixelRatio,this._height*this._pixelRatio,n)).texture.name="EffectComposer.rt1"}else this._pixelRatio=1,this._width=t.width,this._height=t.height;this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],void 0===co&&console.error("THREE.EffectComposer relies on CopyShader"),void 0===fo&&console.error("THREE.EffectComposer relies on ShaderPass"),this.copyPass=new fo(co),this.clock=new s.Clock}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const t=this.passes.indexOf(e);-1!==t&&this.passes.splice(t,1)}isLastEnabledPass(e){for(let t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){void 0===e&&(e=this.clock.getDelta());const t=this.renderer.getRenderTarget();let n=!1;for(let t=0,s=this.passes.length;t<s;t++){const s=this.passes[t];if(!1!==s.enabled){if(s.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(t),s.render(this.renderer,this.writeBuffer,this.readBuffer,e,n),s.needsSwap){if(n){const t=this.renderer.getContext(),n=this.renderer.state.buffers.stencil;n.setFunc(t.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),n.setFunc(t.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==go&&(s instanceof go?n=!0:s instanceof vo&&(n=!1))}}this.renderer.setRenderTarget(t)}reset(e){if(void 0===e){const t=this.renderer.getSize(new s.Vector2);this._pixelRatio=this.renderer.getPixelRatio(),this._width=t.width,this._height=t.height,(e=this.renderTarget1.clone()).setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;const n=this._width*this._pixelRatio,s=this._height*this._pixelRatio;this.renderTarget1.setSize(n,s),this.renderTarget2.setSize(n,s);for(let e=0;e<this.passes.length;e++)this.passes[e].setSize(n,s)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}}new s.OrthographicCamera(-1,1,1,-1,0,1);const xo=new s.BufferGeometry;xo.setAttribute("position",new s.Float32BufferAttribute([-1,3,0,-1,-1,0,3,-1,0],3)),xo.setAttribute("uv",new s.Float32BufferAttribute([0,2,0,0,2,0],2));class bo extends ho{constructor(e,t,n,r,o){super(),this.scene=e,this.camera=t,this.overrideMaterial=n,this.clearColor=r,this.clearAlpha=void 0!==o?o:0,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new s.Color}render(e,t,n){const s=e.autoClear;let r,o;e.autoClear=!1,void 0!==this.overrideMaterial&&(o=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor&&(e.getClearColor(this._oldClearColor),r=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:n),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),this.clearColor&&e.setClearColor(this._oldClearColor,r),void 0!==this.overrideMaterial&&(this.scene.overrideMaterial=o),e.autoClear=s}}const wo={uniforms:{tDiffuse:{value:null},tDisp:{value:null},byp:{value:0},amount:{value:.08},angle:{value:.02},seed:{value:.02},seed_x:{value:.02},seed_y:{value:.02},distortion_x:{value:.5},distortion_y:{value:.6},col_s:{value:.05}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\t\tvoid main() {\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t}",fragmentShader:"\n\n\t\tuniform int byp; //should we apply the glitch ?\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform sampler2D tDisp;\n\n\t\tuniform float amount;\n\t\tuniform float angle;\n\t\tuniform float seed;\n\t\tuniform float seed_x;\n\t\tuniform float seed_y;\n\t\tuniform float distortion_x;\n\t\tuniform float distortion_y;\n\t\tuniform float col_s;\n\n\t\tvarying vec2 vUv;\n\n\n\t\tfloat rand(vec2 co){\n\t\t\treturn fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n\t\t}\n\n\t\tvoid main() {\n\t\t\tif(byp<1) {\n\t\t\t\tvec2 p = vUv;\n\t\t\t\tfloat xs = floor(gl_FragCoord.x / 0.5);\n\t\t\t\tfloat ys = floor(gl_FragCoord.y / 0.5);\n\t\t\t\t//based on staffantans glitch shader for unity https://github.com/staffantan/unityglitch\n\t\t\t\tvec4 normal = texture2D (tDisp, p*seed*seed);\n\t\t\t\tif(p.y<distortion_x+col_s && p.y>distortion_x-col_s*seed) {\n\t\t\t\t\tif(seed_x>0.){\n\t\t\t\t\t\tp.y = 1. - (p.y + distortion_y);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tp.y = distortion_y;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif(p.x<distortion_y+col_s && p.x>distortion_y-col_s*seed) {\n\t\t\t\t\tif(seed_y>0.){\n\t\t\t\t\t\tp.x=distortion_x;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tp.x = 1. - (p.x + distortion_x);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tp.x+=normal.x*seed_x*(seed/5.);\n\t\t\t\tp.y+=normal.y*seed_y*(seed/5.);\n\t\t\t\t//base from RGB shift shader\n\t\t\t\tvec2 offset = amount * vec2( cos(angle), sin(angle));\n\t\t\t\tvec4 cr = texture2D(tDiffuse, p + offset);\n\t\t\t\tvec4 cga = texture2D(tDiffuse, p);\n\t\t\t\tvec4 cb = texture2D(tDiffuse, p - offset);\n\t\t\t\tgl_FragColor = vec4(cr.r, cga.g, cb.b, cga.a);\n\t\t\t\t//add noise\n\t\t\t\tvec4 snow = 200.*amount*vec4(rand(vec2(xs * seed,ys * seed*50.))*0.2);\n\t\t\t\tgl_FragColor = gl_FragColor+ snow;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tgl_FragColor=texture2D (tDiffuse, vUv);\n\t\t\t}\n\t\t}"};class Ao extends ho{constructor(e=64){super(),void 0===wo&&console.error("THREE.GlitchPass relies on DigitalGlitch");const t=wo;this.uniforms=s.UniformsUtils.clone(t.uniforms),this.uniforms.tDisp.value=this.generateHeightmap(e),this.material=new s.ShaderMaterial({uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader}),this.fsQuad=new mo(this.material),this.goWild=!1,this.curF=0,this.generateTrigger()}render(e,t,n){this.uniforms.tDiffuse.value=n.texture,this.uniforms.seed.value=Math.random(),this.uniforms.byp.value=0,this.curF%this.randX==0||1==this.goWild?(this.uniforms.amount.value=Math.random()/30,this.uniforms.angle.value=s.MathUtils.randFloat(-Math.PI,Math.PI),this.uniforms.seed_x.value=s.MathUtils.randFloat(-1,1),this.uniforms.seed_y.value=s.MathUtils.randFloat(-1,1),this.uniforms.distortion_x.value=s.MathUtils.randFloat(0,1),this.uniforms.distortion_y.value=s.MathUtils.randFloat(0,1),this.curF=0,this.generateTrigger()):this.curF%this.randX<this.randX/5?(this.uniforms.amount.value=Math.random()/90,this.uniforms.angle.value=s.MathUtils.randFloat(-Math.PI,Math.PI),this.uniforms.distortion_x.value=s.MathUtils.randFloat(0,1),this.uniforms.distortion_y.value=s.MathUtils.randFloat(0,1),this.uniforms.seed_x.value=s.MathUtils.randFloat(-.3,.3),this.uniforms.seed_y.value=s.MathUtils.randFloat(-.3,.3)):0==this.goWild&&(this.uniforms.byp.value=1),this.curF++,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(),this.fsQuad.render(e))}generateTrigger(){this.randX=s.MathUtils.randInt(120,240)}generateHeightmap(e){const t=new Float32Array(e*e*3),n=e*e;for(let e=0;e<n;e++){const n=s.MathUtils.randFloat(0,1);t[3*e+0]=n,t[3*e+1]=n,t[3*e+2]=n}return new s.DataTexture(t,e,e,s.RGBFormat,s.FloatType)}}const Mo={uniforms:{tDiffuse:{value:null},tSize:{value:new s.Vector2(256,256)},center:{value:new s.Vector2(.5,.5)},angle:{value:1.57},scale:{value:1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform vec2 center;\n\t\tuniform float angle;\n\t\tuniform float scale;\n\t\tuniform vec2 tSize;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tfloat pattern() {\n\n\t\t\tfloat s = sin( angle ), c = cos( angle );\n\n\t\t\tvec2 tex = vUv * tSize - center;\n\t\t\tvec2 point = vec2( c * tex.x - s * tex.y, s * tex.x + c * tex.y ) * scale;\n\n\t\t\treturn ( sin( point.x ) * sin( point.y ) ) * 4.0;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvec4 color = texture2D( tDiffuse, vUv );\n\n\t\t\tfloat average = ( color.r + color.g + color.b ) / 3.0;\n\n\t\t\tgl_FragColor = vec4( vec3( average * 10.0 - 5.0 + pattern() ), color.a );\n\n\t\t}"}})(),o})()}));
//# sourceMappingURL=enable3d.framework.0.23.0.min.js.map