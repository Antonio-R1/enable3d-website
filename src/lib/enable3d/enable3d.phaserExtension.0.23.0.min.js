/*! For license information please see enable3d.phaserExtension.0.23.0.min.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("THREE"),require("Phaser"),require("Matter")):"function"==typeof define&&define.amd?define(["THREE","Phaser","Matter"],t):"object"==typeof exports?exports.ENABLE3D=t(require("THREE"),require("Phaser"),require("Matter")):e.ENABLE3D=t(e.THREE,e.Phaser,e.Matter)}(self,(function(e,t,n){return(()=>{"use strict";var r={650:function(e,t,n){var r=this&&this.__spreadArray||function(e,t){for(var n=0,r=t.length,s=e.length;n<r;n++,s++)e[s]=t[n];return e};Object.defineProperty(t,"__esModule",{value:!0}),t.Events=void 0;var s=n(406),o=function(e,t,n){void 0===n&&(n=!1),this.fn=e,this.context=t,this.once=n},i=function(e,t,n,r,s){if("function"!=typeof n)throw new TypeError("The listener must be a function");var i=new o(n,r||e,s);return e._events.has(t)?e._events.get(t).fn?e._events.set(t,[e._events.get(t),i]):e._events.get(t).push(i):(e._events.set(t,i),e._eventsCount++),e},a=function(e,t){0==--e._eventsCount?e._events=new Map:e._events.delete(t)},l=function(){function e(){this._events=new Map,this._eventsCount=0}return Object.defineProperty(e,"VERSION",{get:function(){return s.VERSION},enumerable:!1,configurable:!0}),e.prototype.eventNames=function(){return Array.from(this._events.keys())},e.prototype.listeners=function(e){var t=this._events.get(e);if(!t)return[];if(t.fn)return[t.fn];for(var n=0,r=t.length,s=new Array(r);n<r;n++)s[n]=t[n].fn;return s},e.prototype.listenerCount=function(e){var t=this._events.get(e);return t?t.fn?1:t.length:0},e.prototype.emit=function(e){for(var t,n,s=[],o=1;o<arguments.length;o++)s[o-1]=arguments[o];if(!this._events.has(e))return!1;var i,a=this._events.get(e);if(a.fn)return a.once&&this.removeListener(e,a.fn,void 0,!0),(t=a.fn).call.apply(t,r([a.context],s)),!0;var l=a.length;for(i=0;i<l;i++)a[i].once&&this.removeListener(e,a[i].fn,void 0,!0),(n=a[i].fn).call.apply(n,r([a[i].context],s));return!0},e.prototype.on=function(e,t,n){return i(this,e,t,n,!1)},e.prototype.once=function(e,t,n){return i(this,e,t,n,!0)},e.prototype.removeListener=function(e,t,n,r){if(!this._events.has(e))return this;if(!t)return a(this,e),this;var s=this._events.get(e);if(s.fn)s.fn!==t||r&&!s.once||n&&s.context!==n||a(this,e);else{for(var o=0,i=[],l=s.length;o<l;o++)(s[o].fn!==t||r&&!s[o].once||n&&s[o].context!==n)&&i.push(s[o]);i.length?this._events.set(e,1===i.length?i[0]:i):a(this,e)}return this},e.prototype.removeAllListeners=function(e){return e?this._events.delete(e)&&a(this,e):(this._events=new Map,this._eventsCount=0),this},Object.defineProperty(e.prototype,"off",{get:function(){return this.removeListener},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"addListener",{get:function(){return this.on},enumerable:!1,configurable:!0}),e}();t.Events=l},406:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.VERSION=void 0,t.VERSION="0.0.5"},197:function(e,t,n){var r=this&&this.__spreadArray||function(e,t){for(var n=0,r=t.length,s=e.length;n<r;n++,s++)e[s]=t[n];return e};Object.defineProperty(t,"__esModule",{value:!0}),t.Events=void 0;var s=n(789),o=function(e,t,n){void 0===n&&(n=!1),this.fn=e,this.context=t,this.once=n},i=function(e,t,n,r,s){if("function"!=typeof n)throw new TypeError("The listener must be a function");var i=new o(n,r||e,s);return e._events.has(t)?e._events.get(t).fn?e._events.set(t,[e._events.get(t),i]):e._events.get(t).push(i):(e._events.set(t,i),e._eventsCount++),e},a=function(e,t){0==--e._eventsCount?e._events=new Map:e._events.delete(t)},l=function(){function e(){this._events=new Map,this._eventsCount=0}return Object.defineProperty(e,"VERSION",{get:function(){return s.VERSION},enumerable:!1,configurable:!0}),e.prototype.eventNames=function(){return Array.from(this._events.keys())},e.prototype.listeners=function(e){var t=this._events.get(e);if(!t)return[];if(t.fn)return[t.fn];for(var n=0,r=t.length,s=new Array(r);n<r;n++)s[n]=t[n].fn;return s},e.prototype.listenerCount=function(e){var t=this._events.get(e);return t?t.fn?1:t.length:0},e.prototype.emit=function(e){for(var t,n,s=[],o=1;o<arguments.length;o++)s[o-1]=arguments[o];if(!this._events.has(e))return!1;var i,a=this._events.get(e);if(a.fn)return a.once&&this.removeListener(e,a.fn,void 0,!0),(t=a.fn).call.apply(t,r([a.context],s)),!0;var l=a.length;for(i=0;i<l;i++)a[i].once&&this.removeListener(e,a[i].fn,void 0,!0),(n=a[i].fn).call.apply(n,r([a[i].context],s));return!0},e.prototype.on=function(e,t,n){return i(this,e,t,n,!1)},e.prototype.once=function(e,t,n){return i(this,e,t,n,!0)},e.prototype.removeListener=function(e,t,n,r){if(!this._events.has(e))return this;if(!t)return a(this,e),this;var s=this._events.get(e);if(s.fn)s.fn!==t||r&&!s.once||n&&s.context!==n||a(this,e);else{for(var o=0,i=[],l=s.length;o<l;o++)(s[o].fn!==t||r&&!s[o].once||n&&s[o].context!==n)&&i.push(s[o]);i.length?this._events.set(e,1===i.length?i[0]:i):a(this,e)}return this},e.prototype.removeAllListeners=function(e){return e?this._events.delete(e)&&a(this,e):(this._events=new Map,this._eventsCount=0),this},Object.defineProperty(e.prototype,"off",{get:function(){return this.removeListener},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"addListener",{get:function(){return this.on},enumerable:!1,configurable:!0}),e}();t.Events=l},789:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.VERSION=void 0,t.VERSION="0.0.5"},613:function(e,t,n){var r=this&&this.__spreadArray||function(e,t){for(var n=0,r=t.length,s=e.length;n<r;n++,s++)e[s]=t[n];return e};Object.defineProperty(t,"__esModule",{value:!0}),t.Events=void 0;var s=n(547),o=function(e,t,n){void 0===n&&(n=!1),this.fn=e,this.context=t,this.once=n},i=function(e,t,n,r,s){if("function"!=typeof n)throw new TypeError("The listener must be a function");var i=new o(n,r||e,s);return e._events.has(t)?e._events.get(t).fn?e._events.set(t,[e._events.get(t),i]):e._events.get(t).push(i):(e._events.set(t,i),e._eventsCount++),e},a=function(e,t){0==--e._eventsCount?e._events=new Map:e._events.delete(t)},l=function(){function e(){this._events=new Map,this._eventsCount=0}return Object.defineProperty(e,"VERSION",{get:function(){return s.VERSION},enumerable:!1,configurable:!0}),e.prototype.eventNames=function(){return Array.from(this._events.keys())},e.prototype.listeners=function(e){var t=this._events.get(e);if(!t)return[];if(t.fn)return[t.fn];for(var n=0,r=t.length,s=new Array(r);n<r;n++)s[n]=t[n].fn;return s},e.prototype.listenerCount=function(e){var t=this._events.get(e);return t?t.fn?1:t.length:0},e.prototype.emit=function(e){for(var t,n,s=[],o=1;o<arguments.length;o++)s[o-1]=arguments[o];if(!this._events.has(e))return!1;var i,a=this._events.get(e);if(a.fn)return a.once&&this.removeListener(e,a.fn,void 0,!0),(t=a.fn).call.apply(t,r([a.context],s)),!0;var l=a.length;for(i=0;i<l;i++)a[i].once&&this.removeListener(e,a[i].fn,void 0,!0),(n=a[i].fn).call.apply(n,r([a[i].context],s));return!0},e.prototype.on=function(e,t,n){return i(this,e,t,n,!1)},e.prototype.once=function(e,t,n){return i(this,e,t,n,!0)},e.prototype.removeListener=function(e,t,n,r){if(!this._events.has(e))return this;if(!t)return a(this,e),this;var s=this._events.get(e);if(s.fn)s.fn!==t||r&&!s.once||n&&s.context!==n||a(this,e);else{for(var o=0,i=[],l=s.length;o<l;o++)(s[o].fn!==t||r&&!s[o].once||n&&s[o].context!==n)&&i.push(s[o]);i.length?this._events.set(e,1===i.length?i[0]:i):a(this,e)}return this},e.prototype.removeAllListeners=function(e){return e?this._events.delete(e)&&a(this,e):(this._events=new Map,this._eventsCount=0),this},Object.defineProperty(e.prototype,"off",{get:function(){return this.removeListener},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"addListener",{get:function(){return this.on},enumerable:!1,configurable:!0}),e}();t.Events=l},547:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.VERSION=void 0,t.VERSION="0.0.5"},626:e=>{e.exports=n},298:e=>{e.exports=t},428:t=>{t.exports=e}},s={};function o(e){var t=s[e];if(void 0!==t)return t.exports;var n=s[e]={exports:{}};return r[e].call(n.exports,n,n.exports,o),n.exports}o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};return(()=>{o.r(i),o.d(i,{Canvas:()=>bs,DotScreenShader:()=>To,EffectComposer:()=>xo,ExtendedGroup:()=>d,ExtendedMesh:()=>u,ExtendedObject3D:()=>h,FLAT:()=>t,FirstPersonControls:()=>ao,GlitchPass:()=>Mo,JoyStick:()=>oo,PhysicsLoader:()=>q,PointerDrag:()=>co,PointerLock:()=>lo,RenderPass:()=>wo,Scene3D:()=>ys,ShaderPass:()=>go,THREE:()=>r,ThirdPersonControls:()=>io,Types:()=>n,enable3d:()=>xs});var e={};o.r(e),o.d(e,{AsyncCompress:()=>Et,AsyncDecompress:()=>Ht,AsyncDeflate:()=>xt,AsyncGunzip:()=>Lt,AsyncGzip:()=>Et,AsyncInflate:()=>Mt,AsyncUnzipInflate:()=>vn,AsyncUnzlib:()=>Ft,AsyncZipDeflate:()=>un,AsyncZlib:()=>Ot,Compress:()=>St,DecodeUTF8:()=>Qt,Decompress:()=>jt,Deflate:()=>yt,EncodeUTF8:()=>Zt,Gunzip:()=>Rt,Gzip:()=>St,Inflate:()=>At,Unzip:()=>yn,UnzipInflate:()=>gn,UnzipPassThrough:()=>fn,Unzlib:()=>Dt,Zip:()=>dn,ZipDeflate:()=>hn,ZipPassThrough:()=>cn,Zlib:()=>It,compress:()=>Pt,compressSync:()=>Ct,decompress:()=>Gt,decompressSync:()=>Wt,deflate:()=>bt,deflateSync:()=>wt,gunzip:()=>Vt,gunzipSync:()=>kt,gzip:()=>Pt,gzipSync:()=>Ct,inflate:()=>Tt,inflateSync:()=>_t,strFromU8:()=>en,strToU8:()=>Jt,unzip:()=>xn,unzipSync:()=>bn,unzlib:()=>Ut,unzlibSync:()=>zt,zip:()=>pn,zipSync:()=>mn,zlib:()=>Nt,zlibSync:()=>Bt});var t={};o.r(t),o.d(t,{ActionSprite:()=>Ws,Button:()=>qs,DrawSprite:()=>Ks,DrawTexture:()=>Ys,SimpleSprite:()=>Gs,SpriteSheet:()=>Xs,TextSprite:()=>Zs,TextTexture:()=>Qs,TextureAtlas:()=>eo,destroy:()=>zs,getParent:()=>Us,initEvents:()=>$s,physics:()=>so,setSize:()=>Fs,updateEvents:()=>Hs});var n={};o.r(n);var r=o(428);class s{perspectiveCamera(e={}){return s.Perspective(e)}orthographicCamera(e={}){return s.Orthographic(e)}static Perspective(e={}){const{fov:t=50,aspect:n=window.innerWidth/window.innerHeight,near:s=.1,far:o=2e3,x:i=0,y:a=5,z:l=25}=e,c=new r.PerspectiveCamera(t,n,s,o);return c.position.set(i,a,l),c}static Orthographic(e={}){const t=window.innerWidth,n=window.innerHeight,{left:s=t/-2,right:o=t/2,top:i=n/2,bottom:a=n/-2,near:l=1,far:c=1e3,x:h=0,y:u=0,z:d=10}=e,p=new r.OrthographicCamera(s,o,i,a,l,c);return p.position.set(h,u,d),p}}const a=new Map,l=(e,t=!1)=>{if(a.has(e)){const t=a.get(e);if(void 0===t)return;if(t>=5)return;a.set(e,t+1)}else a.set(e,1);t?console.error(`%c [enable3d] ${e} `,"background: #222; color: #bada55"):console.warn(`%c [enable3d] ${e} `,"background: #222; color: #bada55")};var c=o(197);class h extends r.Object3D{constructor(){super(),this.isExtendedObject3D=!0,this.isGroup=!1,this.vector3=new r.Vector3,this.hasBody=!1,this.fragmentDepth=0,this.breakable=!1,this.fractureImpulse=1,this._currentAnimation="",this._animationActions=new Map,this.name=`object-${this.id}`}get world(){return{theta:this.worldTheta,phi:this.worldPhi}}get worldTheta(){return this.getWorldDirection(this.vector3),Math.atan2(this.vector3.x,this.vector3.z)}get worldPhi(){return this.getWorldDirection(this.vector3),Math.acos(this.vector3.y)}set animationMixer(e){this._animationMixer=e}get animationMixer(){return this._animationMixer||(this._animationMixer=new r.AnimationMixer(this)),this._animationMixer}get anims(){return{current:this._currentAnimation,add:(e,t)=>this._animsAdd(e,t),get:e=>this._animsGet(e),play:(e,t=500,n=!0)=>this._animsPlay(e,t,n),mixer:this.animationMixer}}get animation(){return l('Please use "anims" instead of "animation"'),this.anims}_animsAdd(e,t){this._animationActions.set(e,this.animationMixer.clipAction(t))}_animsGet(e){const t=this._animationActions.get(e);return t||l(`Animation(${e}) not found!`),t}_animsPlay(e,t=500,n=!0){const s=this._animationActions.get(e),o=this._animationActions.get(this._currentAnimation);s&&(s.reset(),o&&(s.crossFadeFrom(o,t/1e3,!0),s.clampWhenFinished=!0),n||s.setLoop(r.LoopOnce,0),s.play()),this._currentAnimation=e}setAction(e){l(`setAction(${e}) is deprecated. Use animation.play(${e}) instead!`)}traverse(e){super.traverse(e)}traverseVisible(e){super.traverseVisible(e)}traverseAncestors(e){super.traverseAncestors(e)}}class u extends r.Mesh{constructor(e,t){super(e,t),this.isExtendedMesh=!0,this.isGroup=!1,this.vector3=new r.Vector3,this.hasBody=!1,this.fragmentDepth=0,this.breakable=!1,this.fractureImpulse=1,this.name=`object-${this.id}`}get world(){return{theta:this.worldTheta,phi:this.worldPhi}}get worldTheta(){return this.getWorldDirection(this.vector3),Math.atan2(this.vector3.x,this.vector3.z)}get worldPhi(){return this.getWorldDirection(this.vector3),Math.acos(this.vector3.y)}}class d extends r.Group{constructor(){super(),this.isExtendedGroup=!0,this.isMesh=!1,this.hasBody=!1,this.fragmentDepth=0,this.breakable=!1,this.fractureImpulse=1,this.name=`object-${this.id}`}}class p{constructor(e,t){this.worldTransform=e,this.physicsWorld=t,this.tmpBtVector3=new Ammo.btVector3}toAmmoV3(e,t=0){return new Ammo.btVector3(void 0!==(null==e?void 0:e.x)?e.x:t,void 0!==(null==e?void 0:e.y)?e.y:t,void 0!==(null==e?void 0:e.z)?e.z:t)}get addConstraints(){return{lock:(e,t,n)=>this.lock(e,t,n),fixed:(e,t,n)=>this.fixed(e,t,n),pointToPoint:(e,t,n,r)=>this.pointToPoint(e,t,n,r),hinge:(e,t,n,r)=>this.hinge(e,t,n,r),slider:(e,t,n={},r)=>this.slider(e,t,n,r),spring:(e,t,n={},r)=>this.spring(e,t,n,r),coneTwist:(e,t,n={frameA:{},frameB:{}},r)=>this.coneTwist(e,t,n,r),dof:(e,t,n,r)=>this.dof(e,t,n,r)}}getTransform(e,t,n={x:0,y:0,z:0},r=!1){n=Object.assign({x:0,y:0,z:0},n);const s=new Ammo.btTransform;if(s.setIdentity(),r){const r=(o=e.getWorldTransform().getOrigin(),i=t.getWorldTransform().getOrigin(),a=(o.x()-i.x())/2+n.x,l=(o.y()-i.y())/2+n.y,c=(o.z()-i.z())/2+n.z,new Ammo.btVector3(a,l,c)),s=new Ammo.btTransform;s.setIdentity(),s.setOrigin(r);const h=e.getCenterOfMassTransform().inverse().op_mul(t.getWorldTransform());return h.op_mul(s),{transformA:h,transformB:s}}return s.setOrigin(new Ammo.btVector3(n.x,n.y,n.z)),{transformA:e.getCenterOfMassTransform().inverse().op_mul(t.getWorldTransform()).op_mul(s),transformB:s};var o,i,a,l,c}lock(e,t,n=!0){const r={x:0,y:0,z:0};return this.dof(e,t,{angularLowerLimit:r,angularUpperLimit:r},n)}fixed(e,t,n=!0){const r=this.getTransform(e.ammo,t.ammo);r.transformA.setRotation(e.ammo.getWorldTransform().getRotation()),r.transformB.setRotation(t.ammo.getWorldTransform().getRotation());const s=new Ammo.btFixedConstraint(e.ammo,t.ammo,r.transformA,r.transformB);return this.physicsWorld.addConstraint(s,n),s}pointToPoint(e,t,n={},r=!0){const{pivotA:s,pivotB:o}=n,i=new Ammo.btVector3((null==s?void 0:s.x)||0,(null==s?void 0:s.y)||0,(null==s?void 0:s.z)||0),a=new Ammo.btVector3((null==o?void 0:o.x)||0,(null==o?void 0:o.y)||0,(null==o?void 0:o.z)||0),l=new Ammo.btPoint2PointConstraint(e.ammo,t.ammo,i,a);return this.physicsWorld.addConstraint(l,r),l}hinge(e,t,n={},r=!0){const{pivotA:s,pivotB:o,axisA:i,axisB:a}=n,l=new Ammo.btVector3((null==s?void 0:s.x)||0,(null==s?void 0:s.y)||0,(null==s?void 0:s.z)||0),c=new Ammo.btVector3((null==o?void 0:o.x)||0,(null==o?void 0:o.y)||0,(null==o?void 0:o.z)||0),h=new Ammo.btVector3((null==i?void 0:i.x)||0,(null==i?void 0:i.y)||0,(null==i?void 0:i.z)||0),u=new Ammo.btVector3((null==a?void 0:a.x)||0,(null==a?void 0:a.y)||0,(null==a?void 0:a.z)||0),d=new Ammo.btHingeConstraint(e.ammo,t.ammo,l,c,h,u,!0);return this.physicsWorld.addConstraint(d,r),d}slider(e,t,n={},r=!0){const s=this.getTransform(e.ammo,t.ammo),{frameA:o={},frameB:i={},linearLowerLimit:a=0,linearUpperLimit:l=0,angularLowerLimit:c=0,angularUpperLimit:h=0}=n,u=s.transformA.getRotation();u.setEulerZYX(o.x||0,o.y||0,o.z||0),s.transformA.setRotation(u);const d=s.transformB.getRotation();d.setEulerZYX(i.x||0,i.y||0,i.z||0),s.transformB.setRotation(d);const p=new Ammo.btSliderConstraint(e.ammo,t.ammo,s.transformA,s.transformB,!0);return p.setLowerLinLimit(a),p.setUpperLinLimit(l),p.setLowerAngLimit(c),p.setUpperAngLimit(h),this.physicsWorld.addConstraint(p,r),p}spring(e,t,n={},r=!0){const{stiffness:s=50,damping:o=.01,angularLock:i=!1,linearLowerLimit:a={},linearUpperLimit:l={},angularLowerLimit:c={},angularUpperLimit:h={},offset:u={},center:d=!1,enableSpring:p=!0}=n,m=Object.assign({x:0,y:0,z:0},u),f=this.getTransform(e.ammo,t.ammo,m,d),g=new Ammo.btGeneric6DofSpringConstraint(e.ammo,t.ammo,f.transformA,f.transformB,!0);this.tmpBtVector3.setValue(a.x||0,a.y||0,a.z||0),g.setLinearLowerLimit(this.tmpBtVector3),this.tmpBtVector3.setValue(l.x||0,l.y||0,l.z||0),g.setLinearUpperLimit(this.tmpBtVector3),i?(this.tmpBtVector3.setValue(0,0,0),g.setAngularLowerLimit(this.tmpBtVector3),g.setAngularUpperLimit(this.tmpBtVector3)):(console.log(c,h),g.setAngularLowerLimit(this.toAmmoV3(c,-Math.PI)),g.setAngularUpperLimit(this.toAmmoV3(h,Math.PI)));for(let e=0;e<3;e++)g.enableSpring(e,p),g.setStiffness(e,s),g.setDamping(e,o);return this.physicsWorld.addConstraint(g,r),g}coneTwist(e,t,n,r=!0){const{frameA:s,frameB:o}=n,i=new Ammo.btTransform;i.setIdentity(),i.getOrigin().setValue((null==s?void 0:s.x)||0,(null==s?void 0:s.y)||0,(null==s?void 0:s.z)||0);const a=new Ammo.btTransform;a.setIdentity(),a.getOrigin().setValue((null==o?void 0:o.x)||0,(null==o?void 0:o.y)||0,(null==o?void 0:o.z)||0),this.getTransform(e.ammo,t.ammo);const l=new Ammo.btConeTwistConstraint(t.ammo,e.ammo,i,a);return l.setAngularOnly(!0),this.physicsWorld.addConstraint(l,r),l}dof(e,t,n={},r=!0){const{offset:s,center:o=!1}=n,i=Object.assign({x:0,y:0,z:0},s),a=this.getTransform(e.ammo,t.ammo,i,o),l=new Ammo.btGeneric6DofConstraint(e.ammo,t.ammo,a.transformA,a.transformB,!0),{linearLowerLimit:c,linearUpperLimit:h,angularLowerLimit:u,angularUpperLimit:d}=n,p=this.toAmmoV3(c),m=this.toAmmoV3(h),f=this.toAmmoV3(u,-Math.PI),g=this.toAmmoV3(d,Math.PI);return l.setLinearLowerLimit(p),l.setLinearUpperLimit(m),l.setAngularLowerLimit(f),l.setAngularUpperLimit(g),Ammo.destroy(p),Ammo.destroy(m),Ammo.destroy(f),Ammo.destroy(g),this.physicsWorld.addConstraint(l,r),l}}var m=o(650);const f="hull",g="manual",v=function(){const e=new r.Vector3,t=new r.Vector3,n=new r.Matrix4;return function(r,s,o,i={}){if(i.type=f,w(i),i.fit===g)return console.warn("cannot use fit: manual with type: hull"),null;const a=_(r,s),l=new Ammo.btVector3,c=new Ammo.btConvexHullShape;c.setMargin(i.margin),t.addVectors(a.max,a.min).multiplyScalar(.5);let h=0;for(let e=0;e<r.length;e++)h+=r[e].length/3;const u=i.hullMaxVertices||1e5;h>u&&console.warn(`too many vertices for hull shape; sampling ~${u} from ~${h} vertices`);const d=Math.min(1,u/h);for(let o=0;o<r.length;o++){const i=r[o];n.fromArray(s[o]);for(let s=0;s<i.length;s+=3){const a=o===r.length-1&&s===i.length-3;(Math.random()<=d||a)&&(e.set(i[s],i[s+1],i[s+2]).applyMatrix4(n).sub(t),l.setValue(e.x,e.y,e.z),c.addPoint(l,a))}}let p=c;if(c.getNumVertices()>=100){const e=new Ammo.btShapeHull(c);e.buildHull(i.margin),Ammo.destroy(c),p=new Ammo.btConvexHullShape(Ammo.getPointer(e.getVertexPointer()),e.numVertices()),Ammo.destroy(e)}return Ammo.destroy(l),A(p,i,T(o,i)),p}}(),y=function(){const e=new r.Vector3,t=new r.Vector3,n=new r.Matrix4;return function(r,s,o,i,a={}){if(a.type="hacd",w(a),a.fit===g)return console.warn("cannot use fit: manual with type: hacd"),[];if(!Ammo.hasOwnProperty("HACD"))return console.warn("HACD unavailable in included build of Ammo.js. Visit https://github.com/mozillareality/ammo.js for the latest version."),[];const l=_(r,s),c=T(i,a);let h=0,u=0;t.addVectors(l.max,l.min).multiplyScalar(.5);for(let e=0;e<r.length;e++)h+=r[e].length/3,o&&o[e]?u+=o[e].length/3:u+=r[e].length/9;const d=new Ammo.HACD;a.hasOwnProperty("compacityWeight")&&d.SetCompacityWeight(a.compacityWeight),a.hasOwnProperty("volumeWeight")&&d.SetVolumeWeight(a.volumeWeight),a.hasOwnProperty("nClusters")&&d.SetNClusters(a.nClusters),a.hasOwnProperty("nVerticesPerCH")&&d.SetNVerticesPerCH(a.nVerticesPerCH),a.hasOwnProperty("concavity")&&d.SetConcavity(a.concavity);const p=Ammo._malloc(3*h*8),m=Ammo._malloc(3*u*4);d.SetPoints(p),d.SetTriangles(m),d.SetNPoints(h),d.SetNTriangles(u);let f=p/8,v=m/4;for(let i=0;i<r.length;i++){const a=r[i];n.fromArray(s[i]);for(let r=0;r<a.length;r+=3)e.set(a[r+0],a[r+1],a[r+2]).applyMatrix4(n).sub(t),Ammo.HEAPF64[f+0]=e.x,Ammo.HEAPF64[f+1]=e.y,Ammo.HEAPF64[f+2]=e.z,f+=3;if(o[i]){const e=o[i];for(let t=0;t<e.length;t++)Ammo.HEAP32[v]=e[t],v++}else for(let e=0;e<a.length/3;e++)Ammo.HEAP32[v]=e,v++}d.Compute(),Ammo._free(p),Ammo._free(m);const y=d.GetNClusters(),x=[];for(let e=0;e<y;e++){const t=new Ammo.btConvexHullShape;t.setMargin(a.margin);const n=d.GetNPointsCH(e),r=d.GetNTrianglesCH(e),s=Ammo._malloc(3*n*8),o=Ammo._malloc(3*r*4);d.GetCH(e,s,o);const i=s/8;for(let e=0;e<n;e++){const r=new Ammo.btVector3,s=Ammo.HEAPF64[i+3*e+0],o=Ammo.HEAPF64[i+3*e+1],a=Ammo.HEAPF64[i+3*e+2];r.setValue(s,o,a),t.addPoint(r,e===n-1),Ammo.destroy(r)}A(t,a,c),x.push(t)}return x}}(),x=function(){const e=new r.Vector3,t=new r.Vector3,n=new r.Matrix4;return function(r,s,o,i,a={}){if(a.type="vhacd",w(a),a.fit===g)return console.warn("cannot use fit: manual with type: vhacd"),[];if(!Ammo.hasOwnProperty("VHACD"))return console.warn("VHACD unavailable in included build of Ammo.js. Visit https://github.com/mozillareality/ammo.js for the latest version."),[];const l=_(r,s),c=T(i,a);let h=0,u=0;t.addVectors(l.max,l.min).multiplyScalar(.5);for(let e=0;e<r.length;e++)h+=r[e].length/3,o&&o[e]?u+=o[e].length/3:u+=r[e].length/9;const d=new Ammo.VHACD,p=new Ammo.Parameters;a.hasOwnProperty("resolution")&&p.set_m_resolution(a.resolution),a.hasOwnProperty("depth")&&p.set_m_depth(a.depth),a.hasOwnProperty("concavity")&&p.set_m_concavity(a.concavity),a.hasOwnProperty("planeDownsampling")&&p.set_m_planeDownsampling(a.planeDownsampling),a.hasOwnProperty("convexhullDownsampling")&&p.set_m_convexhullDownsampling(a.convexhullDownsampling),a.hasOwnProperty("alpha")&&p.set_m_alpha(a.alpha),a.hasOwnProperty("beta")&&p.set_m_beta(a.beta),a.hasOwnProperty("gamma")&&p.set_m_gamma(a.gamma),a.hasOwnProperty("pca")&&p.set_m_pca(a.pca),a.hasOwnProperty("mode")&&p.set_m_mode(a.mode),a.hasOwnProperty("maxNumVerticesPerCH")&&p.set_m_maxNumVerticesPerCH(a.maxNumVerticesPerCH),a.hasOwnProperty("minVolumePerCH")&&p.set_m_minVolumePerCH(a.minVolumePerCH),a.hasOwnProperty("convexhullApproximation")&&p.set_m_convexhullApproximation(a.convexhullApproximation),a.hasOwnProperty("oclAcceleration")&&p.set_m_oclAcceleration(a.oclAcceleration);const m=Ammo._malloc(3*h*8+3),f=Ammo._malloc(3*u*4);let v=m/8,y=f/4;for(let i=0;i<r.length;i++){const a=r[i];n.fromArray(s[i]);for(let r=0;r<a.length;r+=3)e.set(a[r+0],a[r+1],a[r+2]).applyMatrix4(n).sub(t),Ammo.HEAPF64[v+0]=e.x,Ammo.HEAPF64[v+1]=e.y,Ammo.HEAPF64[v+2]=e.z,v+=3;if(o[i]){const e=o[i];for(let t=0;t<e.length;t++)Ammo.HEAP32[y]=e[t],y++}else for(let e=0;e<a.length/3;e++)Ammo.HEAP32[y]=e,y++}d.Compute(m,3,h,f,3,u,p),Ammo._free(m),Ammo._free(f);const x=d.GetNConvexHulls(),b=[],M=new Ammo.ConvexHull;for(let e=0;e<x;e++){d.GetConvexHull(e,M);const t=M.get_m_nPoints(),n=(M.get_m_points(),new Ammo.btConvexHullShape);n.setMargin(a.margin);for(let e=0;e<t;e++){const r=new Ammo.btVector3,s=M.get_m_points(3*e+0),o=M.get_m_points(3*e+1),i=M.get_m_points(3*e+2);r.setValue(s,o,i),n.addPoint(r,e===t-1),Ammo.destroy(r)}A(n,a,c),b.push(n)}return Ammo.destroy(M),Ammo.destroy(d),b}}(),b=function(){const e=new r.Vector3,t=new r.Vector3,n=new r.Vector3,s=new r.Matrix4;return function(r,o,i,a,l={}){if(l.type="mesh",w(l),l.fit===g)return console.warn("cannot use fit: manual with type: mesh"),null;const c=T(a,l),h=new Ammo.btVector3,u=new Ammo.btVector3,d=new Ammo.btVector3,p=new Ammo.btTriangleMesh(!0,!1);for(let a=0;a<r.length;a++){const l=r[a],c=i[a]?i[a]:null;if(s.fromArray(o[a]),c)for(let r=0;r<c.length;r+=3){const o=3*c[r],i=3*c[r+1],a=3*c[r+2];e.set(l[o],l[o+1],l[o+2]).applyMatrix4(s),t.set(l[i],l[i+1],l[i+2]).applyMatrix4(s),n.set(l[a],l[a+1],l[a+2]).applyMatrix4(s),h.setValue(e.x,e.y,e.z),u.setValue(t.x,t.y,t.z),d.setValue(n.x,n.y,n.z),p.addTriangle(h,u,d,!1)}else for(let r=0;r<l.length;r+=9)e.set(l[r+0],l[r+1],l[r+2]).applyMatrix4(s),t.set(l[r+3],l[r+4],l[r+5]).applyMatrix4(s),n.set(l[r+6],l[r+7],l[r+8]).applyMatrix4(s),h.setValue(e.x,e.y,e.z),u.setValue(t.x,t.y,t.z),d.setValue(n.x,n.y,n.z),p.addTriangle(h,u,d,!1)}const m=new Ammo.btVector3(c.x,c.y,c.z);let f;return p.setScaling(m),Ammo.destroy(m),f=l.concave?new Ammo.btBvhTriangleMeshShape(p,!0,!0):new Ammo.btConvexTriangleMeshShape(p,!0),f.resources=[p],Ammo.destroy(h),Ammo.destroy(u),Ammo.destroy(d),A(f,l),f}}();function w(e){e.type=e.type||f,e.margin=e.hasOwnProperty("margin")?e.margin:.01}const A=function(e,t,n){},M=function(){const e=new r.Matrix4;return function(t,n,s){parseInt(r.REVISION)>=123?e.copy(t.matrixWorld).invert():e.getInverse(t.matrixWorld),(new r.Vector3).setFromMatrixScale(t.matrixWorld),t.traverse((o=>{const i=new r.Matrix4;o.isMesh&&(n.includeInvisible||o.el&&o.el.object3D.visible||o.visible)&&(o===t?i.identity():(o.updateWorldMatrix(!0),i.multiplyMatrices(e,o.matrixWorld)),s(o.geometry.isBufferGeometry?o.geometry.attributes.position.array:o.geometry.vertices,i.elements,o.geometry.index?o.geometry.index.array:null))}))}}(),T=function(){const e=new r.Matrix4;return function(t,n={}){const s=new r.Vector3(1,1,1);return"all"===n.fit&&(e.fromArray(t),s.setFromMatrixScale(e)),s}}(),_=(new r.Vector3,function(e,t){const n=new r.Box3;let s=1/0,o=1/0,i=1/0,a=-1/0,l=-1/0,c=-1/0;return n.min.set(0,0,0),n.max.set(0,0,0),S(e,t,(e=>{e.x<s&&(s=e.x),e.y<o&&(o=e.y),e.z<i&&(i=e.z),e.x>a&&(a=e.x),e.y>l&&(l=e.y),e.z>c&&(c=e.z)})),n.min.set(s,o,i),n.max.set(a,l,c),n}),S=function(){const e=new r.Vector3,t=new r.Matrix4;return function(n,r,s){for(let o=0;o<n.length;o++){t.fromArray(r[o]);for(let r=0;r<n[o].length;r+=3)e.set(n[o][r],n[o][r+1],n[o][r+2]).applyMatrix4(t),s(e)}}}(),E=class{constructor(){this._defaultMaterial=new r.MeshLambertMaterial({color:13421772})}get(){return this._defaultMaterial}};var P=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(r=Object.getOwnPropertySymbols(e);s<r.length;s++)t.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(e,r[s])&&(n[r[s]]=e[r[s]])}return n};class C{constructor(e){this.scene=e,this.isHeadless="headless"===e,this.defaultMaterial=new E}get make(){return{plane:(e={},t={})=>this.makePlane(e,t),box:(e={},t={})=>this.makeBox(e,t),sphere:(e={},t={})=>this.makeSphere(e,t),cylinder:(e={},t={})=>this.makeCylinder(e,t),cone:(e={},t={})=>this.makeCone(e,t),torus:(e={},t={})=>this.makeTorus(e,t),extrude:(e,t={})=>this.makeExtrude(e,t)}}get add(){return{mesh:e=>this.addMesh(e),existing:e=>this.addExisting(e),plane:(e={},t={})=>this.addPlane(e,t),box:(e={},t={})=>this.addBox(e,t),ground:(e,t={})=>this.addGround(e,t),sphere:(e={},t={})=>this.addSphere(e,t),cylinder:(e={},t={})=>this.addCylinder(e,t),cone:(e={},t={})=>this.addCone(e,t),torus:(e={},t={})=>this.addTorus(e,t),extrude:(e,t={})=>this.addExtrude(e,t),material:(e={})=>this.addMaterial(e)}}addExisting(...e){"headless"!==this.scene&&this.scene.add(...e)}addMesh(e){if(Array.isArray(e))for(let t=0;t<e.length;t++)this.addExisting(e[t]);else this.addExisting(e);return this}createMesh(e,t,n){const{x:s=0,y:o=0,z:i=0}=n;let a;switch(!Array.isArray(t)&&t.type){case"LineBasicMaterial":a=new r.Line(e,t);break;case"PointsMaterial":a=new r.Points(e,t);break;default:a=new u(e,t)}return a.position.set(s,o,i),a.castShadow=a.receiveShadow=!0,a}makeExtrude(e,t){const{x:n,y:s,z:o,name:i,shape:a,autoCenter:l=!0,breakable:c=!1}=e,h=P(e,["x","y","z","name","shape","autoCenter","breakable"]),{depth:u=1,bevelEnabled:d=!1}=h,p=new r.ExtrudeBufferGeometry(a,Object.assign({depth:u,bevelEnabled:d},h)),m=this.addMaterial(t),f=this.createMesh(p,m,{x:n,y:s,z:o});return l&&f.geometry.center(),f.name=i||`body_id_${f.id}`,f.shape="extrude",f}addExtrude(e,t={}){const n=this.makeExtrude(e,t);return this.addExisting(n),n}makePlane(e,t){const{x:n,y:s,z:o,name:i,breakable:a=!1}=e,l=P(e,["x","y","z","name","breakable"]),c=new r.PlaneBufferGeometry(l.width||1,l.height||1,l.widthSegments||1,l.heightSegments||1),h=this.addMaterial(t);h.side=r.DoubleSide;const u=this.createMesh(c,h,{x:n,y:s,z:o});return u.name=i||`body_id_${u.id}`,u.shape="plane",u}addPlane(e,t){const n=this.makePlane(e,t);return this.addExisting(n),n}makeSphere(e,t){const{x:n,y:s,z:o,name:i,breakable:a=!1}=e,l=P(e,["x","y","z","name","breakable"]),c=new r.SphereBufferGeometry(l.radius||1,l.widthSegments||16,l.heightSegments||12,l.phiStart||void 0,l.phiLength||void 0,l.thetaStart||void 0,l.thetaLength||void 0),h=this.addMaterial(t),u=this.createMesh(c,h,{x:n,y:s,z:o});return u.name=i||`body_id_${u.id}`,u.shape="sphere",u}addSphere(e={},t={}){const n=this.makeSphere(e,t);return this.addExisting(n),n}makeBox(e,t){const{x:n,y:s,z:o,name:i,breakable:a=!1}=e,l=P(e,["x","y","z","name","breakable"]),c=new r.BoxBufferGeometry(l.width||1,l.height||1,l.depth||1,l.widthSegments||void 0,l.heightSegments||void 0,l.depthSegments||void 0),h=this.addMaterial(t),u=this.createMesh(c,h,{x:n,y:s,z:o});return u.name=i||`body_id_${u.id}`,u.shape="box",u}addBox(e={},t={}){const n=this.makeBox(e,t);return this.addExisting(n),n}addGround(e,t={}){const n=this.makeBox(e,t);return n.rotateX(r.MathUtils.degToRad(90)),this.addExisting(n),n}makeCylinder(e={},t={}){const{x:n,y:s,z:o,name:i,breakable:a=!1}=e,l=P(e,["x","y","z","name","breakable"]),c=new r.CylinderBufferGeometry(l.radiusTop||1,l.radiusBottom||1,l.height||1,l.radiusSegments||void 0,l.heightSegments||void 0,l.openEnded||void 0,l.thetaStart||void 0,l.thetaLength||void 0),h=this.addMaterial(t),u=this.createMesh(c,h,{x:n,y:s,z:o});return u.name=i||`body_id_${u.id}`,u.shape="cylinder",u}addCylinder(e={},t={}){const n=this.makeCylinder(e,t);return this.addExisting(n),n}makeCone(e={},t={}){const{x:n,y:s,z:o,name:i,breakable:a=!1}=e,l=P(e,["x","y","z","name","breakable"]),c=new r.ConeBufferGeometry(l.radius||1,l.height||1,l.radiusSegments||8,l.heightSegments||1,l.openEnded||!1,l.thetaStart||0,l.thetaLength||2*Math.PI),h=this.addMaterial(t),u=this.createMesh(c,h,{x:n,y:s,z:o});return u.name=i||`body_id_${u.id}`,u.shape="cone",u}addCone(e={},t={}){const n=this.makeCone(e,t);return this.addExisting(n),n}makeTorus(e={},t={}){const{x:n,y:s,z:o,name:i,breakable:a=!1}=e,l=P(e,["x","y","z","name","breakable"]),c=new r.TorusBufferGeometry(l.radius||void 0,l.tube||void 0,l.radialSegments||void 0,l.tubularSegments||void 0,l.arc||void 0),h=this.addMaterial(t),u=this.createMesh(c,h,{x:n,y:s,z:o});return u.name=i||`body_id_${u.id}`,u.shape="torus",u}addTorus(e={},t={}){const n=this.makeTorus(e,t);return this.addExisting(n),n}addMaterial(e={}){const t=Object.keys(e)[0];let n;if("headless"===this.scene)return this.defaultMaterial.get();switch(t){case"basic":n=new r.MeshBasicMaterial(e.basic);break;case"normal":n=new r.MeshNormalMaterial(e.normal);break;case"standard":n=new r.MeshStandardMaterial(e.standard);break;case"lambert":n=new r.MeshLambertMaterial(e.lambert);break;case"phong":n=new r.MeshPhongMaterial(e.phong);break;case"physical":void 0!==e.physical?n=new r.MeshPhysicalMaterial(e.physical):(l("You need to pass parameters to the physical material. (Fallback to default material)"),n=this.defaultMaterial.get());break;case"toon":n=new r.MeshToonMaterial(e.toon);break;case"line":n=new r.LineBasicMaterial(e.line);break;case"points":n=new r.PointsMaterial(e.points);break;case"custom":n=e.custom||this.defaultMaterial.get();break;default:n=this.defaultMaterial.get()}return n}}class R extends m.Events{addCollider(e,t,n){e.body&&t.body&&(e.body.checkCollisions=!0,t.body.checkCollisions=!0,this.on("collision",(r=>{var s,o;const{bodies:i,event:a}=r;(null===(s=i[0])||void 0===s?void 0:s.name)&&(null===(o=i[1])||void 0===o?void 0:o.name)&&(null==e?void 0:e.name)&&(null==t?void 0:t.name)&&(i[0].name===e.name&&i[1].name===t.name||i[1].name===e.name&&i[0].name===t.name)&&n(a)})))}}const L=new r.Vector3,V=new r.Line3,k=new r.Plane,I=new r.Vector3,O=new r.Triangle;class N{constructor(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new U,this.unassigned=new U,this.vertices=[]}setFromPoints(e){!0!==Array.isArray(e)&&console.error("THREE.ConvexHull: Points parameter is not an array."),e.length<4&&console.error("THREE.ConvexHull: The algorithm needs at least four points."),this.makeEmpty();for(let t=0,n=e.length;t<n;t++)this.vertices.push(new F(e[t]));return this.compute(),this}setFromObject(e){const t=[];return e.updateMatrixWorld(!0),e.traverse((function(e){const n=e.geometry;if(void 0!==n){if(n.isGeometry)return void console.error("THREE.ConvexHull no longer supports Geometry. Use THREE.BufferGeometry instead.");if(n.isBufferGeometry){const s=n.attributes.position;if(void 0!==s)for(let n=0,o=s.count;n<o;n++){const o=new r.Vector3;o.fromBufferAttribute(s,n).applyMatrix4(e.matrixWorld),t.push(o)}}}})),this.setFromPoints(t)}containsPoint(e){const t=this.faces;for(let n=0,r=t.length;n<r;n++)if(t[n].distanceToPoint(e)>this.tolerance)return!1;return!0}intersectRay(e,t){const n=this.faces;let r=-1/0,s=1/0;for(let t=0,o=n.length;t<o;t++){const o=n[t],i=o.distanceToPoint(e.origin),a=o.normal.dot(e.direction);if(i>0&&a>=0)return null;const l=0!==a?-i/a:0;if(!(l<=0)&&(a>0?s=Math.min(l,s):r=Math.max(l,r),r>s))return null}return r!==-1/0?e.at(r,t):e.at(s,t),t}intersectsRay(e){return null!==this.intersectRay(e,L)}makeEmpty(){return this.faces=[],this.vertices=[],this}addVertexToFace(e,t){return e.face=t,null===t.outside?this.assigned.append(e):this.assigned.insertBefore(t.outside,e),t.outside=e,this}removeVertexFromFace(e,t){return e===t.outside&&(null!==e.next&&e.next.face===t?t.outside=e.next:t.outside=null),this.assigned.remove(e),this}removeAllVerticesFromFace(e){if(null!==e.outside){const t=e.outside;let n=e.outside;for(;null!==n.next&&n.next.face===e;)n=n.next;return this.assigned.removeSubList(t,n),t.prev=n.next=null,e.outside=null,t}}deleteFaceVertices(e,t){const n=this.removeAllVerticesFromFace(e);if(void 0!==n)if(void 0===t)this.unassigned.appendChain(n);else{let e=n;do{const n=e.next;t.distanceToPoint(e.point)>this.tolerance?this.addVertexToFace(e,t):this.unassigned.append(e),e=n}while(null!==e)}return this}resolveUnassignedPoints(e){if(!1===this.unassigned.isEmpty()){let t=this.unassigned.first();do{const n=t.next;let r=this.tolerance,s=null;for(let n=0;n<e.length;n++){const o=e[n];if(0===o.mark){const e=o.distanceToPoint(t.point);if(e>r&&(r=e,s=o),r>1e3*this.tolerance)break}}null!==s&&this.addVertexToFace(t,s),t=n}while(null!==t)}return this}computeExtremes(){const e=new r.Vector3,t=new r.Vector3,n=[],s=[];for(let e=0;e<3;e++)n[e]=s[e]=this.vertices[0];e.copy(this.vertices[0].point),t.copy(this.vertices[0].point);for(let r=0,o=this.vertices.length;r<o;r++){const o=this.vertices[r],i=o.point;for(let t=0;t<3;t++)i.getComponent(t)<e.getComponent(t)&&(e.setComponent(t,i.getComponent(t)),n[t]=o);for(let e=0;e<3;e++)i.getComponent(e)>t.getComponent(e)&&(t.setComponent(e,i.getComponent(e)),s[e]=o)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(e.x),Math.abs(t.x))+Math.max(Math.abs(e.y),Math.abs(t.y))+Math.max(Math.abs(e.z),Math.abs(t.z))),{min:n,max:s}}computeInitialHull(){const e=this.vertices,t=this.computeExtremes(),n=t.min,r=t.max;let s=0,o=0;for(let e=0;e<3;e++){const t=r[e].point.getComponent(e)-n[e].point.getComponent(e);t>s&&(s=t,o=e)}const i=n[o],a=r[o];let l,c;s=0,V.set(i.point,a.point);for(let t=0,n=this.vertices.length;t<n;t++){const n=e[t];if(n!==i&&n!==a){V.closestPointToPoint(n.point,!0,I);const e=I.distanceToSquared(n.point);e>s&&(s=e,l=n)}}s=-1,k.setFromCoplanarPoints(i.point,a.point,l.point);for(let t=0,n=this.vertices.length;t<n;t++){const n=e[t];if(n!==i&&n!==a&&n!==l){const e=Math.abs(k.distanceToPoint(n.point));e>s&&(s=e,c=n)}}const h=[];if(k.distanceToPoint(c.point)<0){h.push(B.create(i,a,l),B.create(c,a,i),B.create(c,l,a),B.create(c,i,l));for(let e=0;e<3;e++){const t=(e+1)%3;h[e+1].getEdge(2).setTwin(h[0].getEdge(t)),h[e+1].getEdge(1).setTwin(h[t+1].getEdge(0))}}else{h.push(B.create(i,l,a),B.create(c,i,a),B.create(c,a,l),B.create(c,l,i));for(let e=0;e<3;e++){const t=(e+1)%3;h[e+1].getEdge(2).setTwin(h[0].getEdge((3-e)%3)),h[e+1].getEdge(0).setTwin(h[t+1].getEdge(1))}}for(let e=0;e<4;e++)this.faces.push(h[e]);for(let t=0,n=e.length;t<n;t++){const n=e[t];if(n!==i&&n!==a&&n!==l&&n!==c){s=this.tolerance;let e=null;for(let t=0;t<4;t++){const r=this.faces[t].distanceToPoint(n.point);r>s&&(s=r,e=this.faces[t])}null!==e&&this.addVertexToFace(n,e)}}return this}reindexFaces(){const e=[];for(let t=0;t<this.faces.length;t++){const n=this.faces[t];0===n.mark&&e.push(n)}return this.faces=e,this}nextVertexToAdd(){if(!1===this.assigned.isEmpty()){let e,t=0;const n=this.assigned.first().face;let r=n.outside;do{const s=n.distanceToPoint(r.point);s>t&&(t=s,e=r),r=r.next}while(null!==r&&r.face===n);return e}}computeHorizon(e,t,n,r){let s;this.deleteFaceVertices(n),n.mark=1,s=null===t?t=n.getEdge(0):t.next;do{const t=s.twin,n=t.face;0===n.mark&&(n.distanceToPoint(e)>this.tolerance?this.computeHorizon(e,t,n,r):r.push(s)),s=s.next}while(s!==t);return this}addAdjoiningFace(e,t){const n=B.create(e,t.tail(),t.head());return this.faces.push(n),n.getEdge(-1).setTwin(t.twin),n.getEdge(0)}addNewFaces(e,t){this.newFaces=[];let n=null,r=null;for(let s=0;s<t.length;s++){const o=t[s],i=this.addAdjoiningFace(e,o);null===n?n=i:i.next.setTwin(r),this.newFaces.push(i.face),r=i}return n.next.setTwin(r),this}addVertexToHull(e){const t=[];return this.unassigned.clear(),this.removeVertexFromFace(e,e.face),this.computeHorizon(e.point,null,e.face,t),this.addNewFaces(e,t),this.resolveUnassignedPoints(this.newFaces),this}cleanup(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this}compute(){let e;for(this.computeInitialHull();void 0!==(e=this.nextVertexToAdd());)this.addVertexToHull(e);return this.reindexFaces(),this.cleanup(),this}}class B{constructor(){this.normal=new r.Vector3,this.midpoint=new r.Vector3,this.area=0,this.constant=0,this.outside=null,this.mark=0,this.edge=null}static create(e,t,n){const r=new B,s=new D(e,r),o=new D(t,r),i=new D(n,r);return s.next=i.prev=o,o.next=s.prev=i,i.next=o.prev=s,r.edge=s,r.compute()}getEdge(e){let t=this.edge;for(;e>0;)t=t.next,e--;for(;e<0;)t=t.prev,e++;return t}compute(){const e=this.edge.tail(),t=this.edge.head(),n=this.edge.next.head();return O.set(e.point,t.point,n.point),O.getNormal(this.normal),O.getMidpoint(this.midpoint),this.area=O.getArea(),this.constant=this.normal.dot(this.midpoint),this}distanceToPoint(e){return this.normal.dot(e)-this.constant}}class D{constructor(e,t){this.vertex=e,this.prev=null,this.next=null,this.twin=null,this.face=t}head(){return this.vertex}tail(){return this.prev?this.prev.vertex:null}length(){const e=this.head(),t=this.tail();return null!==t?t.point.distanceTo(e.point):-1}lengthSquared(){const e=this.head(),t=this.tail();return null!==t?t.point.distanceToSquared(e.point):-1}setTwin(e){return this.twin=e,e.twin=this,this}}class F{constructor(e){this.point=e,this.prev=null,this.next=null,this.face=null}}class U{constructor(){this.head=null,this.tail=null}first(){return this.head}last(){return this.tail}clear(){return this.head=this.tail=null,this}insertBefore(e,t){return t.prev=e.prev,t.next=e,null===t.prev?this.head=t:t.prev.next=t,e.prev=t,this}insertAfter(e,t){return t.prev=e,t.next=e.next,null===t.next?this.tail=t:t.next.prev=t,e.next=t,this}append(e){return null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail,e.next=null,this.tail=e,this}appendChain(e){for(null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail;null!==e.next;)e=e.next;return this.tail=e,this}remove(e){return null===e.prev?this.head=e.next:e.prev.next=e.next,null===e.next?this.tail=e.prev:e.next.prev=e.prev,this}removeSubList(e,t){return null===e.prev?this.head=t.next:e.prev.next=t.next,null===t.next?this.tail=e.prev:t.next.prev=e.prev,this}isEmpty(){return null===this.head}}class z extends r.BufferGeometry{constructor(e){super();const t=[],n=[];void 0===N&&console.error("THREE.ConvexBufferGeometry: ConvexBufferGeometry relies on ConvexHull");const s=(new N).setFromPoints(e).faces;for(let e=0;e<s.length;e++){const r=s[e];let o=r.edge;do{const e=o.head().point;t.push(e.x,e.y,e.z),n.push(r.normal.x,r.normal.y,r.normal.z),o=o.next}while(o!==r.edge)}this.setAttribute("position",new r.Float32BufferAttribute(t,3)),this.setAttribute("normal",new r.Float32BufferAttribute(n,3))}}const j=e=>new(window.THREE&&window.THREE.ConvexGeometry?window.THREE.ConvexGeometry:z)(e),H=function(e,t){this.minSizeForBreak=e||1.4,this.smallDelta=t||1e-4,this.tempLine1=new r.Line3,this.tempPlane1=new r.Plane,this.tempPlane2=new r.Plane,this.tempPlane_Cut=new r.Plane,this.tempCM1=new r.Vector3,this.tempCM2=new r.Vector3,this.tempVector3=new r.Vector3,this.tempVector3_2=new r.Vector3,this.tempVector3_3=new r.Vector3,this.tempVector3_P0=new r.Vector3,this.tempVector3_P1=new r.Vector3,this.tempVector3_P2=new r.Vector3,this.tempVector3_N0=new r.Vector3,this.tempVector3_N1=new r.Vector3,this.tempVector3_AB=new r.Vector3,this.tempVector3_CB=new r.Vector3,this.tempResultObjects={object1:null,object2:null},this.segments=[];for(var n=0;n<900;n++)this.segments[n]=!1};var G;H.prototype={constructor:H,prepareBreakableObject:function(e,t,n,r,s){e.geometry.isBufferGeometry||console.error("THREE.ConvexObjectBreaker.prepareBreakableObject(): Parameter object must have a BufferGeometry."),e.userData.ammoPhysicsData={};var o=e.userData.ammoPhysicsData;o.mass=t,o.velocity=n.clone(),o.angularVelocity=r.clone(),o.breakable=s},subdivideByImpact:function(e,t,n,r,s){var o=[],i=this.tempPlane1,a=this.tempPlane2;this.tempVector3.addVectors(t,n),i.setFromCoplanarPoints(t,e.position,this.tempVector3);var l=s+r,c=this;return function s(h,u,d,p){if(Math.random()<.05*p||p>l)o.push(h);else{var m=Math.PI;0===p?(a.normal.copy(i.normal),a.constant=i.constant):p<=r?(m=(d-u)*(.2+.6*Math.random())+u,c.tempVector3_2.copy(e.position).sub(t).applyAxisAngle(n,m).add(t),a.setFromCoplanarPoints(t,c.tempVector3,c.tempVector3_2)):(m=(.5*(1&p)+.2*(2-Math.random()))*Math.PI,c.tempVector3_2.copy(t).sub(h.position).applyAxisAngle(n,m).add(h.position),c.tempVector3_3.copy(n).add(h.position),a.setFromCoplanarPoints(h.position,c.tempVector3_3,c.tempVector3_2)),c.cutByPlane(h,a,c.tempResultObjects);var f=c.tempResultObjects.object1,g=c.tempResultObjects.object2;f&&s(f,u,m,p+1),g&&s(g,m,d,p+1)}}(e,0,2*Math.PI,0),o},cutByPlane:function(e,t,n){var s=e.geometry,o=s.attributes.position.array,i=s.attributes.normal.array,a=o.length/3,c=a/3,h=s.getIndex();function u(e,t){var n=3*e+t;return h?h[n]:n}h&&(c=(h=h.array).length/3);for(var d=[],p=[],m=this.smallDelta,f=a*a,g=0;g<f;g++)this.segments[g]=!1;var v=this.tempVector3_P0,y=this.tempVector3_P1,x=this.tempVector3_N0,b=this.tempVector3_N1;for(g=0;g<c-1;g++){var w=u(g,0),A=u(g,1),M=u(g,2);x.set(i[w],i[w]+1,i[w]+2);for(var T=g+1;T<c;T++){var _=u(T,0),S=u(T,1),E=u(T,2);b.set(i[_],i[_]+1,i[_]+2),1-x.dot(b)<m&&(w===_||w===S||w===E?A===_||A===S||A===E?(this.segments[w*a+A]=!0,this.segments[A*a+w]=!0):(this.segments[M*a+w]=!0,this.segments[w*a+M]=!0):A!==_&&A!==S&&A!==E||(this.segments[M*a+A]=!0,this.segments[A*a+M]=!0))}}var P=this.tempPlane_Cut;for(e.updateMatrix(),H.transformPlaneToLocalSpace(t,e.matrix,P),g=0;g<c;g++)for(var C=u(g,0),R=u(g,1),L=u(g,2),V=0;V<3;V++){var k=0===V?C:1===V?R:L,I=0===V?R:1===V?L:C;if(!this.segments[k*a+I]){this.segments[k*a+I]=!0,this.segments[I*a+k]=!0,v.set(o[3*k],o[3*k+1],o[3*k+2]),y.set(o[3*I],o[3*I+1],o[3*I+2]);var O=0;(N=P.distanceToPoint(v))>m?(O=2,p.push(v.clone())):N<-m?(O=1,d.push(v.clone())):(O=3,d.push(v.clone()),p.push(v.clone()));var N,B=0;if((N=P.distanceToPoint(y))>m?(B=2,p.push(y.clone())):N<-m?(B=1,d.push(y.clone())):(B=3,d.push(y.clone()),p.push(y.clone())),1===O&&2===B||2===O&&1===B){this.tempLine1.start.copy(v),this.tempLine1.end.copy(y);var D=new r.Vector3;if(void 0===(D=P.intersectLine(this.tempLine1,D)))return console.error("Internal error: segment does not intersect plane."),n.segmentedObject1=null,n.segmentedObject2=null,0;d.push(D),p.push(D.clone())}}}var F=.5*e.userData.ammoPhysicsData.mass;this.tempCM1.set(0,0,0);var U=0,z=d.length;if(z>0){for(g=0;g<z;g++)this.tempCM1.add(d[g]);for(this.tempCM1.divideScalar(z),g=0;g<z;g++)(X=d[g]).sub(this.tempCM1),U=Math.max(U,X.x,X.y,X.z);this.tempCM1.add(e.position)}this.tempCM2.set(0,0,0);var G=0,W=p.length;if(W>0){for(g=0;g<W;g++)this.tempCM2.add(p[g]);for(this.tempCM2.divideScalar(W),g=0;g<W;g++){var X;(X=p[g]).sub(this.tempCM2),G=Math.max(G,X.x,X.y,X.z)}this.tempCM2.add(e.position)}var q=null,Y=null,K=0;if(z>4)try{(q=new r.Mesh(j(d),e.material)).position.copy(this.tempCM1),q.quaternion.copy(e.quaternion),q.userData=e.userData,this.prepareBreakableObject(q,F,e.userData.ammoPhysicsData.velocity,e.userData.ammoPhysicsData.angularVelocity,2*U>this.minSizeForBreak),K++}catch(e){l("Error in ConvexObjectBreaker.ts",!0),l(e,!0)}if(W>4)try{(Y=new r.Mesh(j(p),e.material)).position.copy(this.tempCM2),Y.quaternion.copy(e.quaternion),Y.userData=e.userData,this.prepareBreakableObject(Y,F,e.userData.ammoPhysicsData.velocity,e.userData.ammoPhysicsData.angularVelocity,2*G>this.minSizeForBreak),K++}catch(e){l("Error in ConvexObjectBreaker.ts",!0),l(e,!0)}return n.object1=q,n.object2=Y,K}},H.transformFreeVector=function(e,t){var n=e.x,r=e.y,s=e.z,o=t.elements;return e.x=o[0]*n+o[4]*r+o[8]*s,e.y=o[1]*n+o[5]*r+o[9]*s,e.z=o[2]*n+o[6]*r+o[10]*s,e},H.transformFreeVectorInverse=function(e,t){var n=e.x,r=e.y,s=e.z,o=t.elements;return e.x=o[0]*n+o[1]*r+o[2]*s,e.y=o[4]*n+o[5]*r+o[6]*s,e.z=o[8]*n+o[9]*r+o[10]*s,e},H.transformTiedVectorInverse=function(e,t){var n=e.x,r=e.y,s=e.z,o=t.elements;return e.x=o[0]*n+o[1]*r+o[2]*s-o[12],e.y=o[4]*n+o[5]*r+o[6]*s-o[13],e.z=o[8]*n+o[9]*r+o[10]*s-o[14],e},H.transformPlaneToLocalSpace=(G=new r.Vector3,function(e,t,n){n.normal.copy(e.normal),n.constant=e.constant;var r=H.transformTiedVectorInverse(e.coplanarPoint(G),t);H.transformFreeVectorInverse(n.normal,t),n.constant=-r.dot(n.normal)});const W=(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){console.error(e.message)}return!1})(),X=(e,t)=>{((e,t)=>{var n=document.createElement("script");n.onload=()=>{t()},n.onerror=()=>{throw new Error(`failed to load ${e}`)},n.async=!0,n.src=e,document.head.appendChild(n)})(W?`${e}/ammo.wasm.js`:`${e}/ammo.js`,(()=>t()))},q=(e,t)=>{"undefined"!=typeof window&&(window.__loadPhysics=!0),X(e,(()=>{Ammo().then((()=>{t()}))}))},Y=(e,t)=>{t.forEach((t=>{Object.getOwnPropertyNames(t.prototype).forEach((n=>{Object.defineProperty(e.prototype,n,Object.getOwnPropertyDescriptor(t.prototype,n))}))}))};class K{constructor(e){this.physics=e}setRayFromWorld(e=0,t=0,n=0){this._btRayFrom.setValue(e,t,n)}setRayToWorld(e=0,t=0,n=0){this._btRayTo.setValue(e,t,n)}hasHit(){return this._btRayCallback.hasHit()}rayTest(){void 0!==this._btRayCallback&&Ammo.destroy(this._btRayCallback),this._btRayCallback="closest"===this.type?new Ammo.ClosestRayResultCallback(this._btRayFrom,this._btRayTo):new Ammo.AllHitsRayResultCallback(this._btRayFrom,this._btRayTo),this.physics.physicsWorld.rayTest(this._btRayFrom,this._btRayTo,this._btRayCallback)}destroy(){void 0!==this._btRayFrom&&Ammo.destroy(this._btRayFrom),void 0!==this._btRayTo&&Ammo.destroy(this._btRayTo),void 0!==this._btRayCallback&&Ammo.destroy(this._btRayCallback)}}class ${constructor(e){this.physics=e,this.type="closest",this._btRayFrom=new Ammo.btVector3(0,0,0),this._btRayTo=new Ammo.btVector3(0,0,0)}}class Q{constructor(e){this.physics=e,this.type="allHits",this._btRayFrom=new Ammo.btVector3(0,0,0),this._btRayTo=new Ammo.btVector3(0,0,0)}}Y($,[K,class{constructor(e){this.physics=e}getHitPointWorld(){const e=this._btRayCallback.get_m_hitPointWorld();return{x:e.x(),y:e.y(),z:e.z()}}getHitNormalWorld(){const e=this._btRayCallback.get_m_hitNormalWorld();return{x:e.x(),y:e.y(),z:e.z()}}getCollisionObject(){return Ammo.castObject(this._btRayCallback.get_m_collisionObject(),Ammo.btRigidBody).threeObject}}]),Y(Q,[K,class{constructor(e){this.physics=e}getHitPointsWorld(){const e=this._btRayCallback.get_m_hitPointWorld(),t=[];for(let n=e.size()-1;n>=0;n--){const r=e.at(n);t.push({x:r.x(),y:r.y(),z:r.z()})}return t}getHitPointWorld(){return l("Use getHitPointsWorld() instead of getHitPointWorld() for the AllHitsRayCaster!"),this.getHitPointsWorld()}getHitNormalsWorld(){const e=this._btRayCallback.get_m_hitNormalWorld(),t=[];for(let n=e.size()-1;n>=0;n--){const r=e.at(n);t.push({x:r.x(),y:r.y(),z:r.z()})}return t}getCollisionObjects(){const e=[],t=this._btRayCallback.get_m_collisionObjects();for(let n=t.size()-1;n>=0;n--){const r=Ammo.castObject(t.at(n),Ammo.btRigidBody);e.push(r.threeObject)}return e}}]);class Z extends m.Events{constructor(e,t={}){super(),this.scene=e,this.config=t,this.rigidBodies=[],this.earlierDetectedCollisions=[],this.complexShapes=["plane","hull","hacd","vhacd","convexMesh","concaveMesh"],this.gravity=t.gravity||{x:0,y:-9.81,z:0},this.isHeadless="headless"===e,this.tmpEuler=new r.Euler,this.tmpQuaternion=new r.Quaternion,this.tmpVector3=new r.Vector3,this.tmpVector3a=new r.Vector3,this.tmpMatrix4=new r.Matrix4,this.tmpMatrix4a=new r.Matrix4,this.tmpBtVector3=new Ammo.btVector3,this.tmpBtQuaternion=new Ammo.btQuaternion(0,0,0,1),this.emptyV3=new r.Vector3,this.impactPoint=new r.Vector3,this.impactNormal=new r.Vector3,"headless"!==e&&(this.defaultMaterial=new E),this.start()}get tmpTrans(){return console.warn("Use worldTransform instead of tmpTrans."),this.worldTransform}set tmpTrans(e){console.warn("Use worldTransform instead of tmpTrans."),this.worldTransform=e}destroy(e){var t;const n=Object.keys(e).includes("body")?e.body:e;if(void 0===(null==n?void 0:n.ammo))return;const r=n.ammo.name;let s=n.ammo.threeObject;if(r&&s&&(null===(t=null==s?void 0:s.body)||void 0===t?void 0:t.ammo)){s.body.isSoftBody?this.physicsWorld.removeSoftBody(s.body.ammo):this.physicsWorld.removeRigidBody(s.body.ammo),s.body.destructor(),s.body=void 0,s.hasBody=!1,delete n.ammo.threeObject;for(let e=0;e<this.rigidBodies.length;e++)this.rigidBodies[e].name===r&&(this.rigidBodies.splice(e,1),e--)}"headless"===this.scene&&s&&(s=null)}setup(){if(this.worldTransform=new Ammo.btTransform,"function"==typeof this.config.setupPhysicsWorld?this.physicsWorld=this.config.setupPhysicsWorld():this.physicsWorld=this.setupPhysicsWorld(),"headless"!==this.scene){this.convexBreaker=new H,this.objectsToRemove=[],this.numObjectsToRemove=0;for(let e=0;e<500;e++)this.objectsToRemove[e]=null}this.collisionEvents=new R,this.factory=new C(this.scene),this.shapes=new class{constructor(e,t){this.factory=e,this.addExisting=t}addPlane(e={},t={}){const n=this.factory.add.plane(e,t);return this.addExisting(n,e),n}addSphere(e={},t={}){const n=this.factory.add.sphere(e,t);return this.addExisting(n,e),n}addBox(e={},t={}){const n=this.factory.add.box(e,t);return this.addExisting(n,e),n}addGround(e,t={}){const n=this.factory.add.ground(e,t),r=Object.assign(Object.assign({},e),{mass:0,collisionFlags:1});return this.addExisting(n,r),n}addCylinder(e={},t={}){const n=this.factory.add.cylinder(e,t);return this.addExisting(n,e),n}addCone(e={},t={}){const n=this.factory.add.cone(e,t);return this.addExisting(n,e),n}addTorus(e={},t={}){const n=this.factory.add.torus(e,t);return this.addExisting(n,e),n}addExtrude(e,t={}){const n=this.factory.add.extrude(e,t);return n.translateX(1),this.addExisting(n),n}}(this.factory,((e,t)=>this.addExisting(e,t))),this.constraints=new p(this.worldTransform,this.physicsWorld),"headless"!==this.scene&&(this.debugDrawer=new class{constructor(e,t,n={}){this.scene=e,this.world=t,this.options=n,this.debugDrawMode=n.debugDrawMode||1;const s=32768&this.debugDrawMode||!1,o=n.maxBufferSize||1e6;this.geometry=new r.BufferGeometry;const i=new Float32Array(3*o),a=new Float32Array(3*o);this.geometry.setAttribute("position",new r.BufferAttribute(i,3).setUsage(r.StaticDrawUsage)),this.geometry.setAttribute("color",new r.BufferAttribute(a,3).setUsage(r.StaticDrawUsage)),this.index=0;const l=new r.LineBasicMaterial({vertexColors:!0,depthTest:!s});this.mesh=new r.LineSegments(this.geometry,l),s&&(this.mesh.renderOrder=999),this.mesh.frustumCulled=!1,this.enabled=!1,this.debugDrawer=new Ammo.DebugDrawer,this.debugDrawer.drawLine=this.drawLine.bind(this),this.debugDrawer.drawContactPoint=this.drawContactPoint.bind(this),this.debugDrawer.reportErrorWarning=this.reportErrorWarning.bind(this),this.debugDrawer.draw3dText=this.draw3dText.bind(this),this.debugDrawer.setDebugMode=this.setDebugMode.bind(this),this.debugDrawer.getDebugMode=this.getDebugMode.bind(this),this.world.setDebugDrawer(this.debugDrawer)}enable(){this.enabled=!0,this.scene.add(this.mesh)}disable(){this.enabled=!1,this.scene.remove(this.mesh)}update(){this.enabled&&(0!=this.index&&(this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0),this.index=0,this.world.debugDrawWorld(),this.geometry.setDrawRange(0,this.index))}drawLine(e,t,n){const r=Ammo.HEAPF32,s=r[(n+0)/4],o=r[(n+4)/4],i=r[(n+8)/4],a=r[(e+0)/4],l=r[(e+4)/4],c=r[(e+8)/4];this.geometry.attributes.position.setXYZ(this.index,a,l,c),this.geometry.attributes.color.setXYZ(this.index++,s,o,i);const h=r[(t+0)/4],u=r[(t+4)/4],d=r[(t+8)/4];this.geometry.attributes.position.setXYZ(this.index,h,u,d),this.geometry.attributes.color.setXYZ(this.index++,s,o,i)}drawContactPoint(e,t,n,r,s){const o=Ammo.HEAPF32,i=o[(s+0)/4],a=o[(s+4)/4],l=o[(s+8)/4],c=o[(e+0)/4],h=o[(e+4)/4],u=o[(e+8)/4];this.geometry.attributes.position.setXYZ(this.index,c,h,u),this.geometry.attributes.color.setXYZ(this.index++,i,a,l);const d=o[(t+0)/4]*n,p=o[(t+4)/4]*n,m=o[(t+8)/4]*n;this.geometry.attributes.position.setXYZ(this.index,c+d,h+p,u+m),this.geometry.attributes.color.setXYZ(this.index++,i,a,l)}reportErrorWarning(e){Ammo.hasOwnProperty("Pointer_stringify")?console.warn(Ammo.Pointer_stringify(e)):this.warnedOnce||(this.warnedOnce=!0,console.warn("Cannot print warningString, please rebuild Ammo.js using 'debug' flag"))}draw3dText(e,t){console.warn("TODO: draw3dText")}setDebugMode(e){this.debugDrawMode=e}getDebugMode(){return this.debugDrawMode}}(this.scene,this.physicsWorld,{}))}updateDebugger(){"headless"!==this.scene&&this.debugDrawer&&this.debugDrawer.enabled&&this.debugDrawer.update()}setupPhysicsWorld(){const e=this.gravity,{softBodies:t=!1}=this.config;let n;if(!t){const e=new Ammo.btDefaultCollisionConfiguration,t=new Ammo.btCollisionDispatcher(e),r=new Ammo.btDbvtBroadphase,s=new Ammo.btSequentialImpulseConstraintSolver;n=new Ammo.btDiscreteDynamicsWorld(t,r,s,e)}if(t){const e=new Ammo.btSoftBodyRigidBodyCollisionConfiguration,t=new Ammo.btCollisionDispatcher(e),r=new Ammo.btDbvtBroadphase,s=new Ammo.btSequentialImpulseConstraintSolver,o=new Ammo.btDefaultSoftBodySolver;n=new Ammo.btSoftRigidDynamicsWorld(t,r,s,e,o)}return n.setGravity(new Ammo.btVector3(e.x,e.y,e.z)),n}createDebrisFromBreakableObject(e,t){"headless"!==this.scene&&(e.material=t.material,e.shape="hull",e.fragmentDepth=t.fragmentDepth+1,this.scene.add(e),this.addExisting(e),e.body.fractureImpulse=t.body.fractureImpulse,e.body.breakable=!1,setTimeout((()=>{e.body.breakable=!0}),2500))}removeDebris(e){"headless"!==this.scene&&(this.scene.remove(e),this.destroy(e))}update(e){this.updatePhysics(e),this.detectCollisions()}updatePhysics(e){const t=e/1e3;this.physicsWorld.stepSimulation(t,this.config.maxSubSteps||4,this.config.fixedTimeStep||1/60);for(let e=0;e<this.rigidBodies.length;e++){const t=this.rigidBodies[e],n=t.body.ammo.getMotionState();if(n)if(n.getWorldTransform(this.worldTransform),t.body.didUpdate&&(t.body._emitUpdateEvents&&t.body.eventEmitter.emit("update"),t.body.didUpdate=!1),t.body.ammo.isKinematicObject()&&t.body.needUpdate)t.getWorldQuaternion(this.tmpQuaternion),t.getWorldPosition(this.tmpVector3),this.tmpBtVector3.setValue(this.tmpVector3.x,this.tmpVector3.y,this.tmpVector3.z),this.tmpBtQuaternion.setValue(this.tmpQuaternion.x,this.tmpQuaternion.y,this.tmpQuaternion.z,this.tmpQuaternion.w),this.worldTransform.setOrigin(this.tmpBtVector3),this.worldTransform.setRotation(this.tmpBtQuaternion),n.setWorldTransform(this.worldTransform),t.body.needUpdate=!1;else if(t.body.skipUpdate);else if(!t.body.ammo.isStaticObject()){const e=this.worldTransform.getOrigin(),n=this.worldTransform.getRotation(),s=t.body.offset;if(t.body.ignoreScale)this.tmpVector3a.set(t.scale.x,t.scale.y,t.scale.z);else{const e=t.body.ammo.getCollisionShape().getLocalScaling();this.tmpVector3a.set(e.x(),e.y(),e.z())}this.tmpVector3.set(e.x()+s.x,e.y()+s.y,e.z()+s.z),this.tmpQuaternion.set(n.x(),n.y(),n.z(),n.w()),this.tmpMatrix4.compose(this.tmpVector3,this.tmpQuaternion,this.tmpVector3a),t.parent?parseInt(r.REVISION)>=123?this.tmpMatrix4a.copy(t.parent.matrixWorld).invert():this.tmpMatrix4a.getInverse(t.parent.matrixWorld):this.tmpMatrix4a.identity(),this.tmpMatrix4a.multiply(this.tmpMatrix4),this.tmpMatrix4a.decompose(t.position,t.quaternion,t.scale)}}}detectCollisions(){var e,t;const n=[];this.impactPoint.set(0,0,0),this.impactNormal.set(0,0,0);const r=this.physicsWorld.getDispatcher(),s=r.getNumManifolds();for(let o=0;o<s;o++){const s=r.getManifoldByIndexInternal(o),i=s.getNumContacts(),a=Ammo.castObject(s.getBody0(),Ammo.btRigidBody),l=Ammo.castObject(s.getBody1(),Ammo.btRigidBody),c=a.threeObject,h=l.threeObject;if(!c||!h)continue;if(""===a.name&&""===l.name)continue;const u=null===(e=c.body)||void 0===e?void 0:e.checkCollisions,d=null===(t=h.body)||void 0===t?void 0:t.checkCollisions,p=c.body.breakable,m=h.body.breakable,f=c.body.fractureImpulse,g=h.body.fractureImpulse,v=p||m;if(!u&&!d&&!v)continue;let y=!1,x=0,b="start";for(let e=0;e<i;e++){const t=s.getContactPoint(e);if(t.getDistance()<=0){y=!0;const e=t.getAppliedImpulse(),r=t.get_m_positionWorldOnB(),s=t.get_m_normalWorldOnB();if(u||d){const e=[c.name,h.name].sort(),t=`${e[0]}__${e[1]}`;this.earlierDetectedCollisions.find((e=>e.combinedName===t))&&(b="collision"),n.find((e=>e.combinedName===t))||(n.push({combinedName:t,collision:!0}),this.collisionEvents.emit("collision",{bodies:[c,h],event:b}))}e>=x&&(x=e,(p||m)&&(this.impactPoint.set(r.x(),r.y(),r.z()),this.impactNormal.set(s.x(),s.y(),s.z())));break}}if(!y)continue;if(!v)continue;const w=2;if(this.emptyV3.set(0,0,0),c.userData.ammoPhysicsData={mass:1,velocity:this.emptyV3,angularVelocity:this.emptyV3,breakable:p,physicsBody:a},h.userData.ammoPhysicsData={mass:1,velocity:this.emptyV3,angularVelocity:this.emptyV3,breakable:m,physicsBody:l},p&&x>f&&c.fragmentDepth<w){const e=this.convexBreaker.subdivideByImpact(c,this.impactPoint,this.impactNormal,1,2),t=e.length;for(let n=0;n<t;n++){const t=a.getLinearVelocity(),r=a.getAngularVelocity(),s=e[n];s.userData.ammoPhysicsData.velocity.set(t.x(),t.y(),t.z()),s.userData.ammoPhysicsData.angularVelocity.set(r.x(),r.y(),r.z()),this.createDebrisFromBreakableObject(s,c)}this.objectsToRemove[this.numObjectsToRemove++]=c}if(m&&x>g&&h.fragmentDepth<w){const e=this.convexBreaker.subdivideByImpact(h,this.impactPoint,this.impactNormal,1,2),t=e.length;for(let n=0;n<t;n++){const t=l.getLinearVelocity(),r=l.getAngularVelocity(),s=e[n];s.userData.ammoPhysicsData.velocity.set(t.x(),t.y(),t.z()),s.userData.ammoPhysicsData.angularVelocity.set(r.x(),r.y(),r.z()),this.createDebrisFromBreakableObject(s,h)}this.objectsToRemove[this.numObjectsToRemove++]=h}}for(let e=0;e<this.numObjectsToRemove;e++)this.removeDebris(this.objectsToRemove[e]);this.numObjectsToRemove=0,this.earlierDetectedCollisions.forEach((e=>{const{combinedName:t}=e;if(!n.find((e=>e.combinedName===t))){const e=t.split("__"),n=this.rigidBodies.find((t=>t.name===e[0])),r=this.rigidBodies.find((t=>t.name===e[1])),s="end";n&&r&&this.collisionEvents.emit("collision",{bodies:[n,r],event:s})}})),this.earlierDetectedCollisions=[...n]}setGravity(e=0,t=-9.8,n=0){this.tmpBtVector3.setValue(e,t,n),this.physicsWorld.setGravity(this.tmpBtVector3)}get debug(){return this.isHeadless?null:{enable:()=>{this.debugDrawer.enable()},mode:(e=1)=>{this.debugDrawer.setDebugMode(e)},disable:()=>{this.debugDrawer.disable()}}}start(){"undefined"!=typeof Ammo?"function"==typeof Ammo?Ammo().then((()=>{this.setup()})):this.setup():l("Are you sure you included ammo.js?")}get add(){return{collider:(e,t,n)=>this.collisionEvents.addCollider(e,t,n),constraints:this.constraints.addConstraints,existing:(e,t)=>this.addExisting(e,t),plane:(e={},t={})=>this.shapes.addPlane(e,t),sphere:(e={},t={})=>this.shapes.addSphere(e,t),ground:(e={},t={})=>this.shapes.addGround(e,t),box:(e={},t={})=>this.shapes.addBox(e,t),cylinder:(e={},t={})=>this.shapes.addCylinder(e,t),cone:(e={},t={})=>this.shapes.addCone(e,t),torus:(e={},t={})=>this.shapes.addTorus(e,t),extrude:(e,t={})=>this.shapes.addExtrude(e,t),raycaster:(e="closest")=>"closest"===e?new $(this):new Q(this)}}prepareThreeObjectForCollisionShape(e,t={}){var n,r;const{autoCenter:s=!1}=t,o={width:1,height:1,depth:1,radius:1,radiusTop:1,radiusBottom:1,tube:.4,tubularSegments:6};let i="unknown";const a=(null===(n=e.geometry)||void 0===n?void 0:n.type)||"unknown";/box/i.test(a)?i="box":/cone/i.test(a)?i="cone":/cylinder/i.test(a)?i="cylinder":/extrude/i.test(a)?i="extrude":/plane/i.test(a)?i="plane":/sphere/i.test(a)?i="sphere":/torus/i.test(a)&&(i="torus");let c=Object.assign(Object.assign({},o),null===(r=null==e?void 0:e.geometry)||void 0===r?void 0:r.parameters);return t.shape?(c=Object.assign(Object.assign({},o),t),i=t.shape):e.shape&&(i=e.shape),Object.keys(c).forEach((e=>{void 0===c[e]&&o[e]&&(c[e]=o[e])})),s&&e.geometry.center(),"cylinder"===i&&(c.radius=t.radius||c.radiusTop),"extrude"===i&&(i="hacd"),"mesh"!==i&&"convex"!==i||(i="convexMesh"),"concave"===i&&(i="concaveMesh"),"unknown"===i&&(l(`Shape for ${null==e?void 0:e.name} not recognized! Will fallback to box.`),i="box"),{shape:i,params:c,object:e}}createCollisionShape(e,t,n){const s=(null==n?void 0:n.quaternion)?null==n?void 0:n.quaternion:new r.Quaternion(0,0,0,1),{axis:o="y"}=t,i=new Ammo.btVector3,a=null==n?void 0:n.geometry;n&&(null==a?void 0:a.isGeometry)&&(n.geometry=(new r.BufferGeometry).fromGeometry(a));let l,c={};switch(-1!==this.complexShapes.indexOf(e)&&(c=(e=>{const t=(new r.Matrix4).elements,n=[],s=[],o=[];return M(e,{},((e,t,r)=>{n.push(e),s.push(t),o.push(r)})),{vertices:n,matrices:s,indexes:o,matrixWorld:t}})(n)),e){case"box":i.setValue(t.width/2,t.height/2,t.depth/2),l=new Ammo.btBoxShape(i);break;case"sphere":l=new Ammo.btSphereShape(t.radius);break;case"cylinder":switch(o){case"y":i.setValue(t.radius,t.height/2,t.radius),l=new Ammo.btCylinderShape(i);break;case"x":i.setValue(t.height/2,t.radius,t.radius),l=new Ammo.btCylinderShapeX(i);break;case"z":i.setValue(t.radius,t.radius,t.height/2),l=new Ammo.btCylinderShapeZ(i)}break;case"cone":switch(o){case"y":l=new Ammo.btConeShape(t.radius,t.height);break;case"x":l=new Ammo.btConeShapeX(t.radius,t.height);break;case"z":l=new Ammo.btConeShapeZ(t.radius,t.height)}break;case"capsule":switch(o){case"y":l=new Ammo.btCapsuleShape(t.radius,t.height);break;case"x":l=new Ammo.btCapsuleShapeX(t.radius,t.height);break;case"z":l=new Ammo.btCapsuleShapeZ(t.radius,t.height)}break;case"torus":l=((e,t)=>{const{radius:n=1,tube:r=.4,tubularSegments:s=8}=e,o=Math.PI,i=s,a=Math.sqrt(2*r*r-2*r*r*Math.cos(2*o/i)),l=new Ammo.btVector3(r,o/i+.5*a,r),c=new Ammo.btCylinderShape(l);c.setMargin(.05);const h=new Ammo.btCompoundShape,u=new Ammo.btVector3(0,0,1),d=new Ammo.btVector3(0,n,0),p=new Ammo.btQuaternion(t.x,t.y,t.z,t.w);for(let e=0;e<i;e++){const t=2*e*o/i,n=d.rotate(u,t),r=new Ammo.btTransform;p.setRotation(u,t+Math.PI/2),r.setIdentity(),r.setOrigin(n),r.setRotation(p),h.addChildShape(r,c)}return h})(t,s);break;case"plane":l=b(c.vertices,c.matrices,c.indexes,c.matrixWorld,Object.assign(Object.assign({},t),{concave:!1}));break;case"hull":l=v(c.vertices,c.matrices,c.matrixWorld,t);break;case"hacd":l=y(c.vertices,c.matrices,c.indexes,c.matrixWorld,t);break;case"vhacd":l=x(c.vertices,c.matrices,c.indexes,c.matrixWorld,t);break;case"convexMesh":l=b(c.vertices,c.matrices,c.indexes,c.matrixWorld,Object.assign(Object.assign({},t),{concave:!1}));break;case"concaveMesh":l=b(c.vertices,c.matrices,c.indexes,c.matrixWorld,Object.assign(Object.assign({},t),{concave:!0}))}Ammo.destroy(i);const{x:h,y:u,z:d}=t;return(h||u||d)&&(l.offset={x:h||0,y:u||0,z:d||0}),Array.isArray(l)&&(l=this.mergeCollisionShapesToCompoundShape(l)),l}mergeCollisionShapesToCompoundShape(e){const t=new Ammo.btCompoundShape;return e.forEach((e=>{const n=e._tmp;if(n){const{pos:r,quat:s,scale:o,margin:i}=n,a=this.applyPosQuatScaleMargin(e,r,s,o,i);t.addChildShape(a,e)}else{const n=new Ammo.btTransform;n.setIdentity(),t.addChildShape(n,e)}})),t}addExisting(e,t={}){const{hasBody:n}=e;if(n)return void l(`Object "${e.name}" already has a physical body!`);const s=new r.Vector3,o=new r.Quaternion,i=new r.Vector3;e.getWorldPosition(s),e.getWorldQuaternion(o),e.getWorldScale(i);const a="1"===(t.collisionFlags||0).toString(2).slice(-1),c="1"===(t.collisionFlags||0).toString(2).slice(-2,-1),{shape:h="unknown",compound:u=[],mass:d=(a||c?0:1),collisionFlags:p=0,collisionGroup:m=1,collisionMask:f=-1,offset:g,breakable:v=!1,addChildren:y=!0,margin:x=.01,ignoreScale:b=!1,fractureImpulse:w=1}=t;if(b&&i.set(1,1,1),u.length>=1){const t=u.map((e=>this.createCollisionShape(e.shape,e))),n=this.mergeCollisionShapesToCompoundShape(t),r=this.applyPosQuatScaleMargin(n,s,o,i,x),a=this.collisionShapeToRigidBody(n,r,d,c);return this.addRigidBodyToWorld(e,a,p,m,f,g),e.body.breakable=v,e.body.fractureImpulse=w,void(e.body.ignoreScale=b)}const A=[];if("unknown"!==h||e.isMesh){const n=this.prepareThreeObjectForCollisionShape(e,t),r=this.createCollisionShape(n.shape,n.params,n.object);A.push(r)}if("unknown"===h&&y&&e.children.length>=1&&e.children.forEach((e=>{if(e.isMesh){const t=this.prepareThreeObjectForCollisionShape(e),n=this.createCollisionShape(t.shape,t.params,t.object);n._tmp={pos:e.position.clone(),quat:e.quaternion.clone(),scale:e.scale.clone(),margin:x},A.push(n)}})),0===A.length){const n=this.prepareThreeObjectForCollisionShape(e,t),r=this.createCollisionShape(n.shape,n.params,n.object);A.push(r)}const M=1===A.length?A[0]:this.mergeCollisionShapesToCompoundShape(A),T=this.applyPosQuatScaleMargin(M,s,o,i,x),_=this.collisionShapeToRigidBody(M,T,d,c);this.addRigidBodyToWorld(e,_,p,m,f,g),e.body.breakable=v,e.body.fractureImpulse=w,e.body.ignoreScale=b}addRigidBodyToWorld(e,t,n,s,o,i){this.rigidBodies.push(e),this.physicsWorld.addRigidBody(t,s,o);const a=Object.values(t)[0];t.name=e.name,e.body=new class{constructor(e,t){this.physics=e,this.ammo=t,this.ignoreScale=!1,this.isSoftBody=!1,this.offset={x:0,y:0,z:0},this.errors=[],this.checkCollisions=!1,this.breakable=!1,this.fractureImpulse=1,this.didUpdate=!1,this.skipUpdate=!1,this._emitUpdateEvents=!1,this._needUpdate=!1,this.tmpEuler=new r.Euler,this.tmpQuaternion=new r.Quaternion,this.tmpBtVector3=new Ammo.btVector3,this.tmpBtVector3_1=new Ammo.btVector3,this.tmpBtQuaternion=new Ammo.btQuaternion(0,0,0,1),this.eventEmitter=new c.Events,this.name=t.name}destructor(){this.eventEmitter&&this.eventEmitter.removeAllListeners(),Ammo.destroy(this.tmpBtVector3),Ammo.destroy(this.tmpBtVector3_1),Ammo.destroy(this.tmpBtQuaternion),Ammo.destroy(this.ammo.getCollisionShape()),Ammo.destroy(this.ammo)}setupEventEmitter(){void 0===this.eventEmitter&&(this.eventEmitter=new c.Events)}get needUpdate(){return this._needUpdate}set needUpdate(e){!e&&this._needUpdate&&(this.didUpdate=!0),this._needUpdate=e}onUpdateEvent(e,t=!1){this.setupEventEmitter(),this._emitUpdateEvents=!0,t?this.eventEmitter.once("update",(()=>{e()})):this.eventEmitter.on("update",(()=>{e()}))}get on(){return{update:e=>this.onUpdateEvent(e),collision:e=>this.onCollision(e)}}get once(){return{update:e=>this.onUpdateEvent(e,!0)}}onCollision(e){this.checkCollisions=!0,this.physics.collisionEvents.on("collision",(t=>{const{bodies:n,event:r}=t;n[0].name===this.name?e(n[1],r):n[1].name===this.name&&e(n[0],r)}))}transform(){const e=this.physics.worldTransform;this.ammo.getMotionState().getWorldTransform(e)}refresh(){const e=this.physics.worldTransform;this.ammo.getMotionState().setWorldTransform(e)}setRotation(e,t,n){const r=this.tmpEuler.set(e,t,n),s=this.tmpQuaternion.set(0,0,0,1);s.setFromEuler(r),this.tmpBtQuaternion.setValue(0,0,0,1);const o=this.tmpBtQuaternion;o.setValue(s.x,s.y,s.z,s.w),this.physics.worldTransform.setRotation(o)}get rotation(){let e,t,n;const r=this.physics.worldTransform.getRotation();let s=this.tmpQuaternion.set(r.x(),r.y(),r.z(),r.w());s.w>1&&(s=s.normalize());const o=2*Math.acos(s.w),i=Math.sqrt(1-s.w*s.w);return i<.001?(e=s.x,t=s.y,n=s.z):(e=s.x/i,t=s.y/i,n=s.z/i),{x:e*o,y:t*o,z:n*o}}get quaternion(){const e=this.physics.worldTransform.getRotation();return{x:e.x(),y:e.y(),z:e.z(),w:e.w()}}setPosition(e,t,n){this.physics.worldTransform.getOrigin().setValue(e,t,n)}get position(){const e=this.physics.worldTransform;return{x:e.getOrigin().x(),y:e.getOrigin().y(),z:e.getOrigin().z()}}get velocity(){return{x:this.ammo.getLinearVelocity().x(),y:this.ammo.getLinearVelocity().y(),z:this.ammo.getLinearVelocity().z()}}get angularVelocity(){return{x:this.ammo.getAngularVelocity().x(),y:this.ammo.getAngularVelocity().y(),z:this.ammo.getAngularVelocity().z()}}setVelocity(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.setLinearVelocity(this.tmpBtVector3)}setVelocityX(e){this.tmpBtVector3.setValue(e,this.velocity.y,this.velocity.z),this.ammo.setLinearVelocity(this.tmpBtVector3)}setVelocityY(e){this.tmpBtVector3.setValue(this.velocity.x,e,this.velocity.z),this.ammo.setLinearVelocity(this.tmpBtVector3)}setVelocityZ(e){this.tmpBtVector3.setValue(this.velocity.x,this.velocity.y,e),this.ammo.setLinearVelocity(this.tmpBtVector3)}setAngularVelocity(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.setAngularVelocity(this.tmpBtVector3)}setAngularVelocityX(e){this.tmpBtVector3.setValue(e,this.angularVelocity.y,this.angularVelocity.z),this.ammo.setAngularVelocity(this.tmpBtVector3)}setAngularVelocityY(e){this.tmpBtVector3.setValue(this.angularVelocity.x,e,this.angularVelocity.z),this.ammo.setAngularVelocity(this.tmpBtVector3)}setAngularVelocityZ(e){this.tmpBtVector3.setValue(this.angularVelocity.x,this.angularVelocity.y,e),this.ammo.setAngularVelocity(this.tmpBtVector3)}applyForce(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.applyCentralImpulse(this.tmpBtVector3)}applyForceX(e){this.tmpBtVector3.setValue(e,0,0),this.ammo.applyCentralImpulse(this.tmpBtVector3)}applyForceY(e){this.tmpBtVector3.setValue(0,e,0),this.ammo.applyCentralImpulse(this.tmpBtVector3)}applyForceZ(e){this.tmpBtVector3.setValue(0,0,e),this.ammo.applyCentralImpulse(this.tmpBtVector3)}applyCentralForce(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.applyCentralForce(this.tmpBtVector3)}applyCentralImpulse(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.applyCentralImpulse(this.tmpBtVector3)}applyCentralLocalForce(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.applyCentralLocalForce(this.tmpBtVector3)}applyImpulse(e,t){this.tmpBtVector3.setValue(e.x||0,e.y||0,e.z||0),this.tmpBtVector3_1.setValue(t.x||0,t.y||0,t.z||0),this.ammo.applyImpulse(this.tmpBtVector3,this.tmpBtVector3_1)}applyLocalTorque(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.applyLocalTorque(this.tmpBtVector3)}applyTorque(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.applyTorque(this.tmpBtVector3)}applyTorqueImpulse(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.applyTorqueImpulse(this.tmpBtVector3)}setCollisionFlags(e){this.ammo.setCollisionFlags(e)}getCollisionFlags(){return this.ammo.getCollisionFlags()}setRestitution(e){this.ammo.setRestitution(e)}setBounciness(e){this.setRestitution(e)}setFriction(e){this.ammo.setFriction(e)}setDamping(e,t){this.ammo.setDamping(e,t)}setGravity(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.setGravity(this.tmpBtVector3)}setLinearFactor(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.setLinearFactor(this.tmpBtVector3)}setAngularFactor(e,t,n){this.tmpBtVector3.setValue(e,t,n),this.ammo.setAngularFactor(this.tmpBtVector3)}setCcdMotionThreshold(e){this.ammo.setCcdMotionThreshold(e)}setCcdSweptSphereRadius(e){this.ammo.setCcdSweptSphereRadius(e)}}(this,t),e.hasBody=!0,e.ptr=a,t.threeObject=e,i&&(e.body.offset=Object.assign({x:0,y:0,z:0},i)),e.body.setCollisionFlags(n)}applyPosQuatScaleMargin(e,t=new r.Vector3,n=new r.Quaternion,s=new r.Vector3,o=.01){e.setMargin(o);const i=new Ammo.btQuaternion(0,0,0,1);i.setValue(n.x,n.y,n.z,n.w);const a=new Ammo.btTransform;a.setIdentity(),a.getOrigin().setValue(t.x,t.y,t.z),a.setRotation(i),Ammo.destroy(i);const l=new Ammo.btVector3(s.x,s.y,s.z);return e.setLocalScaling(l),Ammo.destroy(l),a}collisionShapeToRigidBody(e,t,n,r){const s=new Ammo.btDefaultMotionState(t),o=new Ammo.btVector3(0,0,0);n>0&&e.calculateLocalInertia(n,o);const i=new Ammo.btRigidBodyConstructionInfo(n,s,e,o),a=new Ammo.btRigidBody(i);return(n>0||r)&&a.setActivationState(4),a}}console.log("%c %c %c %c %c Powered by enable3d v0.23.0 %c https://enable3d.io/","background: #ff0000","background: #ffff00","background: #00ff00","background: #00ffff","color: #fff; background: #000000;","background: none");var J={},ee=function(e){return URL.createObjectURL(new Blob([e],{type:"text/javascript"}))},te=function(e){return new Worker(e)};try{URL.revokeObjectURL(ee(""))}catch(e){ee=function(e){return"data:application/javascript;charset=UTF-8,"+encodeURI(e)},te=function(e){return new Worker(e,{type:"module"})}}var ne=Uint8Array,re=Uint16Array,se=Uint32Array,oe=new ne([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),ie=new ne([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),ae=new ne([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),le=function(e,t){for(var n=new re(31),r=0;r<31;++r)n[r]=t+=1<<e[r-1];var s=new se(n[30]);for(r=1;r<30;++r)for(var o=n[r];o<n[r+1];++o)s[o]=o-n[r]<<5|r;return[n,s]},ce=le(oe,2),he=ce[0],ue=ce[1];he[28]=258,ue[258]=28;for(var de=le(ie,0),pe=de[0],me=de[1],fe=new re(32768),ge=0;ge<32768;++ge){var ve=(43690&ge)>>>1|(21845&ge)<<1;ve=(61680&(ve=(52428&ve)>>>2|(13107&ve)<<2))>>>4|(3855&ve)<<4,fe[ge]=((65280&ve)>>>8|(255&ve)<<8)>>>1}var ye=function(e,t,n){for(var r=e.length,s=0,o=new re(t);s<r;++s)++o[e[s]-1];var i,a=new re(t);for(s=0;s<t;++s)a[s]=a[s-1]+o[s-1]<<1;if(n){i=new re(1<<t);var l=15-t;for(s=0;s<r;++s)if(e[s])for(var c=s<<4|e[s],h=t-e[s],u=a[e[s]-1]++<<h,d=u|(1<<h)-1;u<=d;++u)i[fe[u]>>>l]=c}else for(i=new re(r),s=0;s<r;++s)e[s]&&(i[s]=fe[a[e[s]-1]++]>>>15-e[s]);return i},xe=new ne(288);for(ge=0;ge<144;++ge)xe[ge]=8;for(ge=144;ge<256;++ge)xe[ge]=9;for(ge=256;ge<280;++ge)xe[ge]=7;for(ge=280;ge<288;++ge)xe[ge]=8;var be=new ne(32);for(ge=0;ge<32;++ge)be[ge]=5;var we=ye(xe,9,0),Ae=ye(xe,9,1),Me=ye(be,5,0),Te=ye(be,5,1),_e=function(e){for(var t=e[0],n=1;n<e.length;++n)e[n]>t&&(t=e[n]);return t},Se=function(e,t,n){var r=t/8|0;return(e[r]|e[r+1]<<8)>>(7&t)&n},Ee=function(e,t){var n=t/8|0;return(e[n]|e[n+1]<<8|e[n+2]<<16)>>(7&t)},Pe=function(e){return(e/8|0)+(7&e&&1)},Ce=function(e,t,n){(null==t||t<0)&&(t=0),(null==n||n>e.length)&&(n=e.length);var r=new(e instanceof re?re:e instanceof se?se:ne)(n-t);return r.set(e.subarray(t,n)),r},Re=function(e,t,n){var r=e.length;if(!r||n&&!n.l&&r<5)return t||new ne(0);var s=!t||n,o=!n||n.i;n||(n={}),t||(t=new ne(3*r));var i=function(e){var n=t.length;if(e>n){var r=new ne(Math.max(2*n,e));r.set(t),t=r}},a=n.f||0,l=n.p||0,c=n.b||0,h=n.l,u=n.d,d=n.m,p=n.n,m=8*r;do{if(!h){n.f=a=Se(e,l,1);var f=Se(e,l+1,3);if(l+=3,!f){var g=e[(E=Pe(l)+4)-4]|e[E-3]<<8,v=E+g;if(v>r){if(o)throw"unexpected EOF";break}s&&i(c+g),t.set(e.subarray(E,v),c),n.b=c+=g,n.p=l=8*v;continue}if(1==f)h=Ae,u=Te,d=9,p=5;else{if(2!=f)throw"invalid block type";var y=Se(e,l,31)+257,x=Se(e,l+10,15)+4,b=y+Se(e,l+5,31)+1;l+=14;for(var w=new ne(b),A=new ne(19),M=0;M<x;++M)A[ae[M]]=Se(e,l+3*M,7);l+=3*x;var T=_e(A),_=(1<<T)-1,S=ye(A,T,1);for(M=0;M<b;){var E,P=S[Se(e,l,_)];if(l+=15&P,(E=P>>>4)<16)w[M++]=E;else{var C=0,R=0;for(16==E?(R=3+Se(e,l,3),l+=2,C=w[M-1]):17==E?(R=3+Se(e,l,7),l+=3):18==E&&(R=11+Se(e,l,127),l+=7);R--;)w[M++]=C}}var L=w.subarray(0,y),V=w.subarray(y);d=_e(L),p=_e(V),h=ye(L,d,1),u=ye(V,p,1)}if(l>m){if(o)throw"unexpected EOF";break}}s&&i(c+131072);for(var k=(1<<d)-1,I=(1<<p)-1,O=l;;O=l){var N=(C=h[Ee(e,l)&k])>>>4;if((l+=15&C)>m){if(o)throw"unexpected EOF";break}if(!C)throw"invalid length/literal";if(N<256)t[c++]=N;else{if(256==N){O=l,h=null;break}var B=N-254;if(N>264){var D=oe[M=N-257];B=Se(e,l,(1<<D)-1)+he[M],l+=D}var F=u[Ee(e,l)&I],U=F>>>4;if(!F)throw"invalid distance";if(l+=15&F,V=pe[U],U>3&&(D=ie[U],V+=Ee(e,l)&(1<<D)-1,l+=D),l>m){if(o)throw"unexpected EOF";break}s&&i(c+131072);for(var z=c+B;c<z;c+=4)t[c]=t[c-V],t[c+1]=t[c+1-V],t[c+2]=t[c+2-V],t[c+3]=t[c+3-V];c=z}}n.l=h,n.p=O,n.b=c,h&&(a=1,n.m=d,n.d=u,n.n=p)}while(!a);return c==t.length?t:Ce(t,0,c)},Le=function(e,t,n){n<<=7&t;var r=t/8|0;e[r]|=n,e[r+1]|=n>>>8},Ve=function(e,t,n){n<<=7&t;var r=t/8|0;e[r]|=n,e[r+1]|=n>>>8,e[r+2]|=n>>>16},ke=function(e,t){for(var n=[],r=0;r<e.length;++r)e[r]&&n.push({s:r,f:e[r]});var s=n.length,o=n.slice();if(!s)return[Ue,0];if(1==s){var i=new ne(n[0].s+1);return i[n[0].s]=1,[i,1]}n.sort((function(e,t){return e.f-t.f})),n.push({s:-1,f:25001});var a=n[0],l=n[1],c=0,h=1,u=2;for(n[0]={s:-1,f:a.f+l.f,l:a,r:l};h!=s-1;)a=n[n[c].f<n[u].f?c++:u++],l=n[c!=h&&n[c].f<n[u].f?c++:u++],n[h++]={s:-1,f:a.f+l.f,l:a,r:l};var d=o[0].s;for(r=1;r<s;++r)o[r].s>d&&(d=o[r].s);var p=new re(d+1),m=Ie(n[h-1],p,0);if(m>t){r=0;var f=0,g=m-t,v=1<<g;for(o.sort((function(e,t){return p[t.s]-p[e.s]||e.f-t.f}));r<s;++r){var y=o[r].s;if(!(p[y]>t))break;f+=v-(1<<m-p[y]),p[y]=t}for(f>>>=g;f>0;){var x=o[r].s;p[x]<t?f-=1<<t-p[x]++-1:++r}for(;r>=0&&f;--r){var b=o[r].s;p[b]==t&&(--p[b],++f)}m=t}return[new ne(p),m]},Ie=function(e,t,n){return-1==e.s?Math.max(Ie(e.l,t,n+1),Ie(e.r,t,n+1)):t[e.s]=n},Oe=function(e){for(var t=e.length;t&&!e[--t];);for(var n=new re(++t),r=0,s=e[0],o=1,i=function(e){n[r++]=e},a=1;a<=t;++a)if(e[a]==s&&a!=t)++o;else{if(!s&&o>2){for(;o>138;o-=138)i(32754);o>2&&(i(o>10?o-11<<5|28690:o-3<<5|12305),o=0)}else if(o>3){for(i(s),--o;o>6;o-=6)i(8304);o>2&&(i(o-3<<5|8208),o=0)}for(;o--;)i(s);o=1,s=e[a]}return[n.subarray(0,r),t]},Ne=function(e,t){for(var n=0,r=0;r<t.length;++r)n+=e[r]*t[r];return n},Be=function(e,t,n){var r=n.length,s=Pe(t+2);e[s]=255&r,e[s+1]=r>>>8,e[s+2]=255^e[s],e[s+3]=255^e[s+1];for(var o=0;o<r;++o)e[s+o+4]=n[o];return 8*(s+4+r)},De=function(e,t,n,r,s,o,i,a,l,c,h){Le(t,h++,n),++s[256];for(var u=ke(s,15),d=u[0],p=u[1],m=ke(o,15),f=m[0],g=m[1],v=Oe(d),y=v[0],x=v[1],b=Oe(f),w=b[0],A=b[1],M=new re(19),T=0;T<y.length;++T)M[31&y[T]]++;for(T=0;T<w.length;++T)M[31&w[T]]++;for(var _=ke(M,7),S=_[0],E=_[1],P=19;P>4&&!S[ae[P-1]];--P);var C,R,L,V,k=c+5<<3,I=Ne(s,xe)+Ne(o,be)+i,O=Ne(s,d)+Ne(o,f)+i+14+3*P+Ne(M,S)+(2*M[16]+3*M[17]+7*M[18]);if(k<=I&&k<=O)return Be(t,h,e.subarray(l,l+c));if(Le(t,h,1+(O<I)),h+=2,O<I){C=ye(d,p,0),R=d,L=ye(f,g,0),V=f;var N=ye(S,E,0);for(Le(t,h,x-257),Le(t,h+5,A-1),Le(t,h+10,P-4),h+=14,T=0;T<P;++T)Le(t,h+3*T,S[ae[T]]);h+=3*P;for(var B=[y,w],D=0;D<2;++D){var F=B[D];for(T=0;T<F.length;++T){var U=31&F[T];Le(t,h,N[U]),h+=S[U],U>15&&(Le(t,h,F[T]>>>5&127),h+=F[T]>>>12)}}}else C=we,R=xe,L=Me,V=be;for(T=0;T<a;++T)if(r[T]>255){U=r[T]>>>18&31,Ve(t,h,C[U+257]),h+=R[U+257],U>7&&(Le(t,h,r[T]>>>23&31),h+=oe[U]);var z=31&r[T];Ve(t,h,L[z]),h+=V[z],z>3&&(Ve(t,h,r[T]>>>5&8191),h+=ie[z])}else Ve(t,h,C[r[T]]),h+=R[r[T]];return Ve(t,h,C[256]),h+R[256]},Fe=new se([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),Ue=new ne(0),ze=function(e,t,n,r,s,o){var i=e.length,a=new ne(r+i+5*(1+Math.ceil(i/7e3))+s),l=a.subarray(r,a.length-s),c=0;if(!t||i<8)for(var h=0;h<=i;h+=65535){var u=h+65535;u<i?c=Be(l,c,e.subarray(h,u)):(l[h]=o,c=Be(l,c,e.subarray(h,i)))}else{for(var d=Fe[t-1],p=d>>>13,m=8191&d,f=(1<<n)-1,g=new re(32768),v=new re(f+1),y=Math.ceil(n/3),x=2*y,b=function(t){return(e[t]^e[t+1]<<y^e[t+2]<<x)&f},w=new se(25e3),A=new re(288),M=new re(32),T=0,_=0,S=(h=0,0),E=0,P=0;h<i;++h){var C=b(h),R=32767&h,L=v[C];if(g[R]=L,v[C]=R,E<=h){var V=i-h;if((T>7e3||S>24576)&&V>423){c=De(e,l,0,w,A,M,_,S,P,h-P,c),S=T=_=0,P=h;for(var k=0;k<286;++k)A[k]=0;for(k=0;k<30;++k)M[k]=0}var I=2,O=0,N=m,B=R-L&32767;if(V>2&&C==b(h-B))for(var D=Math.min(p,V)-1,F=Math.min(32767,h),U=Math.min(258,V);B<=F&&--N&&R!=L;){if(e[h+I]==e[h+I-B]){for(var z=0;z<U&&e[h+z]==e[h+z-B];++z);if(z>I){if(I=z,O=B,z>D)break;var j=Math.min(B,z-2),H=0;for(k=0;k<j;++k){var G=h-B+k+32768&32767,W=G-g[G]+32768&32767;W>H&&(H=W,L=G)}}}B+=(R=L)-(L=g[R])+32768&32767}if(O){w[S++]=268435456|ue[I]<<18|me[O];var X=31&ue[I],q=31&me[O];_+=oe[X]+ie[q],++A[257+X],++M[q],E=h+I,++T}else w[S++]=e[h],++A[e[h]]}}c=De(e,l,o,w,A,M,_,S,P,h-P,c),!o&&7&c&&(c=Be(l,c+1,Ue))}return Ce(a,0,r+Pe(c)+s)},je=function(){for(var e=new se(256),t=0;t<256;++t){for(var n=t,r=9;--r;)n=(1&n&&3988292384)^n>>>1;e[t]=n}return e}(),He=function(){var e=-1;return{p:function(t){for(var n=e,r=0;r<t.length;++r)n=je[255&n^t[r]]^n>>>8;e=n},d:function(){return~e}}},Ge=function(){var e=1,t=0;return{p:function(n){for(var r=e,s=t,o=n.length,i=0;i!=o;){for(var a=Math.min(i+2655,o);i<a;++i)s+=r+=n[i];r=(65535&r)+15*(r>>16),s=(65535&s)+15*(s>>16)}e=r,t=s},d:function(){return(255&(e%=65521))<<24|e>>>8<<16|(255&(t%=65521))<<8|t>>>8}}},We=function(e,t,n,r,s){return ze(e,null==t.level?6:t.level,null==t.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):12+t.mem,n,r,!s)},Xe=function(e,t){var n={};for(var r in e)n[r]=e[r];for(var r in t)n[r]=t[r];return n},qe=function(e,t,n){for(var r=e(),s=e.toString(),o=s.slice(s.indexOf("[")+1,s.lastIndexOf("]")).replace(/ /g,"").split(","),i=0;i<r.length;++i){var a=r[i],l=o[i];if("function"==typeof a){t+=";"+l+"=";var c=a.toString();if(a.prototype)if(-1!=c.indexOf("[native code]")){var h=c.indexOf(" ",8)+1;t+=c.slice(h,c.indexOf("(",h))}else for(var u in t+=c,a.prototype)t+=";"+l+".prototype."+u+"="+a.prototype[u].toString();else t+=c}else n[l]=a}return[t,n]},Ye=[],Ke=function(e,t,n,r){var s;if(!Ye[n]){for(var o="",i={},a=e.length-1,l=0;l<a;++l)o=(s=qe(e[l],o,i))[0],i=s[1];Ye[n]=qe(e[a],o,i)}var c=Xe({},Ye[n][1]);return function(e,t,n,r,s){var o=te(J[t]||(J[t]=ee(e)));return o.onerror=function(e){return s(e.error,null)},o.onmessage=function(e){return s(null,e.data)},o.postMessage(n,r),o}(Ye[n][0]+";onmessage=function(e){for(var k in e.data)self[k]=e.data[k];onmessage="+t.toString()+"}",n,c,function(e){var t=[];for(var n in e)(e[n]instanceof ne||e[n]instanceof re||e[n]instanceof se)&&t.push((e[n]=new e[n].constructor(e[n])).buffer);return t}(c),r)},$e=function(){return[ne,re,se,oe,ie,ae,he,pe,Ae,Te,fe,ye,_e,Se,Ee,Pe,Ce,Re,_t,nt,rt]},Qe=function(){return[ne,re,se,oe,ie,ae,ue,me,we,xe,Me,be,fe,Fe,Ue,ye,Le,Ve,ke,Ie,Oe,Ne,Be,De,Pe,Ce,ze,We,wt,nt]},Ze=function(){return[ut,mt,ht,He,je]},Je=function(){return[dt,pt]},et=function(){return[ft,ht,Ge]},tt=function(){return[gt]},nt=function(e){return postMessage(e,[e.buffer])},rt=function(e){return e&&e.size&&new ne(e.size)},st=function(e,t,n,r,s,o){var i=Ke(n,r,s,(function(e,t){i.terminate(),o(e,t)}));return i.postMessage([e,t],t.consume?[e.buffer]:[]),function(){i.terminate()}},ot=function(e){return e.ondata=function(e,t){return postMessage([e,t],[e.buffer])},function(t){return e.push(t.data[0],t.data[1])}},it=function(e,t,n,r,s){var o,i=Ke(e,r,s,(function(e,n){e?(i.terminate(),t.ondata.call(t,e)):(n[1]&&i.terminate(),t.ondata.call(t,e,n[0],n[1]))}));i.postMessage(n),t.push=function(e,n){if(o)throw"stream finished";if(!t.ondata)throw"no stream handler";i.postMessage([e,o=n],[e.buffer])},t.terminate=function(){i.terminate()}},at=function(e,t){return e[t]|e[t+1]<<8},lt=function(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0},ct=function(e,t){return lt(e,t)+4294967296*lt(e,t+4)},ht=function(e,t,n){for(;n;++t)e[t]=n,n>>>=8},ut=function(e,t){var n=t.filename;if(e[0]=31,e[1]=139,e[2]=8,e[8]=t.level<2?4:9==t.level?2:0,e[9]=3,0!=t.mtime&&ht(e,4,Math.floor(new Date(t.mtime||Date.now())/1e3)),n){e[3]=8;for(var r=0;r<=n.length;++r)e[r+10]=n.charCodeAt(r)}},dt=function(e){if(31!=e[0]||139!=e[1]||8!=e[2])throw"invalid gzip data";var t=e[3],n=10;4&t&&(n+=e[10]|2+(e[11]<<8));for(var r=(t>>3&1)+(t>>4&1);r>0;r-=!e[n++]);return n+(2&t)},pt=function(e){var t=e.length;return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0},mt=function(e){return 10+(e.filename&&e.filename.length+1||0)},ft=function(e,t){var n=t.level,r=0==n?0:n<6?1:9==n?3:2;e[0]=120,e[1]=r<<6|(r?32-2*r:1)},gt=function(e){if(8!=(15&e[0])||e[0]>>>4>7||(e[0]<<8|e[1])%31)throw"invalid zlib data";if(32&e[1])throw"invalid zlib data: preset dictionaries not supported"};function vt(e,t){return t||"function"!=typeof e||(t=e,e={}),this.ondata=t,e}var yt=function(){function e(e,t){t||"function"!=typeof e||(t=e,e={}),this.ondata=t,this.o=e||{}}return e.prototype.p=function(e,t){this.ondata(We(e,this.o,0,0,!t),t)},e.prototype.push=function(e,t){if(this.d)throw"stream finished";if(!this.ondata)throw"no stream handler";this.d=t,this.p(e,t||!1)},e}(),xt=function(){return function(e,t){it([Qe,function(){return[ot,yt]}],this,vt.call(this,e,t),(function(e){var t=new yt(e.data);onmessage=ot(t)}),6)}}();function bt(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return st(e,t,[Qe],(function(e){return nt(wt(e.data[0],e.data[1]))}),0,n)}function wt(e,t){return We(e,t||{},0,0)}var At=function(){function e(e){this.s={},this.p=new ne(0),this.ondata=e}return e.prototype.e=function(e){if(this.d)throw"stream finished";if(!this.ondata)throw"no stream handler";var t=this.p.length,n=new ne(t+e.length);n.set(this.p),n.set(e,t),this.p=n},e.prototype.c=function(e){this.d=this.s.i=e||!1;var t=this.s.b,n=Re(this.p,this.o,this.s);this.ondata(Ce(n,t,this.s.b),this.d),this.o=Ce(n,this.s.b-32768),this.s.b=this.o.length,this.p=Ce(this.p,this.s.p/8|0),this.s.p&=7},e.prototype.push=function(e,t){this.e(e),this.c(t)},e}(),Mt=function(){return function(e){this.ondata=e,it([$e,function(){return[ot,At]}],this,0,(function(){var e=new At;onmessage=ot(e)}),7)}}();function Tt(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return st(e,t,[$e],(function(e){return nt(_t(e.data[0],rt(e.data[1])))}),1,n)}function _t(e,t){return Re(e,t)}var St=function(){function e(e,t){this.c=He(),this.l=0,this.v=1,yt.call(this,e,t)}return e.prototype.push=function(e,t){yt.prototype.push.call(this,e,t)},e.prototype.p=function(e,t){this.c.p(e),this.l+=e.length;var n=We(e,this.o,this.v&&mt(this.o),t&&8,!t);this.v&&(ut(n,this.o),this.v=0),t&&(ht(n,n.length-8,this.c.d()),ht(n,n.length-4,this.l)),this.ondata(n,t)},e}(),Et=function(){return function(e,t){it([Qe,Ze,function(){return[ot,yt,St]}],this,vt.call(this,e,t),(function(e){var t=new St(e.data);onmessage=ot(t)}),8)}}();function Pt(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return st(e,t,[Qe,Ze,function(){return[Ct]}],(function(e){return nt(Ct(e.data[0],e.data[1]))}),2,n)}function Ct(e,t){t||(t={});var n=He(),r=e.length;n.p(e);var s=We(e,t,mt(t),8),o=s.length;return ut(s,t),ht(s,o-8,n.d()),ht(s,o-4,r),s}var Rt=function(){function e(e){this.v=1,At.call(this,e)}return e.prototype.push=function(e,t){if(At.prototype.e.call(this,e),this.v){var n=this.p.length>3?dt(this.p):4;if(n>=this.p.length&&!t)return;this.p=this.p.subarray(n),this.v=0}if(t){if(this.p.length<8)throw"invalid gzip stream";this.p=this.p.subarray(0,-8)}At.prototype.c.call(this,t)},e}(),Lt=function(){return function(e){this.ondata=e,it([$e,Je,function(){return[ot,At,Rt]}],this,0,(function(){var e=new Rt;onmessage=ot(e)}),9)}}();function Vt(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return st(e,t,[$e,Je,function(){return[kt]}],(function(e){return nt(kt(e.data[0]))}),3,n)}function kt(e,t){return Re(e.subarray(dt(e),-8),t||new ne(pt(e)))}var It=function(){function e(e,t){this.c=Ge(),this.v=1,yt.call(this,e,t)}return e.prototype.push=function(e,t){yt.prototype.push.call(this,e,t)},e.prototype.p=function(e,t){this.c.p(e);var n=We(e,this.o,this.v&&2,t&&4,!t);this.v&&(ft(n,this.o),this.v=0),t&&ht(n,n.length-4,this.c.d()),this.ondata(n,t)},e}(),Ot=function(){return function(e,t){it([Qe,et,function(){return[ot,yt,It]}],this,vt.call(this,e,t),(function(e){var t=new It(e.data);onmessage=ot(t)}),10)}}();function Nt(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return st(e,t,[Qe,et,function(){return[Bt]}],(function(e){return nt(Bt(e.data[0],e.data[1]))}),4,n)}function Bt(e,t){t||(t={});var n=Ge();n.p(e);var r=We(e,t,2,4);return ft(r,t),ht(r,r.length-4,n.d()),r}var Dt=function(){function e(e){this.v=1,At.call(this,e)}return e.prototype.push=function(e,t){if(At.prototype.e.call(this,e),this.v){if(this.p.length<2&&!t)return;this.p=this.p.subarray(2),this.v=0}if(t){if(this.p.length<4)throw"invalid zlib stream";this.p=this.p.subarray(0,-4)}At.prototype.c.call(this,t)},e}(),Ft=function(){return function(e){this.ondata=e,it([$e,tt,function(){return[ot,At,Dt]}],this,0,(function(){var e=new Dt;onmessage=ot(e)}),11)}}();function Ut(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return st(e,t,[$e,tt,function(){return[zt]}],(function(e){return nt(zt(e.data[0],rt(e.data[1])))}),5,n)}function zt(e,t){return Re((gt(e),e.subarray(2,-4)),t)}var jt=function(){function e(e){this.G=Rt,this.I=At,this.Z=Dt,this.ondata=e}return e.prototype.push=function(e,t){if(!this.ondata)throw"no stream handler";if(this.s)this.s.push(e,t);else{if(this.p&&this.p.length){var n=new ne(this.p.length+e.length);n.set(this.p),n.set(e,this.p.length)}else this.p=e;if(this.p.length>2){var r=this,s=function(){r.ondata.apply(r,arguments)};this.s=31==this.p[0]&&139==this.p[1]&&8==this.p[2]?new this.G(s):8!=(15&this.p[0])||this.p[0]>>4>7||(this.p[0]<<8|this.p[1])%31?new this.I(s):new this.Z(s),this.s.push(this.p,t),this.p=null}}},e}(),Ht=function(){function e(e){this.G=Lt,this.I=Mt,this.Z=Ft,this.ondata=e}return e.prototype.push=function(e,t){jt.prototype.push.call(this,e,t)},e}();function Gt(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";return 31==e[0]&&139==e[1]&&8==e[2]?Vt(e,t,n):8!=(15&e[0])||e[0]>>4>7||(e[0]<<8|e[1])%31?Tt(e,t,n):Ut(e,t,n)}function Wt(e,t){return 31==e[0]&&139==e[1]&&8==e[2]?kt(e,t):8!=(15&e[0])||e[0]>>4>7||(e[0]<<8|e[1])%31?_t(e,t):zt(e,t)}var Xt=function(e,t,n,r){for(var s in e){var o=e[s],i=t+s;o instanceof ne?n[i]=[o,r]:Array.isArray(o)?n[i]=[o[0],Xe(r,o[1])]:Xt(o,i+"/",n,r)}},qt="undefined"!=typeof TextEncoder&&new TextEncoder,Yt="undefined"!=typeof TextDecoder&&new TextDecoder,Kt=0;try{Yt.decode(Ue,{stream:!0}),Kt=1}catch(e){}var $t=function(e){for(var t="",n=0;;){var r=e[n++],s=(r>127)+(r>223)+(r>239);if(n+s>e.length)return[t,Ce(e,n-1)];s?3==s?(r=((15&r)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536,t+=String.fromCharCode(55296|r>>10,56320|1023&r)):t+=1&s?String.fromCharCode((31&r)<<6|63&e[n++]):String.fromCharCode((15&r)<<12|(63&e[n++])<<6|63&e[n++]):t+=String.fromCharCode(r)}},Qt=function(){function e(e){this.ondata=e,Kt?this.t=new TextDecoder:this.p=Ue}return e.prototype.push=function(e,t){if(!this.ondata)throw"no callback";if(t=!!t,this.t){if(this.ondata(this.t.decode(e,{stream:!0}),t),t){if(this.t.decode().length)throw"invalid utf-8 data";this.t=null}}else{if(!this.p)throw"stream finished";var n=new ne(this.p.length+e.length);n.set(this.p),n.set(e,this.p.length);var r=$t(n),s=r[0],o=r[1];if(t){if(o.length)throw"invalid utf-8 data";this.p=null}else this.p=o;this.ondata(s,t)}},e}(),Zt=function(){function e(e){this.ondata=e}return e.prototype.push=function(e,t){if(!this.ondata)throw"no callback";if(this.d)throw"stream finished";this.ondata(Jt(e),this.d=t||!1)},e}();function Jt(e,t){if(t){for(var n=new ne(e.length),r=0;r<e.length;++r)n[r]=e.charCodeAt(r);return n}if(qt)return qt.encode(e);var s=e.length,o=new ne(e.length+(e.length>>1)),i=0,a=function(e){o[i++]=e};for(r=0;r<s;++r){if(i+5>o.length){var l=new ne(i+8+(s-r<<1));l.set(o),o=l}var c=e.charCodeAt(r);c<128||t?a(c):c<2048?(a(192|c>>6),a(128|63&c)):c>55295&&c<57344?(a(240|(c=65536+(1047552&c)|1023&e.charCodeAt(++r))>>18),a(128|c>>12&63),a(128|c>>6&63),a(128|63&c)):(a(224|c>>12),a(128|c>>6&63),a(128|63&c))}return Ce(o,0,i)}function en(e,t){if(t){for(var n="",r=0;r<e.length;r+=16384)n+=String.fromCharCode.apply(null,e.subarray(r,r+16384));return n}if(Yt)return Yt.decode(e);var s=$t(e),o=s[0];if(s[1].length)throw"invalid utf-8 data";return o}var tn=function(e){return 1==e?3:e<6?2:9==e?1:0},nn=function(e,t){return t+30+at(e,t+26)+at(e,t+28)},rn=function(e,t,n){var r=at(e,t+28),s=en(e.subarray(t+46,t+46+r),!(2048&at(e,t+8))),o=t+46+r,i=lt(e,t+20),a=n&&4294967295==i?sn(e,o):[i,lt(e,t+24),lt(e,t+42)],l=a[0],c=a[1],h=a[2];return[at(e,t+10),l,c,s,o+at(e,t+30)+at(e,t+32),h]},sn=function(e,t){for(;1!=at(e,t);t+=4+at(e,t+2));return[ct(e,t+12),ct(e,t+4),ct(e,t+20)]},on=function(e){var t=0;if(e)for(var n in e){var r=e[n].length;if(r>65535)throw"extra field too long";t+=r+4}return t},an=function(e,t,n,r,s,o,i,a){var l=r.length,c=n.extra,h=a&&a.length,u=on(c);ht(e,t,null!=i?33639248:67324752),t+=4,null!=i&&(e[t++]=20,e[t++]=n.os),e[t]=20,t+=2,e[t++]=n.flag<<1|(null==o&&8),e[t++]=s&&8,e[t++]=255&n.compression,e[t++]=n.compression>>8;var d=new Date(null==n.mtime?Date.now():n.mtime),p=d.getFullYear()-1980;if(p<0||p>119)throw"date not in range 1980-2099";if(ht(e,t,p<<25|d.getMonth()+1<<21|d.getDate()<<16|d.getHours()<<11|d.getMinutes()<<5|d.getSeconds()>>>1),t+=4,null!=o&&(ht(e,t,n.crc),ht(e,t+4,o),ht(e,t+8,n.size)),ht(e,t+12,l),ht(e,t+14,u),t+=16,null!=i&&(ht(e,t,h),ht(e,t+6,n.attrs),ht(e,t+10,i),t+=14),e.set(r,t),t+=l,u)for(var m in c){var f=c[m],g=f.length;ht(e,t,+m),ht(e,t+2,g),e.set(f,t+4),t+=4+g}return h&&(e.set(a,t),t+=h),t},ln=function(e,t,n,r,s){ht(e,t,101010256),ht(e,t+8,n),ht(e,t+10,n),ht(e,t+12,r),ht(e,t+16,s)},cn=function(){function e(e){this.filename=e,this.c=He(),this.size=0,this.compression=0}return e.prototype.process=function(e,t){this.ondata(null,e,t)},e.prototype.push=function(e,t){if(!this.ondata)throw"no callback - add to ZIP archive before pushing";this.c.p(e),this.size+=e.length,t&&(this.crc=this.c.d()),this.process(e,t||!1)},e}(),hn=function(){function e(e,t){var n=this;t||(t={}),cn.call(this,e),this.d=new yt(t,(function(e,t){n.ondata(null,e,t)})),this.compression=8,this.flag=tn(t.level)}return e.prototype.process=function(e,t){try{this.d.push(e,t)}catch(e){this.ondata(e,null,t)}},e.prototype.push=function(e,t){cn.prototype.push.call(this,e,t)},e}(),un=function(){function e(e,t){var n=this;t||(t={}),cn.call(this,e),this.d=new xt(t,(function(e,t,r){n.ondata(e,t,r)})),this.compression=8,this.flag=tn(t.level),this.terminate=this.d.terminate}return e.prototype.process=function(e,t){this.d.push(e,t)},e.prototype.push=function(e,t){cn.prototype.push.call(this,e,t)},e}(),dn=function(){function e(e){this.ondata=e,this.u=[],this.d=1}return e.prototype.add=function(e){var t=this;if(2&this.d)throw"stream finished";var n=Jt(e.filename),r=n.length,s=e.comment,o=s&&Jt(s),i=r!=e.filename.length||o&&s.length!=o.length,a=r+on(e.extra)+30;if(r>65535)throw"filename too long";var l=new ne(a);an(l,0,e,n,i);var c=[l],h=function(){for(var e=0,n=c;e<n.length;e++){var r=n[e];t.ondata(null,r,!1)}c=[]},u=this.d;this.d=0;var d=this.u.length,p=Xe(e,{f:n,u:i,o,t:function(){e.terminate&&e.terminate()},r:function(){if(h(),u){var e=t.u[d+1];e?e.r():t.d=1}u=1}}),m=0;e.ondata=function(n,r,s){if(n)t.ondata(n,r,s),t.terminate();else if(m+=r.length,c.push(r),s){var o=new ne(16);ht(o,0,134695760),ht(o,4,e.crc),ht(o,8,m),ht(o,12,e.size),c.push(o),p.c=m,p.b=a+m+16,p.crc=e.crc,p.size=e.size,u&&p.r(),u=1}else u&&h()},this.u.push(p)},e.prototype.end=function(){var e=this;if(2&this.d){if(1&this.d)throw"stream finishing";throw"stream finished"}this.d?this.e():this.u.push({r:function(){1&e.d&&(e.u.splice(-1,1),e.e())},t:function(){}}),this.d=3},e.prototype.e=function(){for(var e=0,t=0,n=0,r=0,s=this.u;r<s.length;r++)n+=46+(l=s[r]).f.length+on(l.extra)+(l.o?l.o.length:0);for(var o=new ne(n+22),i=0,a=this.u;i<a.length;i++){var l=a[i];an(o,e,l,l.f,l.u,l.c,t,l.o),e+=46+l.f.length+on(l.extra)+(l.o?l.o.length:0),t+=l.b}ln(o,e,this.u.length,n,t),this.ondata(null,o,!0),this.d=2},e.prototype.terminate=function(){for(var e=0,t=this.u;e<t.length;e++)t[e].t();this.d=2},e}();function pn(e,t,n){if(n||(n=t,t={}),"function"!=typeof n)throw"no callback";var r={};Xt(e,"",r,t);var s=Object.keys(r),o=s.length,i=0,a=0,l=o,c=new Array(o),h=[],u=function(){for(var e=0;e<h.length;++e)h[e]()},d=function(){var e=new ne(a+22),t=i,r=a-i;a=0;for(var s=0;s<l;++s){var o=c[s];try{var h=o.c.length;an(e,a,o,o.f,o.u,h);var u=30+o.f.length+on(o.extra),d=a+u;e.set(o.c,d),an(e,i,o,o.f,o.u,h,a,o.m),i+=16+u+(o.m?o.m.length:0),a=d+h}catch(e){return n(e,null)}}ln(e,i,c.length,r,t),n(null,e)};o||d();for(var p=function(e){var t=s[e],l=r[t],p=l[0],m=l[1],f=He(),g=p.length;f.p(p);var v=Jt(t),y=v.length,x=m.comment,b=x&&Jt(x),w=b&&b.length,A=on(m.extra),M=0==m.level?0:8,T=function(r,s){if(r)u(),n(r,null);else{var l=s.length;c[e]=Xe(m,{size:g,crc:f.d(),c:s,f:v,m:b,u:y!=t.length||b&&x.length!=w,compression:M}),i+=30+y+A+l,a+=76+2*(y+A)+(w||0)+l,--o||d()}};if(y>65535&&T("filename too long",null),M)if(g<16e4)try{T(null,wt(p,m))}catch(e){T(e,null)}else h.push(bt(p,m,T));else T(null,p)},m=0;m<l;++m)p(m);return u}function mn(e,t){t||(t={});var n={},r=[];Xt(e,"",n,t);var s=0,o=0;for(var i in n){var a=n[i],l=a[0],c=a[1],h=0==c.level?0:8,u=(M=Jt(i)).length,d=c.comment,p=d&&Jt(d),m=p&&p.length,f=on(c.extra);if(u>65535)throw"filename too long";var g=h?wt(l,c):l,v=g.length,y=He();y.p(l),r.push(Xe(c,{size:l.length,crc:y.d(),c:g,f:M,m:p,u:u!=i.length||p&&d.length!=m,o:s,compression:h})),s+=30+u+f+v,o+=76+2*(u+f)+(m||0)+v}for(var x=new ne(o+22),b=s,w=o-s,A=0;A<r.length;++A){var M=r[A];an(x,M.o,M,M.f,M.u,M.c.length);var T=30+M.f.length+on(M.extra);x.set(M.c,M.o+T),an(x,s,M,M.f,M.u,M.c.length,M.o,M.m),s+=16+T+(M.m?M.m.length:0)}return ln(x,s,r.length,w,b),x}var fn=function(){function e(){}return e.prototype.push=function(e,t){this.ondata(null,e,t)},e.compression=0,e}(),gn=function(){function e(){var e=this;this.i=new At((function(t,n){e.ondata(null,t,n)}))}return e.prototype.push=function(e,t){try{this.i.push(e,t)}catch(n){this.ondata(n,e,t)}},e.compression=8,e}(),vn=function(){function e(e,t){var n=this;t<32e4?this.i=new At((function(e,t){n.ondata(null,e,t)})):(this.i=new Mt((function(e,t,r){n.ondata(e,t,r)})),this.terminate=this.i.terminate)}return e.prototype.push=function(e,t){this.i.terminate&&(e=Ce(e,0)),this.i.push(e,t)},e.compression=8,e}(),yn=function(){function e(e){this.onfile=e,this.k=[],this.o={0:fn},this.p=Ue}return e.prototype.push=function(e,t){var n=this;if(!this.onfile)throw"no callback";if(!this.p)throw"stream finished";if(this.c>0){var r=Math.min(this.c,e.length),s=e.subarray(0,r);if(this.c-=r,this.d?this.d.push(s,!this.c):this.k[0].push(s),(e=e.subarray(r)).length)return this.push(e,t)}else{var o=0,i=0,a=void 0,l=void 0;this.p.length?e.length?((l=new ne(this.p.length+e.length)).set(this.p),l.set(e,this.p.length)):l=this.p:l=e;for(var c=l.length,h=this.c,u=h&&this.d,d=function(){var e,t=lt(l,i);if(67324752==t){o=1,a=i,p.d=null,p.c=0;var r=at(l,i+6),s=at(l,i+8),u=2048&r,d=8&r,m=at(l,i+26),f=at(l,i+28);if(c>i+30+m+f){var g=[];p.k.unshift(g),o=2;var v,y=lt(l,i+18),x=lt(l,i+22),b=en(l.subarray(i+30,i+=30+m),!u);4294967295==y?(e=d?[-2]:sn(l,i),y=e[0],x=e[1]):d&&(y=-1),i+=f,p.c=y;var w={name:b,compression:s,start:function(){if(!w.ondata)throw"no callback";if(y){var e=n.o[s];if(!e)throw"unknown compression type "+s;(v=y<0?new e(b):new e(b,y,x)).ondata=function(e,t,n){w.ondata(e,t,n)};for(var t=0,r=g;t<r.length;t++){var o=r[t];v.push(o,!1)}n.k[0]==g&&n.c?n.d=v:v.push(Ue,!0)}else w.ondata(null,Ue,!0)},terminate:function(){v&&v.terminate&&v.terminate()}};y>=0&&(w.size=y,w.originalSize=x),p.onfile(w)}return"break"}if(h){if(134695760==t)return a=i+=12+(-2==h&&8),o=3,p.c=0,"break";if(33639248==t)return a=i-=4,o=3,p.c=0,"break"}},p=this;i<c-4&&"break"!==d();++i);if(this.p=Ue,h<0){var m=o?l.subarray(0,a-12-(-2==h&&8)-(134695760==lt(l,a-16)&&4)):l.subarray(0,i);u?u.push(m,!!o):this.k[+(2==o)].push(m)}if(2&o)return this.push(l.subarray(i),t);this.p=l.subarray(i)}if(t){if(this.c)throw"invalid zip file";this.p=null}},e.prototype.register=function(e){this.o[e.compression]=e},e}();function xn(e,t){if("function"!=typeof t)throw"no callback";for(var n=[],r=function(){for(var e=0;e<n.length;++e)n[e]()},s={},o=e.length-22;101010256!=lt(e,o);--o)if(!o||e.length-o>65558)return void t("invalid zip file",null);var i=at(e,o+8);i||t(null,{});var a=i,l=lt(e,o+16),c=4294967295==l;if(c){if(o=lt(e,o-12),101075792!=lt(e,o))return void t("invalid zip file",null);a=i=lt(e,o+32),l=lt(e,o+48)}for(var h=function(o){var a=rn(e,l,c),h=a[0],u=a[1],d=a[2],p=a[3],m=a[4],f=a[5],g=nn(e,f);l=m;var v=function(e,n){e?(r(),t(e,null)):(s[p]=n,--i||t(null,s))};if(h)if(8==h){var y=e.subarray(g,g+u);if(u<32e4)try{v(null,_t(y,new ne(d)))}catch(e){v(e,null)}else n.push(Tt(y,{size:d},v))}else v("unknown compression type "+h,null);else v(null,Ce(e,g,g+u))},u=0;u<a;++u)h();return r}function bn(e){for(var t={},n=e.length-22;101010256!=lt(e,n);--n)if(!n||e.length-n>65558)throw"invalid zip file";var r=at(e,n+8);if(!r)return{};var s=lt(e,n+16),o=4294967295==s;if(o){if(n=lt(e,n-12),101075792!=lt(e,n))throw"invalid zip file";r=lt(e,n+32),s=lt(e,n+48)}for(var i=0;i<r;++i){var a=rn(e,s,o),l=a[0],c=a[1],h=a[2],u=a[3],d=a[4],p=a[5],m=nn(e,p);if(s=d,l){if(8!=l)throw"unknown compression type "+l;t[u]=_t(e.subarray(m,m+c),new ne(h))}else t[u]=Ce(e,m,m+c)}return t}class wn{static findSpan(e,t,n){const r=n.length-e-1;if(t>=n[r])return r-1;if(t<=n[e])return e;let s=e,o=r,i=Math.floor((s+o)/2);for(;t<n[i]||t>=n[i+1];)t<n[i]?o=i:s=i,i=Math.floor((s+o)/2);return i}static calcBasisFunctions(e,t,n,r){const s=[],o=[],i=[];s[0]=1;for(let a=1;a<=n;++a){o[a]=t-r[e+1-a],i[a]=r[e+a]-t;let n=0;for(let e=0;e<a;++e){const t=i[e+1],r=o[a-e],l=s[e]/(t+r);s[e]=n+t*l,n=r*l}s[a]=n}return s}static calcBSplinePoint(e,t,n,s){const o=this.findSpan(e,s,t),i=this.calcBasisFunctions(o,s,e,t),a=new r.Vector4(0,0,0,0);for(let t=0;t<=e;++t){const r=n[o-e+t],s=i[t],l=r.w*s;a.x+=r.x*l,a.y+=r.y*l,a.z+=r.z*l,a.w+=r.w*s}return a}static calcBasisFunctionDerivatives(e,t,n,r,s){const o=[];for(let e=0;e<=n;++e)o[e]=0;const i=[];for(let e=0;e<=r;++e)i[e]=o.slice(0);const a=[];for(let e=0;e<=n;++e)a[e]=o.slice(0);a[0][0]=1;const l=o.slice(0),c=o.slice(0);for(let r=1;r<=n;++r){l[r]=t-s[e+1-r],c[r]=s[e+r]-t;let n=0;for(let e=0;e<r;++e){const t=c[e+1],s=l[r-e];a[r][e]=t+s;const o=a[e][r-1]/a[r][e];a[e][r]=n+t*o,n=s*o}a[r][r]=n}for(let e=0;e<=n;++e)i[0][e]=a[e][n];for(let e=0;e<=n;++e){let t=0,s=1;const l=[];for(let e=0;e<=n;++e)l[e]=o.slice(0);l[0][0]=1;for(let o=1;o<=r;++o){let r=0;const c=e-o,h=n-o;e>=o&&(l[s][0]=l[t][0]/a[h+1][c],r=l[s][0]*a[c][h]);const u=e-1<=h?o-1:n-e;for(let e=c>=-1?1:-c;e<=u;++e)l[s][e]=(l[t][e]-l[t][e-1])/a[h+1][c+e],r+=l[s][e]*a[c+e][h];e<=h&&(l[s][o]=-l[t][o-1]/a[h+1][e],r+=l[s][o]*a[e][h]),i[o][e]=r;const d=t;t=s,s=d}}let h=n;for(let e=1;e<=r;++e){for(let t=0;t<=n;++t)i[e][t]*=h;h*=n-e}return i}static calcBSplineDerivatives(e,t,n,s,o){const i=o<e?o:e,a=[],l=this.findSpan(e,s,t),c=this.calcBasisFunctionDerivatives(l,s,e,i,t),h=[];for(let e=0;e<n.length;++e){const t=n[e].clone(),r=t.w;t.x*=r,t.y*=r,t.z*=r,h[e]=t}for(let t=0;t<=i;++t){const n=h[l-e].clone().multiplyScalar(c[t][0]);for(let r=1;r<=e;++r)n.add(h[l-e+r].clone().multiplyScalar(c[t][r]));a[t]=n}for(let e=i+1;e<=o+1;++e)a[e]=new r.Vector4(0,0,0);return a}static calcKoverI(e,t){let n=1;for(let t=2;t<=e;++t)n*=t;let r=1;for(let e=2;e<=t;++e)r*=e;for(let n=2;n<=e-t;++n)r*=n;return n/r}static calcRationalCurveDerivatives(e){const t=e.length,n=[],s=[];for(let o=0;o<t;++o){const t=e[o];n[o]=new r.Vector3(t.x,t.y,t.z),s[o]=t.w}const o=[];for(let e=0;e<t;++e){const t=n[e].clone();for(let n=1;n<=e;++n)t.sub(o[e-n].clone().multiplyScalar(this.calcKoverI(e,n)*s[n]));o[e]=t.divideScalar(s[0])}return o}static calcNURBSDerivatives(e,t,n,r,s){const o=this.calcBSplineDerivatives(e,t,n,r,s);return this.calcRationalCurveDerivatives(o)}static calcSurfacePoint(e,t,n,s,o,i,a,l){const c=this.findSpan(e,i,n),h=this.findSpan(t,a,s),u=this.calcBasisFunctions(c,i,e,n),d=this.calcBasisFunctions(h,a,t,s),p=[];for(let n=0;n<=t;++n){p[n]=new r.Vector4(0,0,0,0);for(let r=0;r<=e;++r){const s=o[c-e+r][h-t+n].clone(),i=s.w;s.x*=i,s.y*=i,s.z*=i,p[n].add(s.multiplyScalar(u[r]))}}const m=new r.Vector4(0,0,0,0);for(let e=0;e<=t;++e)m.add(p[e].multiplyScalar(d[e]));m.divideScalar(m.w),l.set(m.x,m.y,m.z)}}class An extends r.Curve{constructor(e,t,n,s,o){super(),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=s||0,this.endKnot=o||this.knots.length-1;for(let e=0;e<n.length;++e){const t=n[e];this.controlPoints[e]=new r.Vector4(t.x,t.y,t.z,t.w)}}getPoint(e,t=new r.Vector3){const n=t,s=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),o=wn.calcBSplinePoint(this.degree,this.knots,this.controlPoints,s);return 1!==o.w&&o.divideScalar(o.w),n.set(o.x,o.y,o.z)}getTangent(e,t=new r.Vector3){const n=t,s=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),o=wn.calcNURBSDerivatives(this.degree,this.knots,this.controlPoints,s,1);return n.copy(o[1]).normalize(),n}}let Mn,Tn,_n;class Sn extends r.Loader{constructor(e){super(e)}load(e,t,n,s){const o=this,i=""===o.path?r.LoaderUtils.extractUrlBase(e):o.path,a=new r.FileLoader(this.manager);a.setPath(o.path),a.setResponseType("arraybuffer"),a.setRequestHeader(o.requestHeader),a.setWithCredentials(o.withCredentials),a.load(e,(function(n){try{t(o.parse(n,i))}catch(t){s?s(t):console.error(t),o.manager.itemError(e)}}),n,s)}parse(e,t){if(function(e){const t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===Hn(e,0,t.length)}(e))Mn=(new Ln).parse(e);else{const t=Hn(e);if(!function(e){const t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let n=0;function r(t){const r=e[t-1];return e=e.slice(n+t),n++,r}for(let e=0;e<t.length;++e)if(r(1)===t[e])return!1;return!0}(t))throw new Error("THREE.FBXLoader: Unknown format.");if(In(t)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+In(t));Mn=(new Rn).parse(t)}const n=new r.TextureLoader(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new En(n,this.manager).parse(Mn)}}class En{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){Tn=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),n=this.parseMaterials(t),r=this.parseDeformers(),s=(new Pn).parse(r);return this.parseScene(r,s,n),_n}parseConnections(){const e=new Map;return"Connections"in Mn&&Mn.Connections.connections.forEach((function(t){const n=t[0],r=t[1],s=t[2];e.has(n)||e.set(n,{parents:[],children:[]});const o={ID:r,relationship:s};e.get(n).parents.push(o),e.has(r)||e.set(r,{parents:[],children:[]});const i={ID:n,relationship:s};e.get(r).children.push(i)})),e}parseImages(){const e={},t={};if("Video"in Mn.Objects){const n=Mn.Objects.Video;for(const r in n){const s=n[r];if(e[parseInt(r)]=s.RelativeFilename||s.Filename,"Content"in s){const e=s.Content instanceof ArrayBuffer&&s.Content.byteLength>0,o="string"==typeof s.Content&&""!==s.Content;if(e||o){const e=this.parseImage(n[r]);t[s.RelativeFilename||s.Filename]=e}}}}for(const n in e){const r=e[n];void 0!==t[r]?e[n]=t[r]:e[n]=e[n].split("\\").pop()}return e}parseImage(e){const t=e.Content,n=e.RelativeFilename||e.Filename,r=n.slice(n.lastIndexOf(".")+1).toLowerCase();let s;switch(r){case"bmp":s="image/bmp";break;case"jpg":case"jpeg":s="image/jpeg";break;case"png":s="image/png";break;case"tif":s="image/tiff";break;case"tga":null===this.manager.getHandler(".tga")&&console.warn("FBXLoader: TGA loader not found, skipping ",n),s="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+r+'" is not supported.')}if("string"==typeof t)return"data:"+s+";base64,"+t;{const e=new Uint8Array(t);return window.URL.createObjectURL(new Blob([e],{type:s}))}}parseTextures(e){const t=new Map;if("Texture"in Mn.Objects){const n=Mn.Objects.Texture;for(const r in n){const s=this.parseTexture(n[r],e);t.set(parseInt(r),s)}}return t}parseTexture(e,t){const n=this.loadTexture(e,t);n.ID=e.id,n.name=e.attrName;const s=e.WrapModeU,o=e.WrapModeV,i=void 0!==s?s.value:0,a=void 0!==o?o.value:0;if(n.wrapS=0===i?r.RepeatWrapping:r.ClampToEdgeWrapping,n.wrapT=0===a?r.RepeatWrapping:r.ClampToEdgeWrapping,"Scaling"in e){const t=e.Scaling.value;n.repeat.x=t[0],n.repeat.y=t[1]}return n}loadTexture(e,t){let n;const s=this.textureLoader.path,o=Tn.get(e.id).children;let i;void 0!==o&&o.length>0&&void 0!==t[o[0].ID]&&(n=t[o[0].ID],0!==n.indexOf("blob:")&&0!==n.indexOf("data:")||this.textureLoader.setPath(void 0));const a=e.FileName.slice(-3).toLowerCase();if("tga"===a){const t=this.manager.getHandler(".tga");null===t?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),i=new r.Texture):(t.setPath(this.textureLoader.path),i=t.load(n))}else"psd"===a?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),i=new r.Texture):i=this.textureLoader.load(n);return this.textureLoader.setPath(s),i}parseMaterials(e){const t=new Map;if("Material"in Mn.Objects){const n=Mn.Objects.Material;for(const r in n){const s=this.parseMaterial(n[r],e);null!==s&&t.set(parseInt(r),s)}}return t}parseMaterial(e,t){const n=e.id,s=e.attrName;let o=e.ShadingModel;if("object"==typeof o&&(o=o.value),!Tn.has(n))return null;const i=this.parseParameters(e,t,n);let a;switch(o.toLowerCase()){case"phong":a=new r.MeshPhongMaterial;break;case"lambert":a=new r.MeshLambertMaterial;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',o),a=new r.MeshPhongMaterial}return a.setValues(i),a.name=s,a}parseParameters(e,t,n){const s={};e.BumpFactor&&(s.bumpScale=e.BumpFactor.value),e.Diffuse?s.color=(new r.Color).fromArray(e.Diffuse.value):!e.DiffuseColor||"Color"!==e.DiffuseColor.type&&"ColorRGB"!==e.DiffuseColor.type||(s.color=(new r.Color).fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(s.displacementScale=e.DisplacementFactor.value),e.Emissive?s.emissive=(new r.Color).fromArray(e.Emissive.value):!e.EmissiveColor||"Color"!==e.EmissiveColor.type&&"ColorRGB"!==e.EmissiveColor.type||(s.emissive=(new r.Color).fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(s.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(s.opacity=parseFloat(e.Opacity.value)),s.opacity<1&&(s.transparent=!0),e.ReflectionFactor&&(s.reflectivity=e.ReflectionFactor.value),e.Shininess&&(s.shininess=e.Shininess.value),e.Specular?s.specular=(new r.Color).fromArray(e.Specular.value):e.SpecularColor&&"Color"===e.SpecularColor.type&&(s.specular=(new r.Color).fromArray(e.SpecularColor.value));const o=this;return Tn.get(n).children.forEach((function(e){const n=e.relationship;switch(n){case"Bump":s.bumpMap=o.getTexture(t,e.ID);break;case"Maya|TEX_ao_map":s.aoMap=o.getTexture(t,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":s.map=o.getTexture(t,e.ID),s.map.encoding=r.sRGBEncoding;break;case"DisplacementColor":s.displacementMap=o.getTexture(t,e.ID);break;case"EmissiveColor":s.emissiveMap=o.getTexture(t,e.ID),s.emissiveMap.encoding=r.sRGBEncoding;break;case"NormalMap":case"Maya|TEX_normal_map":s.normalMap=o.getTexture(t,e.ID);break;case"ReflectionColor":s.envMap=o.getTexture(t,e.ID),s.envMap.mapping=r.EquirectangularReflectionMapping,s.envMap.encoding=r.sRGBEncoding;break;case"SpecularColor":s.specularMap=o.getTexture(t,e.ID),s.specularMap.encoding=r.sRGBEncoding;break;case"TransparentColor":case"TransparencyFactor":s.alphaMap=o.getTexture(t,e.ID),s.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",n)}})),s}getTexture(e,t){return"LayeredTexture"in Mn.Objects&&t in Mn.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=Tn.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in Mn.Objects){const n=Mn.Objects.Deformer;for(const r in n){const s=n[r],o=Tn.get(parseInt(r));if("Skin"===s.attrType){const t=this.parseSkeleton(o,n);t.ID=r,o.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),t.geometryID=o.parents[0].ID,e[r]=t}else if("BlendShape"===s.attrType){const e={id:r};e.rawTargets=this.parseMorphTargets(o,n),e.id=r,o.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[r]=e}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const n=[];return e.children.forEach((function(e){const s=t[e.ID];if("Cluster"!==s.attrType)return;const o={ID:e.ID,indices:[],weights:[],transformLink:(new r.Matrix4).fromArray(s.TransformLink.a)};"Indexes"in s&&(o.indices=s.Indexes.a,o.weights=s.Weights.a),n.push(o)})),{rawBones:n,bones:[]}}parseMorphTargets(e,t){const n=[];for(let r=0;r<e.children.length;r++){const s=e.children[r],o=t[s.ID],i={name:o.attrName,initialWeight:o.DeformPercent,id:o.id,fullWeights:o.FullWeights.a};if("BlendShapeChannel"!==o.attrType)return;i.geoID=Tn.get(parseInt(s.ID)).children.filter((function(e){return void 0===e.relationship}))[0].ID,n.push(i)}return n}parseScene(e,t,n){_n=new r.Group;const s=this.parseModels(e.skeletons,t,n),o=Mn.Objects.Model,i=this;s.forEach((function(e){const t=o[e.ID];i.setLookAtProperties(e,t),Tn.get(e.ID).parents.forEach((function(t){const n=s.get(t.ID);void 0!==n&&n.add(e)})),null===e.parent&&_n.add(e)})),this.bindSkeleton(e.skeletons,t,s),this.createAmbientLight(),this.setupMorphMaterials(),_n.traverse((function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrix=e.parent.matrix,e.userData.transformData.parentMatrixWorld=e.parent.matrixWorld);const t=Un(e.userData.transformData);e.applyMatrix4(t),e.updateWorldMatrix()}}));const a=(new Cn).parse();1===_n.children.length&&_n.children[0].isGroup&&(_n.children[0].animations=a,_n=_n.children[0]),_n.animations=a}parseModels(e,t,n){const s=new Map,o=Mn.Objects.Model;for(const i in o){const a=parseInt(i),l=o[i],c=Tn.get(a);let h=this.buildSkeleton(c,e,a,l.attrName);if(!h){switch(l.attrType){case"Camera":h=this.createCamera(c);break;case"Light":h=this.createLight(c);break;case"Mesh":h=this.createMesh(c,t,n);break;case"NurbsCurve":h=this.createCurve(c,t);break;case"LimbNode":case"Root":h=new r.Bone;break;case"Null":default:h=new r.Group}h.name=l.attrName?r.PropertyBinding.sanitizeNodeName(l.attrName):"",h.ID=a}this.getTransformData(h,l),s.set(a,h)}return s}buildSkeleton(e,t,n,s){let o=null;return e.parents.forEach((function(e){for(const i in t){const a=t[i];a.rawBones.forEach((function(t,i){if(t.ID===e.ID){const e=o;o=new r.Bone,o.matrixWorld.copy(t.transformLink),o.name=s?r.PropertyBinding.sanitizeNodeName(s):"",o.ID=n,a.bones[i]=o,null!==e&&o.add(e)}}))}})),o}createCamera(e){let t,n;if(e.children.forEach((function(e){const t=Mn.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)})),void 0===n)t=new r.Object3D;else{let e=0;void 0!==n.CameraProjectionType&&1===n.CameraProjectionType.value&&(e=1);let s=1;void 0!==n.NearPlane&&(s=n.NearPlane.value/1e3);let o=1e3;void 0!==n.FarPlane&&(o=n.FarPlane.value/1e3);let i=window.innerWidth,a=window.innerHeight;void 0!==n.AspectWidth&&void 0!==n.AspectHeight&&(i=n.AspectWidth.value,a=n.AspectHeight.value);const l=i/a;let c=45;void 0!==n.FieldOfView&&(c=n.FieldOfView.value);const h=n.FocalLength?n.FocalLength.value:null;switch(e){case 0:t=new r.PerspectiveCamera(c,l,s,o),null!==h&&t.setFocalLength(h);break;case 1:t=new r.OrthographicCamera(-i/2,i/2,a/2,-a/2,s,o);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+e+"."),t=new r.Object3D}}return t}createLight(e){let t,n;if(e.children.forEach((function(e){const t=Mn.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)})),void 0===n)t=new r.Object3D;else{let e;e=void 0===n.LightType?0:n.LightType.value;let s=16777215;void 0!==n.Color&&(s=(new r.Color).fromArray(n.Color.value));let o=void 0===n.Intensity?1:n.Intensity.value/100;void 0!==n.CastLightOnObject&&0===n.CastLightOnObject.value&&(o=0);let i=0;void 0!==n.FarAttenuationEnd&&(i=void 0!==n.EnableFarAttenuation&&0===n.EnableFarAttenuation.value?0:n.FarAttenuationEnd.value);const a=1;switch(e){case 0:t=new r.PointLight(s,o,i,a);break;case 1:t=new r.DirectionalLight(s,o);break;case 2:let e=Math.PI/3;void 0!==n.InnerAngle&&(e=r.MathUtils.degToRad(n.InnerAngle.value));let l=0;void 0!==n.OuterAngle&&(l=r.MathUtils.degToRad(n.OuterAngle.value),l=Math.max(l,1)),t=new r.SpotLight(s,o,i,e,l,a);break;default:console.warn("THREE.FBXLoader: Unknown light type "+n.LightType.value+", defaulting to a PointLight."),t=new r.PointLight(s,o)}void 0!==n.CastShadows&&1===n.CastShadows.value&&(t.castShadow=!0)}return t}createMesh(e,t,n){let s,o=null,i=null;const a=[];return e.children.forEach((function(e){t.has(e.ID)&&(o=t.get(e.ID)),n.has(e.ID)&&a.push(n.get(e.ID))})),a.length>1?i=a:a.length>0?i=a[0]:(i=new r.MeshPhongMaterial({color:13421772}),a.push(i)),"color"in o.attributes&&a.forEach((function(e){e.vertexColors=!0})),o.FBX_Deformer?(s=new r.SkinnedMesh(o,i),s.normalizeSkinWeights()):s=new r.Mesh(o,i),s}createCurve(e,t){const n=e.children.reduce((function(e,n){return t.has(n.ID)&&(e=t.get(n.ID)),e}),null),s=new r.LineBasicMaterial({color:3342591,linewidth:1});return new r.Line(n,s)}getTransformData(e,t){const n={};"InheritType"in t&&(n.inheritType=parseInt(t.InheritType.value)),n.eulerOrder="RotationOrder"in t?zn(t.RotationOrder.value):"ZYX","Lcl_Translation"in t&&(n.translation=t.Lcl_Translation.value),"PreRotation"in t&&(n.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(n.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(n.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(n.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(n.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(n.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(n.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(n.rotationPivot=t.RotationPivot.value),e.userData.transformData=n}setLookAtProperties(e,t){"LookAtProperty"in t&&Tn.get(e.ID).children.forEach((function(t){if("LookAtProperty"===t.relationship){const n=Mn.Objects.Model[t.ID];if("Lcl_Translation"in n){const t=n.Lcl_Translation.value;void 0!==e.target?(e.target.position.fromArray(t),_n.add(e.target)):e.lookAt((new r.Vector3).fromArray(t))}}}))}bindSkeleton(e,t,n){const s=this.parsePoseNodes();for(const o in e){const i=e[o];Tn.get(parseInt(i.ID)).parents.forEach((function(e){if(t.has(e.ID)){const t=e.ID;Tn.get(t).parents.forEach((function(e){n.has(e.ID)&&n.get(e.ID).bind(new r.Skeleton(i.bones),s[e.ID])}))}}))}}parsePoseNodes(){const e={};if("Pose"in Mn.Objects){const t=Mn.Objects.Pose;for(const n in t)if("BindPose"===t[n].attrType){const s=t[n].PoseNode;Array.isArray(s)?s.forEach((function(t){e[t.Node]=(new r.Matrix4).fromArray(t.Matrix.a)})):e[s.Node]=(new r.Matrix4).fromArray(s.Matrix.a)}}return e}createAmbientLight(){if("GlobalSettings"in Mn&&"AmbientColor"in Mn.GlobalSettings){const e=Mn.GlobalSettings.AmbientColor.value,t=e[0],n=e[1],s=e[2];if(0!==t||0!==n||0!==s){const e=new r.Color(t,n,s);_n.add(new r.AmbientLight(e,1))}}}setupMorphMaterials(){const e=this;_n.traverse((function(t){t.isMesh&&t.geometry.morphAttributes.position&&t.geometry.morphAttributes.position.length&&(Array.isArray(t.material)?t.material.forEach((function(n,r){e.setupMorphMaterial(t,n,r)})):e.setupMorphMaterial(t,t.material))}))}setupMorphMaterial(e,t,n){const r=e.uuid,s=t.uuid;let o=!1;if(_n.traverse((function(e){e.isMesh&&(Array.isArray(e.material)?e.material.forEach((function(t){t.uuid===s&&e.uuid!==r&&(o=!0)})):e.material.uuid===s&&e.uuid!==r&&(o=!0))})),!0===o){const r=t.clone();r.morphTargets=!0,void 0===n?e.material=r:e.material[n]=r}else t.morphTargets=!0}}class Pn{parse(e){const t=new Map;if("Geometry"in Mn.Objects){const n=Mn.Objects.Geometry;for(const r in n){const s=Tn.get(parseInt(r)),o=this.parseGeometry(s,n[r],e);t.set(parseInt(r),o)}}return t}parseGeometry(e,t,n){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,n);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,n){const r=n.skeletons,s=[],o=e.parents.map((function(e){return Mn.Objects.Model[e.ID]}));if(0===o.length)return;const i=e.children.reduce((function(e,t){return void 0!==r[t.ID]&&(e=r[t.ID]),e}),null);e.children.forEach((function(e){void 0!==n.morphTargets[e.ID]&&s.push(n.morphTargets[e.ID])}));const a=o[0],l={};"RotationOrder"in a&&(l.eulerOrder=zn(a.RotationOrder.value)),"InheritType"in a&&(l.inheritType=parseInt(a.InheritType.value)),"GeometricTranslation"in a&&(l.translation=a.GeometricTranslation.value),"GeometricRotation"in a&&(l.rotation=a.GeometricRotation.value),"GeometricScaling"in a&&(l.scale=a.GeometricScaling.value);const c=Un(l);return this.genGeometry(t,i,s,c)}genGeometry(e,t,n,s){const o=new r.BufferGeometry;e.attrName&&(o.name=e.attrName);const i=this.parseGeoNode(e,t),a=this.genBuffers(i),l=new r.Float32BufferAttribute(a.vertex,3);if(l.applyMatrix4(s),o.setAttribute("position",l),a.colors.length>0&&o.setAttribute("color",new r.Float32BufferAttribute(a.colors,3)),t&&(o.setAttribute("skinIndex",new r.Uint16BufferAttribute(a.weightsIndices,4)),o.setAttribute("skinWeight",new r.Float32BufferAttribute(a.vertexWeights,4)),o.FBX_Deformer=t),a.normal.length>0){const e=(new r.Matrix3).getNormalMatrix(s),t=new r.Float32BufferAttribute(a.normal,3);t.applyNormalMatrix(e),o.setAttribute("normal",t)}if(a.uvs.forEach((function(e,t){let n="uv"+(t+1).toString();0===t&&(n="uv"),o.setAttribute(n,new r.Float32BufferAttribute(a.uvs[t],2))})),i.material&&"AllSame"!==i.material.mappingType){let e=a.materialIndex[0],t=0;if(a.materialIndex.forEach((function(n,r){n!==e&&(o.addGroup(t,r-t,e),e=n,t=r)})),o.groups.length>0){const t=o.groups[o.groups.length-1],n=t.start+t.count;n!==a.materialIndex.length&&o.addGroup(n,a.materialIndex.length-n,e)}0===o.groups.length&&o.addGroup(0,a.materialIndex.length,a.materialIndex[0])}return this.addMorphTargets(o,e,n,s),o}parseGeoNode(e,t){const n={};if(n.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],n.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(n.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(n.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(n.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){n.uv=[];let t=0;for(;e.LayerElementUV[t];)e.LayerElementUV[t].UV&&n.uv.push(this.parseUVs(e.LayerElementUV[t])),t++}return n.weightTable={},null!==t&&(n.skeleton=t,t.rawBones.forEach((function(e,t){e.indices.forEach((function(r,s){void 0===n.weightTable[r]&&(n.weightTable[r]=[]),n.weightTable[r].push({id:t,weight:e.weights[s]})}))}))),n}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let n=0,r=0,s=!1,o=[],i=[],a=[],l=[],c=[],h=[];const u=this;return e.vertexIndices.forEach((function(d,p){let m,f=!1;d<0&&(d^=-1,f=!0);let g=[],v=[];if(o.push(3*d,3*d+1,3*d+2),e.color){const t=Bn(p,n,d,e.color);a.push(t[0],t[1],t[2])}if(e.skeleton){if(void 0!==e.weightTable[d]&&e.weightTable[d].forEach((function(e){v.push(e.weight),g.push(e.id)})),v.length>4){s||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),s=!0);const e=[0,0,0,0],t=[0,0,0,0];v.forEach((function(n,r){let s=n,o=g[r];t.forEach((function(t,n,r){if(s>t){r[n]=s,s=t;const i=e[n];e[n]=o,o=i}}))})),g=e,v=t}for(;v.length<4;)v.push(0),g.push(0);for(let e=0;e<4;++e)c.push(v[e]),h.push(g[e])}if(e.normal){const t=Bn(p,n,d,e.normal);i.push(t[0],t[1],t[2])}e.material&&"AllSame"!==e.material.mappingType&&(m=Bn(p,n,d,e.material)[0]),e.uv&&e.uv.forEach((function(e,t){const r=Bn(p,n,d,e);void 0===l[t]&&(l[t]=[]),l[t].push(r[0]),l[t].push(r[1])})),r++,f&&(u.genFace(t,e,o,m,i,a,l,c,h,r),n++,r=0,o=[],i=[],a=[],l=[],c=[],h=[])})),t}genFace(e,t,n,r,s,o,i,a,l,c){for(let h=2;h<c;h++)e.vertex.push(t.vertexPositions[n[0]]),e.vertex.push(t.vertexPositions[n[1]]),e.vertex.push(t.vertexPositions[n[2]]),e.vertex.push(t.vertexPositions[n[3*(h-1)]]),e.vertex.push(t.vertexPositions[n[3*(h-1)+1]]),e.vertex.push(t.vertexPositions[n[3*(h-1)+2]]),e.vertex.push(t.vertexPositions[n[3*h]]),e.vertex.push(t.vertexPositions[n[3*h+1]]),e.vertex.push(t.vertexPositions[n[3*h+2]]),t.skeleton&&(e.vertexWeights.push(a[0]),e.vertexWeights.push(a[1]),e.vertexWeights.push(a[2]),e.vertexWeights.push(a[3]),e.vertexWeights.push(a[4*(h-1)]),e.vertexWeights.push(a[4*(h-1)+1]),e.vertexWeights.push(a[4*(h-1)+2]),e.vertexWeights.push(a[4*(h-1)+3]),e.vertexWeights.push(a[4*h]),e.vertexWeights.push(a[4*h+1]),e.vertexWeights.push(a[4*h+2]),e.vertexWeights.push(a[4*h+3]),e.weightsIndices.push(l[0]),e.weightsIndices.push(l[1]),e.weightsIndices.push(l[2]),e.weightsIndices.push(l[3]),e.weightsIndices.push(l[4*(h-1)]),e.weightsIndices.push(l[4*(h-1)+1]),e.weightsIndices.push(l[4*(h-1)+2]),e.weightsIndices.push(l[4*(h-1)+3]),e.weightsIndices.push(l[4*h]),e.weightsIndices.push(l[4*h+1]),e.weightsIndices.push(l[4*h+2]),e.weightsIndices.push(l[4*h+3])),t.color&&(e.colors.push(o[0]),e.colors.push(o[1]),e.colors.push(o[2]),e.colors.push(o[3*(h-1)]),e.colors.push(o[3*(h-1)+1]),e.colors.push(o[3*(h-1)+2]),e.colors.push(o[3*h]),e.colors.push(o[3*h+1]),e.colors.push(o[3*h+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(r),e.materialIndex.push(r),e.materialIndex.push(r)),t.normal&&(e.normal.push(s[0]),e.normal.push(s[1]),e.normal.push(s[2]),e.normal.push(s[3*(h-1)]),e.normal.push(s[3*(h-1)+1]),e.normal.push(s[3*(h-1)+2]),e.normal.push(s[3*h]),e.normal.push(s[3*h+1]),e.normal.push(s[3*h+2])),t.uv&&t.uv.forEach((function(t,n){void 0===e.uvs[n]&&(e.uvs[n]=[]),e.uvs[n].push(i[n][0]),e.uvs[n].push(i[n][1]),e.uvs[n].push(i[n][2*(h-1)]),e.uvs[n].push(i[n][2*(h-1)+1]),e.uvs[n].push(i[n][2*h]),e.uvs[n].push(i[n][2*h+1])}))}addMorphTargets(e,t,n,r){if(0===n.length)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const s=this;n.forEach((function(n){n.rawTargets.forEach((function(n){const o=Mn.Objects.Geometry[n.geoID];void 0!==o&&s.genMorphGeometry(e,t,o,r,n.name)}))}))}genMorphGeometry(e,t,n,s,o){const i=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],a=void 0!==n.Vertices?n.Vertices.a:[],l=void 0!==n.Indexes?n.Indexes.a:[],c=3*e.attributes.position.count,h=new Float32Array(c);for(let e=0;e<l.length;e++){const t=3*l[e];h[t]=a[3*e],h[t+1]=a[3*e+1],h[t+2]=a[3*e+2]}const u={vertexIndices:i,vertexPositions:h},d=this.genBuffers(u),p=new r.Float32BufferAttribute(d.vertex,3);p.name=o||n.attrName,p.applyMatrix4(s),e.morphAttributes.position.push(p)}parseNormals(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,r=e.Normals.a;let s=[];return"IndexToDirect"===n&&("NormalIndex"in e?s=e.NormalIndex.a:"NormalsIndex"in e&&(s=e.NormalsIndex.a)),{dataSize:3,buffer:r,indices:s,mappingType:t,referenceType:n}}parseUVs(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,r=e.UV.a;let s=[];return"IndexToDirect"===n&&(s=e.UVIndex.a),{dataSize:2,buffer:r,indices:s,mappingType:t,referenceType:n}}parseVertexColors(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,r=e.Colors.a;let s=[];return"IndexToDirect"===n&&(s=e.ColorIndex.a),{dataSize:4,buffer:r,indices:s,mappingType:t,referenceType:n}}parseMaterialIndices(e){const t=e.MappingInformationType,n=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:n};const r=e.Materials.a,s=[];for(let e=0;e<r.length;++e)s.push(e);return{dataSize:1,buffer:r,indices:s,mappingType:t,referenceType:n}}parseNurbsGeometry(e){if(void 0===An)return console.error("THREE.FBXLoader: The loader relies on NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new r.BufferGeometry;const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new r.BufferGeometry;const n=t-1,s=e.KnotVector.a,o=[],i=e.Points.a;for(let e=0,t=i.length;e<t;e+=4)o.push((new r.Vector4).fromArray(i,e));let a,l;if("Closed"===e.Form)o.push(o[0]);else if("Periodic"===e.Form){a=n,l=s.length-1-a;for(let e=0;e<n;++e)o.push(o[e])}const c=new An(n,s,o,a,l).getPoints(7*o.length),h=new Float32Array(3*c.length);c.forEach((function(e,t){e.toArray(h,3*t)}));const u=new r.BufferGeometry;return u.setAttribute("position",new r.BufferAttribute(h,3)),u}}class Cn{parse(){const e=[],t=this.parseClips();if(void 0!==t)for(const n in t){const r=t[n],s=this.addClip(r);e.push(s)}return e}parseClips(){if(void 0===Mn.Objects.AnimationCurve)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=Mn.Objects.AnimationCurveNode,t=new Map;for(const n in e){const r=e[n];if(null!==r.attrName.match(/S|R|T|DeformPercent/)){const e={id:r.id,attr:r.attrName,curves:{}};t.set(e.id,e)}}return t}parseAnimationCurves(e){const t=Mn.Objects.AnimationCurve;for(const n in t){const r={id:t[n].id,times:t[n].KeyTime.a.map(On),values:t[n].KeyValueFloat.a},s=Tn.get(r.id);if(void 0!==s){const t=s.parents[0].ID,n=s.parents[0].relationship;n.match(/X/)?e.get(t).curves.x=r:n.match(/Y/)?e.get(t).curves.y=r:n.match(/Z/)?e.get(t).curves.z=r:n.match(/d|DeformPercent/)&&e.has(t)&&(e.get(t).curves.morph=r)}}}parseAnimationLayers(e){const t=Mn.Objects.AnimationLayer,n=new Map;for(const s in t){const t=[],o=Tn.get(parseInt(s));void 0!==o&&(o.children.forEach((function(n,s){if(e.has(n.ID)){const o=e.get(n.ID);if(void 0!==o.curves.x||void 0!==o.curves.y||void 0!==o.curves.z){if(void 0===t[s]){const e=Tn.get(n.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID;if(void 0!==e){const o=Mn.Objects.Model[e.toString()];if(void 0===o)return void console.warn("THREE.FBXLoader: Encountered a unused curve.",n);const i={modelName:o.attrName?r.PropertyBinding.sanitizeNodeName(o.attrName):"",ID:o.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};_n.traverse((function(e){e.ID===o.id&&(i.transform=e.matrix,e.userData.transformData&&(i.eulerOrder=e.userData.transformData.eulerOrder))})),i.transform||(i.transform=new r.Matrix4),"PreRotation"in o&&(i.preRotation=o.PreRotation.value),"PostRotation"in o&&(i.postRotation=o.PostRotation.value),t[s]=i}}t[s]&&(t[s][o.attr]=o)}else if(void 0!==o.curves.morph){if(void 0===t[s]){const e=Tn.get(n.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID,o=Tn.get(e).parents[0].ID,i=Tn.get(o).parents[0].ID,a=Tn.get(i).parents[0].ID,l=Mn.Objects.Model[a],c={modelName:l.attrName?r.PropertyBinding.sanitizeNodeName(l.attrName):"",morphName:Mn.Objects.Deformer[e].attrName};t[s]=c}t[s][o.attr]=o}}})),n.set(parseInt(s),t))}return n}parseAnimStacks(e){const t=Mn.Objects.AnimationStack,n={};for(const r in t){const s=Tn.get(parseInt(r)).children;s.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const o=e.get(s[0].ID);n[r]={name:t[r].attrName,layer:o}}return n}addClip(e){let t=[];const n=this;return e.layer.forEach((function(e){t=t.concat(n.generateTracks(e))})),new r.AnimationClip(e.name,-1,t)}generateTracks(e){const t=[];let n=new r.Vector3,s=new r.Quaternion,o=new r.Vector3;if(e.transform&&e.transform.decompose(n,s,o),n=n.toArray(),s=(new r.Euler).setFromQuaternion(s,e.eulerOrder).toArray(),o=o.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){const r=this.generateVectorTrack(e.modelName,e.T.curves,n,"position");void 0!==r&&t.push(r)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){const n=this.generateRotationTrack(e.modelName,e.R.curves,s,e.preRotation,e.postRotation,e.eulerOrder);void 0!==n&&t.push(n)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){const n=this.generateVectorTrack(e.modelName,e.S.curves,o,"scale");void 0!==n&&t.push(n)}if(void 0!==e.DeformPercent){const n=this.generateMorphTrack(e);void 0!==n&&t.push(n)}return t}generateVectorTrack(e,t,n,s){const o=this.getTimesForAllAxes(t),i=this.getKeyframeTrackValues(o,t,n);return new r.VectorKeyframeTrack(e+"."+s,o,i)}generateRotationTrack(e,t,n,s,o,i){void 0!==t.x&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(r.MathUtils.degToRad)),void 0!==t.y&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(r.MathUtils.degToRad)),void 0!==t.z&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(r.MathUtils.degToRad));const a=this.getTimesForAllAxes(t),l=this.getKeyframeTrackValues(a,t,n);void 0!==s&&((s=s.map(r.MathUtils.degToRad)).push(i),s=(new r.Euler).fromArray(s),s=(new r.Quaternion).setFromEuler(s)),void 0!==o&&((o=o.map(r.MathUtils.degToRad)).push(i),o=(new r.Euler).fromArray(o),o=(new r.Quaternion).setFromEuler(o).invert());const c=new r.Quaternion,h=new r.Euler,u=[];for(let e=0;e<l.length;e+=3)h.set(l[e],l[e+1],l[e+2],i),c.setFromEuler(h),void 0!==s&&c.premultiply(s),void 0!==o&&c.multiply(o),c.toArray(u,e/3*4);return new r.QuaternionKeyframeTrack(e+".quaternion",a,u)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,n=t.values.map((function(e){return e/100})),s=_n.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new r.NumberKeyframeTrack(e.modelName+".morphTargetInfluences["+s+"]",t.times,n)}getTimesForAllAxes(e){let t=[];if(void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort((function(e,t){return e-t})),t.length>1){let e=1,n=t[0];for(let r=1;r<t.length;r++){const s=t[r];s!==n&&(t[e]=s,n=s,e++)}t=t.slice(0,e)}return t}getKeyframeTrackValues(e,t,n){const r=n,s=[];let o=-1,i=-1,a=-1;return e.forEach((function(e){if(t.x&&(o=t.x.times.indexOf(e)),t.y&&(i=t.y.times.indexOf(e)),t.z&&(a=t.z.times.indexOf(e)),-1!==o){const e=t.x.values[o];s.push(e),r[0]=e}else s.push(r[0]);if(-1!==i){const e=t.y.values[i];s.push(e),r[1]=e}else s.push(r[1]);if(-1!==a){const e=t.z.values[a];s.push(e),r[2]=e}else s.push(r[2])})),s}interpolateRotations(e){for(let t=1;t<e.values.length;t++){const n=e.values[t-1],r=e.values[t]-n,s=Math.abs(r);if(s>=180){const o=s/180,i=r/o;let a=n+i;const l=e.times[t-1],c=(e.times[t]-l)/o;let h=l+c;const u=[],d=[];for(;h<e.times[t];)u.push(h),h+=c,d.push(a),a+=i;e.times=Gn(e.times,t,u),e.values=Gn(e.values,t,d)}}}}class Rn{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new kn,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,n=e.split(/[\r\n]+/);return n.forEach((function(e,r){const s=e.match(/^[\s\t]*;/),o=e.match(/^[\s\t]*$/);if(s||o)return;const i=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),a=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=e.match("^\\t{"+(t.currentIndent-1)+"}}");i?t.parseNodeBegin(e,i):a?t.parseNodeProperty(e,a,n[++r]):l?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)})),this.allNodes}parseNodeBegin(e,t){const n=t[1].trim().replace(/^"/,"").replace(/"$/,""),r=t[2].split(",").map((function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")})),s={name:n},o=this.parseNodeAttr(r),i=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(n,s):n in i?("PoseNode"===n?i.PoseNode.push(s):void 0!==i[n].id&&(i[n]={},i[n][i[n].id]=i[n]),""!==o.id&&(i[n][o.id]=s)):"number"==typeof o.id?(i[n]={},i[n][o.id]=s):"Properties70"!==n&&(i[n]="PoseNode"===n?[s]:s),"number"==typeof o.id&&(s.id=o.id),""!==o.name&&(s.attrName=o.name),""!==o.type&&(s.attrType=o.type),this.pushStack(s)}parseNodeAttr(e){let t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let n="",r="";return e.length>1&&(n=e[1].replace(/^(\w+)::/,""),r=e[2]),{id:t,name:n,type:r}}parseNodeProperty(e,t,n){let r=t[1].replace(/^"/,"").replace(/"$/,"").trim(),s=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===r&&","===s&&(s=n.replace(/"/g,"").replace(/,$/,"").trim());const o=this.getCurrentNode();if("Properties70"!==o.name){if("C"===r){const e=s.split(",").slice(1),t=parseInt(e[0]),n=parseInt(e[1]);let i=s.split(",").slice(3);i=i.map((function(e){return e.trim().replace(/^"/,"")})),r="connections",s=[t,n],function(e,t){for(let n=0,r=e.length,s=t.length;n<s;n++,r++)e[r]=t[n]}(s,i),void 0===o[r]&&(o[r]=[])}"Node"===r&&(o.id=s),r in o&&Array.isArray(o[r])?o[r].push(s):"a"!==r?o[r]=s:o.a=s,this.setCurrentProp(o,r),"a"===r&&","!==s.slice(-1)&&(o.a=jn(s))}else this.parseNodeSpecialProperty(e,r,s)}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=jn(t.a))}parseNodeSpecialProperty(e,t,n){const r=n.split('",').map((function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")})),s=r[0],o=r[1],i=r[2],a=r[3];let l=r[4];switch(o){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=jn(l)}this.getPrevNode()[s]={type:o,type2:i,flag:a,value:l},this.setCurrentProp(this.getPrevNode(),s)}}class Ln{parse(e){const t=new Vn(e);t.skip(23);const n=t.getUint32();if(n<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+n);const r=new kn;for(;!this.endOfContent(t);){const e=this.parseNode(t,n);null!==e&&r.add(e.name,e)}return r}endOfContent(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const n={},r=t>=7500?e.getUint64():e.getUint32(),s=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const o=e.getUint8(),i=e.getString(o);if(0===r)return null;const a=[];for(let t=0;t<s;t++)a.push(this.parseProperty(e));const l=a.length>0?a[0]:"",c=a.length>1?a[1]:"",h=a.length>2?a[2]:"";for(n.singleProperty=1===s&&e.getOffset()===r;r>e.getOffset();){const r=this.parseNode(e,t);null!==r&&this.parseSubNode(i,n,r)}return n.propertyList=a,"number"==typeof l&&(n.id=l),""!==c&&(n.attrName=c),""!==h&&(n.attrType=h),""!==i&&(n.name=i),n}parseSubNode(e,t,n){if(!0===n.singleProperty){const e=n.propertyList[0];Array.isArray(e)?(t[n.name]=n,n.a=e):t[n.name]=e}else if("Connections"===e&&"C"===n.name){const e=[];n.propertyList.forEach((function(t,n){0!==n&&e.push(t)})),void 0===t.connections&&(t.connections=[]),t.connections.push(e)}else if("Properties70"===n.name)Object.keys(n).forEach((function(e){t[e]=n[e]}));else if("Properties70"===e&&"P"===n.name){let e=n.propertyList[0],r=n.propertyList[1];const s=n.propertyList[2],o=n.propertyList[3];let i;0===e.indexOf("Lcl ")&&(e=e.replace("Lcl ","Lcl_")),0===r.indexOf("Lcl ")&&(r=r.replace("Lcl ","Lcl_")),i="Color"===r||"ColorRGB"===r||"Vector"===r||"Vector3D"===r||0===r.indexOf("Lcl_")?[n.propertyList[4],n.propertyList[5],n.propertyList[6]]:n.propertyList[4],t[e]={type:r,type2:s,flag:o,value:i}}else void 0===t[n.name]?"number"==typeof n.id?(t[n.name]={},t[n.name][n.id]=n):t[n.name]=n:"PoseNode"===n.name?(Array.isArray(t[n.name])||(t[n.name]=[t[n.name]]),t[n.name].push(n)):void 0===t[n.name][n.id]&&(t[n.name][n.id]=n)}parseProperty(t){const n=t.getString(1);let r;switch(n){case"C":return t.getBoolean();case"D":return t.getFloat64();case"F":return t.getFloat32();case"I":return t.getInt32();case"L":return t.getInt64();case"R":return r=t.getUint32(),t.getArrayBuffer(r);case"S":return r=t.getUint32(),t.getString(r);case"Y":return t.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const s=t.getUint32(),o=t.getUint32(),i=t.getUint32();if(0===o)switch(n){case"b":case"c":return t.getBooleanArray(s);case"d":return t.getFloat64Array(s);case"f":return t.getFloat32Array(s);case"i":return t.getInt32Array(s);case"l":return t.getInt64Array(s)}void 0===e&&console.error("THREE.FBXLoader: External library fflate.min.js required.");const a=zt(new Uint8Array(t.getArrayBuffer(i))),l=new Vn(a.buffer);switch(n){case"b":case"c":return l.getBooleanArray(s);case"d":return l.getFloat64Array(s);case"f":return l.getFloat32Array(s);case"i":return l.getInt32Array(s);case"l":return l.getInt64Array(s)}default:throw new Error("THREE.FBXLoader: Unknown property type "+n)}}}class Vn{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return 1==(1&this.getUint8())}getBooleanArray(e){const t=[];for(let n=0;n<e;n++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,e=4294967295&~e,4294967295===e&&(t=t+1&4294967295),e=e+1&4294967295,-(4294967296*t+e)):4294967296*t+e}getInt64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){let t=[];for(let n=0;n<e;n++)t[n]=this.getUint8();const n=t.indexOf(0);return n>=0&&(t=t.slice(0,n)),r.LoaderUtils.decodeText(new Uint8Array(t))}}class kn{add(e,t){this[e]=t}}function In(e){const t=e.match(/FBXVersion: (\d+)/);if(t)return parseInt(t[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function On(e){return e/46186158e3}const Nn=[];function Bn(e,t,n,r){let s;switch(r.mappingType){case"ByPolygonVertex":s=e;break;case"ByPolygon":s=t;break;case"ByVertice":s=n;break;case"AllSame":s=r.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+r.mappingType)}"IndexToDirect"===r.referenceType&&(s=r.indices[s]);const o=s*r.dataSize,i=o+r.dataSize;return function(e,t,n,r){for(let s=n,o=0;s<r;s++,o++)e[o]=t[s];return e}(Nn,r.buffer,o,i)}const Dn=new r.Euler,Fn=new r.Vector3;function Un(e){const t=new r.Matrix4,n=new r.Matrix4,s=new r.Matrix4,o=new r.Matrix4,i=new r.Matrix4,a=new r.Matrix4,l=new r.Matrix4,c=new r.Matrix4,h=new r.Matrix4,u=new r.Matrix4,d=new r.Matrix4,p=new r.Matrix4,m=e.inheritType?e.inheritType:0;if(e.translation&&t.setPosition(Fn.fromArray(e.translation)),e.preRotation){const t=e.preRotation.map(r.MathUtils.degToRad);t.push(e.eulerOrder),n.makeRotationFromEuler(Dn.fromArray(t))}if(e.rotation){const t=e.rotation.map(r.MathUtils.degToRad);t.push(e.eulerOrder),s.makeRotationFromEuler(Dn.fromArray(t))}if(e.postRotation){const t=e.postRotation.map(r.MathUtils.degToRad);t.push(e.eulerOrder),o.makeRotationFromEuler(Dn.fromArray(t)),o.invert()}e.scale&&i.scale(Fn.fromArray(e.scale)),e.scalingOffset&&l.setPosition(Fn.fromArray(e.scalingOffset)),e.scalingPivot&&a.setPosition(Fn.fromArray(e.scalingPivot)),e.rotationOffset&&c.setPosition(Fn.fromArray(e.rotationOffset)),e.rotationPivot&&h.setPosition(Fn.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(d.copy(e.parentMatrix),u.copy(e.parentMatrixWorld));const f=n.clone().multiply(s).multiply(o),g=new r.Matrix4;g.extractRotation(u);const v=new r.Matrix4;v.copyPosition(u);const y=v.clone().invert().multiply(u),x=g.clone().invert().multiply(y),b=i,w=new r.Matrix4;if(0===m)w.copy(g).multiply(f).multiply(x).multiply(b);else if(1===m)w.copy(g).multiply(x).multiply(f).multiply(b);else{const e=(new r.Matrix4).scale((new r.Vector3).setFromMatrixScale(d)).clone().invert(),t=x.clone().multiply(e);w.copy(g).multiply(f).multiply(t).multiply(b)}const A=h.clone().invert(),M=a.clone().invert();let T=t.clone().multiply(c).multiply(h).multiply(n).multiply(s).multiply(o).multiply(A).multiply(l).multiply(a).multiply(i).multiply(M);const _=(new r.Matrix4).copyPosition(T),S=u.clone().multiply(_);return p.copyPosition(S),T=p.clone().multiply(w),T.premultiply(u.invert()),T}function zn(e){const t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function jn(e){return e.split(",").map((function(e){return parseFloat(e)}))}function Hn(e,t,n){return void 0===t&&(t=0),void 0===n&&(n=e.byteLength),r.LoaderUtils.decodeText(new Uint8Array(e,t,n))}function Gn(e,t,n){return e.slice(0,t).concat(n).concat(e.slice(t))}class Wn extends r.Loader{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new $n(e)})),this.register((function(e){return new Zn(e)})),this.register((function(e){return new Jn(e)})),this.register((function(e){return new Qn(e)})),this.register((function(e){return new Yn(e)})),this.register((function(e){return new er(e)}))}load(e,t,n,s){const o=this;let i;i=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:r.LoaderUtils.extractUrlBase(e),this.manager.itemStart(e);const a=function(t){s?s(t):console.error(t),o.manager.itemError(e),o.manager.itemEnd(e)},l=new r.FileLoader(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,(function(n){try{o.parse(n,i,(function(n){t(n),o.manager.itemEnd(e)}),a)}catch(e){a(e)}}),n,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,s){let o;const i={},a={};if("string"==typeof e)o=e;else if(r.LoaderUtils.decodeText(new Uint8Array(e,0,4))===tr){try{i[qn.KHR_BINARY_GLTF]=new nr(e)}catch(e){return void(s&&s(e))}o=i[qn.KHR_BINARY_GLTF].content}else o=r.LoaderUtils.decodeText(new Uint8Array(e));const l=JSON.parse(o);if(void 0===l.asset||l.asset.version[0]<2)return void(s&&s(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const c=new Mr(l,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](c);a[t.name]=t,i[t.name]=!0}if(l.extensionsUsed)for(let e=0;e<l.extensionsUsed.length;++e){const t=l.extensionsUsed[e],n=l.extensionsRequired||[];switch(t){case qn.KHR_MATERIALS_UNLIT:i[t]=new Kn;break;case qn.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:i[t]=new ir;break;case qn.KHR_DRACO_MESH_COMPRESSION:i[t]=new rr(l,this.dracoLoader);break;case qn.KHR_TEXTURE_TRANSFORM:i[t]=new sr;break;case qn.KHR_MESH_QUANTIZATION:i[t]=new ar;break;default:n.indexOf(t)>=0&&void 0===a[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}c.setExtensions(i),c.setPlugins(a),c.parse(n,s)}}function Xn(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const qn={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};class Yn{constructor(e){this.parser=e,this.name=qn.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let n=0,r=t.length;n<r;n++){const r=t[n];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){const t=this.parser,n="light:"+e;let s=t.cache.get(n);if(s)return s;const o=t.json,i=((o.extensions&&o.extensions[this.name]||{}).lights||[])[e];let a;const l=new r.Color(16777215);void 0!==i.color&&l.fromArray(i.color);const c=void 0!==i.range?i.range:0;switch(i.type){case"directional":a=new r.DirectionalLight(l),a.target.position.set(0,0,-1),a.add(a.target);break;case"point":a=new r.PointLight(l),a.distance=c;break;case"spot":a=new r.SpotLight(l),a.distance=c,i.spot=i.spot||{},i.spot.innerConeAngle=void 0!==i.spot.innerConeAngle?i.spot.innerConeAngle:0,i.spot.outerConeAngle=void 0!==i.spot.outerConeAngle?i.spot.outerConeAngle:Math.PI/4,a.angle=i.spot.outerConeAngle,a.penumbra=1-i.spot.innerConeAngle/i.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+i.type)}return a.position.set(0,0,0),a.decay=2,void 0!==i.intensity&&(a.intensity=i.intensity),a.name=t.createUniqueName(i.name||"light_"+e),s=Promise.resolve(a),t.cache.add(n,s),s}createNodeAttachment(e){const t=this,n=this.parser,r=n.json.nodes[e],s=(r.extensions&&r.extensions[this.name]||{}).light;return void 0===s?null:this._loadLight(s).then((function(e){return n._getNodeRef(t.cache,s,e)}))}}class Kn{constructor(){this.name=qn.KHR_MATERIALS_UNLIT}getMaterialType(){return r.MeshBasicMaterial}extendParams(e,t,n){const s=[];e.color=new r.Color(1,1,1),e.opacity=1;const o=t.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){const t=o.baseColorFactor;e.color.fromArray(t),e.opacity=t[3]}void 0!==o.baseColorTexture&&s.push(n.assignTexture(e,"map",o.baseColorTexture))}return Promise.all(s)}}class $n{constructor(e){this.parser=e,this.name=qn.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const o=[],i=s.extensions[this.name];if(void 0!==i.clearcoatFactor&&(t.clearcoat=i.clearcoatFactor),void 0!==i.clearcoatTexture&&o.push(n.assignTexture(t,"clearcoatMap",i.clearcoatTexture)),void 0!==i.clearcoatRoughnessFactor&&(t.clearcoatRoughness=i.clearcoatRoughnessFactor),void 0!==i.clearcoatRoughnessTexture&&o.push(n.assignTexture(t,"clearcoatRoughnessMap",i.clearcoatRoughnessTexture)),void 0!==i.clearcoatNormalTexture&&(o.push(n.assignTexture(t,"clearcoatNormalMap",i.clearcoatNormalTexture)),void 0!==i.clearcoatNormalTexture.scale)){const e=i.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new r.Vector2(e,-e)}return Promise.all(o)}}class Qn{constructor(e){this.parser=e,this.name=qn.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const s=[],o=r.extensions[this.name];return void 0!==o.transmissionFactor&&(t.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&s.push(n.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(s)}}class Zn{constructor(e){this.parser=e,this.name=qn.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,n=t.json,r=n.textures[e];if(!r.extensions||!r.extensions[this.name])return null;const s=r.extensions[this.name],o=n.images[s.source],i=t.options.ktx2Loader;if(!i){if(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,o,i)}}class Jn{constructor(e){this.parser=e,this.name=qn.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,r=n.json,s=r.textures[e];if(!s.extensions||!s.extensions[t])return null;const o=s.extensions[t],i=r.images[o.source];let a=n.textureLoader;if(i.uri){const e=n.options.manager.getHandler(i.uri);null!==e&&(a=e)}return this.detectSupport().then((function(s){if(s)return n.loadTextureImage(e,i,a);if(r.extensionsRequired&&r.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return n.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class er{constructor(e){this.name=qn.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,n=t.bufferViews[e];if(n.extensions&&n.extensions[this.name]){const e=n.extensions[this.name],r=this.parser.getDependency("buffer",e.buffer),s=this.parser.options.meshoptDecoder;if(!s||!s.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([r,s.ready]).then((function(t){const n=e.byteOffset||0,r=e.byteLength||0,o=e.count,i=e.byteStride,a=new ArrayBuffer(o*i),l=new Uint8Array(t[0],n,r);return s.decodeGltfBuffer(new Uint8Array(a),o,i,l,e.mode,e.filter),a}))}return null}}const tr="glTF";class nr{constructor(e){this.name=qn.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12);if(this.header={magic:r.LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==tr)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-12,s=new DataView(e,12);let o=0;for(;o<n;){const t=s.getUint32(o,!0);o+=4;const n=s.getUint32(o,!0);if(o+=4,1313821514===n){const n=new Uint8Array(e,12+o,t);this.content=r.LoaderUtils.decodeText(n)}else if(5130562===n){const n=12+o;this.body=e.slice(n,n+t)}o+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class rr{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=qn.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const n=this.json,r=this.dracoLoader,s=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,i={},a={},l={};for(const e in o){const t=pr[e]||e.toLowerCase();i[t]=o[e]}for(const t in e.attributes){const r=pr[t]||t.toLowerCase();if(void 0!==o[t]){const s=n.accessors[e.attributes[t]],o=cr[s.componentType];l[r]=o,a[r]=!0===s.normalized}}return t.getDependency("bufferView",s).then((function(e){return new Promise((function(t){r.decodeDracoFile(e,(function(e){for(const t in e.attributes){const n=e.attributes[t],r=a[t];void 0!==r&&(n.normalized=r)}t(e)}),i,l)}))}))}}class sr{constructor(){this.name=qn.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class or extends r.MeshStandardMaterial{constructor(e){super(),this.isGLTFSpecularGlossinessMaterial=!0;const t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),n=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),s=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),o=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),i=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),a={specular:{value:(new r.Color).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=a,this.onBeforeCompile=function(e){for(const t in a)e.uniforms[t]=a[t];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",t).replace("#include <metalnessmap_pars_fragment>",n).replace("#include <roughnessmap_fragment>",s).replace("#include <metalnessmap_fragment>",o).replace("#include <lights_physical_fragment>",i)},Object.defineProperties(this,{specular:{get:function(){return a.specular.value},set:function(e){a.specular.value=e}},specularMap:{get:function(){return a.specularMap.value},set:function(e){a.specularMap.value=e,e?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return a.glossiness.value},set:function(e){a.glossiness.value=e}},glossinessMap:{get:function(){return a.glossinessMap.value},set:function(e){a.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}copy(e){return super.copy(e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}class ir{constructor(){this.name=qn.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"]}getMaterialType(){return or}extendParams(e,t,n){const s=t.extensions[this.name];e.color=new r.Color(1,1,1),e.opacity=1;const o=[];if(Array.isArray(s.diffuseFactor)){const t=s.diffuseFactor;e.color.fromArray(t),e.opacity=t[3]}if(void 0!==s.diffuseTexture&&o.push(n.assignTexture(e,"map",s.diffuseTexture)),e.emissive=new r.Color(0,0,0),e.glossiness=void 0!==s.glossinessFactor?s.glossinessFactor:1,e.specular=new r.Color(1,1,1),Array.isArray(s.specularFactor)&&e.specular.fromArray(s.specularFactor),void 0!==s.specularGlossinessTexture){const t=s.specularGlossinessTexture;o.push(n.assignTexture(e,"glossinessMap",t)),o.push(n.assignTexture(e,"specularMap",t))}return Promise.all(o)}createMaterial(e){const t=new or(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=r.TangentSpaceNormalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}class ar{constructor(){this.name=qn.KHR_MESH_QUANTIZATION}}class lr extends r.Interpolant{constructor(e,t,n,r){super(e,t,n,r)}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,r=this.valueSize,s=e*r*3+r;for(let e=0;e!==r;e++)t[e]=n[s+e];return t}}lr.prototype.beforeStart_=lr.prototype.copySampleValue_,lr.prototype.afterEnd_=lr.prototype.copySampleValue_,lr.prototype.interpolate_=function(e,t,n,r){const s=this.resultBuffer,o=this.sampleValues,i=this.valueSize,a=2*i,l=3*i,c=r-t,h=(n-t)/c,u=h*h,d=u*h,p=e*l,m=p-l,f=-2*d+3*u,g=d-u,v=1-f,y=g-u+h;for(let e=0;e!==i;e++){const t=o[m+e+i],n=o[m+e+a]*c,r=o[p+e+i],l=o[p+e]*c;s[e]=v*t+y*n+f*r+g*l}return s};const cr={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},hr={9728:r.NearestFilter,9729:r.LinearFilter,9984:r.NearestMipmapNearestFilter,9985:r.LinearMipmapNearestFilter,9986:r.NearestMipmapLinearFilter,9987:r.LinearMipmapLinearFilter},ur={33071:r.ClampToEdgeWrapping,33648:r.MirroredRepeatWrapping,10497:r.RepeatWrapping},dr={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},pr={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},mr={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},fr={CUBICSPLINE:void 0,LINEAR:r.InterpolateLinear,STEP:r.InterpolateDiscrete};function gr(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function vr(e,t,n){for(const r in n.extensions)void 0===e[r]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[r]=n.extensions[r])}function yr(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function xr(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,r=t.weights.length;n<r;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){const n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,r=n.length;t<r;t++)e.morphTargetDictionary[n[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function br(e){const t=e.extensions&&e.extensions[qn.KHR_DRACO_MESH_COMPRESSION];let n;return n=t?"draco:"+t.bufferView+":"+t.indices+":"+wr(t.attributes):e.indices+":"+wr(e.attributes)+":"+e.mode,n}function wr(e){let t="";const n=Object.keys(e).sort();for(let r=0,s=n.length;r<s;r++)t+=n[r]+":"+e[n[r]]+";";return t}function Ar(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}class Mr{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Xn,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.textureCache={},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new r.ImageBitmapLoader(this.options.manager):this.textureLoader=new r.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new r.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const n=this,r=this.json,s=this.extensions;this.cache.removeAll(),this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])})).then((function(t){const o={scene:t[0][r.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:r.asset,parser:n,userData:{}};vr(s,o,r),yr(o,r),Promise.all(n._invokeAll((function(e){return e.afterRoot&&e.afterRoot(o)}))).then((function(){e(o)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let n=0,r=t.length;n<r;n++){const r=t[n].joints;for(let t=0,n=r.length;t<n;t++)e[r[t]].isBone=!0}for(let t=0,r=e.length;t<r;t++){const r=e[t];void 0!==r.mesh&&(this._addNodeRef(this.meshCache,r.mesh),void 0!==r.skin&&(n[r.mesh].isSkinnedMesh=!0)),void 0!==r.camera&&this._addNodeRef(this.cameraCache,r.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;const r=n.clone();return r.name+="_instance_"+e.uses[t]++,r}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){const r=e(t[n]);if(r)return r}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const n=[];for(let r=0;r<t.length;r++){const s=e(t[r]);s&&n.push(s)}return n}getDependency(e,t){const n=e+":"+t;let r=this.cache.get(n);if(!r){switch(e){case"scene":r=this.loadScene(t);break;case"node":r=this.loadNode(t);break;case"mesh":r=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":r=this.loadAccessor(t);break;case"bufferView":r=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":r=this.loadBuffer(t);break;case"material":r=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":r=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":r=this.loadSkin(t);break;case"animation":r=this.loadAnimation(t);break;case"camera":r=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(n,r)}return r}getDependencies(e){let t=this.cache.get(e);if(!t){const n=this,r=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(r.map((function(t,r){return n.getDependency(e,r)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[qn.KHR_BINARY_GLTF].body);const r=this.options;return new Promise((function(e,s){n.load(gr(t.uri,r.path),e,void 0,(function(){s(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const n=t.byteLength||0,r=t.byteOffset||0;return e.slice(r,r+n)}))}loadAccessor(e){const t=this,n=this.json,s=this.json.accessors[e];if(void 0===s.bufferView&&void 0===s.sparse)return Promise.resolve(null);const o=[];return void 0!==s.bufferView?o.push(this.getDependency("bufferView",s.bufferView)):o.push(null),void 0!==s.sparse&&(o.push(this.getDependency("bufferView",s.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",s.sparse.values.bufferView))),Promise.all(o).then((function(e){const o=e[0],i=dr[s.type],a=cr[s.componentType],l=a.BYTES_PER_ELEMENT,c=l*i,h=s.byteOffset||0,u=void 0!==s.bufferView?n.bufferViews[s.bufferView].byteStride:void 0,d=!0===s.normalized;let p,m;if(u&&u!==c){const e=Math.floor(h/u),n="InterleavedBuffer:"+s.bufferView+":"+s.componentType+":"+e+":"+s.count;let c=t.cache.get(n);c||(p=new a(o,e*u,s.count*u/l),c=new r.InterleavedBuffer(p,u/l),t.cache.add(n,c)),m=new r.InterleavedBufferAttribute(c,i,h%u/l,d)}else p=null===o?new a(s.count*i):new a(o,h,s.count*i),m=new r.BufferAttribute(p,i,d);if(void 0!==s.sparse){const t=dr.SCALAR,n=cr[s.sparse.indices.componentType],l=s.sparse.indices.byteOffset||0,c=s.sparse.values.byteOffset||0,h=new n(e[1],l,s.sparse.count*t),u=new a(e[2],c,s.sparse.count*i);null!==o&&(m=new r.BufferAttribute(m.array.slice(),m.itemSize,m.normalized));for(let e=0,t=h.length;e<t;e++){const t=h[e];if(m.setX(t,u[e*i]),i>=2&&m.setY(t,u[e*i+1]),i>=3&&m.setZ(t,u[e*i+2]),i>=4&&m.setW(t,u[e*i+3]),i>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return m}))}loadTexture(e){const t=this.json,n=this.options,r=t.textures[e],s=t.images[r.source];let o=this.textureLoader;if(s.uri){const e=n.manager.getHandler(s.uri);null!==e&&(o=e)}return this.loadTextureImage(e,s,o)}loadTextureImage(e,t,n){const s=this,o=this.json,i=this.options,a=o.textures[e],l=(t.uri||t.bufferView)+":"+a.sampler;if(this.textureCache[l])return this.textureCache[l];const c=self.URL||self.webkitURL;let h=t.uri||"",u=!1,d=!0;const p=h.search(/\.jpe?g($|\?)/i)>0||0===h.search(/^data\:image\/jpeg/);if(("image/jpeg"===t.mimeType||p)&&(d=!1),void 0!==t.bufferView)h=s.getDependency("bufferView",t.bufferView).then((function(e){if("image/png"===t.mimeType){const t=new DataView(e,25,1).getUint8(0,!1);d=6===t||4===t||3===t}u=!0;const n=new Blob([e],{type:t.mimeType});return h=c.createObjectURL(n),h}));else if(void 0===t.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const m=Promise.resolve(h).then((function(e){return new Promise((function(t,s){let o=t;!0===n.isImageBitmapLoader&&(o=function(e){const n=new r.Texture(e);n.needsUpdate=!0,t(n)}),n.load(gr(e,i.path),o,void 0,s)}))})).then((function(t){!0===u&&c.revokeObjectURL(h),t.flipY=!1,a.name&&(t.name=a.name),d||(t.format=r.RGBFormat);const n=(o.samplers||{})[a.sampler]||{};return t.magFilter=hr[n.magFilter]||r.LinearFilter,t.minFilter=hr[n.minFilter]||r.LinearMipmapLinearFilter,t.wrapS=ur[n.wrapS]||r.RepeatWrapping,t.wrapT=ur[n.wrapT]||r.RepeatWrapping,s.associations.set(t,{type:"textures",index:e}),t})).catch((function(){return console.error("THREE.GLTFLoader: Couldn't load texture",h),null}));return this.textureCache[l]=m,m}assignTexture(e,t,n){const r=this;return this.getDependency("texture",n.index).then((function(s){if(void 0===n.texCoord||0==n.texCoord||"aoMap"===t&&1==n.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+n.texCoord+" for texture "+t+" not yet supported."),r.extensions[qn.KHR_TEXTURE_TRANSFORM]){const e=void 0!==n.extensions?n.extensions[qn.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=r.associations.get(s);s=r.extensions[qn.KHR_TEXTURE_TRANSFORM].extendTexture(s,e),r.associations.set(s,t)}}e[t]=s}))}assignFinalMaterial(e){const t=e.geometry;let n=e.material;const s=void 0!==t.attributes.tangent,o=void 0!==t.attributes.color,i=void 0===t.attributes.normal,a=Object.keys(t.morphAttributes).length>0,l=a&&void 0!==t.morphAttributes.normal;if(e.isPoints){const e="PointsMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new r.PointsMaterial,r.Material.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,t.sizeAttenuation=!1,this.cache.add(e,t)),n=t}else if(e.isLine){const e="LineBasicMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new r.LineBasicMaterial,r.Material.prototype.copy.call(t,n),t.color.copy(n.color),this.cache.add(e,t)),n=t}if(s||o||i||a){let e="ClonedMaterial:"+n.uuid+":";n.isGLTFSpecularGlossinessMaterial&&(e+="specular-glossiness:"),s&&(e+="vertex-tangents:"),o&&(e+="vertex-colors:"),i&&(e+="flat-shading:"),a&&(e+="morph-targets:"),l&&(e+="morph-normals:");let t=this.cache.get(e);t||(t=n.clone(),o&&(t.vertexColors=!0),i&&(t.flatShading=!0),a&&(t.morphTargets=!0),l&&(t.morphNormals=!0),s&&(t.vertexTangents=!0,t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(n))),n=t}n.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),e.material=n}getMaterialType(){return r.MeshStandardMaterial}loadMaterial(e){const t=this,n=this.json,s=this.extensions,o=n.materials[e];let i;const a={},l=o.extensions||{},c=[];if(l[qn.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){const e=s[qn.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];i=e.getMaterialType(),c.push(e.extendParams(a,o,t))}else if(l[qn.KHR_MATERIALS_UNLIT]){const e=s[qn.KHR_MATERIALS_UNLIT];i=e.getMaterialType(),c.push(e.extendParams(a,o,t))}else{const n=o.pbrMetallicRoughness||{};if(a.color=new r.Color(1,1,1),a.opacity=1,Array.isArray(n.baseColorFactor)){const e=n.baseColorFactor;a.color.fromArray(e),a.opacity=e[3]}void 0!==n.baseColorTexture&&c.push(t.assignTexture(a,"map",n.baseColorTexture)),a.metalness=void 0!==n.metallicFactor?n.metallicFactor:1,a.roughness=void 0!==n.roughnessFactor?n.roughnessFactor:1,void 0!==n.metallicRoughnessTexture&&(c.push(t.assignTexture(a,"metalnessMap",n.metallicRoughnessTexture)),c.push(t.assignTexture(a,"roughnessMap",n.metallicRoughnessTexture))),i=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),c.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,a)}))))}!0===o.doubleSided&&(a.side=r.DoubleSide);const h=o.alphaMode||"OPAQUE";return"BLEND"===h?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,"MASK"===h&&(a.alphaTest=void 0!==o.alphaCutoff?o.alphaCutoff:.5)),void 0!==o.normalTexture&&i!==r.MeshBasicMaterial&&(c.push(t.assignTexture(a,"normalMap",o.normalTexture)),a.normalScale=new r.Vector2(1,-1),void 0!==o.normalTexture.scale&&a.normalScale.set(o.normalTexture.scale,-o.normalTexture.scale)),void 0!==o.occlusionTexture&&i!==r.MeshBasicMaterial&&(c.push(t.assignTexture(a,"aoMap",o.occlusionTexture)),void 0!==o.occlusionTexture.strength&&(a.aoMapIntensity=o.occlusionTexture.strength)),void 0!==o.emissiveFactor&&i!==r.MeshBasicMaterial&&(a.emissive=(new r.Color).fromArray(o.emissiveFactor)),void 0!==o.emissiveTexture&&i!==r.MeshBasicMaterial&&c.push(t.assignTexture(a,"emissiveMap",o.emissiveTexture)),Promise.all(c).then((function(){let n;return n=i===or?s[qn.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(a):new i(a),o.name&&(n.name=o.name),n.map&&(n.map.encoding=r.sRGBEncoding),n.emissiveMap&&(n.emissiveMap.encoding=r.sRGBEncoding),yr(n,o),t.associations.set(n,{type:"materials",index:e}),o.extensions&&vr(s,n,o),n}))}createUniqueName(e){const t=r.PropertyBinding.sanitizeNodeName(e||"");let n=t;for(let e=1;this.nodeNamesUsed[n];++e)n=t+"_"+e;return this.nodeNamesUsed[n]=!0,n}loadGeometries(e){const t=this,n=this.extensions,s=this.primitiveCache;function o(e){return n[qn.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(n){return _r(n,e,t)}))}const i=[];for(let n=0,a=e.length;n<a;n++){const a=e[n],l=br(a),c=s[l];if(c)i.push(c.promise);else{let e;e=a.extensions&&a.extensions[qn.KHR_DRACO_MESH_COMPRESSION]?o(a):_r(new r.BufferGeometry,a,t),s[l]={primitive:a,promise:e},i.push(e)}}return Promise.all(i)}loadMesh(e){const t=this,n=this.json,s=this.extensions,o=n.meshes[e],i=o.primitives,a=[];for(let e=0,t=i.length;e<t;e++){const t=void 0===i[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new r.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:r.FrontSide})),l.DefaultMaterial):this.getDependency("material",i[e].material);a.push(t)}var l;return a.push(t.loadGeometries(i)),Promise.all(a).then((function(n){const a=n.slice(0,n.length-1),l=n[n.length-1],c=[];for(let n=0,h=l.length;n<h;n++){const h=l[n],u=i[n];let d;const p=a[n];if(4===u.mode||5===u.mode||6===u.mode||void 0===u.mode)d=!0===o.isSkinnedMesh?new r.SkinnedMesh(h,p):new r.Mesh(h,p),!0!==d.isSkinnedMesh||d.geometry.attributes.skinWeight.normalized||d.normalizeSkinWeights(),5===u.mode?d.geometry=Sr(d.geometry,r.TriangleStripDrawMode):6===u.mode&&(d.geometry=Sr(d.geometry,r.TriangleFanDrawMode));else if(1===u.mode)d=new r.LineSegments(h,p);else if(3===u.mode)d=new r.Line(h,p);else if(2===u.mode)d=new r.LineLoop(h,p);else{if(0!==u.mode)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+u.mode);d=new r.Points(h,p)}Object.keys(d.geometry.morphAttributes).length>0&&xr(d,o),d.name=t.createUniqueName(o.name||"mesh_"+e),yr(d,o),u.extensions&&vr(s,d,u),t.assignFinalMaterial(d),c.push(d)}if(1===c.length)return c[0];const h=new r.Group;for(let e=0,t=c.length;e<t;e++)h.add(c[e]);return h}))}loadCamera(e){let t;const n=this.json.cameras[e],s=n[n.type];if(s)return"perspective"===n.type?t=new r.PerspectiveCamera(r.MathUtils.radToDeg(s.yfov),s.aspectRatio||1,s.znear||1,s.zfar||2e6):"orthographic"===n.type&&(t=new r.OrthographicCamera(-s.xmag,s.xmag,s.ymag,-s.ymag,s.znear,s.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),yr(t,n),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],n={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(n):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return n.inverseBindMatrices=e,n}))}loadAnimation(e){const t=this.json.animations[e],n=[],s=[],o=[],i=[],a=[];for(let e=0,r=t.channels.length;e<r;e++){const r=t.channels[e],l=t.samplers[r.sampler],c=r.target,h=void 0!==c.node?c.node:c.id,u=void 0!==t.parameters?t.parameters[l.input]:l.input,d=void 0!==t.parameters?t.parameters[l.output]:l.output;n.push(this.getDependency("node",h)),s.push(this.getDependency("accessor",u)),o.push(this.getDependency("accessor",d)),i.push(l),a.push(c)}return Promise.all([Promise.all(n),Promise.all(s),Promise.all(o),Promise.all(i),Promise.all(a)]).then((function(n){const s=n[0],o=n[1],i=n[2],a=n[3],l=n[4],c=[];for(let e=0,t=s.length;e<t;e++){const t=s[e],n=o[e],h=i[e],u=a[e],d=l[e];if(void 0===t)continue;let p;switch(t.updateMatrix(),t.matrixAutoUpdate=!0,mr[d.path]){case mr.weights:p=r.NumberKeyframeTrack;break;case mr.rotation:p=r.QuaternionKeyframeTrack;break;case mr.position:case mr.scale:default:p=r.VectorKeyframeTrack}const m=t.name?t.name:t.uuid,f=void 0!==u.interpolation?fr[u.interpolation]:r.InterpolateLinear,g=[];mr[d.path]===mr.weights?t.traverse((function(e){!0===e.isMesh&&e.morphTargetInfluences&&g.push(e.name?e.name:e.uuid)})):g.push(m);let v=h.array;if(h.normalized){const e=Ar(v.constructor),t=new Float32Array(v.length);for(let n=0,r=v.length;n<r;n++)t[n]=v[n]*e;v=t}for(let e=0,t=g.length;e<t;e++){const t=new p(g[e]+"."+mr[d.path],n.array,v,f);"CUBICSPLINE"===u.interpolation&&(t.createInterpolant=function(e){return new lr(this.times,this.values,this.getValueSize()/3,e)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),c.push(t)}}const h=t.name?t.name:"animation_"+e;return new r.AnimationClip(h,void 0,c)}))}createNodeMesh(e){const t=this.json,n=this,r=t.nodes[e];return void 0===r.mesh?null:n.getDependency("mesh",r.mesh).then((function(e){const t=n._getNodeRef(n.meshCache,r.mesh,e);return void 0!==r.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,n=r.weights.length;t<n;t++)e.morphTargetInfluences[t]=r.weights[t]})),t}))}loadNode(e){const t=this.json,n=this.extensions,s=this,o=t.nodes[e],i=o.name?s.createUniqueName(o.name):"";return function(){const t=[],n=s._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return n&&t.push(n),void 0!==o.camera&&t.push(s.getDependency("camera",o.camera).then((function(e){return s._getNodeRef(s.cameraCache,o.camera,e)}))),s._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){t.push(e)})),Promise.all(t)}().then((function(t){let a;if(a=!0===o.isBone?new r.Bone:t.length>1?new r.Group:1===t.length?t[0]:new r.Object3D,a!==t[0])for(let e=0,n=t.length;e<n;e++)a.add(t[e]);if(o.name&&(a.userData.name=o.name,a.name=i),yr(a,o),o.extensions&&vr(n,a,o),void 0!==o.matrix){const e=new r.Matrix4;e.fromArray(o.matrix),a.applyMatrix4(e)}else void 0!==o.translation&&a.position.fromArray(o.translation),void 0!==o.rotation&&a.quaternion.fromArray(o.rotation),void 0!==o.scale&&a.scale.fromArray(o.scale);return s.associations.set(a,{type:"nodes",index:e}),a}))}loadScene(e){const t=this.json,n=this.extensions,s=this.json.scenes[e],o=this,i=new r.Group;s.name&&(i.name=o.createUniqueName(s.name)),yr(i,s),s.extensions&&vr(n,i,s);const a=s.nodes||[],l=[];for(let e=0,n=a.length;e<n;e++)l.push(Tr(a[e],i,t,o));return Promise.all(l).then((function(){return i}))}}function Tr(e,t,n,s){const o=n.nodes[e];return s.getDependency("node",e).then((function(e){if(void 0===o.skin)return e;let t;return s.getDependency("skin",o.skin).then((function(e){t=e;const n=[];for(let e=0,r=t.joints.length;e<r;e++)n.push(s.getDependency("node",t.joints[e]));return Promise.all(n)})).then((function(n){return e.traverse((function(e){if(!e.isMesh)return;const s=[],o=[];for(let e=0,i=n.length;e<i;e++){const i=n[e];if(i){s.push(i);const n=new r.Matrix4;void 0!==t.inverseBindMatrices&&n.fromArray(t.inverseBindMatrices.array,16*e),o.push(n)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[e])}e.bind(new r.Skeleton(s,o),e.matrixWorld)})),e}))})).then((function(e){t.add(e);const r=[];if(o.children){const t=o.children;for(let o=0,i=t.length;o<i;o++){const i=t[o];r.push(Tr(i,e,n,s))}}return Promise.all(r)}))}function _r(e,t,n){const s=t.attributes,o=[];function i(t,r){return n.getDependency("accessor",t).then((function(t){e.setAttribute(r,t)}))}for(const t in s){const n=pr[t]||t.toLowerCase();n in e.attributes||o.push(i(s[t],n))}if(void 0!==t.indices&&!e.index){const r=n.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));o.push(r)}return yr(e,t),function(e,t,n){const s=t.attributes,o=new r.Box3;if(void 0===s.POSITION)return;{const e=n.json.accessors[s.POSITION],t=e.min,i=e.max;if(void 0===t||void 0===i)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(o.set(new r.Vector3(t[0],t[1],t[2]),new r.Vector3(i[0],i[1],i[2])),e.normalized){const t=Ar(cr[e.componentType]);o.min.multiplyScalar(t),o.max.multiplyScalar(t)}}const i=t.targets;if(void 0!==i){const e=new r.Vector3,t=new r.Vector3;for(let r=0,s=i.length;r<s;r++){const s=i[r];if(void 0!==s.POSITION){const r=n.json.accessors[s.POSITION],o=r.min,i=r.max;if(void 0!==o&&void 0!==i){if(t.setX(Math.max(Math.abs(o[0]),Math.abs(i[0]))),t.setY(Math.max(Math.abs(o[1]),Math.abs(i[1]))),t.setZ(Math.max(Math.abs(o[2]),Math.abs(i[2]))),r.normalized){const e=Ar(cr[r.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}o.expandByVector(e)}e.boundingBox=o;const a=new r.Sphere;o.getCenter(a.center),a.radius=o.min.distanceTo(o.max)/2,e.boundingSphere=a}(e,t,n),Promise.all(o).then((function(){return void 0!==t.targets?function(e,t,n){let r=!1,s=!1;for(let e=0,n=t.length;e<n;e++){const n=t[e];if(void 0!==n.POSITION&&(r=!0),void 0!==n.NORMAL&&(s=!0),r&&s)break}if(!r&&!s)return Promise.resolve(e);const o=[],i=[];for(let a=0,l=t.length;a<l;a++){const l=t[a];if(r){const t=void 0!==l.POSITION?n.getDependency("accessor",l.POSITION):e.attributes.position;o.push(t)}if(s){const t=void 0!==l.NORMAL?n.getDependency("accessor",l.NORMAL):e.attributes.normal;i.push(t)}}return Promise.all([Promise.all(o),Promise.all(i)]).then((function(t){const n=t[0],o=t[1];return r&&(e.morphAttributes.position=n),s&&(e.morphAttributes.normal=o),e.morphTargetsRelative=!0,e}))}(e,t.targets,n):e}))}function Sr(e,t){let n=e.getIndex();if(null===n){const t=[],r=e.getAttribute("position");if(void 0===r)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<r.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}const s=n.count-2,o=[];if(t===r.TriangleFanDrawMode)for(let e=1;e<=s;e++)o.push(n.getX(0)),o.push(n.getX(e)),o.push(n.getX(e+1));else for(let e=0;e<s;e++)e%2==0?(o.push(n.getX(e)),o.push(n.getX(e+1)),o.push(n.getX(e+2))):(o.push(n.getX(e+2)),o.push(n.getX(e+1)),o.push(n.getX(e)));o.length/3!==s&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const i=e.clone();return i.setIndex(o),i}class Er extends r.Loader{constructor(e){super(e),this.defaultDPI=90,this.defaultUnit="px"}load(e,t,n,s){const o=this,i=new r.FileLoader(o.manager);i.setPath(o.path),i.setRequestHeader(o.requestHeader),i.setWithCredentials(o.withCredentials),i.load(e,(function(n){try{t(o.parse(n))}catch(t){s?s(t):console.error(t),o.manager.itemError(e)}}),n,s)}parse(e){const t=this;function n(e,t,n,r,o,i,a,l){if(0==t||0==n)return void e.lineTo(l.x,l.y);r=r*Math.PI/180,t=Math.abs(t),n=Math.abs(n);const c=(a.x-l.x)/2,h=(a.y-l.y)/2,u=Math.cos(r)*c+Math.sin(r)*h,d=-Math.sin(r)*c+Math.cos(r)*h;let p=t*t,m=n*n;const f=u*u,g=d*d,v=f/p+g/m;if(v>1){const e=Math.sqrt(v);p=(t*=e)*t,m=(n*=e)*n}const y=p*g+m*f,x=(p*m-y)/y;let b=Math.sqrt(Math.max(0,x));o===i&&(b=-b);const w=b*t*d/n,A=-b*n*u/t,M=Math.cos(r)*w-Math.sin(r)*A+(a.x+l.x)/2,T=Math.sin(r)*w+Math.cos(r)*A+(a.y+l.y)/2,_=s(1,0,(u-w)/t,(d-A)/n),S=s((u-w)/t,(d-A)/n,(-u-w)/t,(-d-A)/n)%(2*Math.PI);e.currentPath.absellipse(M,T,t,n,_,_+S,0===i,r)}function s(e,t,n,r){const s=e*n+t*r,o=Math.sqrt(e*e+t*t)*Math.sqrt(n*n+r*r);let i=Math.acos(Math.max(-1,Math.min(1,s/o)));return e*r-t*n<0&&(i=-i),i}function o(e,t){t=Object.assign({},t);let n={};if(e.hasAttribute("class")){const t=e.getAttribute("class").split(/\s/).filter(Boolean).map((e=>e.trim()));for(let e=0;e<t.length;e++)n=Object.assign(n,m["."+t[e]])}function r(r,s,o){void 0===o&&(o=function(e){return e.startsWith("url")&&console.warn("SVGLoader: url access in attributes is not implemented."),e}),e.hasAttribute(r)&&(t[s]=o(e.getAttribute(r))),n[r]&&(t[s]=o(n[r])),e.style&&""!==e.style[r]&&(t[s]=o(e.style[r]))}function s(e){return Math.max(0,Math.min(1,h(e)))}function o(e){return Math.max(0,h(e))}return e.hasAttribute("id")&&(n=Object.assign(n,m["#"+e.getAttribute("id")])),r("fill","fill"),r("fill-opacity","fillOpacity",s),r("opacity","opacity",s),r("stroke","stroke"),r("stroke-opacity","strokeOpacity",s),r("stroke-width","strokeWidth",o),r("stroke-linejoin","strokeLineJoin"),r("stroke-linecap","strokeLineCap"),r("stroke-miterlimit","strokeMiterLimit",o),r("visibility","visibility"),t}function i(e,t){return e-(t-e)}function a(e,t,n){if("string"!=typeof e)throw new TypeError("Invalid input: "+typeof e);const r={SEPARATOR:/[ \t\r\n\,.\-+]/,WHITESPACE:/[ \t\r\n]/,DIGIT:/[\d]/,SIGN:/[-+]/,POINT:/\./,COMMA:/,/,EXP:/e/i,FLAGS:/[01]/};let s=0,o=!0,i="",a="";const l=[];function c(e,t,n){const r=new SyntaxError('Unexpected character "'+e+'" at index '+t+".");throw r.partial=n,r}function h(){""!==i&&(""===a?l.push(Number(i)):l.push(Number(i)*Math.pow(10,Number(a)))),i="",a=""}let u;const d=e.length;for(let p=0;p<d;p++)if(u=e[p],Array.isArray(t)&&t.includes(l.length%n)&&r.FLAGS.test(u))s=1,i=u,h();else{if(0===s){if(r.WHITESPACE.test(u))continue;if(r.DIGIT.test(u)||r.SIGN.test(u)){s=1,i=u;continue}if(r.POINT.test(u)){s=2,i=u;continue}r.COMMA.test(u)&&(o&&c(u,p,l),o=!0)}if(1===s){if(r.DIGIT.test(u)){i+=u;continue}if(r.POINT.test(u)){i+=u,s=2;continue}if(r.EXP.test(u)){s=3;continue}r.SIGN.test(u)&&1===i.length&&r.SIGN.test(i[0])&&c(u,p,l)}if(2===s){if(r.DIGIT.test(u)){i+=u;continue}if(r.EXP.test(u)){s=3;continue}r.POINT.test(u)&&"."===i[i.length-1]&&c(u,p,l)}if(3===s){if(r.DIGIT.test(u)){a+=u;continue}if(r.SIGN.test(u)){if(""===a){a+=u;continue}1===a.length&&r.SIGN.test(a)&&c(u,p,l)}}r.WHITESPACE.test(u)?(h(),s=0,o=!1):r.COMMA.test(u)?(h(),s=0,o=!0):r.SIGN.test(u)?(h(),s=1,i=u):r.POINT.test(u)?(h(),s=2,i=u):c(u,p,l)}return h(),l}const l=["mm","cm","in","pt","pc","px"],c={mm:{mm:1,cm:.1,in:1/25.4,pt:72/25.4,pc:6/25.4,px:-1},cm:{mm:10,cm:1,in:1/2.54,pt:72/2.54,pc:6/2.54,px:-1},in:{mm:25.4,cm:2.54,in:1,pt:72,pc:6,px:-1},pt:{mm:25.4/72,cm:2.54/72,in:1/72,pt:1,pc:6/72,px:-1},pc:{mm:25.4/6,cm:2.54/6,in:1/6,pt:12,pc:1,px:-1},px:{px:1}};function h(e){let n,r="px";if("string"==typeof e||e instanceof String)for(let t=0,n=l.length;t<n;t++){const n=l[t];if(e.endsWith(n)){r=n,e=e.substring(0,e.length-n.length);break}}return"px"===r&&"px"!==t.defaultUnit?n=c.in[t.defaultUnit]/t.defaultDPI:(n=c[r][t.defaultUnit],n<0&&(n=c[r].in*t.defaultDPI)),n*parseFloat(e)}function u(e){const t=e.elements;return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function d(e){const t=e.elements;return Math.sqrt(t[3]*t[3]+t[4]*t[4])}const p=[],m={},f=[],g=new r.Matrix3,v=new r.Matrix3,y=new r.Matrix3,x=new r.Matrix3,b=new r.Vector2,w=new r.Vector3,A=new r.Matrix3,M=(new DOMParser).parseFromString(e,"image/svg+xml");return function e(t,s){if(1!==t.nodeType)return;const l=function(e){if(!(e.hasAttribute("transform")||"use"===e.nodeName&&(e.hasAttribute("x")||e.hasAttribute("y"))))return null;const t=function(e){const t=new r.Matrix3,n=g;if("use"===e.nodeName&&(e.hasAttribute("x")||e.hasAttribute("y"))){const n=h(e.getAttribute("x")),r=h(e.getAttribute("y"));t.translate(n,r)}if(e.hasAttribute("transform")){const r=e.getAttribute("transform").split(")");for(let e=r.length-1;e>=0;e--){const s=r[e].trim();if(""===s)continue;const o=s.indexOf("("),i=s.length;if(o>0&&o<i){const e=s.substr(0,o),t=a(s.substr(o+1,i-o-1));switch(n.identity(),e){case"translate":if(t.length>=1){const e=t[0];let r=e;t.length>=2&&(r=t[1]),n.translate(e,r)}break;case"rotate":if(t.length>=1){let e=0,r=0,s=0;e=-t[0]*Math.PI/180,t.length>=3&&(r=t[1],s=t[2]),v.identity().translate(-r,-s),y.identity().rotate(e),x.multiplyMatrices(y,v),v.identity().translate(r,s),n.multiplyMatrices(v,x)}break;case"scale":if(t.length>=1){const e=t[0];let r=e;t.length>=2&&(r=t[1]),n.scale(e,r)}break;case"skewX":1===t.length&&n.set(1,Math.tan(t[0]*Math.PI/180),0,0,1,0,0,0,1);break;case"skewY":1===t.length&&n.set(1,0,0,Math.tan(t[0]*Math.PI/180),1,0,0,0,1);break;case"matrix":6===t.length&&n.set(t[0],t[2],t[4],t[1],t[3],t[5],0,0,1)}}t.premultiply(n)}}return t}(e);return f.length>0&&t.premultiply(f[f.length-1]),A.copy(t),f.push(t),t}(t);let c=!0,M=null;switch(t.nodeName){case"svg":break;case"style":!function(e){if(e.sheet&&e.sheet.cssRules&&e.sheet.cssRules.length)for(let t=0;t<e.sheet.cssRules.length;t++){const n=e.sheet.cssRules[t];if(1!==n.type)continue;const r=n.selectorText.split(/,/gm).filter(Boolean).map((e=>e.trim()));for(let e=0;e<r.length;e++)m[r[e]]=Object.assign(m[r[e]]||{},n.style)}}(t);break;case"g":s=o(t,s);break;case"path":s=o(t,s),t.hasAttribute("d")&&(M=function(e){const t=new r.ShapePath,s=new r.Vector2,o=new r.Vector2,l=new r.Vector2;let c=!0,h=!1;const u=e.getAttribute("d").match(/[a-df-z][^a-df-z]*/gi);for(let e=0,r=u.length;e<r;e++){const r=u[e],d=r.charAt(0),p=r.substr(1).trim();let m;switch(!0===c&&(h=!0,c=!1),d){case"M":m=a(p);for(let e=0,n=m.length;e<n;e+=2)s.x=m[e+0],s.y=m[e+1],o.x=s.x,o.y=s.y,0===e?t.moveTo(s.x,s.y):t.lineTo(s.x,s.y),0===e&&!0===h&&l.copy(s);break;case"H":m=a(p);for(let e=0,n=m.length;e<n;e++)s.x=m[e],o.x=s.x,o.y=s.y,t.lineTo(s.x,s.y),0===e&&!0===h&&l.copy(s);break;case"V":m=a(p);for(let e=0,n=m.length;e<n;e++)s.y=m[e],o.x=s.x,o.y=s.y,t.lineTo(s.x,s.y),0===e&&!0===h&&l.copy(s);break;case"L":m=a(p);for(let e=0,n=m.length;e<n;e+=2)s.x=m[e+0],s.y=m[e+1],o.x=s.x,o.y=s.y,t.lineTo(s.x,s.y),0===e&&!0===h&&l.copy(s);break;case"C":m=a(p);for(let e=0,n=m.length;e<n;e+=6)t.bezierCurveTo(m[e+0],m[e+1],m[e+2],m[e+3],m[e+4],m[e+5]),o.x=m[e+2],o.y=m[e+3],s.x=m[e+4],s.y=m[e+5],0===e&&!0===h&&l.copy(s);break;case"S":m=a(p);for(let e=0,n=m.length;e<n;e+=4)t.bezierCurveTo(i(s.x,o.x),i(s.y,o.y),m[e+0],m[e+1],m[e+2],m[e+3]),o.x=m[e+0],o.y=m[e+1],s.x=m[e+2],s.y=m[e+3],0===e&&!0===h&&l.copy(s);break;case"Q":m=a(p);for(let e=0,n=m.length;e<n;e+=4)t.quadraticCurveTo(m[e+0],m[e+1],m[e+2],m[e+3]),o.x=m[e+0],o.y=m[e+1],s.x=m[e+2],s.y=m[e+3],0===e&&!0===h&&l.copy(s);break;case"T":m=a(p);for(let e=0,n=m.length;e<n;e+=2){const n=i(s.x,o.x),r=i(s.y,o.y);t.quadraticCurveTo(n,r,m[e+0],m[e+1]),o.x=n,o.y=r,s.x=m[e+0],s.y=m[e+1],0===e&&!0===h&&l.copy(s)}break;case"A":m=a(p,[3,4],7);for(let e=0,r=m.length;e<r;e+=7){if(m[e+5]==s.x&&m[e+6]==s.y)continue;const r=s.clone();s.x=m[e+5],s.y=m[e+6],o.x=s.x,o.y=s.y,n(t,m[e],m[e+1],m[e+2],m[e+3],m[e+4],r,s),0===e&&!0===h&&l.copy(s)}break;case"m":m=a(p);for(let e=0,n=m.length;e<n;e+=2)s.x+=m[e+0],s.y+=m[e+1],o.x=s.x,o.y=s.y,0===e?t.moveTo(s.x,s.y):t.lineTo(s.x,s.y),0===e&&!0===h&&l.copy(s);break;case"h":m=a(p);for(let e=0,n=m.length;e<n;e++)s.x+=m[e],o.x=s.x,o.y=s.y,t.lineTo(s.x,s.y),0===e&&!0===h&&l.copy(s);break;case"v":m=a(p);for(let e=0,n=m.length;e<n;e++)s.y+=m[e],o.x=s.x,o.y=s.y,t.lineTo(s.x,s.y),0===e&&!0===h&&l.copy(s);break;case"l":m=a(p);for(let e=0,n=m.length;e<n;e+=2)s.x+=m[e+0],s.y+=m[e+1],o.x=s.x,o.y=s.y,t.lineTo(s.x,s.y),0===e&&!0===h&&l.copy(s);break;case"c":m=a(p);for(let e=0,n=m.length;e<n;e+=6)t.bezierCurveTo(s.x+m[e+0],s.y+m[e+1],s.x+m[e+2],s.y+m[e+3],s.x+m[e+4],s.y+m[e+5]),o.x=s.x+m[e+2],o.y=s.y+m[e+3],s.x+=m[e+4],s.y+=m[e+5],0===e&&!0===h&&l.copy(s);break;case"s":m=a(p);for(let e=0,n=m.length;e<n;e+=4)t.bezierCurveTo(i(s.x,o.x),i(s.y,o.y),s.x+m[e+0],s.y+m[e+1],s.x+m[e+2],s.y+m[e+3]),o.x=s.x+m[e+0],o.y=s.y+m[e+1],s.x+=m[e+2],s.y+=m[e+3],0===e&&!0===h&&l.copy(s);break;case"q":m=a(p);for(let e=0,n=m.length;e<n;e+=4)t.quadraticCurveTo(s.x+m[e+0],s.y+m[e+1],s.x+m[e+2],s.y+m[e+3]),o.x=s.x+m[e+0],o.y=s.y+m[e+1],s.x+=m[e+2],s.y+=m[e+3],0===e&&!0===h&&l.copy(s);break;case"t":m=a(p);for(let e=0,n=m.length;e<n;e+=2){const n=i(s.x,o.x),r=i(s.y,o.y);t.quadraticCurveTo(n,r,s.x+m[e+0],s.y+m[e+1]),o.x=n,o.y=r,s.x=s.x+m[e+0],s.y=s.y+m[e+1],0===e&&!0===h&&l.copy(s)}break;case"a":m=a(p,[3,4],7);for(let e=0,r=m.length;e<r;e+=7){if(0==m[e+5]&&0==m[e+6])continue;const r=s.clone();s.x+=m[e+5],s.y+=m[e+6],o.x=s.x,o.y=s.y,n(t,m[e],m[e+1],m[e+2],m[e+3],m[e+4],r,s),0===e&&!0===h&&l.copy(s)}break;case"Z":case"z":t.currentPath.autoClose=!0,t.currentPath.curves.length>0&&(s.copy(l),t.currentPath.currentPoint.copy(s),c=!0);break;default:console.warn(r)}h=!1}return t}(t));break;case"rect":s=o(t,s),M=function(e){const t=h(e.getAttribute("x")||0),n=h(e.getAttribute("y")||0),s=h(e.getAttribute("rx")||0),o=h(e.getAttribute("ry")||0),i=h(e.getAttribute("width")),a=h(e.getAttribute("height")),l=new r.ShapePath;return l.moveTo(t+2*s,n),l.lineTo(t+i-2*s,n),(0!==s||0!==o)&&l.bezierCurveTo(t+i,n,t+i,n,t+i,n+2*o),l.lineTo(t+i,n+a-2*o),(0!==s||0!==o)&&l.bezierCurveTo(t+i,n+a,t+i,n+a,t+i-2*s,n+a),l.lineTo(t+2*s,n+a),(0!==s||0!==o)&&l.bezierCurveTo(t,n+a,t,n+a,t,n+a-2*o),l.lineTo(t,n+2*o),(0!==s||0!==o)&&l.bezierCurveTo(t,n,t,n,t+2*s,n),l}(t);break;case"polygon":s=o(t,s),M=function(e){const t=new r.ShapePath;let n=0;return e.getAttribute("points").replace(/(-?[\d\.?]+)[,|\s](-?[\d\.?]+)/g,(function(e,r,s){const o=h(r),i=h(s);0===n?t.moveTo(o,i):t.lineTo(o,i),n++})),t.currentPath.autoClose=!0,t}(t);break;case"polyline":s=o(t,s),M=function(e){const t=new r.ShapePath;let n=0;return e.getAttribute("points").replace(/(-?[\d\.?]+)[,|\s](-?[\d\.?]+)/g,(function(e,r,s){const o=h(r),i=h(s);0===n?t.moveTo(o,i):t.lineTo(o,i),n++})),t.currentPath.autoClose=!1,t}(t);break;case"circle":s=o(t,s),M=function(e){const t=h(e.getAttribute("cx")||0),n=h(e.getAttribute("cy")||0),s=h(e.getAttribute("r")||0),o=new r.Path;o.absarc(t,n,s,0,2*Math.PI);const i=new r.ShapePath;return i.subPaths.push(o),i}(t);break;case"ellipse":s=o(t,s),M=function(e){const t=h(e.getAttribute("cx")||0),n=h(e.getAttribute("cy")||0),s=h(e.getAttribute("rx")||0),o=h(e.getAttribute("ry")||0),i=new r.Path;i.absellipse(t,n,s,o,0,2*Math.PI);const a=new r.ShapePath;return a.subPaths.push(i),a}(t);break;case"line":s=o(t,s),M=function(e){const t=h(e.getAttribute("x1")||0),n=h(e.getAttribute("y1")||0),s=h(e.getAttribute("x2")||0),o=h(e.getAttribute("y2")||0),i=new r.ShapePath;return i.moveTo(t,n),i.lineTo(s,o),i.currentPath.autoClose=!1,i}(t);break;case"defs":c=!1;break;case"use":s=o(t,s);const l=t.href.baseVal.substring(1),u=t.viewportElement.getElementById(l);u?e(u,s):console.warn("SVGLoader: 'use node' references non-existent node id: "+l)}if(M&&(void 0!==s.fill&&"none"!==s.fill&&M.color.setStyle(s.fill),function(e,t){function n(e){w.set(e.x,e.y,1).applyMatrix3(t),e.set(w.x,w.y)}const r=function(e){return 0!==e.elements[1]||0!==e.elements[3]}(t),s=e.subPaths;for(let e=0,o=s.length;e<o;e++){const o=s[e].curves;for(let e=0;e<o.length;e++){const s=o[e];s.isLineCurve?(n(s.v1),n(s.v2)):s.isCubicBezierCurve?(n(s.v0),n(s.v1),n(s.v2),n(s.v3)):s.isQuadraticBezierCurve?(n(s.v0),n(s.v1),n(s.v2)):s.isEllipseCurve&&(r&&console.warn("SVGLoader: Elliptic arc or ellipse rotation or skewing is not implemented."),b.set(s.aX,s.aY),n(b),s.aX=b.x,s.aY=b.y,s.xRadius*=u(t),s.yRadius*=d(t))}}}(M,A),p.push(M),M.userData={node:t,style:s}),c){const n=t.childNodes;for(let t=0;t<n.length;t++)e(n[t],s)}l&&(f.pop(),f.length>0?A.copy(f[f.length-1]):A.identity())}(M.documentElement,{fill:"#000",fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeLineJoin:"miter",strokeLineCap:"butt",strokeMiterLimit:4}),{paths:p,xml:M.documentElement}}static createShapes(e){const t=999999999,n={loc:0,t:0};function s(e,t,r,s){const i=e.x,a=t.x,l=r.x,c=s.x,h=e.y,u=t.y,d=r.y,p=s.y,m=(c-l)*(h-d)-(p-d)*(i-l),f=(p-d)*(a-i)-(c-l)*(u-h),g=m/f,v=((a-i)*(h-d)-(u-h)*(i-l))/f;if(0===f&&0!==m||g<=0||g>=1||v<0||v>1)return null;if(0===m&&0===f){for(let l=0;l<2;l++){if(o(0===l?r:s,e,t),0==n.loc){const e=0===l?r:s;return{x:e.x,y:e.y,t:n.t}}if(2==n.loc)return{x:+(i+n.t*(a-i)).toPrecision(10),y:+(h+n.t*(u-h)).toPrecision(10),t:n.t}}return null}for(let i=0;i<2;i++)if(o(0===i?r:s,e,t),0==n.loc){const e=0===i?r:s;return{x:e.x,y:e.y,t:n.t}}return{x:+(i+g*(a-i)).toPrecision(10),y:+(h+g*(u-h)).toPrecision(10),t:g}}function o(e,t,r){const s=r.x-t.x,o=r.y-t.y,i=e.x-t.x,a=e.y-t.y,l=s*a-i*o;if(e.x===t.x&&e.y===t.y)return n.loc=0,void(n.t=0);if(e.x===r.x&&e.y===r.y)return n.loc=1,void(n.t=1);if(l<-Number.EPSILON)return void(n.loc=3);if(l>Number.EPSILON)return void(n.loc=4);if(s*i<0||o*a<0)return void(n.loc=5);if(Math.sqrt(s*s+o*o)<Math.sqrt(i*i+a*a))return void(n.loc=6);let c;c=0!==s?i/s:a/o,n.loc=2,n.t=c}let i=0,a=t,l=-999999999,c=e.subPaths.map((e=>{const n=e.getPoints();let s=-999999999,o=t,c=-999999999,h=t;for(let e=0;e<n.length;e++){const t=n[e];t.y>s&&(s=t.y),t.y<o&&(o=t.y),t.x>c&&(c=t.x),t.x<h&&(h=t.x)}return l<=c&&(l=c+1),a>=h&&(a=h-1),{points:n,isCW:r.ShapeUtils.isClockWise(n),identifier:i++,boundingBox:new r.Box2(new r.Vector2(h,o),new r.Vector2(c,s))}}));c=c.filter((e=>e.points.length>1));const h=c.map((t=>function(e,t,n,o,i){null!=i&&""!==i||(i="nonzero");const a=new r.Vector2;e.boundingBox.getCenter(a);const l=function(e,t,n){const o=new r.Vector2;t.getCenter(o);const i=[];return n.forEach((t=>{t.boundingBox.containsPoint(o)&&function(e,t){const n=[],o=[];for(let i=1;i<e.length;i++){const a=e[i-1],l=e[i];for(let e=1;e<t.length;e++){const i=s(a,l,t[e-1],t[e]);null!==i&&void 0===n.find((e=>e.t<=i.t+Number.EPSILON&&e.t>=i.t-Number.EPSILON))&&(n.push(i),o.push(new r.Vector2(i.x,i.y)))}}return o}(e,t.points).forEach((e=>{i.push({identifier:t.identifier,isCW:t.isCW,point:e})}))})),i.sort(((e,t)=>e.point.x-t.point.x)),i}([new r.Vector2(n,a.y),new r.Vector2(o,a.y)],e.boundingBox,t);l.sort(((e,t)=>e.point.x-t.point.x));const c=[],h=[];l.forEach((t=>{t.identifier===e.identifier?c.push(t):h.push(t)}));const u=c[0].point.x,d=[];let p=0;for(;p<h.length&&h[p].point.x<u;)d.length>0&&d[d.length-1]===h[p].identifier?d.pop():d.push(h[p].identifier),p++;if(d.push(e.identifier),"evenodd"===i){const t=d.length%2==0,n=d[d.length-2];return{identifier:e.identifier,isHole:t,for:n}}if("nonzero"===i){let n=!0,r=null,s=null;for(let e=0;e<d.length;e++){const o=d[e];n?(s=t[o].isCW,n=!1,r=o):s!==t[o].isCW&&(s=t[o].isCW,n=!0)}return{identifier:e.identifier,isHole:n,for:r}}console.warn('fill-rule: "'+i+'" is currently not implemented.')}(t,c,a,l,e.userData.style.fillRule))),u=[];return c.forEach((e=>{if(!h[e.identifier].isHole){const t=new r.Shape(e.points);h.filter((t=>t.isHole&&t.for===e.identifier)).forEach((e=>{const n=c[e.identifier];t.holes.push(new r.Path(n.points))})),u.push(t)}})),u}static getStrokeStyle(e,t,n,r,s){return{strokeColor:t=void 0!==t?t:"#000",strokeWidth:e=void 0!==e?e:1,strokeLineJoin:n=void 0!==n?n:"miter",strokeLineCap:r=void 0!==r?r:"butt",strokeMiterLimit:s=void 0!==s?s:4}}static pointsToStroke(e,t,n,s){const o=[],i=[],a=[];if(0===Er.pointsToStrokeWithBuffers(e,t,n,s,o,i,a))return null;const l=new r.BufferGeometry;return l.setAttribute("position",new r.Float32BufferAttribute(o,3)),l.setAttribute("normal",new r.Float32BufferAttribute(i,3)),l.setAttribute("uv",new r.Float32BufferAttribute(a,2)),l}static pointsToStrokeWithBuffers(e,t,n,s,o,i,a,l){const c=new r.Vector2,h=new r.Vector2,u=new r.Vector2,d=new r.Vector2,p=new r.Vector2,m=new r.Vector2,f=new r.Vector2,g=new r.Vector2,v=new r.Vector2,y=new r.Vector2,x=new r.Vector2,b=new r.Vector2,w=new r.Vector2,A=new r.Vector2,M=new r.Vector2,T=new r.Vector2,_=new r.Vector2;n=void 0!==n?n:12,s=void 0!==s?s:.001,l=void 0!==l?l:0;const S=(e=function(e){let t=!1;for(let n=1,r=e.length-1;n<r;n++)if(e[n].distanceTo(e[n+1])<s){t=!0;break}if(!t)return e;const n=[];n.push(e[0]);for(let t=1,r=e.length-1;t<r;t++)e[t].distanceTo(e[t+1])>=s&&n.push(e[t]);return n.push(e[e.length-1]),n}(e)).length;if(S<2)return 0;const E=e[0].equals(e[S-1]);let P,C,R=e[0];const L=t.strokeWidth/2,V=1/(S-1);let k,I,O,N,B=0,D=!1,F=0,U=3*l,z=2*l;j(e[0],e[1],c).multiplyScalar(L),g.copy(e[0]).sub(c),v.copy(e[0]).add(c),y.copy(g),x.copy(v);for(let n=1;n<S;n++){P=e[n],C=n===S-1?E?e[1]:void 0:e[n+1];const r=c;if(j(R,P,r),u.copy(r).multiplyScalar(L),b.copy(P).sub(u),w.copy(P).add(u),k=B+V,I=!1,void 0!==C){j(P,C,h),u.copy(h).multiplyScalar(L),A.copy(P).sub(u),M.copy(P).add(u),O=!0,u.subVectors(C,R),r.dot(u)<0&&(O=!1),1===n&&(D=O),u.subVectors(C,P),u.normalize();const e=Math.abs(r.dot(u));if(0!==e){const n=L/e;u.multiplyScalar(-n),d.subVectors(P,R),p.copy(d).setLength(n).add(u),T.copy(p).negate();const r=p.length(),s=d.length();d.divideScalar(s),m.subVectors(C,P);const o=m.length();switch(m.divideScalar(o),d.dot(T)<s&&m.dot(T)<o&&(I=!0),_.copy(p).add(P),T.add(P),N=!1,I?O?(M.copy(T),w.copy(T)):(A.copy(T),b.copy(T)):W(),t.strokeLineJoin){case"bevel":X(O,I,k);break;case"round":q(O,I),O?G(P,b,A,k,0):G(P,M,w,k,1);break;case"miter":case"miter-clip":default:const e=L*t.strokeMiterLimit/r;if(e<1){if("miter-clip"!==t.strokeLineJoin){X(O,I,k);break}q(O,I),O?(m.subVectors(_,b).multiplyScalar(e).add(b),f.subVectors(_,A).multiplyScalar(e).add(A),H(b,k,0),H(m,k,0),H(P,k,.5),H(P,k,.5),H(m,k,0),H(f,k,0),H(P,k,.5),H(f,k,0),H(A,k,0)):(m.subVectors(_,w).multiplyScalar(e).add(w),f.subVectors(_,M).multiplyScalar(e).add(M),H(w,k,1),H(m,k,1),H(P,k,.5),H(P,k,.5),H(m,k,1),H(f,k,1),H(P,k,.5),H(f,k,1),H(M,k,1))}else I?(O?(H(v,B,1),H(g,B,0),H(_,k,0),H(v,B,1),H(_,k,0),H(T,k,1)):(H(v,B,1),H(g,B,0),H(_,k,1),H(g,B,0),H(T,k,0),H(_,k,1)),O?A.copy(_):M.copy(_)):O?(H(b,k,0),H(_,k,0),H(P,k,.5),H(P,k,.5),H(_,k,0),H(A,k,0)):(H(w,k,1),H(_,k,1),H(P,k,.5),H(P,k,.5),H(_,k,1),H(M,k,1)),N=!0}}else W()}else W();E||n!==S-1||Y(e[0],y,x,O,!0,B),B=k,R=P,g.copy(A),v.copy(M)}if(E){if(I&&o){let e=_,t=T;D!==O&&(e=T,t=_),O?(N||D)&&(t.toArray(o,0),t.toArray(o,9),N&&e.toArray(o,3)):!N&&D||(t.toArray(o,3),t.toArray(o,9),N&&e.toArray(o,0))}}else Y(P,b,w,O,!1,k);return F;function j(e,t,n){return n.subVectors(t,e),n.set(-n.y,n.x).normalize()}function H(e,t,n){o&&(o[U]=e.x,o[U+1]=e.y,o[U+2]=0,i&&(i[U]=0,i[U+1]=0,i[U+2]=1),U+=3,a&&(a[z]=t,a[z+1]=n,z+=2)),F+=3}function G(e,t,r,s,o){c.copy(t).sub(e).normalize(),h.copy(r).sub(e).normalize();let i=Math.PI;const a=c.dot(h);Math.abs(a)<1&&(i=Math.abs(Math.acos(a))),i/=n,u.copy(t);for(let t=0,r=n-1;t<r;t++)d.copy(u).rotateAround(e,i),H(u,s,o),H(d,s,o),H(e,s,.5),u.copy(d);H(d,s,o),H(r,s,o),H(e,s,.5)}function W(){H(v,B,1),H(g,B,0),H(b,k,0),H(v,B,1),H(b,k,1),H(w,k,0)}function X(e,t,n){t?e?(H(v,B,1),H(g,B,0),H(b,k,0),H(v,B,1),H(b,k,0),H(T,k,1),H(b,n,0),H(A,n,0),H(T,n,.5)):(H(v,B,1),H(g,B,0),H(w,k,1),H(g,B,0),H(T,k,0),H(w,k,1),H(w,n,1),H(M,n,0),H(T,n,.5)):e?(H(b,n,0),H(A,n,0),H(P,n,.5)):(H(w,n,1),H(M,n,0),H(P,n,.5))}function q(e,t){t&&(e?(H(v,B,1),H(g,B,0),H(b,k,0),H(v,B,1),H(b,k,0),H(T,k,1),H(b,B,0),H(P,k,.5),H(T,k,1),H(P,k,.5),H(A,B,0),H(T,k,1)):(H(v,B,1),H(g,B,0),H(w,k,1),H(g,B,0),H(T,k,0),H(w,k,1),H(w,B,1),H(T,k,0),H(P,k,.5),H(P,k,.5),H(T,k,0),H(M,B,1)))}function Y(e,n,r,s,i,a){switch(t.strokeLineCap){case"round":i?G(e,r,n,a,.5):G(e,n,r,a,.5);break;case"square":if(i)c.subVectors(n,e),h.set(c.y,-c.x),u.addVectors(c,h).add(e),d.subVectors(h,c).add(e),s?(u.toArray(o,3),d.toArray(o,0),d.toArray(o,9)):(u.toArray(o,3),u.toArray(o,9),d.toArray(o,0));else{c.subVectors(r,e),h.set(c.y,-c.x),u.addVectors(c,h).add(e),d.subVectors(h,c).add(e);const t=o.length;s?(u.toArray(o,t-3),d.toArray(o,t-6),d.toArray(o,t-12)):(u.toArray(o,t-6),d.toArray(o,t-3),d.toArray(o,t-12))}}}}}var Pr=function(e,t,n,r){return new(n||(n=Promise))((function(s,o){function i(e){try{l(r.next(e))}catch(e){o(e)}}function a(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}l((r=r.apply(e,t||[])).next())}))};class Cr{constructor(e,t){this.cache=e,this.textureAnisotropy=t}get fileLoader(){return this._fileLoader||(this._fileLoader=new r.FileLoader),this._fileLoader}get imageLoader(){return this._imgLoader||(this._imgLoader=new r.ImageLoader),this._imgLoader}get svgLoader(){return this._svgLoader||(this._svgLoader=new Er),this._svgLoader}get textureLoader(){return this._textureLoader||(this._textureLoader=new r.TextureLoader),this._textureLoader}get objectLoader(){return this._objectLoader||(this._objectLoader=new r.ObjectLoader),this._objectLoader}get gltfLoader(){return this._gltfLoader||(this._gltfLoader=new Wn),this._gltfLoader}get fbxLoader(){return this._fbxLoader||(this._fbxLoader=new Sn),this._fbxLoader}preload(e,t){return Pr(this,void 0,void 0,(function*(){return this.cache.add(e,t),new Promise((e=>{const n=/\.fbx$|\.glb$|\.gltf$/.test(t);/\.jpe?g$|\.png$/.test(t)?this.textureLoader.load(t,(t=>e(t))):(n&&this.fileLoader.setResponseType("arraybuffer"),this.fileLoader.load(t,(t=>e(t))))}))}))}textureAtlas(e,t,n="JSONHash"){return Pr(this,void 0,void 0,(function*(){let n=JSON.parse(yield this.file(t));if(n.textures){const e=n.textures[0].frames;let t={frames:{}};e.forEach((e=>{t=Object.assign(Object.assign({},t),{frames:Object.assign(Object.assign({},t.frames),{[e.filename]:{frame:e.frame,rotated:e.rotated,sourceSize:e.sourceSize,spriteSourceSize:e.spriteSourceSize,trimmed:e.trimmed}})})})),n=t}return{texture:yield this.texture(e),json:n}}))}file(e){const t=this.cache.get(e);return e=t||e,new Promise((t=>{this.fileLoader.load(e,(e=>t(e)))}))}svg(e){const t=this.cache.get(e);return e=t||e,new Promise((t=>{this.svgLoader.load(e,(e=>t(e)))}))}texture(e){if(!/^data:image\/[\S]+;base64,/gm.test(e)){const t=this.cache.get(e);e=t||e}return new Promise((t=>{this.textureLoader.load(e,(e=>{e.anisotropy=this.textureAnisotropy,e.needsUpdate=!0,t(e)}))}))}object(e){const t=this.cache.get(e);return e=t||e,new Promise((t=>{this.objectLoader.load(e,(e=>{t(e)}))}))}gltf(e){const t=this.cache.get(e);return e=t||e,new Promise((t=>{this.gltfLoader.load(e,(e=>{t(e)}))}))}fbx(e){const t=this.cache.get(e);return e=t||e,new Promise((t=>{this.fbxLoader.load(e,(e=>{t(e)}))}))}}class Rr extends r.Object3D{constructor(e,t,n,s){super(),this.scene=e,this.light=t,this.size=n,this.color=s,this.geo=new r.SphereBufferGeometry(n||.2,16,8),this.mat=new r.MeshBasicMaterial({color:s||t.color}),this.mesh=new r.Mesh(this.geo,this.mat),this.add(this.mesh),t.add(this)}dispose(){this.mesh.geometry.dispose(),Array.isArray(this.mesh.material)?this.mesh.material.forEach((e=>e.dispose())):this.mesh.material.dispose(),this.remove(this.mesh)}update(){}}class Lr{constructor(e){this.scene=e}get helper(){return{directionalLightHelper:(e,t,n)=>{const s=new r.DirectionalLightHelper(e,t,n);return this.scene.add(s),s},spotLightHelper:(e,t)=>{const n=new r.SpotLightHelper(e,t);return this.scene.add(n),n},pointLightHelper:(e,t,n)=>new Rr(this.scene,e,t,n)}}directionalLight(e={}){const{color:t=16777215,intensity:n=1}=e,s=new r.DirectionalLight(t,n);return s.castShadow=!0,this.scene.add(s),s}hemisphereLight(e={}){const{skyColor:t=16777215,groundColor:n=16777215,intensity:s=1}=e,o=new r.HemisphereLight(t,n,s);return this.scene.add(o),o}ambientLight(e={}){const{color:t=16777215,intensity:n=1}=e,s=new r.AmbientLight(t,n);return this.scene.add(s),s}pointLight(e={}){const{color:t=16777215,intensity:n=1,distance:s=0,decay:o=1}=e,i=new r.PointLight(t,n,s,o);return i.castShadow=!0,this.scene.add(i),i}spotLight(e={}){const{color:t=16777215,intensity:n=1,distance:s=0,angle:o=Math.PI/8,penumbra:i=0,decay:a=1}=e,l=new r.SpotLight(t,n,s,o,i,a);return l.castShadow=!0,this.scene.add(l),l}rectAreaLight(e={}){const{color:t=16777215,intensity:n=1,width:s=10,height:o=10}=e,i=new r.RectAreaLight(t,n,s,o);return this.scene.add(i),i}}const Vr=new r.Matrix4,kr=new r.Object3D,Ir=new r.Vector3;class Or extends r.EventDispatcher{constructor(){super(),this.uuid=r.MathUtils.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.elementsNeedUpdate=!1,this.verticesNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1}applyMatrix4(e){const t=(new r.Matrix3).getNormalMatrix(e);for(let t=0,n=this.vertices.length;t<n;t++)this.vertices[t].applyMatrix4(e);for(let e=0,n=this.faces.length;e<n;e++){const n=this.faces[e];n.normal.applyMatrix3(t).normalize();for(let e=0,r=n.vertexNormals.length;e<r;e++)n.vertexNormals[e].applyMatrix3(t).normalize()}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0,this}rotateX(e){return Vr.makeRotationX(e),this.applyMatrix4(Vr),this}rotateY(e){return Vr.makeRotationY(e),this.applyMatrix4(Vr),this}rotateZ(e){return Vr.makeRotationZ(e),this.applyMatrix4(Vr),this}translate(e,t,n){return Vr.makeTranslation(e,t,n),this.applyMatrix4(Vr),this}scale(e,t,n){return Vr.makeScale(e,t,n),this.applyMatrix4(Vr),this}lookAt(e){return kr.lookAt(e),kr.updateMatrix(),this.applyMatrix4(kr.matrix),this}fromBufferGeometry(e){const t=this,n=null!==e.index?e.index:void 0,s=e.attributes;if(void 0===s.position)return console.error("THREE.Geometry.fromBufferGeometry(): Position attribute required for conversion."),this;const o=s.position,i=s.normal,a=s.color,l=s.uv,c=s.uv2;void 0!==c&&(this.faceVertexUvs[1]=[]);for(let e=0;e<o.count;e++)t.vertices.push((new r.Vector3).fromBufferAttribute(o,e)),void 0!==a&&t.colors.push((new r.Color).fromBufferAttribute(a,e));function h(e,n,s,o){const h=void 0===a?[]:[t.colors[e].clone(),t.colors[n].clone(),t.colors[s].clone()],u=void 0===i?[]:[(new r.Vector3).fromBufferAttribute(i,e),(new r.Vector3).fromBufferAttribute(i,n),(new r.Vector3).fromBufferAttribute(i,s)],d=new Br(e,n,s,u,h,o);t.faces.push(d),void 0!==l&&t.faceVertexUvs[0].push([(new r.Vector2).fromBufferAttribute(l,e),(new r.Vector2).fromBufferAttribute(l,n),(new r.Vector2).fromBufferAttribute(l,s)]),void 0!==c&&t.faceVertexUvs[1].push([(new r.Vector2).fromBufferAttribute(c,e),(new r.Vector2).fromBufferAttribute(c,n),(new r.Vector2).fromBufferAttribute(c,s)])}const u=e.groups;if(u.length>0)for(let e=0;e<u.length;e++){const t=u[e],r=t.start;for(let e=r,s=r+t.count;e<s;e+=3)void 0!==n?h(n.getX(e),n.getX(e+1),n.getX(e+2),t.materialIndex):h(e,e+1,e+2,t.materialIndex)}else if(void 0!==n)for(let e=0;e<n.count;e+=3)h(n.getX(e),n.getX(e+1),n.getX(e+2));else for(let e=0;e<o.count;e+=3)h(e,e+1,e+2);return this.computeFaceNormals(),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(Ir).negate(),this.translate(Ir.x,Ir.y,Ir.z),this}normalize(){this.computeBoundingSphere();const e=this.boundingSphere.center,t=this.boundingSphere.radius,n=0===t?1:1/t,s=new r.Matrix4;return s.set(n,0,0,-n*e.x,0,n,0,-n*e.y,0,0,n,-n*e.z,0,0,0,1),this.applyMatrix4(s),this}computeFaceNormals(){const e=new r.Vector3,t=new r.Vector3;for(let n=0,r=this.faces.length;n<r;n++){const r=this.faces[n],s=this.vertices[r.a],o=this.vertices[r.b],i=this.vertices[r.c];e.subVectors(i,o),t.subVectors(s,o),e.cross(t),e.normalize(),r.normal.copy(e)}}computeVertexNormals(e=!0){const t=new Array(this.vertices.length);for(let e=0,n=this.vertices.length;e<n;e++)t[e]=new r.Vector3;if(e){const e=new r.Vector3,n=new r.Vector3;for(let r=0,s=this.faces.length;r<s;r++){const s=this.faces[r],o=this.vertices[s.a],i=this.vertices[s.b],a=this.vertices[s.c];e.subVectors(a,i),n.subVectors(o,i),e.cross(n),t[s.a].add(e),t[s.b].add(e),t[s.c].add(e)}}else{this.computeFaceNormals();for(let e=0,n=this.faces.length;e<n;e++){const n=this.faces[e];t[n.a].add(n.normal),t[n.b].add(n.normal),t[n.c].add(n.normal)}}for(let e=0,n=this.vertices.length;e<n;e++)t[e].normalize();for(let e=0,n=this.faces.length;e<n;e++){const n=this.faces[e],r=n.vertexNormals;3===r.length?(r[0].copy(t[n.a]),r[1].copy(t[n.b]),r[2].copy(t[n.c])):(r[0]=t[n.a].clone(),r[1]=t[n.b].clone(),r[2]=t[n.c].clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)}computeFlatVertexNormals(){this.computeFaceNormals();for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e],n=t.vertexNormals;3===n.length?(n[0].copy(t.normal),n[1].copy(t.normal),n[2].copy(t.normal)):(n[0]=t.normal.clone(),n[1]=t.normal.clone(),n[2]=t.normal.clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)}computeMorphNormals(){for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e];t.__originalFaceNormal?t.__originalFaceNormal.copy(t.normal):t.__originalFaceNormal=t.normal.clone(),t.__originalVertexNormals||(t.__originalVertexNormals=[]);for(let e=0,n=t.vertexNormals.length;e<n;e++)t.__originalVertexNormals[e]?t.__originalVertexNormals[e].copy(t.vertexNormals[e]):t.__originalVertexNormals[e]=t.vertexNormals[e].clone()}const e=new Or;e.faces=this.faces;for(let t=0,n=this.morphTargets.length;t<n;t++){if(!this.morphNormals[t]){this.morphNormals[t]={},this.morphNormals[t].faceNormals=[],this.morphNormals[t].vertexNormals=[];const e=this.morphNormals[t].faceNormals,n=this.morphNormals[t].vertexNormals;for(let t=0,s=this.faces.length;t<s;t++){const t=new r.Vector3,s={a:new r.Vector3,b:new r.Vector3,c:new r.Vector3};e.push(t),n.push(s)}}const n=this.morphNormals[t];e.vertices=this.morphTargets[t].vertices,e.computeFaceNormals(),e.computeVertexNormals();for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e],r=n.faceNormals[e],s=n.vertexNormals[e];r.copy(t.normal),s.a.copy(t.vertexNormals[0]),s.b.copy(t.vertexNormals[1]),s.c.copy(t.vertexNormals[2])}}for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e];t.normal=t.__originalFaceNormal,t.vertexNormals=t.__originalVertexNormals}}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new r.Box3),this.boundingBox.setFromPoints(this.vertices)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new r.Sphere),this.boundingSphere.setFromPoints(this.vertices)}merge(e,t,n=0){if(!e||!e.isGeometry)return void console.error("THREE.Geometry.merge(): geometry not an instance of THREE.Geometry.",e);let s;const o=this.vertices.length,i=this.vertices,a=e.vertices,l=this.faces,c=e.faces,h=this.colors,u=e.colors;void 0!==t&&(s=(new r.Matrix3).getNormalMatrix(t));for(let e=0,n=a.length;e<n;e++){const n=a[e].clone();void 0!==t&&n.applyMatrix4(t),i.push(n)}for(let e=0,t=u.length;e<t;e++)h.push(u[e].clone());for(let e=0,t=c.length;e<t;e++){const t=c[e];let r,i;const a=t.vertexNormals,h=t.vertexColors,u=new Br(t.a+o,t.b+o,t.c+o);u.normal.copy(t.normal),void 0!==s&&u.normal.applyMatrix3(s).normalize();for(let e=0,t=a.length;e<t;e++)r=a[e].clone(),void 0!==s&&r.applyMatrix3(s).normalize(),u.vertexNormals.push(r);u.color.copy(t.color);for(let e=0,t=h.length;e<t;e++)i=h[e],u.vertexColors.push(i.clone());u.materialIndex=t.materialIndex+n,l.push(u)}for(let t=0,n=e.faceVertexUvs.length;t<n;t++){const n=e.faceVertexUvs[t];void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]);for(let e=0,r=n.length;e<r;e++){const r=n[e],s=[];for(let e=0,t=r.length;e<t;e++)s.push(r[e].clone());this.faceVertexUvs[t].push(s)}}}mergeMesh(e){e&&e.isMesh?(e.matrixAutoUpdate&&e.updateMatrix(),this.merge(e.geometry,e.matrix)):console.error("THREE.Geometry.mergeMesh(): mesh not an instance of THREE.Mesh.",e)}mergeVertices(e=4){const t={},n=[],r=[],s=Math.pow(10,e);for(let e=0,o=this.vertices.length;e<o;e++){const o=this.vertices[e],i=Math.round(o.x*s)+"_"+Math.round(o.y*s)+"_"+Math.round(o.z*s);void 0===t[i]?(t[i]=e,n.push(this.vertices[e]),r[e]=n.length-1):r[e]=r[t[i]]}const o=[];for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e];t.a=r[t.a],t.b=r[t.b],t.c=r[t.c];const n=[t.a,t.b,t.c];for(let t=0;t<3;t++)if(n[t]===n[(t+1)%3]){o.push(e);break}}for(let e=o.length-1;e>=0;e--){const t=o[e];this.faces.splice(t,1);for(let e=0,n=this.faceVertexUvs.length;e<n;e++)this.faceVertexUvs[e].splice(t,1)}const i=this.vertices.length-n.length;return this.vertices=n,i}setFromPoints(e){this.vertices=[];for(let t=0,n=e.length;t<n;t++){const n=e[t];this.vertices.push(new r.Vector3(n.x,n.y,n.z||0))}return this}sortFacesByMaterialIndex(){const e=this.faces,t=e.length;for(let n=0;n<t;n++)e[n]._id=n;e.sort((function(e,t){return e.materialIndex-t.materialIndex}));const n=this.faceVertexUvs[0],r=this.faceVertexUvs[1];let s,o;n&&n.length===t&&(s=[]),r&&r.length===t&&(o=[]);for(let i=0;i<t;i++){const t=e[i]._id;s&&s.push(n[t]),o&&o.push(r[t])}s&&(this.faceVertexUvs[0]=s),o&&(this.faceVertexUvs[1]=o)}toJSON(){const e={metadata:{version:4.5,type:"Geometry",generator:"Geometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),void 0!==this.parameters){const t=this.parameters;for(const n in t)void 0!==t[n]&&(e[n]=t[n]);return e}const t=[];for(let e=0;e<this.vertices.length;e++){const n=this.vertices[e];t.push(n.x,n.y,n.z)}const n=[],r=[],s={},o=[],i={},a=[],l={};for(let e=0;e<this.faces.length;e++){const t=this.faces[e],r=!0,s=!1,o=void 0!==this.faceVertexUvs[0][e],i=t.normal.length()>0,a=t.vertexNormals.length>0,l=1!==t.color.r||1!==t.color.g||1!==t.color.b,p=t.vertexColors.length>0;let m=0;if(m=c(m,0,0),m=c(m,1,r),m=c(m,2,s),m=c(m,3,o),m=c(m,4,i),m=c(m,5,a),m=c(m,6,l),m=c(m,7,p),n.push(m),n.push(t.a,t.b,t.c),n.push(t.materialIndex),o){const t=this.faceVertexUvs[0][e];n.push(d(t[0]),d(t[1]),d(t[2]))}if(i&&n.push(h(t.normal)),a){const e=t.vertexNormals;n.push(h(e[0]),h(e[1]),h(e[2]))}if(l&&n.push(u(t.color)),p){const e=t.vertexColors;n.push(u(e[0]),u(e[1]),u(e[2]))}}function c(e,t,n){return n?e|1<<t:e&~(1<<t)}function h(e){const t=e.x.toString()+e.y.toString()+e.z.toString();return void 0!==s[t]||(s[t]=r.length/3,r.push(e.x,e.y,e.z)),s[t]}function u(e){const t=e.r.toString()+e.g.toString()+e.b.toString();return void 0!==i[t]||(i[t]=o.length,o.push(e.getHex())),i[t]}function d(e){const t=e.x.toString()+e.y.toString();return void 0!==l[t]||(l[t]=a.length/2,a.push(e.x,e.y)),l[t]}return e.data={},e.data.vertices=t,e.data.normals=r,o.length>0&&(e.data.colors=o),a.length>0&&(e.data.uvs=[a]),e.data.faces=n,e}clone(){return(new Or).copy(this)}copy(e){this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.name=e.name;const t=e.vertices;for(let e=0,n=t.length;e<n;e++)this.vertices.push(t[e].clone());const n=e.colors;for(let e=0,t=n.length;e<t;e++)this.colors.push(n[e].clone());const r=e.faces;for(let e=0,t=r.length;e<t;e++)this.faces.push(r[e].clone());for(let t=0,n=e.faceVertexUvs.length;t<n;t++){const n=e.faceVertexUvs[t];void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]);for(let e=0,r=n.length;e<r;e++){const r=n[e],s=[];for(let e=0,t=r.length;e<t;e++){const t=r[e];s.push(t.clone())}this.faceVertexUvs[t].push(s)}}const s=e.morphTargets;for(let e=0,t=s.length;e<t;e++){const t={};if(t.name=s[e].name,void 0!==s[e].vertices){t.vertices=[];for(let n=0,r=s[e].vertices.length;n<r;n++)t.vertices.push(s[e].vertices[n].clone())}if(void 0!==s[e].normals){t.normals=[];for(let n=0,r=s[e].normals.length;n<r;n++)t.normals.push(s[e].normals[n].clone())}this.morphTargets.push(t)}const o=e.morphNormals;for(let e=0,t=o.length;e<t;e++){const t={};if(void 0!==o[e].vertexNormals){t.vertexNormals=[];for(let n=0,r=o[e].vertexNormals.length;n<r;n++){const r=o[e].vertexNormals[n],s={};s.a=r.a.clone(),s.b=r.b.clone(),s.c=r.c.clone(),t.vertexNormals.push(s)}}if(void 0!==o[e].faceNormals){t.faceNormals=[];for(let n=0,r=o[e].faceNormals.length;n<r;n++)t.faceNormals.push(o[e].faceNormals[n].clone())}this.morphNormals.push(t)}const i=e.skinWeights;for(let e=0,t=i.length;e<t;e++)this.skinWeights.push(i[e].clone());const a=e.skinIndices;for(let e=0,t=a.length;e<t;e++)this.skinIndices.push(a[e].clone());const l=e.lineDistances;for(let e=0,t=l.length;e<t;e++)this.lineDistances.push(l[e]);const c=e.boundingBox;null!==c&&(this.boundingBox=c.clone());const h=e.boundingSphere;return null!==h&&(this.boundingSphere=h.clone()),this.elementsNeedUpdate=e.elementsNeedUpdate,this.verticesNeedUpdate=e.verticesNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.lineDistancesNeedUpdate=e.lineDistancesNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this}toBufferGeometry(){const e=(new Nr).fromGeometry(this),t=new r.BufferGeometry,n=new Float32Array(3*e.vertices.length);if(t.setAttribute("position",new r.BufferAttribute(n,3).copyVector3sArray(e.vertices)),e.normals.length>0){const n=new Float32Array(3*e.normals.length);t.setAttribute("normal",new r.BufferAttribute(n,3).copyVector3sArray(e.normals))}if(e.colors.length>0){const n=new Float32Array(3*e.colors.length);t.setAttribute("color",new r.BufferAttribute(n,3).copyColorsArray(e.colors))}if(e.uvs.length>0){const n=new Float32Array(2*e.uvs.length);t.setAttribute("uv",new r.BufferAttribute(n,2).copyVector2sArray(e.uvs))}if(e.uvs2.length>0){const n=new Float32Array(2*e.uvs2.length);t.setAttribute("uv2",new r.BufferAttribute(n,2).copyVector2sArray(e.uvs2))}t.groups=e.groups;for(const n in e.morphTargets){const s=[],o=e.morphTargets[n];for(let e=0,t=o.length;e<t;e++){const t=o[e],n=new r.Float32BufferAttribute(3*t.data.length,3);n.name=t.name,s.push(n.copyVector3sArray(t.data))}t.morphAttributes[n]=s}if(e.skinIndices.length>0){const n=new r.Float32BufferAttribute(4*e.skinIndices.length,4);t.setAttribute("skinIndex",n.copyVector4sArray(e.skinIndices))}if(e.skinWeights.length>0){const n=new r.Float32BufferAttribute(4*e.skinWeights.length,4);t.setAttribute("skinWeight",n.copyVector4sArray(e.skinWeights))}return null!==e.boundingSphere&&(t.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(t.boundingBox=e.boundingBox.clone()),t}computeTangents(){console.error("THREE.Geometry: .computeTangents() has been removed.")}computeLineDistances(){console.error("THREE.Geometry: .computeLineDistances() has been removed. Use THREE.Line.computeLineDistances() instead.")}applyMatrix(e){return console.warn("THREE.Geometry: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(e)}dispose(){this.dispatchEvent({type:"dispose"})}static createBufferGeometryFromObject(e){let t=new r.BufferGeometry;const n=e.geometry;if(e.isPoints||e.isLine){const e=new r.Float32BufferAttribute(3*n.vertices.length,3),s=new r.Float32BufferAttribute(3*n.colors.length,3);if(t.setAttribute("position",e.copyVector3sArray(n.vertices)),t.setAttribute("color",s.copyColorsArray(n.colors)),n.lineDistances&&n.lineDistances.length===n.vertices.length){const e=new r.Float32BufferAttribute(n.lineDistances.length,1);t.setAttribute("lineDistance",e.copyArray(n.lineDistances))}null!==n.boundingSphere&&(t.boundingSphere=n.boundingSphere.clone()),null!==n.boundingBox&&(t.boundingBox=n.boundingBox.clone())}else e.isMesh&&(t=n.toBufferGeometry());return t}}Or.prototype.isGeometry=!0;class Nr{constructor(){this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}computeGroups(e){const t=[];let n,r,s;const o=e.faces;for(r=0;r<o.length;r++){const e=o[r];e.materialIndex!==s&&(s=e.materialIndex,void 0!==n&&(n.count=3*r-n.start,t.push(n)),n={start:3*r,materialIndex:s})}void 0!==n&&(n.count=3*r-n.start,t.push(n)),this.groups=t}fromGeometry(e){const t=e.faces,n=e.vertices,s=e.faceVertexUvs,o=s[0]&&s[0].length>0,i=s[1]&&s[1].length>0,a=e.morphTargets,l=a.length;let c;if(l>0){c=[];for(let e=0;e<l;e++)c[e]={name:a[e].name,data:[]};this.morphTargets.position=c}const h=e.morphNormals,u=h.length;let d;if(u>0){d=[];for(let e=0;e<u;e++)d[e]={name:h[e].name,data:[]};this.morphTargets.normal=d}const p=e.skinIndices,m=e.skinWeights,f=p.length===n.length,g=m.length===n.length;n.length>0&&0===t.length&&console.error("THREE.DirectGeometry: Faceless geometries are not supported.");for(let e=0;e<t.length;e++){const v=t[e];this.vertices.push(n[v.a],n[v.b],n[v.c]);const y=v.vertexNormals;if(3===y.length)this.normals.push(y[0],y[1],y[2]);else{const e=v.normal;this.normals.push(e,e,e)}const x=v.vertexColors;if(3===x.length)this.colors.push(x[0],x[1],x[2]);else{const e=v.color;this.colors.push(e,e,e)}if(!0===o){const t=s[0][e];void 0!==t?this.uvs.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",e),this.uvs.push(new r.Vector2,new r.Vector2,new r.Vector2))}if(!0===i){const t=s[1][e];void 0!==t?this.uvs2.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",e),this.uvs2.push(new r.Vector2,new r.Vector2,new r.Vector2))}for(let e=0;e<l;e++){const t=a[e].vertices;c[e].data.push(t[v.a],t[v.b],t[v.c])}for(let t=0;t<u;t++){const n=h[t].vertexNormals[e];d[t].data.push(n.a,n.b,n.c)}f&&this.skinIndices.push(p[v.a],p[v.b],p[v.c]),g&&this.skinWeights.push(m[v.a],m[v.b],m[v.c])}return this.computeGroups(e),this.verticesNeedUpdate=e.verticesNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),this}}class Br{constructor(e,t,n,s,o,i=0){this.a=e,this.b=t,this.c=n,this.normal=s&&s.isVector3?s:new r.Vector3,this.vertexNormals=Array.isArray(s)?s:[],this.color=o&&o.isColor?o:new r.Color,this.vertexColors=Array.isArray(o)?o:[],this.materialIndex=i}clone(){return(new this.constructor).copy(this)}copy(e){this.a=e.a,this.b=e.b,this.c=e.c,this.normal.copy(e.normal),this.color.copy(e.color),this.materialIndex=e.materialIndex;for(let t=0,n=e.vertexNormals.length;t<n;t++)this.vertexNormals[t]=e.vertexNormals[t].clone();for(let t=0,n=e.vertexColors.length;t<n;t++)this.vertexColors[t]=e.vertexColors[t].clone();return this}}class Dr{constructor(){this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}computeGroups(e){const t=[];let n,r,s;const o=e.faces;for(r=0;r<o.length;r++){const e=o[r];e.materialIndex!==s&&(s=e.materialIndex,void 0!==n&&(n.count=3*r-n.start,t.push(n)),n={start:3*r,materialIndex:s})}void 0!==n&&(n.count=3*r-n.start,t.push(n)),this.groups=t}fromGeometry(e){const t=e.faces,n=e.vertices,s=e.faceVertexUvs,o=s[0]&&s[0].length>0,i=s[1]&&s[1].length>0,a=e.morphTargets,l=a.length;let c;if(l>0){c=[];for(let e=0;e<l;e++)c[e]={name:a[e].name,data:[]};this.morphTargets.position=c}const h=e.morphNormals,u=h.length;let d;if(u>0){d=[];for(let e=0;e<u;e++)d[e]={name:h[e].name,data:[]};this.morphTargets.normal=d}const p=e.skinIndices,m=e.skinWeights,f=p.length===n.length,g=m.length===n.length;n.length>0&&0===t.length&&console.error("THREE.DirectGeometry: Faceless geometries are not supported.");for(let e=0;e<t.length;e++){const v=t[e];this.vertices.push(n[v.a],n[v.b],n[v.c]);const y=v.vertexNormals;if(3===y.length)this.normals.push(y[0],y[1],y[2]);else{const e=v.normal;this.normals.push(e,e,e)}const x=v.vertexColors;if(3===x.length)this.colors.push(x[0],x[1],x[2]);else{const e=v.color;this.colors.push(e,e,e)}if(!0===o){const t=s[0][e];void 0!==t?this.uvs.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",e),this.uvs.push(new r.Vector2,new r.Vector2,new r.Vector2))}if(!0===i){const t=s[1][e];void 0!==t?this.uvs2.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",e),this.uvs2.push(new r.Vector2,new r.Vector2,new r.Vector2))}for(let e=0;e<l;e++){const t=a[e].vertices;c[e].data.push(t[v.a],t[v.b],t[v.c])}for(let t=0;t<u;t++){const n=h[t].vertexNormals[e];d[t].data.push(n.a,n.b,n.c)}f&&this.skinIndices.push(p[v.a],p[v.b],p[v.c]),g&&this.skinWeights.push(m[v.a],m[v.b],m[v.c])}return this.computeGroups(e),this.verticesNeedUpdate=e.verticesNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),this}}const Fr=(e,t)=>{const n=(new Dr).fromGeometry(t);return Ur(e,n)},Ur=(e,t)=>{var n,s;const o=new Float32Array(3*t.vertices.length);if(e.setAttribute("position",new r.BufferAttribute(o,3).copyVector3sArray(t.vertices)),t.normals.length>0){const n=new Float32Array(3*t.normals.length);e.setAttribute("normal",new r.BufferAttribute(n,3).copyVector3sArray(t.normals))}if(t.colors.length>0){const n=new Float32Array(3*t.colors.length);e.setAttribute("color",new r.BufferAttribute(n,3).copyColorsArray(t.colors))}if(t.uvs.length>0){const n=new Float32Array(2*t.uvs.length);e.setAttribute("uv",new r.BufferAttribute(n,2).copyVector2sArray(t.uvs))}if(t.uvs2.length>0){const n=new Float32Array(2*t.uvs2.length);e.setAttribute("uv2",new r.BufferAttribute(n,2).copyVector2sArray(t.uvs2))}e.groups=t.groups;for(const n in t.morphTargets){const s=[],o=t.morphTargets[n];for(let e=0,t=o.length;e<t;e++){const t=o[e],n=new r.Float32BufferAttribute(3*t.data.length,3);n.name=t.name,s.push(n.copyVector3sArray(t.data))}e.morphAttributes[n]=s}if(t.skinIndices.length>0){const n=new r.Float32BufferAttribute(4*t.skinIndices.length,4);e.setAttribute("skinIndex",n.copyVector4sArray(t.skinIndices))}if(t.skinWeights.length>0){const n=new r.Float32BufferAttribute(4*t.skinWeights.length,4);e.setAttribute("skinWeight",n.copyVector4sArray(t.skinWeights))}return null!==t.boundingSphere&&(e.boundingSphere=null===(n=t.boundingSphere)||void 0===n?void 0:n.clone()),null!==t.boundingBox&&(e.boundingBox=null===(s=t.boundingBox)||void 0===s?void 0:s.clone()),e};class zr{constructor(e){this.scene=e}add(e,t={}){const n=this.make(e,t);return n?this.scene.add(n):console.warn("Could not make heightmap"),n}make(e,t={}){const{image:n}=e,{width:s,height:o}=n,{colorScale:i}=t,a=document.createElement("canvas");a.width=s,a.height=o;const l=a.getContext("2d");if(!l)return;l.drawImage(e.image,0,0);const c=l.getImageData(0,0,s,o),h=(new Or).fromBufferGeometry(new r.PlaneBufferGeometry(10,10,s-1,o-1));let d={color:13421772,side:r.DoubleSide};i&&(d=Object.assign(Object.assign({},d),{vertexColors:!0}));const p=new r.MeshPhongMaterial(d),m=new u(h,p);m.receiveShadow=m.castShadow=!0,m.shape="concave";const f=m.geometry;for(let e=0;e<f.vertices.length;e++)f.vertices[e].z=c.data[4*e]/120;return i&&f.faces.forEach((e=>e.color=new r.Color(i(((e,t)=>{var n=e.vertices[t.a].z,r=e.vertices[t.b].z,s=e.vertices[t.c].z;return Math.max(n,r,s)})(f,e)).hex()))),m.rotateX(-Math.PI/2),m.updateMatrix(),h.computeFaceNormals(),h.computeVertexNormals(),m.name="heightmap",m.geometry=Fr(new r.BufferGeometry,m.geometry),m}}const jr={type:"change"},Hr={type:"start"},Gr={type:"end"};class Wr extends r.EventDispatcher{constructor(e,t){super(),void 0===t&&console.warn('THREE.OrbitControls: The second parameter "domElement" is now mandatory.'),t===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.object=e,this.domElement=t,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new r.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:r.MOUSE.ROTATE,MIDDLE:r.MOUSE.DOLLY,RIGHT:r.MOUSE.PAN},this.touches={ONE:r.TOUCH.ROTATE,TWO:r.TOUCH.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return a.phi},this.getAzimuthalAngle=function(){return a.theta},this.listenToKeyEvents=function(e){e.addEventListener("keydown",G),this._domElementKeyEvents=e},this.saveState=function(){n.target0.copy(n.target),n.position0.copy(n.object.position),n.zoom0=n.object.zoom},this.reset=function(){n.target.copy(n.target0),n.object.position.copy(n.position0),n.object.zoom=n.zoom0,n.object.updateProjectionMatrix(),n.dispatchEvent(jr),n.update(),o=s.NONE},this.update=function(){const t=new r.Vector3,d=(new r.Quaternion).setFromUnitVectors(e.up,new r.Vector3(0,1,0)),p=d.clone().invert(),m=new r.Vector3,f=new r.Quaternion,g=2*Math.PI;return function(){const e=n.object.position;t.copy(e).sub(n.target),t.applyQuaternion(d),a.setFromVector3(t),n.autoRotate&&o===s.NONE&&T(2*Math.PI/60/60*n.autoRotateSpeed),n.enableDamping?(a.theta+=l.theta*n.dampingFactor,a.phi+=l.phi*n.dampingFactor):(a.theta+=l.theta,a.phi+=l.phi);let r=n.minAzimuthAngle,v=n.maxAzimuthAngle;return isFinite(r)&&isFinite(v)&&(r<-Math.PI?r+=g:r>Math.PI&&(r-=g),v<-Math.PI?v+=g:v>Math.PI&&(v-=g),a.theta=r<=v?Math.max(r,Math.min(v,a.theta)):a.theta>(r+v)/2?Math.max(r,a.theta):Math.min(v,a.theta)),a.phi=Math.max(n.minPolarAngle,Math.min(n.maxPolarAngle,a.phi)),a.makeSafe(),a.radius*=c,a.radius=Math.max(n.minDistance,Math.min(n.maxDistance,a.radius)),!0===n.enableDamping?n.target.addScaledVector(h,n.dampingFactor):n.target.add(h),t.setFromSpherical(a),t.applyQuaternion(p),e.copy(n.target).add(t),n.object.lookAt(n.target),!0===n.enableDamping?(l.theta*=1-n.dampingFactor,l.phi*=1-n.dampingFactor,h.multiplyScalar(1-n.dampingFactor)):(l.set(0,0,0),h.set(0,0,0)),c=1,!!(u||m.distanceToSquared(n.object.position)>i||8*(1-f.dot(n.object.quaternion))>i)&&(n.dispatchEvent(jr),m.copy(n.object.position),f.copy(n.object.quaternion),u=!1,!0)}}(),this.dispose=function(){n.domElement.removeEventListener("contextmenu",W),n.domElement.removeEventListener("pointerdown",F),n.domElement.removeEventListener("pointercancel",j),n.domElement.removeEventListener("wheel",H),n.domElement.ownerDocument.removeEventListener("pointermove",U),n.domElement.ownerDocument.removeEventListener("pointerup",z),null!==n._domElementKeyEvents&&n._domElementKeyEvents.removeEventListener("keydown",G)};const n=this,s={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let o=s.NONE;const i=1e-6,a=new r.Spherical,l=new r.Spherical;let c=1;const h=new r.Vector3;let u=!1;const d=new r.Vector2,p=new r.Vector2,m=new r.Vector2,f=new r.Vector2,g=new r.Vector2,v=new r.Vector2,y=new r.Vector2,x=new r.Vector2,b=new r.Vector2,w=[],A={};function M(){return Math.pow(.95,n.zoomSpeed)}function T(e){l.theta-=e}function _(e){l.phi-=e}const S=function(){const e=new r.Vector3;return function(t,n){e.setFromMatrixColumn(n,0),e.multiplyScalar(-t),h.add(e)}}(),E=function(){const e=new r.Vector3;return function(t,r){!0===n.screenSpacePanning?e.setFromMatrixColumn(r,1):(e.setFromMatrixColumn(r,0),e.crossVectors(n.object.up,e)),e.multiplyScalar(t),h.add(e)}}(),P=function(){const e=new r.Vector3;return function(t,r){const s=n.domElement;if(n.object.isPerspectiveCamera){const o=n.object.position;e.copy(o).sub(n.target);let i=e.length();i*=Math.tan(n.object.fov/2*Math.PI/180),S(2*t*i/s.clientHeight,n.object.matrix),E(2*r*i/s.clientHeight,n.object.matrix)}else n.object.isOrthographicCamera?(S(t*(n.object.right-n.object.left)/n.object.zoom/s.clientWidth,n.object.matrix),E(r*(n.object.top-n.object.bottom)/n.object.zoom/s.clientHeight,n.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),n.enablePan=!1)}}();function C(e){n.object.isPerspectiveCamera?c/=e:n.object.isOrthographicCamera?(n.object.zoom=Math.max(n.minZoom,Math.min(n.maxZoom,n.object.zoom*e)),n.object.updateProjectionMatrix(),u=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),n.enableZoom=!1)}function R(e){n.object.isPerspectiveCamera?c*=e:n.object.isOrthographicCamera?(n.object.zoom=Math.max(n.minZoom,Math.min(n.maxZoom,n.object.zoom/e)),n.object.updateProjectionMatrix(),u=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),n.enableZoom=!1)}function L(e){d.set(e.clientX,e.clientY)}function V(e){f.set(e.clientX,e.clientY)}function k(){if(1===w.length)d.set(w[0].pageX,w[0].pageY);else{const e=.5*(w[0].pageX+w[1].pageX),t=.5*(w[0].pageY+w[1].pageY);d.set(e,t)}}function I(){if(1===w.length)f.set(w[0].pageX,w[0].pageY);else{const e=.5*(w[0].pageX+w[1].pageX),t=.5*(w[0].pageY+w[1].pageY);f.set(e,t)}}function O(){const e=w[0].pageX-w[1].pageX,t=w[0].pageY-w[1].pageY,n=Math.sqrt(e*e+t*t);y.set(0,n)}function N(e){if(1==w.length)p.set(e.pageX,e.pageY);else{const t=Y(e),n=.5*(e.pageX+t.x),r=.5*(e.pageY+t.y);p.set(n,r)}m.subVectors(p,d).multiplyScalar(n.rotateSpeed);const t=n.domElement;T(2*Math.PI*m.x/t.clientHeight),_(2*Math.PI*m.y/t.clientHeight),d.copy(p)}function B(e){if(1===w.length)g.set(e.pageX,e.pageY);else{const t=Y(e),n=.5*(e.pageX+t.x),r=.5*(e.pageY+t.y);g.set(n,r)}v.subVectors(g,f).multiplyScalar(n.panSpeed),P(v.x,v.y),f.copy(g)}function D(e){const t=Y(e),r=e.pageX-t.x,s=e.pageY-t.y,o=Math.sqrt(r*r+s*s);x.set(0,o),b.set(0,Math.pow(x.y/y.y,n.zoomSpeed)),C(b.y),y.copy(x)}function F(e){!1!==n.enabled&&(0===w.length&&(n.domElement.ownerDocument.addEventListener("pointermove",U),n.domElement.ownerDocument.addEventListener("pointerup",z)),function(e){w.push(e)}(e),"touch"===e.pointerType?function(e){switch(q(e),w.length){case 1:switch(n.touches.ONE){case r.TOUCH.ROTATE:if(!1===n.enableRotate)return;k(),o=s.TOUCH_ROTATE;break;case r.TOUCH.PAN:if(!1===n.enablePan)return;I(),o=s.TOUCH_PAN;break;default:o=s.NONE}break;case 2:switch(n.touches.TWO){case r.TOUCH.DOLLY_PAN:if(!1===n.enableZoom&&!1===n.enablePan)return;n.enableZoom&&O(),n.enablePan&&I(),o=s.TOUCH_DOLLY_PAN;break;case r.TOUCH.DOLLY_ROTATE:if(!1===n.enableZoom&&!1===n.enableRotate)return;n.enableZoom&&O(),n.enableRotate&&k(),o=s.TOUCH_DOLLY_ROTATE;break;default:o=s.NONE}break;default:o=s.NONE}o!==s.NONE&&n.dispatchEvent(Hr)}(e):function(e){let t;switch(e.button){case 0:t=n.mouseButtons.LEFT;break;case 1:t=n.mouseButtons.MIDDLE;break;case 2:t=n.mouseButtons.RIGHT;break;default:t=-1}switch(t){case r.MOUSE.DOLLY:if(!1===n.enableZoom)return;!function(e){y.set(e.clientX,e.clientY)}(e),o=s.DOLLY;break;case r.MOUSE.ROTATE:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===n.enablePan)return;V(e),o=s.PAN}else{if(!1===n.enableRotate)return;L(e),o=s.ROTATE}break;case r.MOUSE.PAN:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===n.enableRotate)return;L(e),o=s.ROTATE}else{if(!1===n.enablePan)return;V(e),o=s.PAN}break;default:o=s.NONE}o!==s.NONE&&n.dispatchEvent(Hr)}(e))}function U(e){!1!==n.enabled&&("touch"===e.pointerType?function(e){switch(q(e),o){case s.TOUCH_ROTATE:if(!1===n.enableRotate)return;N(e),n.update();break;case s.TOUCH_PAN:if(!1===n.enablePan)return;B(e),n.update();break;case s.TOUCH_DOLLY_PAN:if(!1===n.enableZoom&&!1===n.enablePan)return;!function(e){n.enableZoom&&D(e),n.enablePan&&B(e)}(e),n.update();break;case s.TOUCH_DOLLY_ROTATE:if(!1===n.enableZoom&&!1===n.enableRotate)return;!function(e){n.enableZoom&&D(e),n.enableRotate&&N(e)}(e),n.update();break;default:o=s.NONE}}(e):function(e){if(!1!==n.enabled)switch(o){case s.ROTATE:if(!1===n.enableRotate)return;!function(e){p.set(e.clientX,e.clientY),m.subVectors(p,d).multiplyScalar(n.rotateSpeed);const t=n.domElement;T(2*Math.PI*m.x/t.clientHeight),_(2*Math.PI*m.y/t.clientHeight),d.copy(p),n.update()}(e);break;case s.DOLLY:if(!1===n.enableZoom)return;!function(e){x.set(e.clientX,e.clientY),b.subVectors(x,y),b.y>0?C(M()):b.y<0&&R(M()),y.copy(x),n.update()}(e);break;case s.PAN:if(!1===n.enablePan)return;!function(e){g.set(e.clientX,e.clientY),v.subVectors(g,f).multiplyScalar(n.panSpeed),P(v.x,v.y),f.copy(g),n.update()}(e)}}(e))}function z(e){!1!==n.enabled&&(e.pointerType,n.dispatchEvent(Gr),o=s.NONE,X(e),0===w.length&&(n.domElement.ownerDocument.removeEventListener("pointermove",U),n.domElement.ownerDocument.removeEventListener("pointerup",z)))}function j(e){X(e)}function H(e){!1===n.enabled||!1===n.enableZoom||o!==s.NONE&&o!==s.ROTATE||(e.preventDefault(),n.dispatchEvent(Hr),function(e){e.deltaY<0?R(M()):e.deltaY>0&&C(M()),n.update()}(e),n.dispatchEvent(Gr))}function G(e){!1!==n.enabled&&!1!==n.enablePan&&function(e){let t=!1;switch(e.code){case n.keys.UP:P(0,n.keyPanSpeed),t=!0;break;case n.keys.BOTTOM:P(0,-n.keyPanSpeed),t=!0;break;case n.keys.LEFT:P(n.keyPanSpeed,0),t=!0;break;case n.keys.RIGHT:P(-n.keyPanSpeed,0),t=!0}t&&(e.preventDefault(),n.update())}(e)}function W(e){!1!==n.enabled&&e.preventDefault()}function X(e){delete A[e.pointerId];for(let t=0;t<w.length;t++)if(w[t].pointerId==e.pointerId)return void w.splice(t,1)}function q(e){let t=A[e.pointerId];void 0===t&&(t=new r.Vector2,A[e.pointerId]=t),t.set(e.pageX,e.pageY)}function Y(e){const t=e.pointerId===w[0].pointerId?w[1]:w[0];return A[t.pointerId]}n.domElement.addEventListener("contextmenu",W),n.domElement.addEventListener("pointerdown",F),n.domElement.addEventListener("pointercancel",j),n.domElement.addEventListener("wheel",H,{passive:!1}),this.update()}}class Xr{constructor(e,t,n,r,s,o,i){this.scene=e,this.renderer=t,this.camera=n,this.lights=r,this.physics=s,this.load=o,this.factories=i}warpSpeed(...e){return t=this,n=void 0,o=function*(){let t={};const n=e.filter((e=>/^-\w+/.test(e))),s=n.length>0;if((0===e.length||s)&&(e=["light","camera","lookAtCenter","ground","grid","orbitControls","fog","sky"]),s&&n.map((e=>e.substr(1))).forEach((t=>{const n=e.indexOf(t);e.splice(n,1)})),e.includes("sky")){const e=["varying vec3 vWorldPosition;","","void main() {","","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;","","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","","}"].join("\n"),t=["uniform vec3 topColor;","uniform vec3 bottomColor;","uniform float offset;","uniform float exponent;","","varying vec3 vWorldPosition;","","void main() {","","float h = normalize( vWorldPosition + offset ).y;","gl_FragColor = vec4( mix( bottomColor, topColor, max( pow( max( h , 0.0), exponent ), 0.0 ) ), 1.0 );","","}"].join("\n"),n={topColor:{value:new r.Color(30719)},bottomColor:{value:new r.Color(15595007)},offset:{value:33},exponent:{value:.6}};var o=new r.SphereBufferGeometry(500,32,15),i=new r.ShaderMaterial({uniforms:n,vertexShader:e,fragmentShader:t,side:r.BackSide}),a=new r.Mesh(o,i);this.scene.add(a)}if(e.includes("camera")&&(this.camera.position.set(0,6,12),t=Object.assign({camera:this.camera},t)),e.includes("light")){const e=.4,n=this.lights.hemisphereLight({skyColor:16777215,groundColor:0,intensity:e}),r=this.lights.ambientLight({color:16777215,intensity:e}),s=this.lights.directionalLight({color:16777215,intensity:e});s.position.set(100,200,50);const o=20;s.shadow.camera.top=o,s.shadow.camera.bottom=-o,s.shadow.camera.left=-o,s.shadow.camera.right=o,s.shadow.mapSize.set(1024,1024);const i={ambientLight:r,directionalLight:s,hemisphereLight:n};t=Object.assign({lights:i},t)}if(e.includes("lookAtCenter")&&this.camera.lookAt(this.scene.position),e.includes("ground")){const n=e.includes("grid"),s="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOnAAADusBZ+q87AAAAJtJREFUeJzt0EENwDAAxLDbNP6UOxh+NEYQ5dl2drFv286598GrA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAu37AD8eaBH5JQdVbAAAAAElFTkSuQmCC",o=yield this.load.texture(s);o.wrapS=o.wrapT=r.RepeatWrapping,o.repeat.set(21,21);const i={name:"ground",width:21,height:21,depth:1,y:-.5},a={phong:{map:n?o:null,color:16777215}};let l;window.__loadPhysics?(l=this.physics.add.ground(i,a),l.body.setRestitution(1)):l=this.factories.add.ground(i,a),l.receiveShadow=!0,t=Object.assign({ground:l},t)}if(e.includes("orbitControls")){const e=new Wr(this.camera,document.getElementById("enable3d-phaser-canvas")||this.renderer.domElement);t=Object.assign({orbitControls:e},t)}return t},new((s=void 0)||(s=Promise))((function(e,r){function i(e){try{l(o.next(e))}catch(e){r(e)}}function a(e){try{l(o.throw(e))}catch(e){r(e)}}function l(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(i,a)}l((o=o.apply(t,n||[])).next())}));var t,n,s,o}}class qr extends r.Mesh{constructor(e,t={}){super(e),this.type="Reflector";const n=this,s=void 0!==t.color?new r.Color(t.color):new r.Color(8355711),o=t.textureWidth||512,i=t.textureHeight||512,a=t.clipBias||0,l=t.shader||qr.ReflectorShader,c=new r.Plane,h=new r.Vector3,u=new r.Vector3,d=new r.Vector3,p=new r.Matrix4,m=new r.Vector3(0,0,-1),f=new r.Vector4,g=new r.Vector3,v=new r.Vector3,y=new r.Vector4,x=new r.Matrix4,b=new r.PerspectiveCamera,w={minFilter:r.LinearFilter,magFilter:r.LinearFilter,format:r.RGBFormat},A=new r.WebGLRenderTarget(o,i,w);r.MathUtils.isPowerOfTwo(o)&&r.MathUtils.isPowerOfTwo(i)||(A.texture.generateMipmaps=!1);const M=new r.ShaderMaterial({uniforms:r.UniformsUtils.clone(l.uniforms),fragmentShader:l.fragmentShader,vertexShader:l.vertexShader});M.uniforms.tDiffuse.value=A.texture,M.uniforms.color.value=s,M.uniforms.textureMatrix.value=x,this.material=M,this.onBeforeRender=function(e,t,r){if(u.setFromMatrixPosition(n.matrixWorld),d.setFromMatrixPosition(r.matrixWorld),p.extractRotation(n.matrixWorld),h.set(0,0,1),h.applyMatrix4(p),g.subVectors(u,d),g.dot(h)>0)return;g.reflect(h).negate(),g.add(u),p.extractRotation(r.matrixWorld),m.set(0,0,-1),m.applyMatrix4(p),m.add(d),v.subVectors(u,m),v.reflect(h).negate(),v.add(u),b.position.copy(g),b.up.set(0,1,0),b.up.applyMatrix4(p),b.up.reflect(h),b.lookAt(v),b.far=r.far,b.updateMatrixWorld(),b.projectionMatrix.copy(r.projectionMatrix),x.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),x.multiply(b.projectionMatrix),x.multiply(b.matrixWorldInverse),x.multiply(n.matrixWorld),c.setFromNormalAndCoplanarPoint(h,u),c.applyMatrix4(b.matrixWorldInverse),f.set(c.normal.x,c.normal.y,c.normal.z,c.constant);const s=b.projectionMatrix;y.x=(Math.sign(f.x)+s.elements[8])/s.elements[0],y.y=(Math.sign(f.y)+s.elements[9])/s.elements[5],y.z=-1,y.w=(1+s.elements[10])/s.elements[14],f.multiplyScalar(2/f.dot(y)),s.elements[2]=f.x,s.elements[6]=f.y,s.elements[10]=f.z+1-a,s.elements[14]=f.w,A.texture.encoding=e.outputEncoding,n.visible=!1;const o=e.getRenderTarget(),i=e.xr.enabled,l=e.shadowMap.autoUpdate;e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(A),e.state.buffers.depth.setMask(!0),!1===e.autoClear&&e.clear(),e.render(t,b),e.xr.enabled=i,e.shadowMap.autoUpdate=l,e.setRenderTarget(o);const w=r.viewport;void 0!==w&&e.state.viewport(w),n.visible=!0},this.getRenderTarget=function(){return A}}}qr.prototype.isReflector=!0,qr.ReflectorShader={uniforms:{color:{value:null},tDiffuse:{value:null},textureMatrix:{value:null}},vertexShader:"\n\t\tuniform mat4 textureMatrix;\n\t\tvarying vec4 vUv;\n\n\t\t#include <common>\n\t\t#include <logdepthbuf_pars_vertex>\n\n\t\tvoid main() {\n\n\t\t\tvUv = textureMatrix * vec4( position, 1.0 );\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t\t#include <logdepthbuf_vertex>\n\n\t\t}",fragmentShader:"\n\t\tuniform vec3 color;\n\t\tuniform sampler2D tDiffuse;\n\t\tvarying vec4 vUv;\n\n\t\t#include <logdepthbuf_pars_fragment>\n\n\t\tfloat blendOverlay( float base, float blend ) {\n\n\t\t\treturn( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );\n\n\t\t}\n\n\t\tvec3 blendOverlay( vec3 base, vec3 blend ) {\n\n\t\t\treturn vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#include <logdepthbuf_fragment>\n\n\t\t\tvec4 base = texture2DProj( tDiffuse, vUv );\n\t\t\tgl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );\n\n\t\t}"};class Yr extends r.Mesh{constructor(e,t={}){super(e),this.type="Refractor";const n=this,s=void 0!==t.color?new r.Color(t.color):new r.Color(8355711),o=t.textureWidth||512,i=t.textureHeight||512,a=t.clipBias||0,l=t.shader||Yr.RefractorShader,c=new r.PerspectiveCamera;c.matrixAutoUpdate=!1,c.userData.refractor=!0;const h=new r.Plane,u=new r.Matrix4,d={minFilter:r.LinearFilter,magFilter:r.LinearFilter,format:r.RGBFormat},p=new r.WebGLRenderTarget(o,i,d);r.MathUtils.isPowerOfTwo(o)&&r.MathUtils.isPowerOfTwo(i)||(p.texture.generateMipmaps=!1),this.material=new r.ShaderMaterial({uniforms:r.UniformsUtils.clone(l.uniforms),vertexShader:l.vertexShader,fragmentShader:l.fragmentShader,transparent:!0}),this.material.uniforms.color.value=s,this.material.uniforms.tDiffuse.value=p.texture,this.material.uniforms.textureMatrix.value=u;const m=function(){const e=new r.Vector3,t=new r.Vector3,s=new r.Matrix4,o=new r.Vector3,i=new r.Vector3;return function(r){return e.setFromMatrixPosition(n.matrixWorld),t.setFromMatrixPosition(r.matrixWorld),o.subVectors(e,t),s.extractRotation(n.matrixWorld),i.set(0,0,1),i.applyMatrix4(s),o.dot(i)<0}}(),f=function(){const e=new r.Vector3,t=new r.Vector3,s=new r.Quaternion,o=new r.Vector3;return function(){n.matrixWorld.decompose(t,s,o),e.set(0,0,1).applyQuaternion(s).normalize(),e.negate(),h.setFromNormalAndCoplanarPoint(e,t)}}(),g=function(){const e=new r.Plane,t=new r.Vector4,n=new r.Vector4;return function(r){c.matrixWorld.copy(r.matrixWorld),c.matrixWorldInverse.copy(c.matrixWorld).invert(),c.projectionMatrix.copy(r.projectionMatrix),c.far=r.far,e.copy(h),e.applyMatrix4(c.matrixWorldInverse),t.set(e.normal.x,e.normal.y,e.normal.z,e.constant);const s=c.projectionMatrix;n.x=(Math.sign(t.x)+s.elements[8])/s.elements[0],n.y=(Math.sign(t.y)+s.elements[9])/s.elements[5],n.z=-1,n.w=(1+s.elements[10])/s.elements[14],t.multiplyScalar(2/t.dot(n)),s.elements[2]=t.x,s.elements[6]=t.y,s.elements[10]=t.z+1-a,s.elements[14]=t.w}}();this.onBeforeRender=function(e,t,r){p.texture.encoding=e.outputEncoding,!0!==r.userData.refractor&&1!=!m(r)&&(f(),function(e){u.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),u.multiply(e.projectionMatrix),u.multiply(e.matrixWorldInverse),u.multiply(n.matrixWorld)}(r),g(r),function(e,t,r){n.visible=!1;const s=e.getRenderTarget(),o=e.xr.enabled,i=e.shadowMap.autoUpdate;e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(p),!1===e.autoClear&&e.clear(),e.render(t,c),e.xr.enabled=o,e.shadowMap.autoUpdate=i,e.setRenderTarget(s);const a=r.viewport;void 0!==a&&e.state.viewport(a),n.visible=!0}(e,t,r))},this.getRenderTarget=function(){return p}}}Yr.prototype.isRefractor=!0,Yr.RefractorShader={uniforms:{color:{value:null},tDiffuse:{value:null},textureMatrix:{value:null}},vertexShader:"\n\n\t\tuniform mat4 textureMatrix;\n\n\t\tvarying vec4 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = textureMatrix * vec4( position, 1.0 );\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform vec3 color;\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec4 vUv;\n\n\t\tfloat blendOverlay( float base, float blend ) {\n\n\t\t\treturn( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );\n\n\t\t}\n\n\t\tvec3 blendOverlay( vec3 base, vec3 blend ) {\n\n\t\t\treturn vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvec4 base = texture2DProj( tDiffuse, vUv );\n\t\t\tgl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );\n\n\t\t}"};class Kr extends r.Mesh{constructor(e,t={}){super(e),this.type="Water";const n=this,s=void 0!==t.color?new r.Color(t.color):new r.Color(16777215),o=t.textureWidth||512,i=t.textureHeight||512,a=t.clipBias||0,l=t.flowDirection||new r.Vector2(1,0),c=t.flowSpeed||.03,h=t.reflectivity||.02,u=t.scale||1,d=t.shader||Kr.WaterShader,p=void 0!==t.encoding?t.encoding:r.LinearEncoding,m=new r.TextureLoader,f=t.flowMap||void 0,g=t.normalMap0||m.load("textures/water/Water_1_M_Normal.jpg"),v=t.normalMap1||m.load("textures/water/Water_2_M_Normal.jpg"),y=.15,x=.075,b=new r.Matrix4,w=new r.Clock;if(void 0===qr)return void console.error("THREE.Water: Required component Reflector not found.");if(void 0===Yr)return void console.error("THREE.Water: Required component Refractor not found.");const A=new qr(e,{textureWidth:o,textureHeight:i,clipBias:a,encoding:p}),M=new Yr(e,{textureWidth:o,textureHeight:i,clipBias:a,encoding:p});A.matrixAutoUpdate=!1,M.matrixAutoUpdate=!1,this.material=new r.ShaderMaterial({uniforms:r.UniformsUtils.merge([r.UniformsLib.fog,d.uniforms]),vertexShader:d.vertexShader,fragmentShader:d.fragmentShader,transparent:!0,fog:!0}),void 0!==f?(this.material.defines.USE_FLOWMAP="",this.material.uniforms.tFlowMap={type:"t",value:f}):this.material.uniforms.flowDirection={type:"v2",value:l},g.wrapS=g.wrapT=r.RepeatWrapping,v.wrapS=v.wrapT=r.RepeatWrapping,this.material.uniforms.tReflectionMap.value=A.getRenderTarget().texture,this.material.uniforms.tRefractionMap.value=M.getRenderTarget().texture,this.material.uniforms.tNormalMap0.value=g,this.material.uniforms.tNormalMap1.value=v,this.material.uniforms.color.value=s,this.material.uniforms.reflectivity.value=h,this.material.uniforms.textureMatrix.value=b,this.material.uniforms.config.value.x=0,this.material.uniforms.config.value.y=x,this.material.uniforms.config.value.z=x,this.material.uniforms.config.value.w=u,this.onBeforeRender=function(e,t,r){!function(e){b.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),b.multiply(e.projectionMatrix),b.multiply(e.matrixWorldInverse),b.multiply(n.matrixWorld)}(r),function(){const e=w.getDelta(),t=n.material.uniforms.config;t.value.x+=c*e,t.value.y=t.value.x+x,t.value.x>=y?(t.value.x=0,t.value.y=x):t.value.y>=y&&(t.value.y=t.value.y-y)}(),n.visible=!1,A.matrixWorld.copy(n.matrixWorld),M.matrixWorld.copy(n.matrixWorld),A.onBeforeRender(e,t,r),M.onBeforeRender(e,t,r),n.visible=!0}}}Kr.prototype.isWater=!0,Kr.WaterShader={uniforms:{color:{type:"c",value:null},reflectivity:{type:"f",value:0},tReflectionMap:{type:"t",value:null},tRefractionMap:{type:"t",value:null},tNormalMap0:{type:"t",value:null},tNormalMap1:{type:"t",value:null},textureMatrix:{type:"m4",value:null},config:{type:"v4",value:new r.Vector4}},vertexShader:"\n\n\t\t#include <common>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\n\t\tuniform mat4 textureMatrix;\n\n\t\tvarying vec4 vCoord;\n\t\tvarying vec2 vUv;\n\t\tvarying vec3 vToEye;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tvCoord = textureMatrix * vec4( position, 1.0 );\n\n\t\t\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n\t\t\tvToEye = cameraPosition - worldPosition.xyz;\n\n\t\t\tvec4 mvPosition =  viewMatrix * worldPosition; // used in fog_vertex\n\t\t\tgl_Position = projectionMatrix * mvPosition;\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}",fragmentShader:"\n\n\t\t#include <common>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\n\t\tuniform sampler2D tReflectionMap;\n\t\tuniform sampler2D tRefractionMap;\n\t\tuniform sampler2D tNormalMap0;\n\t\tuniform sampler2D tNormalMap1;\n\n\t\t#ifdef USE_FLOWMAP\n\t\t\tuniform sampler2D tFlowMap;\n\t\t#else\n\t\t\tuniform vec2 flowDirection;\n\t\t#endif\n\n\t\tuniform vec3 color;\n\t\tuniform float reflectivity;\n\t\tuniform vec4 config;\n\n\t\tvarying vec4 vCoord;\n\t\tvarying vec2 vUv;\n\t\tvarying vec3 vToEye;\n\n\t\tvoid main() {\n\n\t\t\t#include <logdepthbuf_fragment>\n\n\t\t\tfloat flowMapOffset0 = config.x;\n\t\t\tfloat flowMapOffset1 = config.y;\n\t\t\tfloat halfCycle = config.z;\n\t\t\tfloat scale = config.w;\n\n\t\t\tvec3 toEye = normalize( vToEye );\n\n\t\t\t// determine flow direction\n\t\t\tvec2 flow;\n\t\t\t#ifdef USE_FLOWMAP\n\t\t\t\tflow = texture2D( tFlowMap, vUv ).rg * 2.0 - 1.0;\n\t\t\t#else\n\t\t\t\tflow = flowDirection;\n\t\t\t#endif\n\t\t\tflow.x *= - 1.0;\n\n\t\t\t// sample normal maps (distort uvs with flowdata)\n\t\t\tvec4 normalColor0 = texture2D( tNormalMap0, ( vUv * scale ) + flow * flowMapOffset0 );\n\t\t\tvec4 normalColor1 = texture2D( tNormalMap1, ( vUv * scale ) + flow * flowMapOffset1 );\n\n\t\t\t// linear interpolate to get the final normal color\n\t\t\tfloat flowLerp = abs( halfCycle - flowMapOffset0 ) / halfCycle;\n\t\t\tvec4 normalColor = mix( normalColor0, normalColor1, flowLerp );\n\n\t\t\t// calculate normal vector\n\t\t\tvec3 normal = normalize( vec3( normalColor.r * 2.0 - 1.0, normalColor.b,  normalColor.g * 2.0 - 1.0 ) );\n\n\t\t\t// calculate the fresnel term to blend reflection and refraction maps\n\t\t\tfloat theta = max( dot( toEye, normal ), 0.0 );\n\t\t\tfloat reflectance = reflectivity + ( 1.0 - reflectivity ) * pow( ( 1.0 - theta ), 5.0 );\n\n\t\t\t// calculate final uv coords\n\t\t\tvec3 coord = vCoord.xyz / vCoord.w;\n\t\t\tvec2 uv = coord.xy + coord.z * normal.xz * 0.05;\n\n\t\t\tvec4 reflectColor = texture2D( tReflectionMap, vec2( 1.0 - uv.x, uv.y ) );\n\t\t\tvec4 refractColor = texture2D( tRefractionMap, uv );\n\n\t\t\t// multiply water color with the mix of both textures\n\t\t\tgl_FragColor = vec4( color, 1.0 ) * mix( refractColor, reflectColor, reflectance );\n\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}"};class $r{constructor(e,t,n){this.scene=e,this.renderer=t,this.factories=n}water(e={}){((e,t,n={})=>{const{width:s=20,height:o=20,x:i=0,y:a=0,z:l=0,color:c="#ffffff",scale:h=4,flowX:u=1,flowY:d=1,normalMap0:p,normalMap1:m}=n,f=new r.PlaneBufferGeometry(s,o),g=new r.MeshStandardMaterial({color:30654,transparent:!0,opacity:.8}),v=new r.Mesh(f,g);v.position.set(i,a,l),v.rotation.x=-.5*Math.PI,e.add(v);const y=new r.PlaneBufferGeometry(s,o),x=new Kr(y,{color:c,scale:h,flowDirection:new r.Vector2(u,d),textureWidth:1024,textureHeight:1024,normalMap0:p,normalMap1:m,encoding:t.outputEncoding});x.position.set(i,a+.1,l),x.rotation.x=-.5*Math.PI,e.add(x)})(this.scene,this.renderer,e)}textureCube(e){6!==e.length&&l("You need to pass 6 urls to textureCube()");const t=new Qr;return e.forEach(((e,n)=>{e.wrapS=e.wrapT=r.RepeatWrapping;const s=this.factories.add.material({phong:{map:e}});t.materials[n]=s})),t}}class Qr{constructor(){this.materials=new Array(6)}get texture(){return{left:this.getTexture(0),right:this.getTexture(1),up:this.getTexture(2),down:this.getTexture(3),front:this.getTexture(4),back:this.getTexture(5)}}getTexture(e){return this.materials[e].map}}class Zr{constructor(e,t){this.camera=e,this.renderer=t}static geometryToBufferGeometry(e){return e.isGeometry?Fr(new r.BufferGeometry,e):e}static bufferGeometryToGeometry(e){return e.isBufferGeometry?(new Or).fromBufferGeometry(e):e}fromSVGtoShape(e,t=!1,n){if(e){const r=new Er,s=[];return r.parse(e).paths.forEach((e=>{e.toShapes(t,n).forEach((e=>{s.push(e)}))})),s}return[]}from3dto2d(e){const t=new r.Vector3(e.x,e.y,e.z),n=this.renderer.domElement;this.camera.updateMatrixWorld(),t.project(this.camera);const s=Math.round((t.x+1)*(n.width/2)),o=Math.round((1-t.y)*(n.height/2));return new r.Vector2(s,o)}from2dto3d(e,t,n){var s;if(!this.tmpPlane){const e=new r.PlaneBufferGeometry(1e4,1e4),t=new r.MeshBasicMaterial({transparent:!0,opacity:.25});this.tmpPlane=new r.Mesh(e,t),this.tmpPlane.name="_tmp_raycast_plane"}let o;this.tmpRaycaster||(this.tmpRaycaster=new r.Raycaster),this.tmpVector3||(this.tmpVector3=new r.Vector3),this.tmpPlane.setRotationFromEuler(this.camera.rotation);const i=this.camera.position;this.tmpPlane.position.set(i.x,i.y,i.z),this.camera.getWorldDirection(this.tmpVector3),this.tmpPlane.position.add(this.tmpVector3.clone().multiplyScalar(n)),this.tmpPlane.updateMatrix(),this.tmpPlane.updateMatrixWorld(!0),this.tmpRaycaster.setFromCamera({x:e,y:t},this.camera);const a=this.tmpRaycaster.intersectObjects([this.tmpPlane]);return"_tmp_raycast_plane"===(null===(s=a[0])||void 0===s?void 0:s.object.name)&&(o=a[0].point),o}}const Jr={Handedness:Object.freeze({NONE:"none",LEFT:"left",RIGHT:"right"}),ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})};async function es(e){const t=await fetch(e);if(t.ok)return t.json();throw new Error(t.statusText)}const ts={xAxis:0,yAxis:0,button:0,state:Jr.ComponentState.DEFAULT};class ns{constructor(e){this.componentProperty=e.componentProperty,this.states=e.states,this.valueNodeName=e.valueNodeName,this.valueNodeProperty=e.valueNodeProperty,this.valueNodeProperty===Jr.VisualResponseProperty.TRANSFORM&&(this.minNodeName=e.minNodeName,this.maxNodeName=e.maxNodeName),this.value=0,this.updateFromComponent(ts)}updateFromComponent({xAxis:e,yAxis:t,button:n,state:r}){const{normalizedXAxis:s,normalizedYAxis:o}=function(e=0,t=0){let n=e,r=t;if(Math.sqrt(e*e+t*t)>1){const s=Math.atan2(t,e);n=Math.cos(s),r=Math.sin(s)}return{normalizedXAxis:.5*n+.5,normalizedYAxis:.5*r+.5}}(e,t);switch(this.componentProperty){case Jr.ComponentProperty.X_AXIS:this.value=this.states.includes(r)?s:.5;break;case Jr.ComponentProperty.Y_AXIS:this.value=this.states.includes(r)?o:.5;break;case Jr.ComponentProperty.BUTTON:this.value=this.states.includes(r)?n:0;break;case Jr.ComponentProperty.STATE:this.valueNodeProperty===Jr.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(r):this.value=this.states.includes(r)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}class rs{constructor(e,t){if(!(e&&t&&t.visualResponses&&t.gamepadIndices&&0!==Object.keys(t.gamepadIndices).length))throw new Error("Invalid arguments supplied");this.id=e,this.type=t.type,this.rootNodeName=t.rootNodeName,this.touchPointNodeName=t.touchPointNodeName,this.visualResponses={},Object.keys(t.visualResponses).forEach((e=>{const n=new ns(t.visualResponses[e]);this.visualResponses[e]=n})),this.gamepadIndices=Object.assign({},t.gamepadIndices),this.values={state:Jr.ComponentState.DEFAULT,button:void 0!==this.gamepadIndices.button?0:void 0,xAxis:void 0!==this.gamepadIndices.xAxis?0:void 0,yAxis:void 0!==this.gamepadIndices.yAxis?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(e){if(this.values.state=Jr.ComponentState.DEFAULT,void 0!==this.gamepadIndices.button&&e.buttons.length>this.gamepadIndices.button){const t=e.buttons[this.gamepadIndices.button];this.values.button=t.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,t.pressed||1===this.values.button?this.values.state=Jr.ComponentState.PRESSED:(t.touched||this.values.button>Jr.ButtonTouchThreshold)&&(this.values.state=Jr.ComponentState.TOUCHED)}void 0!==this.gamepadIndices.xAxis&&e.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=e.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===Jr.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>Jr.AxisTouchThreshold&&(this.values.state=Jr.ComponentState.TOUCHED)),void 0!==this.gamepadIndices.yAxis&&e.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=e.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===Jr.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>Jr.AxisTouchThreshold&&(this.values.state=Jr.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach((e=>{e.updateFromComponent(this.values)}))}}class ss{constructor(e,t,n){if(!e)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No profile supplied");this.xrInputSource=e,this.assetUrl=n,this.id=t.profileId,this.layoutDescription=t.layouts[e.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach((e=>{const t=this.layoutDescription.components[e];this.components[e]=new rs(e,t)})),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const e=[];return Object.values(this.components).forEach((t=>{e.push(t.data)})),e}updateFromGamepad(){Object.values(this.components).forEach((e=>{e.updateFromGamepad(this.xrInputSource.gamepad)}))}}class os extends r.Object3D{constructor(){super(),this.motionController=null,this.envMap=null}setEnvironmentMap(e){return this.envMap==e||(this.envMap=e,this.traverse((e=>{e.isMesh&&(e.material.envMap=this.envMap,e.material.needsUpdate=!0)}))),this}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&(this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach((e=>{Object.values(e.visualResponses).forEach((e=>{const{valueNode:t,minNode:n,maxNode:r,value:s,valueNodeProperty:o}=e;t&&(o===Jr.VisualResponseProperty.VISIBILITY?t.visible=s:o===Jr.VisualResponseProperty.TRANSFORM&&(t.quaternion.slerpQuaternions(n.quaternion,r.quaternion,s),t.position.lerpVectors(n.position,r.position,s)))}))})))}}function is(e,t){!function(e,t){Object.values(e.components).forEach((e=>{const{type:n,touchPointNodeName:s,visualResponses:o}=e;if(n===Jr.ComponentType.TOUCHPAD)if(e.touchPointNode=t.getObjectByName(s),e.touchPointNode){const t=new r.SphereGeometry(.001),n=new r.MeshBasicMaterial({color:255}),s=new r.Mesh(t,n);e.touchPointNode.add(s)}else console.warn(`Could not find touch dot, ${e.touchPointNodeName}, in touchpad component ${e.id}`);Object.values(o).forEach((e=>{const{valueNodeName:n,minNodeName:r,maxNodeName:s,valueNodeProperty:o}=e;if(o===Jr.VisualResponseProperty.TRANSFORM){if(e.minNode=t.getObjectByName(r),e.maxNode=t.getObjectByName(s),!e.minNode)return void console.warn(`Could not find ${r} in the model`);if(!e.maxNode)return void console.warn(`Could not find ${s} in the model`)}e.valueNode=t.getObjectByName(n),e.valueNode||console.warn(`Could not find ${n} in the model`)}))}))}(e.motionController,t),e.envMap&&t.traverse((t=>{t.isMesh&&(t.material.envMap=e.envMap,t.material.needsUpdate=!0)})),e.add(t)}class as{constructor(e=null){this.gltfLoader=e,this.path="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",this._assetCache={},this.gltfLoader||(this.gltfLoader=new Wn)}createControllerModel(e){const t=new os;let n=null;return e.addEventListener("connected",(e=>{const r=e.data;"tracked-pointer"===r.targetRayMode&&r.gamepad&&async function(e,t,n=null,r=!0){if(!e)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No basePath supplied");const s=await async function(e){if(!e)throw new Error("No basePath supplied");return await es(`${e}/profilesList.json`)}(t);let o;if(e.profiles.some((e=>{const n=s[e];return n&&(o={profileId:e,profilePath:`${t}/${n.path}`,deprecated:!!n.deprecated}),!!o})),!o){if(!n)throw new Error("No matching profile name found");const e=s[n];if(!e)throw new Error(`No matching profile name found and default profile "${n}" missing.`);o={profileId:n,profilePath:`${t}/${e.path}`,deprecated:!!e.deprecated}}const i=await es(o.profilePath);let a;if(r){let t;if(t="any"===e.handedness?i.layouts[Object.keys(i.layouts)[0]]:i.layouts[e.handedness],!t)throw new Error(`No matching handedness, ${e.handedness}, in profile ${o.profileId}`);t.assetPath&&(a=o.profilePath.replace("profile.json",t.assetPath))}return{profile:i,assetPath:a}}(r,this.path,"generic-trigger").then((({profile:e,assetPath:s})=>{t.motionController=new ss(r,e,s);const o=this._assetCache[t.motionController.assetUrl];if(o)n=o.scene.clone(),is(t,n);else{if(!this.gltfLoader)throw new Error("GLTFLoader not set.");this.gltfLoader.setPath(""),this.gltfLoader.load(t.motionController.assetUrl,(e=>{this._assetCache[t.motionController.assetUrl]=e,n=e.scene.clone(),is(t,n)}),null,(()=>{throw new Error(`Asset ${t.motionController.assetUrl} missing or malformed.`)}))}})).catch((e=>{console.warn(e)}))})),e.addEventListener("disconnected",(()=>{t.motionController=null,t.remove(n),n=null})),t}}class ls{constructor(e,t,n){this._renderer=e,this._scene=t,this._camera=n,this.controllerModelFactory=new as,this.cameraGroup=new r.Group,this.cameraGroup.add(n),t.add(this.cameraGroup),e.xr.enabled=!0;const s=class{static createButton(e,t){t&&console.error('THREE.VRButton: The "options" parameter has been removed. Please set the reference space type via renderer.xr.setReferenceSpaceType() instead.');const n=document.createElement("button");function r(e){e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="rgba(0,0,0,0.1)",e.style.color="#fff",e.style.font="normal 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.5",e.style.outline="none",e.style.zIndex="999"}if("xr"in navigator)return n.id="VRButton",n.style.display="none",r(n),navigator.xr.isSessionSupported("immersive-vr").then((function(t){t?function(){let t=null;async function r(r){r.addEventListener("end",s),await e.xr.setSession(r),n.textContent="EXIT VR",t=r}function s(){t.removeEventListener("end",s),n.textContent="ENTER VR",t=null}n.style.display="",n.style.cursor="pointer",n.style.left="calc(50% - 50px)",n.style.width="100px",n.textContent="ENTER VR",n.onmouseenter=function(){n.style.opacity="1.0"},n.onmouseleave=function(){n.style.opacity="0.5"},n.onclick=function(){if(null===t){const e={optionalFeatures:["local-floor","bounded-floor","hand-tracking","layers"]};navigator.xr.requestSession("immersive-vr",e).then(r)}else t.end()}}():(n.style.display="",n.style.cursor="auto",n.style.left="calc(50% - 75px)",n.style.width="150px",n.onmouseenter=null,n.onmouseleave=null,n.onclick=null,n.textContent="VR NOT SUPPORTED")})),n;{const e=document.createElement("a");return!1===window.isSecureContext?(e.href=document.location.href.replace(/^http:/,"https:"),e.innerHTML="WEBXR NEEDS HTTPS"):(e.href="https://immersiveweb.dev/",e.innerHTML="WEBXR NOT AVAILABLE"),e.style.left="calc(50% - 90px)",e.style.width="180px",e.style.textDecoration="none",r(e),e}}}.createButton(e);s.style.cssText+="background: rgba(0, 0, 0, 0.8); ",document.body.appendChild(s)}get isPresenting(){var e,t;return!!(null===(t=null===(e=this._renderer)||void 0===e?void 0:e.xr)||void 0===t?void 0:t.isPresenting)}getController(e){const t=this._renderer.xr.getController(e);return this.cameraGroup.add(t),t}getControllerGrip(e){const t=this._renderer.xr.getControllerGrip(e),n=this.controllerModelFactory.createControllerModel(t);return t.add(n),this.cameraGroup.add(t),t}getControllerRay(e){const{targetRayMode:t}=e;if("tracked-pointer"===t){const e=new r.BufferGeometry;e.setAttribute("position",new r.Float32BufferAttribute([0,0,0,0,0,-1],3)),e.setAttribute("color",new r.Float32BufferAttribute([1,0,0,1,1,1],3));const t=new r.LineBasicMaterial({vertexColors:!0});return new r.Line(e,t)}if("gaze"===t){const e=new r.RingBufferGeometry(.02,.04,32).translate(0,0,-1),t=new r.MeshBasicMaterial({color:"red",opacity:.5,transparent:!0});return new r.Mesh(e,t)}}get camera(){return this.WebXRCamera}get WebXRCamera(){var e;return{group:this.cameraGroup,position:null===(e=this.cameraGroup)||void 0===e?void 0:e.position,rotation:this.isPresenting?this._renderer.xr.getCamera(this._camera).rotation:void 0,getWorldDirection:e=>this.isPresenting?this._renderer.xr.getCamera(this._camera).getWorldDirection(e):void 0}}}class cs{constructor(e,t,n,s,o,i=0){this.a=e,this.b=t,this.c=n,this.normal=s&&s.isVector3?s:new r.Vector3,this.vertexNormals=Array.isArray(s)?s:[],this.color=o&&o.isColor?o:new r.Color,this.vertexColors=Array.isArray(o)?o:[],this.materialIndex=i}clone(){return(new this.constructor).copy(this)}copy(e){this.a=e.a,this.b=e.b,this.c=e.c,this.normal.copy(e.normal),this.color.copy(e.color),this.materialIndex=e.materialIndex;for(let t=0,n=e.vertexNormals.length;t<n;t++)this.vertexNormals[t]=e.vertexNormals[t].clone();for(let t=0,n=e.vertexColors.length;t<n;t++)this.vertexColors[t]=e.vertexColors[t].clone();return this}}class hs{static toGeometry(e,t){e.geometry=Zr.bufferGeometryToGeometry(e.geometry),t.geometry=Zr.bufferGeometryToGeometry(t.geometry)}static toBufferGeometry(e){e.geometry=Zr.geometryToBufferGeometry(e.geometry)}static union(e,t){this.toGeometry(e,t);const n=this.doCSG(e,t,"union");return this.toBufferGeometry(n),n}static subtract(e,t){this.toGeometry(e,t);const n=this.doCSG(e,t,"subtract");return this.toBufferGeometry(n),n}static intersect(e,t){this.toGeometry(e,t);const n=this.doCSG(e,t,"intersect");return this.toBufferGeometry(n),n}static doCSG(e,t,n){e.updateMatrix(),t.updateMatrix();const r=us.fromMesh(e),s=us.fromMesh(t),o=r[n](s);return us.toMesh(o,e.matrix)}}class us{constructor(){this.polygons=[]}static fromPolygons(e){const t=new us;return t.polygons=e,t}static fromGeometry(e){e.isBufferGeometry&&(e=(new Or).fromBufferGeometry(e));const t=e.faces,n=e.vertices,r=[],s=["a","b","c"];for(let o=0;o<t.length;o++){const i=t[o],a=[];for(let t=0;t<3;t++){const r=void 0!==e.faceVertexUvs[0][o]&&void 0!==e.faceVertexUvs[0][o][t]?e.faceVertexUvs[0][o][t]:void 0;a.push(new ps(n[i[s[t]]],i.vertexNormals[t],r))}r.push(new fs(a))}return us.fromPolygons(r)}static fromMesh(e){const t=us.fromGeometry(e.geometry);us._tmpm3.getNormalMatrix(e.matrix);for(const n of t.polygons)for(const t of n.vertices)t.pos.applyMatrix4(e.matrix),t.normal.applyMatrix3(us._tmpm3);return t}static toMesh(e,t){const n=new Or,s=e.polygons,o=n.vertices,i=n.faceVertexUvs[0];for(const e of s){const t=e.vertices,s=o.length,a=t.length;for(const e of t)o.push((new r.Vector3).copy(e.pos));for(let o=3;o<=a;o++){const a=new cs(s,s+o-2,s+o-1),l=[];i.push(l);const c=a.vertexNormals;c.push((new r.Vector3).copy(t[0].normal)),c.push((new r.Vector3).copy(t[o-2].normal)),c.push((new r.Vector3).copy(t[o-1].normal)),t[0].uv&&t[o-2].uv&&t[o-1].uv&&(l.push((new r.Vector3).copy(t[0].uv)),l.push((new r.Vector3).copy(t[o-2].uv)),l.push((new r.Vector3).copy(t[o-1].uv))),a.normal=(new r.Vector3).copy(e.plane.normal),n.faces.push(a)}}const a=parseInt(r.REVISION)>=123?(new r.Matrix4).copy(t).invert():(new r.Matrix4).getInverse(t);n.applyMatrix4(a),n.verticesNeedUpdate=n.elementsNeedUpdate=n.normalsNeedUpdate=!0,n.computeBoundingSphere(),n.computeBoundingBox();const l=new r.Mesh(n);return l.matrix.copy(t),l.matrix.decompose(l.position,l.rotation,l.scale),l.updateMatrixWorld(),l}static iEval(e,t=0){var n;if("string"==typeof e)us.currentOp=e;else if(e instanceof Array)for(const t of e)us.iEval(t,0);else if("object"==typeof e){const t=us.currentOp;e.updateMatrix(),e.updateMatrixWorld(),us.sourceMesh?(us.nextPrim=us.fromMesh(e),us.currentPrim=us.currentPrim[t](us.nextPrim)):us.currentPrim=us.fromMesh(us.sourceMesh=e),us.doRemove&&(null===(n=null==e?void 0:e.parent)||void 0===n||n.remove(e))}}static eval(e,t){delete us.currentOp,delete us.sourceMesh,us.doRemove=t,us.iEval(e);const n=us.toMesh(us.currentPrim,us.sourceMesh.matrix);return n.material=us.sourceMesh.material,n.castShadow=n.receiveShadow=!0,n}clone(){const e=new us;return e.polygons=this.polygons.map((e=>e.clone())),e}toPolygons(){return this.polygons}union(e){const t=new gs(this.clone().polygons),n=new gs(e.clone().polygons);return t.clipTo(n),n.clipTo(t),n.invert(),n.clipTo(t),n.invert(),t.build(n.allPolygons()),us.fromPolygons(t.allPolygons())}subtract(e){const t=new gs(this.clone().polygons),n=new gs(e.clone().polygons);return t.invert(),t.clipTo(n),n.clipTo(t),n.invert(),n.clipTo(t),n.invert(),t.build(n.allPolygons()),t.invert(),us.fromPolygons(t.allPolygons())}intersect(e){const t=new gs(this.clone().polygons),n=new gs(e.clone().polygons);return t.invert(),n.clipTo(t),n.invert(),t.clipTo(n),n.clipTo(t),t.build(n.allPolygons()),t.invert(),us.fromPolygons(t.allPolygons())}inverse(){const e=this.clone();return e.polygons.map((e=>{e.flip()})),e}}us._tmpm3=new r.Matrix3;class ds extends r.Vector3{constructor(e,t,n){if(3===arguments.length)super(e,t,n);else if(Array.isArray(e))super(e[0],e[1],e[2]);else{if("object"!=typeof e)throw new Error("Invalid constructor to vector");this.copy(e)}}clone(){return new ds(this.x,this.y,this.z)}negated(){return this.clone().multiplyScalar(-1)}plus(e){return this.clone().add(e)}minus(e){return this.clone().sub(e)}times(e){return this.clone().multiplyScalar(e)}dividedBy(e){return this.clone().divideScalar(e)}lerp(e,t){return this.plus(e.minus(this).times(t))}unit(){return this.dividedBy(this.length())}cross(e,t){return r.Vector3.prototype.cross.call(this.clone(),e)}}class ps{constructor(e,t,n){this.pos=new ds(e.x,e.y,e.z),this.normal=new ds(t.x,t.y,t.z),n&&(this.uv=new ds(n.x,n.y,n.z))}clone(){return new ps(this.pos.clone(),this.normal.clone(),this.uv?this.uv.clone():void 0)}flip(){this.normal=this.normal.negated()}interpolate(e,t){return new ps(this.pos.lerp(e.pos,t),this.normal.lerp(e.normal,t),this.uv?this.uv.lerp(e.uv,t):void 0)}}class ms{constructor(e,t){this.normal=e,this.w=t}static fromPoints(e,t,n){const r=t.minus(e).cross(n.minus(e)).unit();return new ms(r,r.dot(e))}clone(){return new ms(this.normal.clone(),this.w)}flip(){this.normal=this.normal.negated(),this.w=-this.w}splitPolygon(e,t,n,r,s){let o=0;const i=[];for(const t of e.vertices){const e=this.normal.dot(t.pos)-this.w,n=e<-ms.EPSILON?2:e>ms.EPSILON?1:0;o|=n,i.push(n)}switch(o){case 0:this.normal.dot(e.plane.normal)>0?t.push(e):n.push(e);break;case 1:r.push(e);break;case 2:s.push(e);break;case 3:const o=[],a=[];for(let t=0;t<e.vertices.length;t++){const n=(t+1)%e.vertices.length,r=i[t],s=i[n],l=e.vertices[t],c=e.vertices[n];if(2!==r&&o.push(l),1!==r&&a.push(2!==r?l.clone():l),3==(r|s)){const e=(this.w-this.normal.dot(l.pos))/this.normal.dot(c.pos.minus(l.pos)),t=l.interpolate(c,e);o.push(t),a.push(t.clone())}}o.length>=3&&r.push(new fs(o,e.shared)),a.length>=3&&s.push(new fs(a,e.shared))}}}ms.EPSILON=1e-5;class fs{constructor(e,t=null){this.vertices=e,this.shared=t,this.plane=ms.fromPoints(e[0].pos,e[1].pos,e[2].pos)}clone(){const e=this.vertices.map((e=>e.clone()));return new fs(e,this.shared)}flip(){this.vertices.reverse().map((e=>{e.flip()})),this.plane.flip()}}class gs{constructor(e){delete this.plane,delete this.front,delete this.back,this.polygons=[],e&&this.build(e)}clone(){const e=new gs;return e.plane=this.plane&&this.plane.clone(),e.front=this.front&&this.front.clone(),e.back=this.back&&this.back.clone(),e.polygons=this.polygons.map((e=>e.clone())),e}invert(){for(const e of this.polygons)e.flip();this.plane.flip(),this.front&&this.front.invert(),this.back&&this.back.invert();const e=this.front;this.front=this.back,this.back=e}clipPolygons(e){if(!this.plane)return e.slice();let t=[],n=[];for(const r of e)this.plane.splitPolygon(r,t,n,t,n);return this.front&&(t=this.front.clipPolygons(t)),n=this.back?this.back.clipPolygons(n):[],t.concat(n)}clipTo(e){this.polygons=e.clipPolygons(this.polygons),this.front&&this.front.clipTo(e),this.back&&this.back.clipTo(e)}allPolygons(){let e=this.polygons.slice();return this.front&&(e=e.concat(this.front.allPolygons())),this.back&&(e=e.concat(this.back.allPolygons())),e}build(e){if(!e.length)return;this.plane||(this.plane=e[0].plane.clone());const t=[],n=[];for(const r of e)this.plane.splitPolygon(r,this.polygons,this.polygons,t,n);t.length&&(this.front||(this.front=new gs),this.front.build(t)),n.length&&(this.back||(this.back=new gs),this.back.build(n))}}var vs=o(298);class ys extends vs.Scene{constructor(e){super(e)}warpSpeesd(...e){return t=this,n=void 0,s=function*(){return yield this.third.warpSpeed(...e)},new((r=void 0)||(r=Promise))((function(e,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}l((s=s.apply(t,n||[])).next())}));var t,n,r,s}haveSomeFun(e=20){this.third.haveSomeFun(e)}requestThirdDimension(){l("You do not need requestThirdDimension() anymore. Place accessThirdDimension() inside init() instead!")}clearThirdDimension(){for(const e in this.third)delete this.third[e];delete this.third}accessThirdDimension(e={}){this.clearThirdDimension(),this.third=new class extends class{constructor(e={}){this.threeGraphicsConfig=e;const{alpha:t=!1,anisotropy:n=1,camera:o=s.Perspective({z:25,y:5}),antialias:i=!1,usePhysics:a=!0,renderer:c}=e;this.textureAnisotropy=n,this.camera=o,this.scene=new r.Scene,this.renderer=c||new r.WebGLRenderer({antialias:i,alpha:t}),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=r.PCFSoftShadowMap,this.cache=r.Cache,this.cache.enabled=!0,a&&("undefined"!=typeof Ammo?this.physics=new Z(this.scene,e):l("Are you sure you included ammo.js?"))}}{constructor(e,t={}){var n;const o=document.getElementById("enable3d-three-canvas");let i={};o&&(i={canvas:o}),t.renderer=new r.WebGLRenderer(Object.assign(Object.assign({},i),{antialias:t.antialias||!1})),super(t),null===(n=e.sys.game.canvas.parentElement)||void 0===n||n.insertBefore(t.renderer.domElement,e.sys.game.canvas),e.sys.game.canvas.style.position="relative";const a=()=>{var n,r;if(!t.renderer)return;const{width:s,height:o,marginLeft:i,marginTop:a}=e.sys.game.canvas.style;t.renderer.domElement.id="enable3d-three-canvas",null===(n=this.camera)||void 0===n||(n.aspect=e.sys.game.scale.baseSize.width/e.sys.game.scale.baseSize.height),null===(r=this.camera)||void 0===r||r.updateProjectionMatrix(),t.renderer.setSize(e.sys.game.scale.baseSize.width,e.sys.game.scale.baseSize.height),t.renderer.domElement.style.width=s,t.renderer.domElement.style.height=o,t.renderer.domElement.style.marginLeft=i,t.renderer.domElement.style.marginTop=a};a(),e.scale.on("resize",(()=>{a()}));const l=document.createElement("style");l.innerText="\n      #enable3d-phaser-canvas:focus,\n      #enable3d-three-canvas:focus {\n        outline: none;\n      }\n\n      #enable3d-three-canvas {\n        position: absolute;\n      }\n    ",document.head.appendChild(l);const{enableXR:c=!1}=t;if(this.isXrEnabled=c,this.scene3D=e,c&&(this.webXR=new ls(this.renderer,this.scene,this.camera)),this.isXrEnabled){let t=0;this.renderer.setAnimationLoop((n=>{if(this.renderer.xr.isPresenting){const r=n-t;t=n,e.updateLoopXR(n,r),this.renderer.state.reset(),this.preRender(),this.composer?this.composer.render():this.renderer.render(this.scene,this.camera),this.postRender()}}))}e.add.extern().render=e=>{this.renderer.xr.isPresenting||(this.preRender(),this.composer?this.composer.render():this.renderer.render(this.scene,this.camera),this.postRender())},e.events.on("postupdate",((e,t)=>{var n,r,s;null===(n=this.animationMixers)||void 0===n||n.update(t),null===(r=this.physics)||void 0===r||r.update(t),null===(s=this.physics)||void 0===s||s.updateDebugger()})),this.load=new Cr(this.cache,this.textureAnisotropy),this.lights=new Lr(this.scene),this.transform=new Zr(this.camera,this.renderer),this.csg=hs,this.heightMap=new zr(this.scene),this.factories=new C(this.scene),this.misc=new $r(this.scene,this.renderer,this.factories),this.cameras=new s,this.ws=new Xr(this.scene,this.renderer,this.camera,this.lights,this.physics,this.load,this.factories),this.mixers=new class{constructor(){this._mixers=[]}animationMixer(e){const t=new r.AnimationMixer(e);return this.mixers.add(t),t}get mixers(){return{create:e=>this.animationMixer(e),add:e=>this._mixers.push(e),get:()=>this._mixers,update:e=>{var t;return null===(t=this._mixers)||void 0===t?void 0:t.forEach((t=>t.update(e/1e3)))}}}},e.events.once("shutdown",(()=>{e.clearThirdDimension(),e.events.removeListener("update")}))}preRender(){}postRender(){}destroy(e){var t;null===(t=this.physics)||void 0===t||t.destroy(e.body),this.scene.remove(e),e=null}warpSpeed(...e){return t=this,n=void 0,s=function*(){return yield this.ws.warpSpeed(...e)},new((r=void 0)||(r=Promise))((function(e,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}l((s=s.apply(t,n||[])).next())}));var t,n,r,s}haveSomeFun(e=20){((e=20,t)=>{if(window.__loadPhysics)for(let n=0;n<e;n++){const e=["standard","basic","normal","phong","line","points"],n=(e,t)=>Math.floor(Math.random()*(t-e+1)+e),r=e=>e[Math.floor(Math.random()*e.length)];Math.random()>.5?t.add.box({x:n(-10,10),y:n(10,20),z:n(-10,10),width:n(1,2)/10,height:n(1,2)/10,depth:n(1,2)/10,mass:1},{[r(e)]:{color:Math.floor(16777215*Math.random())}}).body.setRestitution(Math.floor(10*Math.random())/20):t.add.sphere({x:n(-10,10),y:n(10,20),z:n(-10,10),radius:n(1,2)/10,mass:1},{[r(e)]:{color:Math.floor(16777215*Math.random())}}).body.setRestitution(Math.floor(10*Math.random())/20)}else console.log("There is not much fun without physics enabled!")})(e,this.physics)}get animationMixers(){var e;return null===(e=this.mixers)||void 0===e?void 0:e.mixers}get make(){return this.factories.make}get add(){return this.factories.add}}(this,e),this.cameras.main.transparent=!0,this.cameras.main.setBackgroundColor("rgba(0,0,0,0)"),this.third.scene.background=new r.Color("white")}updateLoopXR(e,t){this.preUpdateXR(e,t),this.updateXR(e,t),this.postUpdateXR(e,t)}preUpdateXR(e,t){}updateXR(e,t){}postUpdateXR(e,t){this.third.isXrEnabled&&(this.time.update(e,t),this.third.physics.update(t),this.third.physics.updateDebugger(),this.third.animationMixers.update(t))}}window.__loadPhysics=!1,window.__ammoPath="";const xs=e=>(window.setTimeout((()=>{window.__loadPhysics?X(window.__ammoPath,(()=>{Ammo().then((()=>{e()}))})):e()}),50),{withPhysics(e){window.__loadPhysics=!0,window.__ammoPath=e}}),bs=(e={})=>{const{antialias:t=!0,parent:n,canvasId:r="enable3d-phaser-canvas"}=e,s=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");s.id=r;const o=n?document.getElementById(n):document.body;o?o.appendChild(s):l(`Parent "${n}" not found!`);const i={antialias:t},a={alpha:void 0===i.alpha||i.alpha,depth:void 0===i.depth||i.depth,stencil:void 0===i.stencil||i.stencil,antialias:void 0!==i.antialias&&i.antialias,premultipliedAlpha:void 0===i.premultipliedAlpha||i.premultipliedAlpha,preserveDrawingBuffer:void 0!==i.preserveDrawingBuffer&&i.preserveDrawingBuffer,powerPreference:void 0!==i.powerPreference?i.powerPreference:"default",failIfMajorPerformanceCaveat:void 0!==i.failIfMajorPerformanceCaveat&&i.failIfMajorPerformanceCaveat,xrCompatible:!0},c=Object.assign({},a),h=class{static isWebGLAvailable(){try{const e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}}static isWebGL2Available(){try{const e=document.createElement("canvas");return!(!window.WebGL2RenderingContext||!e.getContext("webgl2"))}catch(e){return!1}}static getWebGLErrorMessage(){return this.getErrorMessage(1)}static getWebGL2ErrorMessage(){return this.getErrorMessage(2)}static getErrorMessage(e){const t={1:window.WebGLRenderingContext,2:window.WebGL2RenderingContext};let n='Your $0 does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">$1</a>';const r=document.createElement("div");return r.id="webglmessage",r.style.fontFamily="monospace",r.style.fontSize="13px",r.style.fontWeight="normal",r.style.textAlign="center",r.style.background="#fff",r.style.color="#000",r.style.padding="1.5em",r.style.width="400px",r.style.margin="5em auto 0",n=t[e]?n.replace("$0","graphics card"):n.replace("$0","browser"),n=n.replace("$1",{1:"WebGL",2:"WebGL 2"}[e]),r.innerHTML=n,r}}.isWebGL2Available()?"webgl2":"webgl",u=s.getContext(h,c);return{canvas:s,context:u}};var ws=o(613);const As=[{name:"pointer",enabled:!0,test:"onpointerdown"in window,events:{down:"pointerdown",move:"pointermove",up:"pointerup"}},{name:"touch",enabled:!0,test:"ontouchstart"in window&&window.navigator.maxTouchPoints>=1,events:{down:"touchstart",move:"touchmove",up:"touchend"}},{name:"mouse",enabled:!0,test:"onmousedown"in window,events:{down:"mousedown",move:"mousemove",up:"mouseup"}}];class Ms{constructor(e){this._events=new ws.Events,this.domElement=null,this._isDown=!1,this._isPaused=!1,this.active={touch:!1,mouse:!1,pointer:!1},this.registered={touch:!1,mouse:!1,pointer:!1},this._currentPosition={x:-1,y:-1},this._lastPosition={x:-1,y:-1},this._isPointerLockAvailable="onpointerlockchange"in document,this._add(e)}static get VERSION(){return"0.0.3"}get isDown(){return this._isDown}set _position(e){e.x===this._currentPosition.x&&e.y==this._currentPosition.y||(this._lastPosition=this._currentPosition,this._currentPosition=e)}get currentPosition(){return this._currentPosition}get lastPosition(){return this._lastPosition}get isPaused(){return this._isPaused}pause(){this._isPaused=!0}resume(){this._isPaused=!1}_onPointerLockChange(){return new Promise((e=>{document.addEventListener("pointerlockchange",(t=>{e(t)}),{once:!0})}))}get pointerLock(){return{onceChange:this._onPointerLockChange,request:()=>new Promise(((e,t)=>this._isPointerLockAvailable?this.pointerLock.isLocked?t("Pointer is already locked!"):(this._onPointerLockChange().then((t=>{e(t)})),void this.once.down((()=>{var e;null===(e=this.domElement)||void 0===e||e.requestPointerLock()}))):t("PointerLock is not available!"))),exit:()=>new Promise(((e,t)=>{if(!this.pointerLock.isLocked)return t("Pointer is not locked!");this._onPointerLockChange().then((t=>{e(t)})),document.exitPointerLock()})),available:this._isPointerLockAvailable,isLocked:!!document.pointerLockElement}}get once(){return{down:e=>{this._events.once("down",(t=>{e(t)}))},move:e=>{this._events.once("move",(t=>{e(t)}))},up:e=>{this._events.once("up",(t=>{e(t)}))}}}get on(){return{down:e=>{this._events.on("down",(t=>{this._isPaused||e(t)}))},move:e=>{this._events.on("move",(t=>{this._isPaused||e(t)}))},up:e=>{this._events.on("up",(t=>{this._isPaused||e(t)}))}}}_add(e){const t=this.domElement=null!=e?e:window;t||console.warn("[tap] No domElement found!"),this._onDown=this._onDown.bind(this),this._onMove=this._onMove.bind(this),this._onUp=this._onUp.bind(this),As.forEach((e=>{e.test&&e.enabled&&(this.active[e.name]=!0,t.addEventListener(e.events.down,this._onDown,!1),t.addEventListener(e.events.move,this._onMove,!1),t.addEventListener(e.events.up,this._onUp,!1))}))}_remove(e){if(!this.active[e])return;const t=this.domElement;t||console.warn("[tap] No domElement found!"),As.forEach((n=>{n.name===e&&(t.removeEventListener(n.events.down,this._onDown,!1),t.removeEventListener(n.events.move,this._onMove,!1),t.removeEventListener(n.events.up,this._onUp,!1))})),this.active[e]=!1}destroy(){this.pause(),Object.keys(this.active).forEach((e=>{this._remove(e)})),this._events.removeAllListeners(),this._events=null,this.domElement=null,this._isDown=null,this._isPaused=null,this.active=null,this.registered=null,this._currentPosition=null,this._lastPosition=null}_calcPosition(e){let t,n;return e.touches&&e.touches[0]?(t=e.touches[0].pageX,n=e.touches[0].pageY):e.clientX?(t=e.clientX,n=e.clientY):(t=this._currentPosition.x,n=this._currentPosition.y),this.pointerLock.isLocked&&(t=e.movementX,n=e.movementY),this._position={x:t,y:n},{x:t,y:n}}_removeDuplicates(e){return"pointerdown"===e.type&&(this.registered.pointer=!0),"touchstart"===e.type&&(this.registered.touch=!0),"mousedown"===e.type&&(this.registered.mouse=!0),"touchstart"===e.type&&this.active.touch&&this.registered.pointer?(this._remove("touch"),!1):"mousedown"!==e.type||!this.active.mouse||!this.registered.pointer&&!this.registered.touch||(this._remove("mouse"),!1)}_onDown(e){this._removeDuplicates(e)&&(this._isDown=!0,this._events.emit("down",{position:this._calcPosition(e),event:e}))}_onMove(e){this._events.emit("move",{position:this._calcPosition(e),event:e,dragging:this._isDown})}_onUp(e){this._isDown=!1,this._events.emit("up",{position:this._calcPosition(e),event:e})}}const Ts=(e,t,n,r,s,o)=>{r<2*o&&(o=r/2),s<2*o&&(o=s/2),e.beginPath(),e.moveTo(t+o,n),e.arcTo(t+r,n,t+r,n+s,o),e.arcTo(t+r,n+s,t,n+s,o),e.arcTo(t,n+s,t,n,o),e.arcTo(t,n,t+r,n,o),e.closePath()},_s=new Map,Ss=e=>{const t=new r.Texture(e);return t.minFilter=r.LinearFilter,t.generateMipmaps=!1,t.needsUpdate=!0,t},Es=document.createElement("canvas");let Ps,Cs,Rs,Ls=!1;const Vs=[],ks=new r.Raycaster,Is=new r.Vector2,Os=new r.Vector2,Ns=new r.Vector2,Bs=[],Ds=e=>{Bs.includes(e)||(console.warn(e),Bs.push(e))},Fs=(e,t)=>{Ns.x=e,Ns.y=t},Us=()=>Ps,zs=()=>{js(),Rs&&Rs.destroy()},js=()=>{for(;Vs.length>0;)Vs.pop()},Hs=e=>{return t=void 0,n=void 0,s=function*(){if(!Rs)return;const{currentPosition:{x:t,y:n},isDown:r}=Rs;if(Is.x===t&&Is.y===n&&Ls===r)return;if(Ls=r,Is.x=t,Is.y=n,0===Ns.x||void 0===Ns.x)return void Ds("[FLAT] Please call FLAT.setSize() first!");Os.x=t/Ns.x*2-1,Os.y=-n/Ns.y*2+1,ks.setFromCamera(Os,e);let s=[...Vs];const o=ks.intersectObjects(s);0===o.length?document.body.style.cursor="default":document.body.style.cursor="pointer",Cs&&Cs.enabled&&o.length>=0&&(Cs.enabled=!1),Cs&&!Cs.enabled&&0===o.length&&(Cs.enabled=!0);for(let e=0;e<o.length;e++){const t=o[e].object;let n=!1;if(t.pixelPerfect){const e=e=>{Es.width=e.width,Es.height=e.height;const t=Es.getContext("2d");return t.drawImage(e,0,0),t.getImageData(0,0,e.width,e.height)},r=(e,t,n)=>{const r=4*(t+e.width*n),s=e.data;return{r:s[r],g:s[r+1],b:s[r+2],a:s[r+3]}},s=o[0].uv,{x:i,y:a}=t.texture.transformUv(s),l=e(yield createImageBitmap(t.texture.image)),{r:c,g:h,b:u,a:d}=r(l,Math.round(i*l.width),Math.round(a*l.height));n=c+h+u+d===0}if(t.pixelPerfect&&n)continue;t.event=Rs.isDown?"down":"over";const r=s.findIndex((e=>e.uuid===t.uuid));s=[...s.slice(0,r),...s.slice(r+1)];break}return s.forEach((e=>{e.event="out"})),o},new((r=void 0)||(r=Promise))((function(e,o){function i(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,a)}l((s=s.apply(t,n||[])).next())}));var t,n,r,s};class Gs extends r.Sprite{constructor(e,t=!0){super(new r.SpriteMaterial({map:t?e.clone():e,color:16777215})),this._event="out",this._pixelPerfect=!1,this._isInteractive=!1,this._depth=0,this._bodyOffset={x:0,y:0},this._internalScale={x:1,y:1},this._pixelRatio=1,this.onInputOver=()=>{},this.onInputOut=()=>{},this.onInputDown=()=>{},this._setTexture(),this.setScale(this._internalScale.x,this._internalScale.y),this.setDepth(this._calcZ())}_onInputOver(){}_onInputOut(){}_onInputDown(){}set event(e){this._event!==e&&(this._event=e,"over"===e?(this._onInputOver(),this.onInputOver()):"out"===e?(this._onInputOut(),this.onInputOut()):"down"===e&&(this._onInputDown(),this.onInputDown()))}setPixelRatio(e){this._pixelRatio=e,this.setScale(this._internalScale.x,this._internalScale.y)}setInteractive({pixelPerfect:e=!1}={}){var t;this._isInteractive||(this._isInteractive=!0,this._pixelPerfect=e,t=this,0===Vs.length&&(()=>{const e=Us();e?Rs=new Ms(e):Ds('Please call "FLAT.initEvents()" first.')})(),Vs.push(t))}get pixelPerfect(){return this._pixelPerfect}_calcZ(){return this._depth/100-1e-8*this.id}getTexture(){return this.texture}setTexture(e){this._setTexture(e)}get texture(){return this.material.map}_setTexture(e){if(!this.material.map)return void console.warn("Something went wrong!");e&&(this.material.map=e);const{width:t,height:n}=this.material.map.image;this.textureWidth=t,this.textureHeight=n,this.material.map.needsUpdate=!0}getBodyOffset(){return{x:this._bodyOffset.x*this.getScale().x,y:this._bodyOffset.y*this.getScale().y}}setPosition(e,t){this.position.set(e,t,this._calcZ())}setDepth(e){this._depth=e,this.position.setZ(this._calcZ())}setRotation(e){this.material.rotation=e}getRotation(){return this.material.rotation}getPixelRatio(){return this._pixelRatio}getScale(){return{x:this._internalScale.x,y:this._internalScale.y}}setScale(e,t){this._internalScale.x=e,this._internalScale.y=t||e;const n=e,r=t||e;this.scale.set(n*this.textureWidth/this._pixelRatio,r*this.textureHeight/this._pixelRatio,1)}}class Ws extends Gs{constructor(e){super(e),this._anims=[],this._flipX=!1,this._frame={name:"",index:-1,width:-1,height:-1},this._currentIndex=0,this._currentAnimationName=""}get frame(){return{name:this._frame.name,index:this._frame.index,width:this._frame.width*this._internalScale.x*1/this._pixelRatio,height:this._frame.height*this._internalScale.y*1/this._pixelRatio}}get anims(){return{add:this._add.bind(this),get:this.getAnimationByName.bind(this),play:this._play.bind(this),stop:this._stop.bind(this),getName:()=>this._currentAnimationName,name:this._currentAnimationName}}getAnimationByName(e){return this._anims.filter((t=>t.name===e))[0]}_add(e,t){const{start:n,end:r,rate:s=30,repeat:o=-1,timeline:i=[]}=t;if(this.getAnimationByName(e))console.warn(`The animation "${e}" does already exist!`);else{if(0===i.length){if(void 0===r||void 0===n)return void console.warn('You need to provide "start" and "end or a "timeline"!');for(let e=n;e<=r;e++)i.push(e)}this._anims.push({name:e,timeline:i,rate:s,repeat:o})}}_stop(){this.interval&&clearInterval(this.interval)}_play(e){this._stop(),this._currentAnimationName=e;const t=this.getAnimationByName(e);t||console.warn(`Animation "${e}" does not exist!`);const{timeline:n,rate:r,repeat:s}=t;this._currentIndex=-1;let o=0;const i=()=>{if(this._currentIndex++,this._currentIndex>=n.length&&(this._currentIndex=0,o++),this._currentIndex=n[this._currentIndex],!(-1===s||o<s))return this._stop(),void this._events.emit("complete");this.setFrame(this._currentIndex)};return i(),this.interval=window.setInterval((()=>{i()}),1e3/r),{onComplete:e=>this._events.once("complete",e)}}get _events(){return{emit:e=>{this._eventEmitter||(this._eventEmitter=new ws.Events),this._eventEmitter.emit(e)},once:(e,t)=>{this._eventEmitter||(this._eventEmitter=new ws.Events),this._eventEmitter.once(e,t)}}}}class Xs extends Ws{constructor(e,t){super(e);const{width:n=this.textureWidth,height:r=this.textureHeight}=t;this._tilesHoriz=this.textureWidth/n,this._tilesVert=this.textureHeight/r,this._tilesHoriz!==Math.round(this._tilesHoriz)&&console.warn("The horizontal row does not seem to fit!"),this._tilesVert!==Math.round(this._tilesVert)&&console.warn("The vertical row does not seem to fit!"),this._width=n,this._height=r,this._frame.width=n,this._frame.height=r,this.sizeFrame(1/this._tilesHoriz,1/this._tilesVert),this.scaleFrame()}setScale(e,t){super.setScale(e,t),this.scaleFrame()}scaleFrame(){this.scale.set(this._width*this._internalScale.x/this._pixelRatio,this._height*this._internalScale.y/this._pixelRatio,1)}getRow(e){return Math.floor(e/this._tilesHoriz)}getColumn(e){return e%this._tilesHoriz}sizeFrame(e,t){this.texture.wrapS=this.texture.wrapT=r.RepeatWrapping,this.texture.repeat.set(e,t),this.texture.needsUpdate=!0}offsetTexture(e,t){this._flipX&&(e+=1/this._tilesHoriz),this.texture.offset.setX(e),this.texture.offset.setY(t)}flipX(e){this._flipX=e;let t=1/this._tilesHoriz;const n=1/this._tilesVert;e&&(t*=-1),this.texture.repeat.set(t,n),this.setFrame(this._frame.index)}setFrame(e){this._frame.index=e;const t=this.getColumn(e)/this._tilesHoriz,n=(this._tilesVert-this.getRow(e)-1)/this._tilesVert;this.offsetTexture(t,n)}}class qs extends Xs{constructor(e,t,n,r,s){super(e,t),this.overFrame=n,this.outFrame=r,this.downFrame=s,this.setFrame(r)}_onInputOver(){this.setFrame(this.overFrame)}_onInputOut(){this.setFrame(this.outFrame)}_onInputDown(){this.setFrame(this.downFrame)}}class Ys extends r.Texture{constructor(e,t,n){const s=Es.getContext("2d");s.clearRect(0,0,Es.width,Es.height),Es.height=t,Es.width=e,n(s),super(s.getImageData(0,0,Es.width,Es.height)),this.minFilter=r.LinearFilter,this.generateMipmaps=!1,this.width=e,this.height=t,this.drawCanvas=n,this.needsUpdate=!0}clone(){return new Ys(this.width,this.height,this.drawCanvas).copy(this)}}class Ks extends Gs{constructor(e,t,n){const r=Es.getContext("2d");r.clearRect(0,0,Es.width,Es.height),Es.height=t,Es.width=e,n(r);const s=r.getImageData(0,0,Es.width,Es.height);super(Ss(s)),this._drawCanvas=n}clone(){return new Ks(this.textureWidth,this.textureHeight,this._drawCanvas).clone()}}const $s=({canvas:e,orbitControls:t})=>{(e=>{e&&(Cs=e)})(t),(e=>{Ps=e})(e)};class Qs extends r.Texture{constructor(e,t={}){const{imageData:n,width:s,height:o}=Js(e,t);super(n),this.width=s,this.height=o,this._text=e,this._styles=t,this._image=n,this.minFilter=r.LinearFilter,this.generateMipmaps=!1,this.needsUpdate=!0}getText(){return this._text}getStyles(){return this._styles}clone(){return new this.constructor(this._text,this._styles).copy(this)}}class Zs extends Gs{constructor(e){super(e,!1),this._text=e.getText(),this._styles=e.getStyles()}getText(){return this._text}getStyles(){return this._styles}setStyles(e){this._styles=e,this.texture.dispose(),this.setTexture(Ss(Js(this._text,e).imageData))}setText(e){this._text=e,this.texture.dispose(),this.setTexture(Ss(Js(e,this._styles).imageData)),this._update()}_update(){this.textureHeight=this.texture.image.height,this.textureWidth=this.texture.image.width,this.texture.needsUpdate=!0,this.material.needsUpdate=!0;const{x:e,y:t}=this._internalScale;this.setScale(e,t)}}const Js=(e,t)=>{const{align:n="center",background:r="",baseline:s="middle",borderColor:o="",borderRadius:i=0,borderWidth:a=0,fillStyle:l="SlateBlue",fontFamily:c="Arial",fontSize:h=48,fontWeight:u="",lineHeight:d=1,lineWidth:p=4,padding:m=0,strokeStyle:f=""}=t,{offset:{x:g=0,y:v=0}={}}=t;let y,x;"number"!=typeof m?(y=m.x||0,x=m.y||0):(y=m,x=m);const b=`${u} ${h}px ${c}`,w=Es.getContext("2d");w.clearRect(0,0,Es.width,Es.height);const A=e.split("\n");w.font=b;const M=((e,t,n,r=1)=>{const s=t+n;let o=_s.get(s);if(!o){const i=document.createElement("p");i.style.fontFamily=n,i.style.fontSize=`${t}px`,i.style.whiteSpace="nowrap",i.style.lineHeight=r.toString(),i.textContent=e,document.body.appendChild(i),o=Math.ceil(i.offsetHeight),document.body.removeChild(i),_s.set(s,o)}return o})(e,h,c,d),T=l?2*p:p,_=M*A.length+2*x+2*a,S=((e,t)=>Math.max(...t.map((t=>Math.ceil(e.measureText(t).width)))))(w,A)+T+2*y+2*a;Es.height=_,Es.width=S,o&&(w.strokeStyle=o,Ts(w,a/2,a/2,Es.width-a,Es.height-a,i),w.lineWidth=a,w.stroke()),r&&(w.fillStyle=r,Ts(w,a,a,Es.width-2*a,Es.height-2*a,o?i/2:i),w.fill()),w.font=b,w.textAlign=n,w.textBaseline=s,f&&p&&(w.strokeStyle=f,w.lineWidth=T),l&&(w.fillStyle=l);for(var E=0;E<A.length;E++){let e=E*M+M/2,t=0;"left"===n&&(t=T/2,t+=y,t+=a),"center"===n&&(t=S/2),"right"===n&&(t=S-T/2,t-=y,t-=a),e+=x,e+=a,e+=v,t+=g,f&&p&&w.strokeText(A[E],t,e),l&&w.fillText(A[E],t,e)}return{imageData:w.getImageData(0,0,Es.width,Es.height),width:S,height:_}};class eo extends Ws{constructor(e,t){super(e.texture),this.positionOffset={x:0,y:0},this.JSONHash=e.json,t&&this.setFrame(t)}setScale(e,t){this._internalScale.x=e,this._internalScale.y=t||e,this.scaleFrame()}scaleFrame(){var e;if(!(null===(e=this._frame)||void 0===e?void 0:e.name))return;const{frame:{w:t,h:n}}=this.getFrame(this._frame.name),r=t*this._internalScale.x/this._pixelRatio,s=n*this._internalScale.y/this._pixelRatio;this.scale.set(r,s,1)}sizeFrame(e,t){this.texture.wrapS=this.texture.wrapT=r.RepeatWrapping,this.texture.repeat.set(e,t),this.texture.needsUpdate=!0}offsetTexture(e,t){this.texture.offset.setX(e),this.texture.offset.setY(t)}flipX(e){this._flipX=e,this.update()}getFrame(e){return this.JSONHash.frames[e]}setFrame(e){this.update(e)}update(e){if(e||(e=this._frame.name),!e)return;const t=this.getFrame(e);t||console.warn(`Frame ${e} not found!`);const{frame:n,rotated:r,trimmed:s,spriteSourceSize:o,sourceSize:i}=t;this._frame.name=e,this.texture.rotation=0;const a=n.x/this.textureWidth;let l=1-(n.y+n.h)/this.textureHeight,c=n.w,h=n.h;if(this._frame.width=c,this._frame.height=h,r&&(this.texture.rotation=Math.PI/2,l=1-n.y/this.textureHeight,[c,h]=[h,c],this._flipX&&(this.texture.rotation*=-1)),s){const e=((i.w-n.w)/2-o.x)/(1/this._internalScale.x),t=((i.h-n.h)/2-o.y)/(1/this._internalScale.x);this._flipX?this.position.x+=e-this.positionOffset.x:this.position.x-=e-this.positionOffset.x,this.position.y+=t-this.positionOffset.y,this.positionOffset.x=e,this.positionOffset.y=t}let u=a,d=l,p=c/this.textureWidth;const m=h/this.textureHeight;this._flipX&&(p*=-1,r?d-=n.w/this.textureHeight:u+=n.w/this.textureWidth),this.offsetTexture(u,d),this.sizeFrame(p,m),this.scaleFrame()}}var to=o(626);const no={colors:{dynamic:"#ff0000",static:"#90ee90",sensor:"#ffff00",sleeping:"#464646"},lineWidth:2,fill:!1,opacity:.25},ro=(e,t=0,n,r)=>{const s=((e={})=>{const{colors:t}=no;return e.isStatic?t.static:e.isSensor?t.sensor:e.isSleeping?t.sleeping:t.dynamic})(e),o=no.opacity,i=no.lineWidth,a=no.fill;let l=null!=n?n:s+Math.round(255*o).toString(16);a||(l=null!=n?n:"transparent"),!e.isSleeping||e.isStatic||e.isSensor||(l=null!=n?n:s);const c=null!=r?r:s;e.render.fillStyle=l,e.render.strokeStyle=c,e.render.lineWidth=i,t>=5||e.parts.forEach((e=>{ro(e,t+1,l,c)}))};class so{constructor(e=!0){this._objects=new Map,this.width=window.innerWidth,this.height=window.innerHeight;const t=e;if(this.engine=to.Engine.create({enableSleeping:!0}),this.world=this.engine.world,this.runner=to.Runner.create(),t){const e=document.createElement("canvas");e.id="matter-debug",e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.pointerEvents="none",document.body.append(e),this.render=to.Render.create({canvas:e,engine:this.engine,options:{width:this.width,height:this.height,background:"transparent",wireframeBackground:"transparent",wireframes:!1,showConvexHulls:!0,showPositions:!0,showVelocity:!0}}),to.Render.run(this.render)}to.Runner.run(this.runner,this.engine),to.Events.on(this.engine,"afterUpdate",(()=>this.update()))}destroy(){to.World.clear(this.world,!1),to.Engine.clear(this.engine)}parsePhysics(e){const t=JSON.parse(e);delete t.generator_info;let n={};for(const e in t){const r=t[e].fixtures;n=Object.assign(Object.assign({},n),{[e]:r})}return n}addBodyFromFixtures(e,t,n){const r=[];let s;return n.forEach((n=>{let s;n.vertices?s=this.add.fromVertices(e,t,n.vertices):n.circle?s=this.add.circle(e+n.circle.x,t+n.circle.y,n.circle.radius):console.log("Shape not recognized!"),s&&r.push(s)})),s=r.length>1?to.Body.create({parts:r}):r[0],to.Body.setPosition(s,{x:e,y:t}),s}fromVertices_Fixed(e,t,n,r={}){const s=[];for(var o=0;o<n.length;o++){const i=to.Bodies.fromVertices(e,t,[n[o]],Object.assign({},r));s.push(i);const a=to.Vertices.centre(n[o]);to.Body.setPosition(i,{x:i.position.x+a.x,y:i.position.y+a.y})}return to.Body.create(Object.assign(Object.assign({},r),{parts:s}))}fromVertices(e,t,n,r={}){return this.fromVertices_Fixed(e,t,n,Object.assign({},r))}setBounds(e=0,t=0,n=this.width,r=this.height,s=50){to.World.add(this.world,[this.add.rectangle(e+n/2,t+0-s/2,n+2*s,s,{isStatic:!0}),this.add.rectangle(e+n/2,t+r+s/2,n+2*s,s,{isStatic:!0}),this.add.rectangle(e+0-s/2,t+r/2,s,r+2*s,{isStatic:!0}),this.add.rectangle(e+n+s/2,t+r/2,s,r+2*s,{isStatic:!0})])}rectangle(e,t,n,r,s={}){return to.Bodies.rectangle(e,t,n,r,Object.assign({},s))}circle(e,t,n,r={}){return to.Bodies.circle(e,t,n,Object.assign({},r))}existing(e){this.add.bodyToSprite(e),this._objects.set(e.body.id.toString(),e)}calcBodyOffset(e){const t=e.body,n=t.bounds.max.x-t.bounds.min.x,r=t.bounds.max.y-t.bounds.min.y,s=to.Vector.sub(t.bounds.min,t.position),o=(t.position,{x:s.x+n/2,y:s.y+r/2});e._bodyOffset=o}_addBodyToSprite(e){this.add.body(e.body),this.calcBodyOffset(e);const t=e.getScale().x,n=e.getScale().y;((e,t,n)=>{e.circleRadius||e.parts.forEach((e=>{((e,t,n)=>{e.circleRadius&&(t===n?e.circleRadius*=t:e.circleRadius=void 0)})(e,t,n)})),to.Body.scale(e,t,n)})(e.body,t,n),e.setBodyPosition=(t,n)=>{to.Body.setPosition(e.body,{x:t-e.getBodyOffset().x,y:n-e.getBodyOffset().y})}}_addBody(e){to.World.add(this.world,e)}get add(){return{body:this._addBody.bind(this),bodyToSprite:this._addBodyToSprite.bind(this),fromVertices:this.fromVertices.bind(this),circle:this.circle.bind(this),existing:this.existing.bind(this),rectangle:this.rectangle.bind(this)}}adjustDebugColor(e){ro(e)}update(){this._objects.forEach((e=>{const{body:t}=e,{angle:n,position:s}=t,{x:o,y:i}=s,a=new r.Vector2(e.getBodyOffset().x,e.getBodyOffset().y);a.rotateAround(new r.Vector2,n),e.setPosition(o+a.x,this.height-i-a.y),e.setRotation(-n),ro(t)}))}}class oo extends c.Events{constructor(){super(...arguments),this.id=-1}get add(){return{axis:(e={})=>this.addAxis(e),button:(e={})=>this.addButton(e)}}addAxis(e={}){this.id++;const{styles:t={left:35,bottom:35,size:100}}=e,n=this.circle({styles:t}),r=this.thumb({styles:t});n.appendChild(r),document.body.appendChild(n);const{maxRadius:s=40,rotationDamping:o=.06,moveDamping:i=.01}=e,a={id:this.id,domElement:r,maxRadius:s,maxRadiusSquared:s*s,origin:{left:r.offsetLeft,top:r.offsetTop},offset:{x:0,y:0},rotationDamping:o,moveDamping:i};if(null==a?void 0:a.domElement){const{domElement:e}=a;"ontouchstart"in window?e.addEventListener("touchstart",(e=>{e.preventDefault(),this.tap(e,a),e.stopPropagation()})):e.addEventListener("mousedown",(e=>{e.preventDefault(),this.tap(e,a),e.stopPropagation()}))}return{onMove:e=>{this.on(`axis_onmove_${a.id}`,(t=>{e(t)}))}}}addButton(e={}){this.id++;const{styles:t={right:35,bottom:35,size:80},letter:n="A"}=e,r=this.circle({styles:t}),s=this.letter({letter:n});r.appendChild(s),document.body.appendChild(r);const o={id:this.id,domElement:r,offset:{x:0,y:0}};return(null==o?void 0:o.domElement)&&this.click(o),{onClick:e=>{this.on(`button_onclick_${o.id}`,(t=>{e(t)}))},onRelease:e=>{this.on(`button_onrelease_${o.id}`,(t=>{e(t)}))}}}circle(e={}){const{styles:t}=e,{top:n,right:r,bottom:s,left:o,size:i}=t,a=document.createElement("div");let l=`position:absolute; width:${i}px; height:${i}px; background:rgba(126, 126, 126, 0.5); border:#444 solid medium; border-radius:50%; cursor: pointer; `;return n&&(l+=`top:${n}px; `),r&&(l+=`right:${r}px; `),s&&(l+=`bottom:${s}px; `),o&&(l+=`left:${o}px; `),a.style.cssText=l,a}thumb(e={}){const{styles:t}=e,{size:n}=t,r=document.createElement("div");return r.style.cssText=`position: absolute; left: ${n/4}px; top: ${n/4}px; width: ${n/2}px; height: ${n/2}px; border-radius: 50%; background: #fff; `,r}letter(e={}){const{letter:t}=e,n=document.createElement("span");return n.innerText=t,n.style.cssText="position: absolute; text-align: center; top: 4px; width: 80px; height: 80px; font-size: 64px; color: #fff; ",n}click(e){const{id:t,domElement:n}=e;"ontouchstart"in window?(n.addEventListener("touchstart",(e=>{e.preventDefault(),this.emit(`button_onclick_${t}`)})),n.addEventListener("touchend",(e=>{e.preventDefault(),this.emit(`button_onrelease_${t}`)}))):(n.addEventListener("mousedown",(e=>{e.preventDefault(),this.emit(`button_onclick_${t}`),e.stopPropagation()})),n.addEventListener("mouseup",(e=>{e.preventDefault(),this.emit(`button_onrelease_${t}`),e.stopPropagation()})))}tap(e,t){e=e||window.event,t.offset=this.getMousePosition(e),"ontouchstart"in window?(document.ontouchmove=e=>{e.target===t.domElement&&this.move(e,t)},document.ontouchend=e=>{e.target===t.domElement&&this.up(t)}):(document.onmousemove=e=>{e.target===t.domElement&&this.move(e,t)},document.onmouseup=e=>{this.up(t)})}move(e,t){const{domElement:n,maxRadius:r,maxRadiusSquared:s,origin:o,offset:i,id:a}=t;e=e||window.event;const l=this.getMousePosition(e);let c=l.x-i.x,h=l.y-i.y;const u=c*c+h*h;if(u>s){const e=Math.sqrt(u);c/=e,h/=e,c*=r,h*=r}n.style.top=`${h+n.clientHeight/2}px`,n.style.left=`${c+n.clientWidth/2}px`;const d=-(h-o.top+n.clientHeight/2)/r,p=(c-o.left+n.clientWidth/2)/r;this.emit(`axis_onmove_${a}`,{top:d,right:p})}up(e){const{domElement:t,origin:n,id:r}=e;"ontouchstart"in window?(document.ontouchmove=null,document.touchend=null):(document.onmousemove=null,document.onmouseup=null),t.style.top=`${n.top}px`,t.style.left=`${n.left}px`,this.emit(`axis_onmove_${r}`,{top:0,right:0})}getMousePosition(e){return{x:e.targetTouches?e.targetTouches[0].pageX:e.clientX,y:e.targetTouches?e.targetTouches[0].pageY:e.clientY}}}class io{constructor(e,t,n){this.camera=e,this.target=t,this.config=n;const{offset:s=new r.Vector3(0,0,0),sensitivity:o=new r.Vector2(.25,.25),radius:i=8,targetRadius:a=10,interpolationFactor:l=.05,pointerLock:c=!0,autoUpdate:h=!0,theta:u=0,phi:d=0,maxPhi:p=85,minPhi:m=-85}=n;this.offset=s,this.sensitivity=o,this.radius=i,this.targetRadius=a,this.interpolationFactor=l,this.theta=u,this.phi=d,this.maxPhi=p,this.minPhi=m}update(e,t){const n=this.target.position.clone().add(this.offset);this.theta-=e*(this.sensitivity.x/2),this.theta%=360,this.phi+=t*(this.sensitivity.y/2),this.phi=Math.min(this.maxPhi,Math.max(this.minPhi,this.phi)),this.radius=r.MathUtils.lerp(this.radius,this.targetRadius,this.interpolationFactor),this.camera.position.x=n.x+this.radius*Math.sin(this.theta*Math.PI/180)*Math.cos(this.phi*Math.PI/180),this.camera.position.y=n.y+this.radius*Math.sin(this.phi*Math.PI/180),this.camera.position.z=n.z+this.radius*Math.cos(this.theta*Math.PI/180)*Math.cos(this.phi*Math.PI/180),this.camera.updateMatrix(),this.camera.lookAt(n)}}class ao{constructor(e,t,n){this.camera=e,this.target=t,this.config=n;const{offset:s=new r.Vector3(0,0,0),sensitivity:o=new r.Vector2(.25,.25),radius:i=8,targetRadius:a=10,interpolationFactor:l=.05,pointerLock:c=!0,autoUpdate:h=!0}=n;this.offset=s,this.sensitivity=o,this.radius=i,this.targetRadius=a,this.interpolationFactor=l,this.theta=0,this.phi=0}update(e,t){const n=this.target.position.clone().add(this.offset);this.camera.position.copy(n),this.theta-=e*(this.sensitivity.x/2),this.theta%=360,this.phi+=t*(-this.sensitivity.y/2),this.phi=Math.min(85,Math.max(-85,this.phi));const s=new r.Vector3;s.x=n.x+this.radius*Math.sin(this.theta*Math.PI/180)*Math.cos(this.phi*Math.PI/180),s.y=n.y+this.radius*Math.sin(this.phi*Math.PI/180),s.z=n.z+this.radius*Math.cos(this.theta*Math.PI/180)*Math.cos(this.phi*Math.PI/180),this.camera.updateMatrix(),this.camera.lookAt(s)}}class lo{constructor(e,t=!0){this._element=e,this._isRunning=!1,t&&this.request()}isLocked(){return!!document.pointerLockElement}exit(){this._isRunning=!1,document.exitPointerLock(),this.removeListeners()}removeListeners(){document.removeEventListener("pointerlockchange",(()=>this.pointerLockChangeHandler())),this._element.removeEventListener("pointerdown",(()=>this.pointerDownHandlerHandler()))}pointerLockChangeHandler(){this._isRunning&&this._request()}pointerDownHandlerHandler(){this._isRunning&&this._element.requestPointerLock()}request(){this._isRunning=!0,this._request()}_request(){document.addEventListener("pointerlockchange",(()=>this.pointerLockChangeHandler()),{once:!0}),document.pointerLockElement||this._element.addEventListener("pointerdown",(()=>this.pointerDownHandlerHandler()),{once:!0})}}class co{constructor(e,t=!0){this._element=e,this._isRunning=!1,this._position={x:0,y:0},this._delta={x:0,y:0},this._onMoveCallback=()=>{},this._isPointerDown=!1,t&&this.start()}get isTouchDevice(){return"ontouchstart"in window}get isPointerDown(){return this._isPointerDown}start(){this._isRunning||(this._isRunning=!0,this.isTouchDevice?(this._element.addEventListener("touchstart",(e=>this.onTouchStart(e))),this._element.addEventListener("touchend",(e=>this.onTouchEnd(e))),this._element.addEventListener("touchmove",(e=>this.onTouchMove(e)))):(this._element.addEventListener("mousedown",(e=>this.onPointerDown(e))),this._element.addEventListener("mouseup",(e=>this.onPointerUp(e))),this._element.addEventListener("mouseleave",(e=>this.onPointerLeave(e))),this._element.addEventListener("mouseover",(e=>this.onPointerOver(e))),this._element.addEventListener("mousemove",(e=>this.onPointerMove(e)))))}stop(){this.isTouchDevice?(this._element.removeEventListener("touchstart",(e=>this.onTouchStart(e))),this._element.removeEventListener("touchend",(e=>this.onTouchEnd(e))),this._element.removeEventListener("touchmove",(e=>this.onTouchMove(e)))):(this._element.removeEventListener("mousedown",(e=>this.onPointerDown(e))),this._element.removeEventListener("mouseleave",(e=>this.onPointerLeave(e))),this._element.removeEventListener("mouseup",(e=>this.onPointerUp(e))),this._element.removeEventListener("mouseover",(e=>this.onPointerOver(e))),this._element.removeEventListener("mousemove",(e=>this.onPointerMove(e)))),this._isRunning=!1}removeListeners(){this.stop()}onMove(e){this._onMoveCallback=e}onPointerDown(e){this._isPointerDown=!0}onPointerUp(e){this._isPointerDown=!1}onPointerLeave(e){this._isPointerDown=!1}onPointerMove(e){const t=e.movementX,n=e.movementY;this._delta={x:t,y:n},this._onMoveCallback(this._delta)}onPointerOver(e){}onTouchStart(e){const t=e.touches[0].clientX,n=e.touches[0].clientY;this._position={x:t,y:n}}onTouchEnd(e){this._position={x:0,y:0},this._delta={x:0,y:0},this._onMoveCallback(this._delta)}onTouchMove(e){const t=e.touches[0].clientX,n=e.touches[0].clientY;this._delta={x:t-this._position.x,y:n-this._position.y},this._onMoveCallback(this._delta),this._position={x:t,y:n}}}var ho={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform float opacity;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\t\t\tgl_FragColor = opacity * texel;\n\n\t\t}"};class uo{constructor(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}}const po=new r.OrthographicCamera(-1,1,1,-1,0,1),mo=new r.BufferGeometry;mo.setAttribute("position",new r.Float32BufferAttribute([-1,3,0,-1,-1,0,3,-1,0],3)),mo.setAttribute("uv",new r.Float32BufferAttribute([0,2,0,0,2,0],2));class fo{constructor(e){this._mesh=new r.Mesh(mo,e)}dispose(){this._mesh.geometry.dispose()}render(e){e.render(this._mesh,po)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}}class go extends uo{constructor(e,t){super(),this.textureID=void 0!==t?t:"tDiffuse",e instanceof r.ShaderMaterial?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=r.UniformsUtils.clone(e.uniforms),this.material=new r.ShaderMaterial({defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.fsQuad=new fo(this.material)}render(e,t,n){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=n.texture),this.fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}}class vo extends uo{constructor(e,t){super(),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,n){const r=e.getContext(),s=e.state;let o,i;s.buffers.color.setMask(!1),s.buffers.depth.setMask(!1),s.buffers.color.setLocked(!0),s.buffers.depth.setLocked(!0),this.inverse?(o=0,i=1):(o=1,i=0),s.buffers.stencil.setTest(!0),s.buffers.stencil.setOp(r.REPLACE,r.REPLACE,r.REPLACE),s.buffers.stencil.setFunc(r.ALWAYS,o,4294967295),s.buffers.stencil.setClear(i),s.buffers.stencil.setLocked(!0),e.setRenderTarget(n),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),s.buffers.color.setLocked(!1),s.buffers.depth.setLocked(!1),s.buffers.stencil.setLocked(!1),s.buffers.stencil.setFunc(r.EQUAL,1,4294967295),s.buffers.stencil.setOp(r.KEEP,r.KEEP,r.KEEP),s.buffers.stencil.setLocked(!0)}}class yo extends uo{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}class xo{constructor(e,t){if(this.renderer=e,void 0===t){const n={minFilter:r.LinearFilter,magFilter:r.LinearFilter,format:r.RGBAFormat},s=e.getSize(new r.Vector2);this._pixelRatio=e.getPixelRatio(),this._width=s.width,this._height=s.height,(t=new r.WebGLRenderTarget(this._width*this._pixelRatio,this._height*this._pixelRatio,n)).texture.name="EffectComposer.rt1"}else this._pixelRatio=1,this._width=t.width,this._height=t.height;this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],void 0===ho&&console.error("THREE.EffectComposer relies on CopyShader"),void 0===go&&console.error("THREE.EffectComposer relies on ShaderPass"),this.copyPass=new go(ho),this.clock=new r.Clock}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const t=this.passes.indexOf(e);-1!==t&&this.passes.splice(t,1)}isLastEnabledPass(e){for(let t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){void 0===e&&(e=this.clock.getDelta());const t=this.renderer.getRenderTarget();let n=!1;for(let t=0,r=this.passes.length;t<r;t++){const r=this.passes[t];if(!1!==r.enabled){if(r.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(t),r.render(this.renderer,this.writeBuffer,this.readBuffer,e,n),r.needsSwap){if(n){const t=this.renderer.getContext(),n=this.renderer.state.buffers.stencil;n.setFunc(t.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),n.setFunc(t.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==vo&&(r instanceof vo?n=!0:r instanceof yo&&(n=!1))}}this.renderer.setRenderTarget(t)}reset(e){if(void 0===e){const t=this.renderer.getSize(new r.Vector2);this._pixelRatio=this.renderer.getPixelRatio(),this._width=t.width,this._height=t.height,(e=this.renderTarget1.clone()).setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;const n=this._width*this._pixelRatio,r=this._height*this._pixelRatio;this.renderTarget1.setSize(n,r),this.renderTarget2.setSize(n,r);for(let e=0;e<this.passes.length;e++)this.passes[e].setSize(n,r)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}}new r.OrthographicCamera(-1,1,1,-1,0,1);const bo=new r.BufferGeometry;bo.setAttribute("position",new r.Float32BufferAttribute([-1,3,0,-1,-1,0,3,-1,0],3)),bo.setAttribute("uv",new r.Float32BufferAttribute([0,2,0,0,2,0],2));class wo extends uo{constructor(e,t,n,s,o){super(),this.scene=e,this.camera=t,this.overrideMaterial=n,this.clearColor=s,this.clearAlpha=void 0!==o?o:0,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new r.Color}render(e,t,n){const r=e.autoClear;let s,o;e.autoClear=!1,void 0!==this.overrideMaterial&&(o=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor&&(e.getClearColor(this._oldClearColor),s=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:n),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),this.clearColor&&e.setClearColor(this._oldClearColor,s),void 0!==this.overrideMaterial&&(this.scene.overrideMaterial=o),e.autoClear=r}}const Ao={uniforms:{tDiffuse:{value:null},tDisp:{value:null},byp:{value:0},amount:{value:.08},angle:{value:.02},seed:{value:.02},seed_x:{value:.02},seed_y:{value:.02},distortion_x:{value:.5},distortion_y:{value:.6},col_s:{value:.05}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\t\tvoid main() {\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t}",fragmentShader:"\n\n\t\tuniform int byp; //should we apply the glitch ?\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform sampler2D tDisp;\n\n\t\tuniform float amount;\n\t\tuniform float angle;\n\t\tuniform float seed;\n\t\tuniform float seed_x;\n\t\tuniform float seed_y;\n\t\tuniform float distortion_x;\n\t\tuniform float distortion_y;\n\t\tuniform float col_s;\n\n\t\tvarying vec2 vUv;\n\n\n\t\tfloat rand(vec2 co){\n\t\t\treturn fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n\t\t}\n\n\t\tvoid main() {\n\t\t\tif(byp<1) {\n\t\t\t\tvec2 p = vUv;\n\t\t\t\tfloat xs = floor(gl_FragCoord.x / 0.5);\n\t\t\t\tfloat ys = floor(gl_FragCoord.y / 0.5);\n\t\t\t\t//based on staffantans glitch shader for unity https://github.com/staffantan/unityglitch\n\t\t\t\tvec4 normal = texture2D (tDisp, p*seed*seed);\n\t\t\t\tif(p.y<distortion_x+col_s && p.y>distortion_x-col_s*seed) {\n\t\t\t\t\tif(seed_x>0.){\n\t\t\t\t\t\tp.y = 1. - (p.y + distortion_y);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tp.y = distortion_y;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif(p.x<distortion_y+col_s && p.x>distortion_y-col_s*seed) {\n\t\t\t\t\tif(seed_y>0.){\n\t\t\t\t\t\tp.x=distortion_x;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tp.x = 1. - (p.x + distortion_x);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tp.x+=normal.x*seed_x*(seed/5.);\n\t\t\t\tp.y+=normal.y*seed_y*(seed/5.);\n\t\t\t\t//base from RGB shift shader\n\t\t\t\tvec2 offset = amount * vec2( cos(angle), sin(angle));\n\t\t\t\tvec4 cr = texture2D(tDiffuse, p + offset);\n\t\t\t\tvec4 cga = texture2D(tDiffuse, p);\n\t\t\t\tvec4 cb = texture2D(tDiffuse, p - offset);\n\t\t\t\tgl_FragColor = vec4(cr.r, cga.g, cb.b, cga.a);\n\t\t\t\t//add noise\n\t\t\t\tvec4 snow = 200.*amount*vec4(rand(vec2(xs * seed,ys * seed*50.))*0.2);\n\t\t\t\tgl_FragColor = gl_FragColor+ snow;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tgl_FragColor=texture2D (tDiffuse, vUv);\n\t\t\t}\n\t\t}"};class Mo extends uo{constructor(e=64){super(),void 0===Ao&&console.error("THREE.GlitchPass relies on DigitalGlitch");const t=Ao;this.uniforms=r.UniformsUtils.clone(t.uniforms),this.uniforms.tDisp.value=this.generateHeightmap(e),this.material=new r.ShaderMaterial({uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader}),this.fsQuad=new fo(this.material),this.goWild=!1,this.curF=0,this.generateTrigger()}render(e,t,n){this.uniforms.tDiffuse.value=n.texture,this.uniforms.seed.value=Math.random(),this.uniforms.byp.value=0,this.curF%this.randX==0||1==this.goWild?(this.uniforms.amount.value=Math.random()/30,this.uniforms.angle.value=r.MathUtils.randFloat(-Math.PI,Math.PI),this.uniforms.seed_x.value=r.MathUtils.randFloat(-1,1),this.uniforms.seed_y.value=r.MathUtils.randFloat(-1,1),this.uniforms.distortion_x.value=r.MathUtils.randFloat(0,1),this.uniforms.distortion_y.value=r.MathUtils.randFloat(0,1),this.curF=0,this.generateTrigger()):this.curF%this.randX<this.randX/5?(this.uniforms.amount.value=Math.random()/90,this.uniforms.angle.value=r.MathUtils.randFloat(-Math.PI,Math.PI),this.uniforms.distortion_x.value=r.MathUtils.randFloat(0,1),this.uniforms.distortion_y.value=r.MathUtils.randFloat(0,1),this.uniforms.seed_x.value=r.MathUtils.randFloat(-.3,.3),this.uniforms.seed_y.value=r.MathUtils.randFloat(-.3,.3)):0==this.goWild&&(this.uniforms.byp.value=1),this.curF++,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(),this.fsQuad.render(e))}generateTrigger(){this.randX=r.MathUtils.randInt(120,240)}generateHeightmap(e){const t=new Float32Array(e*e*3),n=e*e;for(let e=0;e<n;e++){const n=r.MathUtils.randFloat(0,1);t[3*e+0]=n,t[3*e+1]=n,t[3*e+2]=n}return new r.DataTexture(t,e,e,r.RGBFormat,r.FloatType)}}const To={uniforms:{tDiffuse:{value:null},tSize:{value:new r.Vector2(256,256)},center:{value:new r.Vector2(.5,.5)},angle:{value:1.57},scale:{value:1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform vec2 center;\n\t\tuniform float angle;\n\t\tuniform float scale;\n\t\tuniform vec2 tSize;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tfloat pattern() {\n\n\t\t\tfloat s = sin( angle ), c = cos( angle );\n\n\t\t\tvec2 tex = vUv * tSize - center;\n\t\t\tvec2 point = vec2( c * tex.x - s * tex.y, s * tex.x + c * tex.y ) * scale;\n\n\t\t\treturn ( sin( point.x ) * sin( point.y ) ) * 4.0;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvec4 color = texture2D( tDiffuse, vUv );\n\n\t\t\tfloat average = ( color.r + color.g + color.b ) / 3.0;\n\n\t\t\tgl_FragColor = vec4( vec3( average * 10.0 - 5.0 + pattern() ), color.a );\n\n\t\t}"}})(),i})()}));
//# sourceMappingURL=enable3d.phaserExtension.0.23.0.min.js.map